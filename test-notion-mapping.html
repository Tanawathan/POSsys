<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion é£Ÿæåº«æ˜ å°„æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ§ª Notion é£Ÿæåº«æ¬„ä½æ˜ å°„æ¸¬è©¦</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”— API é€£æ¥ç‹€æ…‹</h2>
            <div id="connection-status" class="text-gray-600">æ­£åœ¨æ¸¬è©¦é€£æ¥...</div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ åŸå§‹ Notion è³‡æ–™çµæ§‹</h2>
            <pre id="raw-data" class="bg-gray-50 p-4 rounded text-sm overflow-auto max-h-64"></pre>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”„ æ˜ å°„å¾Œçš„è³‡æ–™çµæ§‹</h2>
            <pre id="mapped-data" class="bg-gray-50 p-4 rounded text-sm overflow-auto max-h-64"></pre>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š é£Ÿæåº«å­˜æ¸…å–® (å‰10é …)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é£Ÿæåç¨±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¾›æ‡‰å•†</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¦æ ¼/å–®ä½</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">åº«å­˜é‡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å®‰å…¨åº«å­˜</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å–®ä½æˆæœ¬</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table" class="bg-white divide-y divide-gray-200">
                        <!-- è³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button onclick="refreshData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™
            </button>
        </div>
    </div>

    <script>
        // æ¸¬è©¦æ˜ å°„åŠŸèƒ½
        async function testNotionMapping() {
            try {
                document.getElementById('connection-status').innerHTML = 
                    '<span class="text-yellow-600">â³ æ­£åœ¨è¼‰å…¥ Notion è³‡æ–™...</span>';
                
                // ç²å–åŸå§‹ Notion è³‡æ–™
                const response = await fetch("/.netlify/functions/notion-api/databases/237fd5adc30b808cbba3c03f8f2065fd/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const rawData = await response.json();
                
                // é¡¯ç¤ºé€£æ¥ç‹€æ…‹
                document.getElementById('connection-status').innerHTML = 
                    '<span class="text-green-600">âœ… Notion API é€£æ¥æˆåŠŸ</span>';
                
                // é¡¯ç¤ºåŸå§‹è³‡æ–™çµæ§‹ï¼ˆç¬¬ä¸€å€‹é …ç›®ï¼‰
                document.getElementById('raw-data').textContent = 
                    JSON.stringify(rawData.results[0].properties, null, 2);
                
                // æ˜ å°„è³‡æ–™
                const mappedData = rawData.results.slice(0, 10).map((item, index) => {
                    const properties = item.properties;
                    
                    // å¾è¦æ ¼/å–®ä½æ¬„ä½è§£æå–®ä½
                    const specText = properties['è¦æ ¼/å–®ä½']?.rich_text?.[0]?.text?.content || '';
                    const unitMatch = specText.match(/(å…‹|å…¬æ–¤|æ¯«å‡|å…¬å‡|é¡†|æ–¤|åŒ…|ç“¶|ç½)/);
                    const extractedUnit = unitMatch ? unitMatch[1] : 'å…¬å…‹';
                    
                    return {
                        id: item.id,
                        itemId: properties['å“é …ID']?.title?.[0]?.text?.content || `ITEM-${String(index + 1).padStart(3, '0')}`,
                        name: properties['é£Ÿæåç¨±']?.rich_text?.[0]?.text?.content || 
                              properties['å“é …ID']?.title?.[0]?.text?.content || 'æœªå‘½åé£Ÿæ',
                        supplier: properties['ä¾›æ‡‰å•†']?.select?.name || 'æœªæŒ‡å®šä¾›æ‡‰å•†',
                        specification: properties['è¦æ ¼/å–®ä½']?.rich_text?.[0]?.text?.content || '',
                        unit: extractedUnit,
                        stock: properties['åº«å­˜é‡']?.number || 0,
                        safetyStock: properties['å®‰å…¨åº«å­˜é‡']?.number || 100,
                        unitCost: properties['å–®ä½æˆæœ¬']?.formula?.number || 0,
                        purchasePrice: properties['é€²åƒ¹']?.number || 0,
                        category: properties['å“é …é¡åˆ¥']?.select?.name || 'ä¸€èˆ¬é£Ÿæ',
                        status: getStockStatus(
                            properties['åº«å­˜é‡']?.number || 0, 
                            properties['å®‰å…¨åº«å­˜é‡']?.number || 100
                        ),
                        lastPurchase: properties['æœ€å¾Œé€²è²¨æ—¥']?.last_edited_time ? 
                            new Date(properties['æœ€å¾Œé€²è²¨æ—¥'].last_edited_time).toLocaleDateString('zh-TW') : 
                            new Date().toLocaleDateString('zh-TW'),
                        notes: properties['ç‹€æ…‹']?.status?.name || '',
                        totalPurchase: properties['ç¸½é€²è²¨é‡']?.rollup?.number || 0
                    };
                });
                
                // é¡¯ç¤ºæ˜ å°„å¾Œçš„è³‡æ–™çµæ§‹
                document.getElementById('mapped-data').textContent = 
                    JSON.stringify(mappedData[0], null, 2);
                
                // æ¸²æŸ“è¡¨æ ¼
                renderTable(mappedData);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('connection-status').innerHTML = 
                    `<span class="text-red-600">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</span>`;
            }
        }
        
        // åˆ¤æ–·åº«å­˜ç‹€æ…‹
        function getStockStatus(stock, safetyStock) {
            if (stock === 0) return 'critical';
            if (stock <= safetyStock) return 'low';
            return 'safe';
        }
        
        // æ ¼å¼åŒ–é‡é‡é¡¯ç¤º
        function formatWeight(grams) {
            if (!grams || grams === 0) return '0';
            if (grams >= 1000) {
                const kg = grams / 1000;
                return kg % 1 === 0 ? `${kg}` : `${kg.toFixed(1)}`;
            }
            return grams.toLocaleString();
        }
        
        // ç²å–é‡é‡å–®ä½
        function getWeightUnit(grams) {
            if (!grams || grams === 0) return 'å…¬å…‹';
            return grams >= 1000 ? 'å…¬æ–¤' : 'å…¬å…‹';
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const statusConfig = {
                    'critical': { class: 'text-red-600', text: 'ç¼ºè²¨' },
                    'low': { class: 'text-yellow-600', text: 'åº«å­˜ä¸è¶³' },
                    'safe': { class: 'text-green-600', text: 'åº«å­˜å……è¶³' }
                };
                
                const config = statusConfig[item.status] || statusConfig.safe;
                
                // ç‚ºå…¬å…‹å–®ä½ä½¿ç”¨ç‰¹æ®Šæ ¼å¼åŒ–
                const displayStock = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    formatWeight(item.stock) : item.stock.toLocaleString();
                const displaySafetyStock = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    formatWeight(item.safetyStock) : item.safetyStock.toLocaleString();
                const stockUnit = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    getWeightUnit(item.stock) : item.unit;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${item.supplier}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.specification}</td>
                    <td class="px-4 py-3">
                        <span class="font-semibold ${config.class}">
                            ${displayStock} ${stockUnit}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">${displaySafetyStock} ${stockUnit}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">NT$ ${item.unitCost.toFixed(2)}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.class.replace('text-', 'bg-').replace('-600', '-100')} ${config.class}">
                            ${config.text}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // é‡æ–°è¼‰å…¥è³‡æ–™
        function refreshData() {
            testNotionMapping();
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæ¸¬è©¦
        document.addEventListener('DOMContentLoaded', testNotionMapping);
    </script>
</body>
</html>
