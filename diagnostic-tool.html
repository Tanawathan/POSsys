<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜ç³»çµ±è¨ºæ–·å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ”§ åº«å­˜ç³»çµ±è¨ºæ–·å·¥å…·</h1>
        
        <div class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“¡ API é€£æ¥æ¸¬è©¦</h2>
                <div id="api-test" class="text-gray-600">æ­£åœ¨æ¸¬è©¦...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“‚ JavaScript æ–‡ä»¶è¼‰å…¥ç‹€æ…‹</h2>
                <div id="js-status" class="text-gray-600">æª¢æŸ¥ä¸­...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ” å¯¦éš›è¼‰å…¥çš„è³‡æ–™ä¾†æº</h2>
                <div id="data-source" class="text-gray-600">åˆ†æä¸­...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ·ï¸ å‰3å€‹é …ç›®å°æ¯”</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-green-600">Notion API è³‡æ–™</h3>
                        <pre id="notion-data" class="bg-gray-50 p-3 text-sm overflow-auto max-h-48"></pre>
                    </div>
                    <div>
                        <h3 class="font-semibold text-blue-600">ç³»çµ±é¡¯ç¤ºè³‡æ–™</h3>
                        <pre id="system-data" class="bg-gray-50 p-3 text-sm overflow-auto max-h-48"></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button onclick="runDiagnostics()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                ğŸ”„ é‡æ–°è¨ºæ–·
            </button>
        </div>
    </div>

    <script>
        async function runDiagnostics() {
            // 1. API é€£æ¥æ¸¬è©¦
            try {
                const response = await fetch('/api/notion/databases/237fd5adc30b808cbba3c03f8f2065fd/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('api-test').innerHTML = 
                        `<span class="text-green-600">âœ… API æ­£å¸¸ - å–å¾— ${data.results.length} å€‹é …ç›®</span>`;
                    
                    // é¡¯ç¤º Notion çœŸå¯¦è³‡æ–™
                    const notionSample = data.results.slice(0, 3).map(item => ({
                        é£Ÿæåç¨±: item.properties['é£Ÿæåç¨±']?.rich_text?.[0]?.text?.content,
                        ä¾›æ‡‰å•†: item.properties['ä¾›æ‡‰å•†']?.select?.name,
                        åº«å­˜é‡: item.properties['åº«å­˜é‡']?.number,
                        è¦æ ¼: item.properties['è¦æ ¼/å–®ä½']?.rich_text?.[0]?.text?.content
                    }));
                    document.getElementById('notion-data').textContent = JSON.stringify(notionSample, null, 2);
                } else {
                    document.getElementById('api-test').innerHTML = 
                        `<span class="text-red-600">âŒ API éŒ¯èª¤ - ç‹€æ…‹ç¢¼: ${response.status}</span>`;
                }
            } catch (error) {
                document.getElementById('api-test').innerHTML = 
                    `<span class="text-red-600">âŒ é€£æ¥å¤±æ•—: ${error.message}</span>`;
            }
            
            // 2. JavaScript æ–‡ä»¶è¼‰å…¥ç‹€æ…‹
            let jsStatus = [];
            
            // æª¢æŸ¥ InventoryManager æ˜¯å¦å­˜åœ¨
            if (typeof InventoryManager !== 'undefined') {
                jsStatus.push('âœ… InventoryManager é¡åˆ¥å·²è¼‰å…¥');
            } else {
                jsStatus.push('âŒ InventoryManager é¡åˆ¥æœªè¼‰å…¥');
            }
            
            // æª¢æŸ¥é…ç½®æ–‡ä»¶
            if (typeof window.config !== 'undefined') {
                jsStatus.push('âœ… config.js å·²è¼‰å…¥');
            } else {
                jsStatus.push('âŒ config.js æœªè¼‰å…¥');
            }
            
            document.getElementById('js-status').innerHTML = jsStatus.join('<br>');
            
            // 3. æ¨¡æ“¬åº«å­˜ç®¡ç†å™¨è¼‰å…¥æ¸¬è©¦
            try {
                // æ¨¡æ“¬ InventoryManager åˆå§‹åŒ–
                if (typeof InventoryManager !== 'undefined') {
                    const testManager = new InventoryManager();
                    
                    // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ Notion è³‡æ–™
                    if (testManager.isNotionConnected) {
                        document.getElementById('data-source').innerHTML = 
                            '<span class="text-green-600">âœ… ä½¿ç”¨ Notion API è³‡æ–™</span>';
                    } else {
                        document.getElementById('data-source').innerHTML = 
                            '<span class="text-yellow-600">âš ï¸ ä½¿ç”¨æœ¬åœ°å‚™ç”¨è³‡æ–™</span>';
                    }
                    
                    // é¡¯ç¤ºç³»çµ±å¯¦éš›è³‡æ–™
                    const systemSample = testManager.inventoryData.slice(0, 3).map(item => ({
                        é£Ÿæåç¨±: item.name,
                        ä¾›æ‡‰å•†: item.supplier,
                        åº«å­˜é‡: item.stock,
                        è¦æ ¼: item.specification || item.spec
                    }));
                    document.getElementById('system-data').textContent = JSON.stringify(systemSample, null, 2);
                } else {
                    document.getElementById('data-source').innerHTML = 
                        '<span class="text-red-600">âŒ ç„¡æ³•å»ºç«‹ InventoryManager</span>';
                }
            } catch (error) {
                document.getElementById('data-source').innerHTML = 
                    `<span class="text-red-600">âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}</span>`;
                
                // é¡¯ç¤ºéŒ¯èª¤è©³æƒ…
                document.getElementById('system-data').textContent = 
                    `éŒ¯èª¤è©³æƒ…: ${error.stack || error.message}`;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œè¨ºæ–·
        document.addEventListener('DOMContentLoaded', runDiagnostics);
    </script>
    
    <!-- è¼‰å…¥ç›¸åŒçš„æ–‡ä»¶ä»¥é€²è¡Œæ¸¬è©¦ -->
    <script src="/config/config.js"></script>
    <script src="/assets/js/notion-manager.js"></script>
    <script src="/assets/js/inventory-management.js"></script>
</body>
</html>
