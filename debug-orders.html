<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®æ˜ å°„èª¿è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .debug-title { font-weight: bold; color: #2563eb; margin-bottom: 10px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; }
        .order-card { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .loading { color: #666; font-style: italic; }
        .error { color: #dc2626; }
        .success { color: #16a34a; }
    </style>
</head>
<body>
    <h1>ğŸ” è¨‚å–®æ˜ å°„èª¿è©¦å·¥å…·</h1>
    
    <div class="debug-section">
        <div class="debug-title">Notion API ç‹€æ…‹</div>
        <div id="api-status" class="loading">æª¢æŸ¥APIé€£ç·šä¸­...</div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">åŸå§‹ Notion è³‡æ–™</div>
        <pre id="raw-data">è¼‰å…¥ä¸­...</pre>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">å±¬æ€§æ˜ å°„åˆ†æ</div>
        <div id="property-analysis">åˆ†æä¸­...</div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">æ˜ å°„å¾Œçš„è¨‚å–®</div>
        <div id="mapped-orders">è™•ç†ä¸­...</div>
    </div>
    
    <script>
        const NOTION_CONFIG = {
            databaseIds: {
                orders: '23afd5adc30b80c39e71d1a640ccfb5d'
            }
        };
        
        async function debugOrderMapping() {
            const apiStatus = document.getElementById('api-status');
            const rawData = document.getElementById('raw-data');
            const propertyAnalysis = document.getElementById('property-analysis');
            const mappedOrders = document.getElementById('mapped-orders');
            
            try {
                apiStatus.innerHTML = '<span class="loading">é€£æ¥ Notion API...</span>';
                
                // æŸ¥è©¢ Notion è¨‚å–®è³‡æ–™åº«
                const response = await fetch("/.netlify/functions/notion-api/databases/' + NOTION_CONFIG.databaseIds.orders + '/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_size: 5,
                        sorts: [
                            {
                                property: 'å»ºç«‹æ™‚é–“',
                                direction: 'descending'
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIéŒ¯èª¤: ${response.status} ${response.statusText}`);
                }
                
                const notionData = await response.json();
                apiStatus.innerHTML = `<span class="success">âœ… APIé€£ç·šæˆåŠŸ - æ‰¾åˆ° ${notionData.results?.length || 0} ç­†è¨‚å–®</span>`;
                
                // é¡¯ç¤ºåŸå§‹è³‡æ–™
                rawData.textContent = JSON.stringify(notionData, null, 2);
                
                // åˆ†æå±¬æ€§
                if (notionData.results && notionData.results.length > 0) {
                    const firstOrder = notionData.results[0];
                    const properties = firstOrder.properties || {};
                    const propertyNames = Object.keys(properties);
                    
                    let analysisHTML = `
                        <div><strong>ğŸ“‹ å¯ç”¨å±¬æ€§ (${propertyNames.length} å€‹):</strong></div>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                    `;
                    
                    propertyNames.forEach(propName => {
                        const prop = properties[propName];
                        const type = prop.type;
                        let value = 'ç„¡è³‡æ–™';
                        
                        try {
                            if (prop.title && prop.title[0]) value = prop.title[0].text.content;
                            else if (prop.rich_text && prop.rich_text[0]) value = prop.rich_text[0].text.content;
                            else if (prop.select) value = prop.select.name;
                            else if (prop.number !== undefined) value = prop.number;
                            else if (prop.date) value = prop.date.start;
                            else value = JSON.stringify(prop).substring(0, 50) + '...';
                        } catch (e) {
                            value = 'è§£æéŒ¯èª¤';
                        }
                        
                        analysisHTML += `<li><strong>${propName}</strong> (${type}): ${value}</li>`;
                    });
                    
                    analysisHTML += '</ul>';
                    propertyAnalysis.innerHTML = analysisHTML;
                    
                    // æ˜ å°„è¨‚å–®
                    const mappedOrdersArray = notionData.results.map((orderRecord, index) => {
                        const props = orderRecord.properties || {};
                        
                        // ä½¿ç”¨å¼·åŒ–çš„æ˜ å°„é‚è¼¯
                        const orderNumber = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || 
                                          props['Order Number']?.title?.[0]?.text?.content ||
                                          props['Name']?.title?.[0]?.text?.content ||
                                          `è¨‚å–®-${orderRecord.id.slice(-8)}`;
                        
                        const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 
                                          props['æ¡Œè™Ÿ']?.number ||
                                          props['Table']?.rich_text?.[0]?.text?.content ||
                                          props['Table']?.number ||
                                          props['table_number']?.rich_text?.[0]?.text?.content ||
                                          props['table_number']?.number ||
                                          props['æ¡Œä½']?.select?.name ||
                                          'æœªçŸ¥æ¡Œè™Ÿ';
                        
                        const status = props['ç‹€æ…‹']?.select?.name || 
                                     props['Status']?.select?.name ||
                                     props['status']?.select?.name ||
                                     'æœªçŸ¥ç‹€æ…‹';
                        
                        const totalAmount = props['ç¸½é‡‘é¡']?.number || 
                                          props['Total']?.number ||
                                          props['total_amount']?.number ||
                                          props['ç¸½è¨ˆ']?.number ||
                                          0;
                        
                        const items = props['è¨‚å–®é …ç›®']?.rich_text?.[0]?.text?.content ||
                                    props['Items']?.rich_text?.[0]?.text?.content ||
                                    props['items']?.rich_text?.[0]?.text?.content ||
                                    props['èœå“']?.rich_text?.[0]?.text?.content ||
                                    '';
                        
                        const createTime = props['å»ºç«‹æ™‚é–“']?.date?.start ||
                                         props['Create Time']?.date?.start ||
                                         props['created_time']?.date?.start ||
                                         props['Date']?.date?.start ||
                                         orderRecord.created_time ||
                                         '';
                        
                        return {
                            index: index + 1,
                            id: orderRecord.id,
                            orderNumber: orderNumber,
                            tableNumber: tableNumber,
                            status: status,
                            totalAmount: totalAmount,
                            items: items,
                            createTime: createTime,
                            mappingSuccess: orderNumber !== `è¨‚å–®-${orderRecord.id.slice(-8)}` && 
                                          tableNumber !== 'æœªçŸ¥æ¡Œè™Ÿ' && 
                                          status !== 'æœªçŸ¥ç‹€æ…‹'
                        };
                    });
                    
                    // é¡¯ç¤ºæ˜ å°„çµæœ
                    let ordersHTML = `<div><strong>ğŸ“Š æ˜ å°„çµæœ (${mappedOrdersArray.length} ç­†):</strong></div>`;
                    
                    mappedOrdersArray.forEach(order => {
                        const statusClass = order.mappingSuccess ? 'success' : 'error';
                        const statusIcon = order.mappingSuccess ? 'âœ…' : 'âŒ';
                        
                        ordersHTML += `
                            <div class="order-card">
                                <div class="${statusClass}">
                                    ${statusIcon} è¨‚å–® #${order.index} - ${order.mappingSuccess ? 'æ˜ å°„æˆåŠŸ' : 'æ˜ å°„ä¸å®Œæ•´'}
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${order.orderNumber}<br>
                                    <strong>æ¡Œè™Ÿ:</strong> ${order.tableNumber}<br>
                                    <strong>ç‹€æ…‹:</strong> ${order.status}<br>
                                    <strong>é‡‘é¡:</strong> NT$${order.totalAmount}<br>
                                    <strong>é …ç›®:</strong> ${order.items || 'ç„¡é …ç›®è³‡æ–™'}<br>
                                    <strong>æ™‚é–“:</strong> ${order.createTime || 'ç„¡æ™‚é–“è³‡æ–™'}
                                </div>
                            </div>
                        `;
                    });
                    
                    mappedOrders.innerHTML = ordersHTML;
                } else {
                    propertyAnalysis.innerHTML = '<div class="error">âŒ æ²’æœ‰æ‰¾åˆ°è¨‚å–®è³‡æ–™</div>';
                    mappedOrders.innerHTML = '<div class="error">âŒ ç„¡æ³•é€²è¡Œè¨‚å–®æ˜ å°„</div>';
                }
                
            } catch (error) {
                console.error('èª¿è©¦å¤±æ•—:', error);
                apiStatus.innerHTML = `<span class="error">âŒ APIé€£ç·šå¤±æ•—: ${error.message}</span>`;
                rawData.textContent = `éŒ¯èª¤: ${error.message}`;
                propertyAnalysis.innerHTML = '<div class="error">âŒ ç„¡æ³•åˆ†æå±¬æ€§</div>';
                mappedOrders.innerHTML = '<div class="error">âŒ æ˜ å°„å¤±æ•—</div>';
            }
        }
        
        // é é¢è¼‰å…¥æ™‚é–‹å§‹èª¿è©¦
        document.addEventListener('DOMContentLoaded', debugOrderMapping);
    </script>
</body>
</html>
