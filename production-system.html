<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠæˆå“è£½ä½œç³»çµ± - Tanawaté¤å»³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-available { color: #22c55e; }
        .status-insufficient { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        .recipe-card { transition: all 0.3s ease; }
        .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .production-log { max-height: 300px; overflow-y: auto; }
        .ingredient-item { transition: all 0.2s ease; }
        .ingredient-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-green-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-industry mr-2"></i>
                åŠæˆå“è£½ä½œç³»çµ±
            </h1>
            <div class="flex space-x-4">
                <button onclick="loadAllData()" class="bg-green-500 hover:bg-green-700 px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>é‡æ–°è¼‰å…¥
                </button>
                <button onclick="showProductionLog()" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded">
                    <i class="fas fa-history mr-2"></i>è£½ä½œè¨˜éŒ„
                </button>
                <button onclick="showInventoryStatus()" class="bg-yellow-500 hover:bg-yellow-700 px-4 py-2 rounded">
                    <i class="fas fa-warehouse mr-2"></i>åº«å­˜ç‹€æ³
                </button>
            </div>
        </div>
    </nav>

    <!-- çµ±è¨ˆé¢æ¿ -->
    <div class="container mx-auto mt-6 px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-flask text-green-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">å¯è£½ä½œåŠæˆå“</p>
                        <p class="text-2xl font-bold" id="availableRecipes">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">ææ–™ä¸è¶³</p>
                        <p class="text-2xl font-bold status-warning" id="insufficientRecipes">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-blue-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">ä»Šæ—¥è£½ä½œ</p>
                        <p class="text-2xl font-bold" id="todayProduction">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-boxes text-purple-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">ç¸½åŠæˆå“</p>
                        <p class="text-2xl font-bold" id="totalRecipes">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¯©é¸æ§åˆ¶ -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex flex-wrap gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è£½ä½œç‹€æ…‹</label>
                    <select id="statusFilter" class="border rounded px-3 py-2" onchange="filterRecipes()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="available">å¯è£½ä½œ</option>
                        <option value="insufficient">ææ–™ä¸è¶³</option>
                        <option value="partial">éƒ¨åˆ†å¯è£½ä½œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŠæˆå“é¡å‹</label>
                    <select id="categoryFilter" class="border rounded px-3 py-2" onchange="filterRecipes()">
                        <option value="">å…¨éƒ¨é¡å‹</option>
                        <option value="é†¬æ–™">é†¬æ–™</option>
                        <option value="é…èœ">é…èœ</option>
                        <option value="æ¹¯åº•">æ¹¯åº•</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœå°‹åŠæˆå“</label>
                    <input type="text" id="searchInput" placeholder="è¼¸å…¥åŠæˆå“åç¨±..." 
                           class="w-full border rounded px-3 py-2" onkeyup="filterRecipes()">
                </div>
                <div class="flex items-end">
                    <button onclick="showBatchProduction()" class="bg-indigo-500 hover:bg-indigo-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-layer-group mr-2"></i>æ‰¹é‡è£½ä½œ
                    </button>
                </div>
            </div>
        </div>

        <!-- åŠæˆå“è£½ä½œåˆ—è¡¨ -->
        <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- åŠæˆå“å¡ç‰‡å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loadingIndicator" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-green-500"></i>
            <p class="mt-2 text-gray-600">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- è£½ä½œè©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="productionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" id="modalRecipeName">è£½ä½œè©³æƒ…</h2>
                        <button onclick="closeProductionModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent">
                        <!-- è©³æƒ…å…§å®¹å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è£½ä½œç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                        <h3 class="text-lg font-bold">ç¢ºèªè£½ä½œ</h3>
                    </div>
                    <div id="confirmContent">
                        <!-- ç¢ºèªå…§å®¹å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeConfirmModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                            å–æ¶ˆ
                        </button>
                        <button onclick="executeProduction()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-play mr-2"></i>é–‹å§‹è£½ä½œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è£½ä½œé€²åº¦æ¨¡æ…‹æ¡† -->
    <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-cog fa-spin text-blue-500 text-2xl mr-3"></i>
                        <h3 class="text-lg font-bold">è£½ä½œé€²è¡Œä¸­</h3>
                    </div>
                    
                    <!-- é€²åº¦æ¢ -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">è£½ä½œé€²åº¦</span>
                            <span id="progressPercent" class="text-sm font-medium text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- ç•¶å‰æ­¥é©Ÿ -->
                    <div id="currentStep" class="text-sm text-gray-600 mb-4">
                        æº–å‚™é–‹å§‹è£½ä½œ...
                    </div>
                    
                    <!-- æ­¥é©Ÿåˆ—è¡¨ -->
                    <div class="space-y-2">
                        <div id="step1" class="flex items-center text-sm">
                            <i class="fas fa-circle text-gray-300 mr-2"></i>
                            <span>å¢åŠ åŠæˆå“åº«å­˜</span>
                        </div>
                        <div id="step2" class="flex items-center text-sm">
                            <i class="fas fa-circle text-gray-300 mr-2"></i>
                            <span>æ‰£é™¤é£Ÿæåº«å­˜</span>
                        </div>
                        <div id="step3" class="flex items-center text-sm">
                            <i class="fas fa-circle text-gray-300 mr-2"></i>
                            <span>è¨˜éŒ„è£½ä½œæ­·å²</span>
                        </div>
                        <div id="step4" class="flex items-center text-sm">
                            <i class="fas fa-circle text-gray-300 mr-2"></i>
                            <span>é‡æ–°è¼‰å…¥è³‡æ–™</span>
                        </div>
                    </div>
                    
                    <!-- è­¦å‘Šæ–‡å­— -->
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-xs text-yellow-700">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            è£½ä½œé€²è¡Œä¸­ï¼Œè«‹å‹¿é—œé–‰ç€è¦½å™¨æˆ–é‡æ–°æ•´ç†é é¢
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠæˆå“è£½ä½œç³»çµ±æ ¸å¿ƒé¡åˆ¥
        class ProductionSystem {
            constructor() {
                this.recipes = [];           // åŠæˆå“
                this.ingredients = [];       // åŠæˆå“çµ„æˆé …ç›®
                this.inventory = [];         // é£Ÿæåº«
                this.filteredRecipes = [];   // ç¯©é¸å¾Œçš„åŠæˆå“
                this.productionLog = [];     // è£½ä½œè¨˜éŒ„
                this.currentProduction = null; // ç•¶å‰è£½ä½œé …ç›®
                
                // Notion API è¨­å®š
                this.apiKey = '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';
                this.apiVersion = '2022-06-28';
                
                // è³‡æ–™åº« IDs
                this.databaseIds = {
                    inventory: '237fd5adc30b808cbba3c03f8f2065fd',        // é£Ÿæåº«
                    ingredients: '237fd5adc30b80f7aedfe94804d80218',     // åŠæˆå“çµ„æˆé …ç›®
                    recipes: '237fd5adc30b80c09b59c03cd67c6432',          // åŠæˆå“
                    productionRecords: '23bfd5adc30b81a3a8e2e8cb68a4b2bd' // è£½ä½œè¨˜éŒ„
                };
            }

            // è¼‰å…¥æ‰€æœ‰è³‡æ–™
            async loadAllData() {
                try {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    console.log('ğŸ”„ é–‹å§‹è¼‰å…¥è£½ä½œç³»çµ±è³‡æ–™...');
                    
                    // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™åº«
                    const [inventory, ingredients, recipes] = await Promise.all([
                        this.loadDatabase(this.databaseIds.inventory, 'é£Ÿæåº«'),
                        this.loadDatabase(this.databaseIds.ingredients, 'åŠæˆå“çµ„æˆé …ç›®'),
                        this.loadDatabase(this.databaseIds.recipes, 'åŠæˆå“')
                    ]);
                    
                    this.ingredientInventory = inventory;  // é£Ÿæåº«å­˜æ•¸æ“š
                    this.ingredients = ingredients;       // åŠæˆå“çµ„æˆé …ç›®
                    this.recipes = recipes;               // åŠæˆå“è³‡æ–™
                    
                    console.log('ğŸ“Š è³‡æ–™è¼‰å…¥å®Œæˆ:');
                    console.log(`  - é£Ÿæåº«: ${this.ingredientInventory.length} é …`);
                    console.log(`  - åŠæˆå“çµ„æˆ: ${this.ingredients.length} é …`);
                    console.log(`  - åŠæˆå“: ${this.recipes.length} é …`);
                    
                    // è¨ˆç®—è£½ä½œç‹€æ…‹
                    this.calculateProductionStatus();
                    
                    // é¡¯ç¤ºåŠæˆå“åˆ—è¡¨
                    this.displayRecipes();
                    this.updateStatistics();
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            // è¼‰å…¥å–®ä¸€è³‡æ–™åº«
            async loadDatabase(databaseId, name) {
                const allResults = [];
                let cursor = undefined;
                
                try {
                    do {
                        const requestBody = {
                            page_size: 100
                        };
                        
                        if (cursor) {
                            requestBody.start_cursor = cursor;
                        }
                        
                        const response = await fetch(`/api/notion/databases/${databaseId}/query`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`è¼‰å…¥ ${name} å¤±æ•—: ${response.status} - ${errorText}`);
                        }
                        
                        const data = await response.json();
                        allResults.push(...data.results);
                        cursor = data.next_cursor;
                        
                    } while (cursor);
                    
                    console.log(`âœ… ${name} è¼‰å…¥å®Œæˆ: ${allResults.length} ç­†`);
                    return allResults;
                    
                } catch (error) {
                    console.error(`âŒ è¼‰å…¥ ${name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                    throw error;
                }
            }

            // è¨ˆç®—è£½ä½œç‹€æ…‹
            calculateProductionStatus() {
                this.recipes.forEach(recipe => {
                    const recipeId = recipe.id;
                    const recipeName = this.getPropertyTitle(recipe, 'åç¨±');
                    
                    // å–å¾—æ­¤åŠæˆå“æ‰€éœ€çš„åŸæ–™
                    const requiredIngredients = this.getRecipeIngredients(recipeId);
                    
                    let canProduce = true;
                    let maxProducible = Infinity;
                    let insufficientIngredients = [];
                    
                    requiredIngredients.forEach(ingredient => {
                        const ingredientName = this.getPropertyTitle(ingredient, 'é …ç›®åç¨±');
                        const requiredAmount = this.getPropertyNumber(ingredient, 'ä½¿ç”¨æ•¸é‡(å…‹)');
                        
                        if (requiredAmount && requiredAmount > 0) {
                            const availableStock = this.getIngredientStock(ingredientName);
                            const possibleBatches = Math.floor(availableStock / requiredAmount);
                            
                            if (possibleBatches <= 0) {
                                canProduce = false;
                                insufficientIngredients.push({
                                    name: ingredientName,
                                    required: requiredAmount,
                                    available: availableStock,
                                    shortage: requiredAmount - availableStock
                                });
                            } else {
                                maxProducible = Math.min(maxProducible, possibleBatches);
                            }
                        }
                    });
                    
                    // è¨­å®šè£½ä½œç‹€æ…‹
                    recipe.productionStatus = {
                        canProduce: canProduce,
                        maxProducible: maxProducible === Infinity ? 0 : maxProducible,
                        insufficientIngredients: insufficientIngredients,
                        requiredIngredients: requiredIngredients
                    };
                });
            }

            // å–å¾—åŠæˆå“æ‰€éœ€åŸæ–™
            getRecipeIngredients(recipeId) {
                // æ¨™æº–åŒ– ID æ ¼å¼ï¼ˆç§»é™¤çŸ­æ©«ç·šé€²è¡Œæ¯”è¼ƒï¼‰
                const normalizedRecipeId = recipeId.replace(/-/g, '');
                
                return this.ingredients.filter(ingredient => {
                    const relations = this.getPropertyRelation(ingredient, 'é£Ÿè­œ/èœå–®è³‡æ–™åº«');
                    return relations.some(rel => {
                        const normalizedRelationId = rel.id.replace(/-/g, '');
                        return normalizedRelationId === normalizedRecipeId;
                    });
                });
            }

            // å–å¾—é£Ÿæåº«å­˜é‡
            getIngredientStock(ingredientName) {
                // æ¸…ç†é£Ÿæåç¨±ï¼Œç§»é™¤å‰ç¶´ï¼ˆå¦‚"é…¸è¾£æ¹¯åº•-é…¸è¾£æ¹¯å¡Š" â†’ "é…¸è¾£æ¹¯å¡Š"ï¼‰
                const cleanedName = ingredientName.includes('-') ? 
                    ingredientName.split('-').pop().trim() : 
                    ingredientName.trim();
                
                console.log(`ğŸ” æœå°‹é£Ÿæ: "${ingredientName}" -> æ¸…ç†å¾Œ: "${cleanedName}"`);
                console.log(`ğŸ“‹ é£Ÿæåº«ç¸½æ•¸: ${this.ingredientInventory?.length || 0} é …`);
                
                if (!this.ingredientInventory || this.ingredientInventory.length === 0) {
                    console.warn('âŒ é£Ÿæåº«æ•¸æ“šç‚ºç©º');
                    return 0;
                }
                
                // å…ˆåˆ—å‡ºå‰å¹¾å€‹é£Ÿæåç¨±ä¾†èª¿è©¦
                console.log('ğŸ“‹ é£Ÿæåº«å‰10é …:');
                this.ingredientInventory.slice(0, 10).forEach((item, index) => {
                    console.log(`  ${index + 1}. å®Œæ•´é …ç›®æ•¸æ“š:`, item);
                    console.log(`  ${index + 1}. Properties:`, item.properties);
                    
                    // å˜—è©¦å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
                    const possibleNameFields = ['åç¨±', 'Name', 'é£Ÿæåç¨±', 'å“é …åç¨±', 'title'];
                    const possibleStockFields = ['å¯¦éš›åº«å­˜é‡', 'åº«å­˜é‡', 'æ•¸é‡', 'Stock', 'Quantity'];
                    
                    let itemName = '';
                    let stock = 0;
                    
                    // å°‹æ‰¾åç¨±æ¬„ä½
                    for (const field of possibleNameFields) {
                        if (item.properties?.[field]) {
                            if (item.properties[field].title?.[0]?.plain_text) {
                                itemName = item.properties[field].title[0].plain_text;
                                console.log(`  æ‰¾åˆ°åç¨±æ¬„ä½ "${field}": "${itemName}"`);
                                break;
                            }
                            if (item.properties[field].rich_text?.[0]?.plain_text) {
                                itemName = item.properties[field].rich_text[0].plain_text;
                                console.log(`  æ‰¾åˆ°åç¨±æ¬„ä½ "${field}" (rich_text): "${itemName}"`);
                                break;
                            }
                        }
                    }
                    
                    // å°‹æ‰¾åº«å­˜æ¬„ä½
                    for (const field of possibleStockFields) {
                        if (item.properties?.[field]?.number !== undefined) {
                            stock = item.properties[field].number;
                            console.log(`  æ‰¾åˆ°åº«å­˜æ¬„ä½ "${field}": ${stock}g`);
                            break;
                        }
                    }
                    
                    console.log(`  ${index + 1}. è§£æçµæœ: "${itemName}" - åº«å­˜: ${stock}g`);
                });
                
                const inventoryItem = this.ingredientInventory.find(item => {
                    const itemName = item.properties?.['é£Ÿæåç¨±']?.rich_text?.[0]?.plain_text || '';
                    
                    // è©³ç´°çš„åŒ¹é…é‚è¼¯
                    const exactMatch = itemName === ingredientName;
                    const cleanMatch = itemName === cleanedName;
                    const containsMatch = itemName.includes(cleanedName);
                    const reverseMatch = cleanedName.includes(itemName);
                    const noSpaceMatch = itemName.replace(/\s+/g, '') === cleanedName.replace(/\s+/g, '');
                    
                    // ç‰¹æ®ŠåŒ¹é…ï¼šå»é™¤ç‰¹æ®Šå­—ç¬¦å¾Œæ¯”è¼ƒ
                    const normalizedItem = itemName.replace(/[^\u4e00-\u9fa5\w]/g, '').toLowerCase();
                    const normalizedSearch = cleanedName.replace(/[^\u4e00-\u9fa5\w]/g, '').toLowerCase();
                    const normalizedMatch = normalizedItem === normalizedSearch || 
                                          normalizedItem.includes(normalizedSearch) || 
                                          normalizedSearch.includes(normalizedItem);
                    
                    console.log(`ğŸ” æ¯”è¼ƒ "${itemName}" vs "${cleanedName}":`);
                    console.log(`  - å®Œå…¨åŒ¹é…: ${exactMatch}`);
                    console.log(`  - æ¸…ç†åŒ¹é…: ${cleanMatch}`);
                    console.log(`  - åŒ…å«åŒ¹é…: ${containsMatch}`);
                    console.log(`  - åå‘åŒ¹é…: ${reverseMatch}`);
                    console.log(`  - æ¨™æº–åŒ–åŒ¹é…: ${normalizedMatch} (${normalizedItem} vs ${normalizedSearch})`);
                    
                    return exactMatch || cleanMatch || containsMatch || reverseMatch || normalizedMatch;
                });
                
                if (!inventoryItem) {
                    console.warn(`âš ï¸ æ‰¾ä¸åˆ°é£Ÿæåº«å­˜: "${ingredientName}" (æ¸…ç†å¾Œ: "${cleanedName}")`);
                    return 0;
                }
                
                const itemName = inventoryItem.properties?.['é£Ÿæåç¨±']?.rich_text?.[0]?.plain_text || '';
                const stock = inventoryItem.properties?.['åº«å­˜é‡']?.number || 0;
                
                console.log(`âœ… æ‰¾åˆ°åŒ¹é…: "${ingredientName}" <-> "${itemName}"`);
                console.log(`ğŸ“¦ ${itemName} åº«å­˜: ${stock}g`);
                return stock;
            }

            // é¡¯ç¤ºåŠæˆå“åˆ—è¡¨
            displayRecipes() {
                this.filteredRecipes = [...this.recipes];
                this.renderRecipeGrid();
            }

            // æ¸²æŸ“åŠæˆå“ç¶²æ ¼
            renderRecipeGrid() {
                const grid = document.getElementById('recipeGrid');
                
                if (this.filteredRecipes.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„åŠæˆå“</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = this.filteredRecipes.map(recipe => this.createRecipeCard(recipe)).join('');
            }

            // å‰µå»ºåŠæˆå“å¡ç‰‡
            createRecipeCard(recipe) {
                const name = this.getPropertyTitle(recipe, 'åç¨±');
                const category = this.getPropertySelect(recipe, 'é¡åˆ¥') || this.getPropertySelect(recipe, 'åˆ†é¡') || 'æœªåˆ†é¡';
                const currentStock = this.getPropertyNumber(recipe, 'å¯¦éš›åº«å­˜é‡') || this.getPropertyNumber(recipe, 'å‹•æ…‹åº«å­˜é‡') || 0;
                const unit = this.getPropertyRichText(recipe, 'å–®ä½') || 'ä»½';
                const status = recipe.productionStatus;
                
                const statusConfig = this.getProductionStatusConfig(status);
                
                return `
                    <div class="recipe-card bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800">${name || 'æœªå‘½ååŠæˆå“'}</h3>
                                <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">${category}</span>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600">ç›®å‰åº«å­˜</span>
                                    <span class="font-medium">${currentStock} ${unit}</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">å¯è£½ä½œæ•¸é‡</span>
                                    <span class="font-medium ${statusConfig.color}">${status.maxProducible} ${unit}</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas ${statusConfig.icon} ${statusConfig.color} mr-2"></i>
                                    <span class="text-sm ${statusConfig.color}">${statusConfig.text}</span>
                                </div>
                                ${status.insufficientIngredients.length > 0 ? `
                                    <div class="text-xs text-red-600">
                                        ç¼ºå°‘: ${status.insufficientIngredients.slice(0, 2).map(ing => ing.name).join(', ')}
                                        ${status.insufficientIngredients.length > 2 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex justify-between space-x-2">
                                <button onclick="showProductionDetail('${recipe.id}')" 
                                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-info-circle mr-1"></i>è©³æƒ…
                                </button>
                                
                                <button onclick="startProduction('${recipe.id}')" 
                                        class="flex-1 ${status.canProduce ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'} text-white px-3 py-2 rounded text-sm"
                                        ${!status.canProduce ? 'disabled' : ''}>
                                    <i class="fas fa-play mr-1"></i>è£½ä½œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // å–å¾—è£½ä½œç‹€æ…‹é…ç½®
            getProductionStatusConfig(status) {
                if (!status.canProduce) {
                    return {
                        icon: 'fa-times-circle',
                        color: 'status-insufficient',
                        text: 'ææ–™ä¸è¶³'
                    };
                } else if (status.maxProducible <= 5) {
                    return {
                        icon: 'fa-exclamation-triangle',
                        color: 'status-warning',
                        text: 'å¯è£½ä½œé‡å°‘'
                    };
                } else {
                    return {
                        icon: 'fa-check-circle',
                        color: 'status-available',
                        text: 'å¯ä»¥è£½ä½œ'
                    };
                }
            }

            // é¡¯ç¤ºè£½ä½œè©³æƒ…
            showProductionDetail(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe) return;
                
                const name = this.getPropertyTitle(recipe, 'å“é …åç¨±') || this.getPropertyTitle(recipe, 'åç¨±');
                const status = recipe.productionStatus;
                
                document.getElementById('modalRecipeName').textContent = name || 'æœªå‘½ååŠæˆå“';
                document.getElementById('modalContent').innerHTML = this.createProductionDetailContent(recipe);
                document.getElementById('productionModal').classList.remove('hidden');
            }

            // å‰µå»ºè£½ä½œè©³æƒ…å…§å®¹
            createProductionDetailContent(recipe) {
                const name = this.getPropertyTitle(recipe, 'åç¨±');
                const category = this.getPropertySelect(recipe, 'é¡åˆ¥') || this.getPropertySelect(recipe, 'åˆ†é¡') || 'æœªåˆ†é¡';
                const currentStock = this.getPropertyNumber(recipe, 'å¯¦éš›åº«å­˜é‡') || this.getPropertyNumber(recipe, 'å‹•æ…‹åº«å­˜é‡') || 0;
                const unit = this.getPropertyRichText(recipe, 'å–®ä½') || 'ä»½';
                const status = recipe.productionStatus;
                const statusConfig = this.getProductionStatusConfig(status);
                
                let ingredientsList = '';
                if (status.requiredIngredients.length > 0) {
                    ingredientsList = status.requiredIngredients.map(ingredient => {
                        const ingName = this.getPropertyTitle(ingredient, 'é …ç›®åç¨±');
                        const requiredAmount = this.getPropertyNumber(ingredient, 'ä½¿ç”¨æ•¸é‡(å…‹)');
                        const availableStock = this.getIngredientStock(ingName);
                        const isInsufficient = availableStock < requiredAmount;
                        
                        return `
                            <tr class="border-b ingredient-item">
                                <td class="py-3 px-4">${ingName || 'æœªå‘½åé£Ÿæ'}</td>
                                <td class="py-3 px-4">${requiredAmount || 0}g</td>
                                <td class="py-3 px-4 ${isInsufficient ? 'status-insufficient' : 'status-available'}">${availableStock}g</td>
                                <td class="py-3 px-4">
                                    ${isInsufficient ? 
                                        `<span class="status-insufficient">ä¸è¶³ ${requiredAmount - availableStock}g</span>` : 
                                        `<span class="status-available">å……è¶³</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    ingredientsList = '<tr><td colspan="4" class="py-4 text-center text-gray-500">æš«ç„¡åŸæ–™è³‡æ–™</td></tr>';
                }
                
                return `
                    <div class="space-y-6">
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">åŸºæœ¬è³‡è¨Š</h3>
                                <div class="space-y-2">
                                    <p><span class="font-medium">é¡åˆ¥:</span> ${category || 'æœªåˆ†é¡'}</p>
                                    <p><span class="font-medium">ç›®å‰åº«å­˜:</span> ${currentStock} ${unit}</p>
                                    <p><span class="font-medium">å–®ä½:</span> ${unit}</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">è£½ä½œç‹€æ…‹</h3>
                                <div class="flex items-center mb-2">
                                    <i class="fas ${statusConfig.icon} ${statusConfig.color} mr-2"></i>
                                    <span class="${statusConfig.color} font-medium">${statusConfig.text}</span>
                                </div>
                                <p class="text-sm text-gray-600">æœ€å¤šå¯è£½ä½œ: ${status.maxProducible} ${unit}</p>
                            </div>
                        </div>
                        
                        <!-- æ‰€éœ€åŸæ–™ -->
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">æ‰€éœ€åŸæ–™</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-200 py-2 px-4 text-left">åŸæ–™åç¨±</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">éœ€è¦æ•¸é‡</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">ç¾æœ‰åº«å­˜</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">ç‹€æ…‹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ingredientsList}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- è£½ä½œé¸é … -->
                        ${status.canProduce ? `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-700 mb-2">è£½ä½œé¸é …</h3>
                                <div class="flex items-center space-x-4">
                                    <label class="text-sm font-medium text-gray-700">è£½ä½œæ•¸é‡:</label>
                                    <input type="number" id="productionQuantity" min="1" max="${status.maxProducible}" value="1" 
                                           class="border rounded px-3 py-1 w-20">
                                    <span class="text-sm text-gray-600">${unit} (æœ€å¤š ${status.maxProducible})</span>
                                    <button onclick="confirmProduction('${recipe.id}')" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                                        <i class="fas fa-play mr-2"></i>é–‹å§‹è£½ä½œ
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-red-700 mb-2">ç„¡æ³•è£½ä½œ</h3>
                                <p class="text-sm text-red-600">è«‹è£œå……ä»¥ä¸‹åŸæ–™:</p>
                                <ul class="list-disc list-inside text-sm text-red-600 mt-2">
                                    ${status.insufficientIngredients.map(ing => 
                                        `<li>${ing.name}: ç¼ºå°‘ ${ing.shortage}g</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `}
                    </div>
                `;
            }

            // é–‹å§‹è£½ä½œæµç¨‹
            startProduction(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe || !recipe.productionStatus.canProduce) return;
                
                this.showProductionDetail(recipeId);
            }

            // ç¢ºèªè£½ä½œ
            confirmProduction(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe) return;
                
                const quantity = parseInt(document.getElementById('productionQuantity').value) || 1;
                const maxProducible = recipe.productionStatus.maxProducible;
                
                if (quantity > maxProducible) {
                    alert(`è£½ä½œæ•¸é‡ä¸èƒ½è¶…é ${maxProducible}`);
                    return;
                }
                
                this.currentProduction = {
                    recipe: recipe,
                    quantity: quantity
                };
                
                const name = this.getPropertyTitle(recipe, 'å“é …åç¨±') || this.getPropertyTitle(recipe, 'åç¨±');
                const unit = this.getPropertyRichText(recipe, 'å–®ä½') || 'ä»½';
                
                document.getElementById('confirmContent').innerHTML = `
                    <p class="mb-4">ç¢ºå®šè¦è£½ä½œä»¥ä¸‹åŠæˆå“å—ï¼Ÿ</p>
                    <div class="bg-gray-50 p-4 rounded">
                        <p><strong>åŠæˆå“:</strong> ${name}</p>
                        <p><strong>è£½ä½œæ•¸é‡:</strong> ${quantity} ${unit}</p>
                        <p class="text-sm text-gray-600 mt-2">æ­¤æ“ä½œå°‡ï¼š</p>
                        <ul class="text-sm text-gray-600 list-disc list-inside">
                            <li>å¢åŠ åŠæˆå“åº«å­˜ ${quantity} ${unit}</li>
                            <li>æ‰£é™¤ç›¸æ‡‰çš„åŸæ–™åº«å­˜</li>
                            <li>è¨˜éŒ„è£½ä½œæ­·å²</li>
                        </ul>
                    </div>
                `;
                
                document.getElementById('productionModal').classList.add('hidden');
                document.getElementById('confirmModal').classList.remove('hidden');
            }

            // åŸ·è¡Œè£½ä½œï¼ˆå®Œæ•´çš„è£½ä½œæµç¨‹ï¼‰
            async executeProduction() {
                if (!this.currentProduction) return;
                
                // ç¦ç”¨åŸ·è¡ŒæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
                const executeButton = document.querySelector('button[onclick="executeProduction()"]');
                if (executeButton) {
                    executeButton.disabled = true;
                    executeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è™•ç†ä¸­...';
                    executeButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                // é—œé–‰ç¢ºèªæ¨¡æ…‹æ¡†ï¼Œé¡¯ç¤ºé€²åº¦æ¨¡æ…‹æ¡†
                this.closeConfirmModal();
                this.showProgressModal();
                
                try {
                    const { recipe, quantity } = this.currentProduction;
                    const name = this.getPropertyTitle(recipe, 'å“é …åç¨±') || this.getPropertyTitle(recipe, 'åç¨±');
                    
                    console.log(`ğŸ”„ é–‹å§‹è£½ä½œæµç¨‹: ${name} x${quantity}`);
                    
                    // 1. æ›´æ–°åŠæˆå“åº«å­˜ (åœ¨åŠæˆå“è³‡æ–™åº«ï¼š237fd5adc30b80c09b59c03cd67c6432 å¢åŠ å¯¦éš›åº«å­˜é‡)
                    this.updateProgress(1, 'å¢åŠ åŠæˆå“åº«å­˜ä¸­...', 25);
                    await this.updateRecipeStock(recipe, quantity);
                    
                    // 2. æ‰£é™¤åŸæ–™åº«å­˜ (å¾é£Ÿæåº«ï¼š237fd5adc30b808cbba3c03f8f2065fd æ‰£é™¤é£Ÿæåº«å­˜)
                    this.updateProgress(2, 'æ‰£é™¤é£Ÿæåº«å­˜ä¸­...', 50);
                    await this.deductIngredientStock(recipe, quantity);
                    
                    // 3. è¨˜éŒ„è£½ä½œæ­·å²
                    this.updateProgress(3, 'è¨˜éŒ„è£½ä½œæ­·å²ä¸­...', 75);
                    await this.logProduction(recipe, quantity);
                    
                    // 4. é‡æ–°è¼‰å…¥è³‡æ–™
                    this.updateProgress(4, 'é‡æ–°è¼‰å…¥è³‡æ–™ä¸­...', 90);
                    await this.loadAllData();
                    
                    // å®Œæˆ
                    this.updateProgress(0, 'è£½ä½œå®Œæˆï¼', 100);
                    
                    console.log(`âœ… è£½ä½œæµç¨‹å®Œæˆï¼`);
                    
                    // å»¶é²ä¸€ç§’å¾Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦é—œé–‰é€²åº¦æ¢
                    setTimeout(() => {
                        this.hideProgressModal();
                        alert(`âœ… è£½ä½œå®Œæˆï¼${name} +${quantity}\n\nâœ“ åŠæˆå“åº«å­˜å·²å¢åŠ \nâœ“ é£Ÿæåº«å­˜å·²æ‰£é™¤\nâœ“ è£½ä½œè¨˜éŒ„å·²ä¿å­˜`);
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ è£½ä½œå¤±æ•—:', error);
                    this.hideProgressModal();
                    alert(`è£½ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}\n\nè«‹æª¢æŸ¥:\nâ€¢ ç¶²è·¯é€£ç·š\nâ€¢ è³‡æ–™åº«æ¬Šé™\nâ€¢ åº«å­˜æ•¸é‡æ˜¯å¦è¶³å¤ `);
                } finally {
                    // æ¢å¾©åŸ·è¡ŒæŒ‰éˆ•
                    if (executeButton) {
                        executeButton.disabled = false;
                        executeButton.innerHTML = '<i class="fas fa-play mr-2"></i>é–‹å§‹è£½ä½œ';
                        executeButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    this.currentProduction = null;
                }
            }

            // æ›´æ–°åŠæˆå“åº«å­˜ï¼ˆåœ¨åŠæˆå“è³‡æ–™åº«ï¼š237fd5adc30b80c09b59c03cd67c6432 å¢åŠ å¯¦éš›åº«å­˜é‡ï¼‰
            async updateRecipeStock(recipe, quantity) {
                const recipeName = this.getPropertyTitle(recipe, 'å“é …åç¨±') || this.getPropertyTitle(recipe, 'åç¨±');
                const currentStock = this.getPropertyNumber(recipe, 'å¯¦éš›åº«å­˜é‡') || this.getPropertyNumber(recipe, 'å‹•æ…‹åº«å­˜é‡') || 0;
                const newStock = currentStock + quantity;
                
                console.log(`ğŸ”„ æ›´æ–°åŠæˆå“åº«å­˜: ${recipeName}`);
                console.log(`ğŸ“Š åº«å­˜è®ŠåŒ–: ${currentStock} â†’ ${newStock} (å¢åŠ : ${quantity})`);
                
                const updateData = {
                    properties: {
                        'å¯¦éš›åº«å­˜é‡': {
                            number: newStock
                        }
                    }
                };
                
                const response = await fetch(`/api/notion/pages/${recipe.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error(`âŒ æ›´æ–°åŠæˆå“åº«å­˜å¤±æ•—: ${response.status}`, errorDetails);
                    throw new Error(`æ›´æ–°åŠæˆå“åº«å­˜å¤±æ•—: ${response.status} - ${errorDetails}`);
                }
                
                console.log(`âœ… åŠæˆå“åº«å­˜æ›´æ–°æˆåŠŸ: ${recipeName} ${currentStock} â†’ ${newStock}`);
            }

            // æ‰£é™¤åŸæ–™åº«å­˜ï¼ˆå¾é£Ÿæåº«ï¼š237fd5adc30b808cbba3c03f8f2065fdï¼‰
            async deductIngredientStock(recipe, quantity) {
                const requiredIngredients = recipe.productionStatus.requiredIngredients;
                
                console.log(`ğŸ”„ é–‹å§‹æ‰£é™¤é£Ÿæåº«å­˜ï¼Œè£½ä½œæ•¸é‡: ${quantity}`);
                console.log(`ğŸ“‹ æ‰€éœ€åŸæ–™æ¸…å–®:`, requiredIngredients.map(ing => ({
                    name: this.getPropertyTitle(ing, 'é …ç›®åç¨±'),
                    amount: this.getPropertyNumber(ing, 'ä½¿ç”¨æ•¸é‡(å…‹)')
                })));
                
                for (const ingredient of requiredIngredients) {
                    const ingredientName = this.getPropertyTitle(ingredient, 'é …ç›®åç¨±');
                    const requiredAmount = this.getPropertyNumber(ingredient, 'ä½¿ç”¨æ•¸é‡(å…‹)');
                    const totalDeduction = requiredAmount * quantity;
                    
                    console.log(`ğŸ” è™•ç†é£Ÿæ: ${ingredientName}, å–®æ¬¡ç”¨é‡: ${requiredAmount}g, ç¸½æ‰£é™¤: ${totalDeduction}g`);
                    
                    // å¾é£Ÿæåº«ï¼ˆingredientInventoryï¼‰ä¸­å°‹æ‰¾å°æ‡‰çš„é£Ÿæ
                    const inventoryItem = this.ingredientInventory.find(item => {
                        const itemName = this.getPropertyRichText(item, 'é£Ÿæåç¨±') || 
                                        this.getPropertyTitle(item, 'å“é …åç¨±') || 
                                        this.getPropertyTitle(item, 'åç¨±');
                        
                        // å¤šç¨®åŒ¹é…æ–¹å¼
                        const exactMatch = itemName === ingredientName;
                        const containsMatch = itemName.includes(ingredientName) || ingredientName.includes(itemName);
                        const cleanMatch = itemName.replace(/\s+/g, '') === ingredientName.replace(/\s+/g, '');
                        
                        console.log(`ğŸ” æ¯”è¼ƒé£Ÿæ: "${itemName}" vs "${ingredientName}"`);
                        console.log(`  - å®Œå…¨åŒ¹é…: ${exactMatch}`);
                        console.log(`  - åŒ…å«åŒ¹é…: ${containsMatch}`);
                        console.log(`  - æ¸…ç†åŒ¹é…: ${cleanMatch}`);
                        
                        return exactMatch || containsMatch || cleanMatch;
                    });
                    
                    if (inventoryItem) {
                        const currentStock = this.getPropertyNumber(inventoryItem, 'åº«å­˜é‡') || 0;
                        const newStock = Math.max(0, currentStock - totalDeduction);
                        
                        console.log(`ğŸ“¦ æ‰¾åˆ°é£Ÿæ: ${ingredientName}`);
                        console.log(`ğŸ“Š åº«å­˜è®ŠåŒ–: ${currentStock}g â†’ ${newStock}g (æ‰£é™¤: ${totalDeduction}g)`);
                        
                        const updateData = {
                            properties: {
                                'åº«å­˜é‡': {
                                    number: newStock
                                }
                            }
                        };
                        
                        const response = await fetch(`/api/notion/pages/${inventoryItem.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (!response.ok) {
                            const errorDetails = await response.text();
                            console.error(`âŒ æ›´æ–°é£Ÿæåº«å­˜å¤±æ•—: ${response.status}`, errorDetails);
                            throw new Error(`æ›´æ–°é£Ÿæåº«å­˜å¤±æ•—: ${response.status} - ${errorDetails}`);
                        }
                        
                        console.log(`âœ… é£Ÿæåº«å­˜æ›´æ–°æˆåŠŸ ${ingredientName}: ${currentStock}g â†’ ${newStock}g`);
                    } else {
                        console.warn(`âš ï¸ æ‰¾ä¸åˆ°é£Ÿæåº«å­˜é …ç›®: ${ingredientName}`);
                        console.log(`ğŸ“‹ é£Ÿæåº«ä¸­çš„æ‰€æœ‰é …ç›®:`, this.ingredientInventory.map(item => ({
                            name: this.getPropertyRichText(item, 'é£Ÿæåç¨±') || this.getPropertyTitle(item, 'åç¨±'),
                            id: item.id
                        })));
                    }
                }
            }

            // è¨˜éŒ„è£½ä½œæ­·å²
            async logProduction(recipe, quantity) {
                const name = this.getPropertyTitle(recipe, 'åç¨±');
                const unit = this.getPropertyRichText(recipe, 'å–®ä½') || 'ä»½';
                const now = new Date();
                
                // 1. æœ¬åœ°è¨˜éŒ„ (ç”¨æ–¼å¿«é€Ÿé¡¯ç¤º)
                this.productionLog.unshift({
                    timestamp: now,
                    recipeName: name,
                    quantity: quantity,
                    unit: unit,
                    id: recipe.id
                });
                
                // ä¿ç•™æœ€è¿‘100ç­†è¨˜éŒ„
                if (this.productionLog.length > 100) {
                    this.productionLog = this.productionLog.slice(0, 100);
                }
                
                // 2. ä¿å­˜åˆ° Notion è£½ä½œè¨˜éŒ„è³‡æ–™åº«
                try {
                    await this.saveProductionRecord(recipe, quantity, now);
                } catch (error) {
                    console.warn('âš ï¸ è£½ä½œè¨˜éŒ„ä¿å­˜å¤±æ•—:', error);
                }
            }

            // ä¿å­˜è£½ä½œè¨˜éŒ„åˆ° Notion
            async saveProductionRecord(recipe, quantity, timestamp) {
                const name = this.getPropertyTitle(recipe, 'åç¨±');
                const recordId = `PR-${timestamp.getFullYear()}${String(timestamp.getMonth() + 1).padStart(2, '0')}${String(timestamp.getDate()).padStart(2, '0')}-${String(timestamp.getHours()).padStart(2, '0')}${String(timestamp.getMinutes()).padStart(2, '0')}`;
                
                const recordData = {
                    parent: {
                        database_id: this.databaseIds.productionRecords
                    },
                    properties: {
                        'è£½ä½œè¨˜éŒ„ID': {
                            title: [
                                {
                                    text: {
                                        content: recordId
                                    }
                                }
                            ]
                        },
                        'è£½ä½œæ—¥æœŸ': {
                            date: {
                                start: timestamp.toISOString()
                            }
                        },
                        'åŠæˆå“åç¨±': {
                            relation: [
                                {
                                    id: recipe.id
                                }
                            ]
                        },
                        'è£½ä½œæ•¸é‡': {
                            number: quantity
                        },
                        'è£½ä½œç‹€æ…‹': {
                            select: {
                                name: 'å·²å®Œæˆ'
                            }
                        },
                        'å®Œæˆæ™‚é–“': {
                            date: {
                                start: timestamp.toISOString()
                            }
                        },
                        'è£½ä½œå‚™è¨»': {
                            rich_text: [
                                {
                                    text: {
                                        content: `è‡ªå‹•è£½ä½œè¨˜éŒ„ - ${name} ${quantity}ä»½`
                                    }
                                }
                            ]
                        }
                    }
                };

                const response = await fetch('/api/notion/pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`ä¿å­˜è£½ä½œè¨˜éŒ„å¤±æ•—: ${error.message || response.status}`);
                }

                const result = await response.json();
                console.log(`âœ… è£½ä½œè¨˜éŒ„å·²ä¿å­˜: ${recordId}`);
                return result;
            }

            // ç¯©é¸åŠæˆå“
            filterRecipes() {
                const statusFilter = document.getElementById('statusFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                this.filteredRecipes = this.recipes.filter(recipe => {
                    const name = this.getPropertyTitle(recipe, 'åç¨±');
                    const category = this.getPropertySelect(recipe, 'é¡åˆ¥') || this.getPropertySelect(recipe, 'åˆ†é¡');
                    const status = recipe.productionStatus;
                    
                    // ç‹€æ…‹ç¯©é¸
                    let statusMatch = true;
                    if (statusFilter === 'available') {
                        statusMatch = status.canProduce && status.maxProducible > 5;
                    } else if (statusFilter === 'insufficient') {
                        statusMatch = !status.canProduce;
                    } else if (statusFilter === 'partial') {
                        statusMatch = status.canProduce && status.maxProducible <= 5;
                    }
                    
                    return statusMatch &&
                           (!categoryFilter || category === categoryFilter) &&
                           (!searchTerm || name.toLowerCase().includes(searchTerm));
                });
                
                this.renderRecipeGrid();
                this.updateStatistics();
            }

            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            updateStatistics() {
                const available = this.filteredRecipes.filter(r => r.productionStatus.canProduce && r.productionStatus.maxProducible > 5).length;
                const insufficient = this.filteredRecipes.filter(r => !r.productionStatus.canProduce).length;
                const today = this.productionLog.filter(log => {
                    const today = new Date();
                    const logDate = new Date(log.timestamp);
                    return logDate.toDateString() === today.toDateString();
                }).length;
                
                document.getElementById('availableRecipes').textContent = available;
                document.getElementById('insufficientRecipes').textContent = insufficient;
                document.getElementById('todayProduction').textContent = today;
                document.getElementById('totalRecipes').textContent = this.filteredRecipes.length;
            }

            // é¡¯ç¤ºè£½ä½œè¨˜éŒ„
            async showProductionLog() {
                try {
                    // é¡¯ç¤ºè¼‰å…¥ä¸­
                    document.getElementById('modalRecipeName').textContent = 'è£½ä½œè¨˜éŒ„';
                    document.getElementById('modalContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500">è¼‰å…¥è£½ä½œè¨˜éŒ„ä¸­...</p>
                        </div>
                    `;
                    document.getElementById('productionModal').classList.remove('hidden');

                    // å¾ Notion è¼‰å…¥è£½ä½œè¨˜éŒ„
                    const records = await this.loadProductionRecords();
                    
                    const logContent = records.length > 0 ? 
                        records.map(record => {
                            const recordId = record.properties?.['è£½ä½œè¨˜éŒ„ID']?.title?.[0]?.plain_text || 'N/A';
                            const productionDate = record.properties?.['è£½ä½œæ—¥æœŸ']?.date?.start || '';
                            const quantity = record.properties?.['è£½ä½œæ•¸é‡']?.number || 0;
                            const status = record.properties?.['è£½ä½œç‹€æ…‹']?.select?.name || 'æœªçŸ¥';
                            const completionTime = record.properties?.['å®Œæˆæ™‚é–“']?.date?.start || '';
                            const notes = record.properties?.['è£½ä½œå‚™è¨»']?.rich_text?.[0]?.plain_text || '';
                            
                            // ç²å–é—œè¯çš„åŠæˆå“åç¨±
                            const relatedRecipe = record.properties?.['åŠæˆå“åç¨±']?.relation?.[0];
                            let recipeName = 'æœªçŸ¥åŠæˆå“';
                            if (relatedRecipe) {
                                const recipe = this.recipes.find(r => r.id === relatedRecipe.id);
                                if (recipe) {
                                    recipeName = this.getPropertyTitle(recipe, 'åç¨±') || 'æœªçŸ¥åŠæˆå“';
                                }
                            }
                            
                            const statusColor = status === 'å·²å®Œæˆ' ? 'text-green-600' : 
                                              status === 'è£½ä½œä¸­' ? 'text-orange-600' : 
                                              status === 'æº–å‚™ä¸­' ? 'text-blue-600' : 'text-gray-600';
                            
                            return `
                                <div class="border-b border-gray-200 py-3" id="record-${record.id}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="font-medium text-lg">${recipeName}</span>
                                            <span class="ml-2 text-sm text-gray-500">${recordId}</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm ${statusColor} font-medium" id="status-${record.id}">${status}</span>
                                            <button onclick="editRecordStatus('${record.id}', '${status}')" 
                                                    class="text-blue-500 hover:text-blue-700 text-xs">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                        <div>
                                            <i class="fas fa-calendar mr-1"></i>
                                            è£½ä½œæ™‚é–“: ${new Date(productionDate).toLocaleString()}
                                        </div>
                                        <div>
                                            <i class="fas fa-calculator mr-1"></i>
                                            æ•¸é‡: ${quantity} ä»½
                                        </div>
                                        ${completionTime ? `
                                            <div>
                                                <i class="fas fa-check mr-1"></i>
                                                å®Œæˆæ™‚é–“: ${new Date(completionTime).toLocaleString()}
                                            </div>
                                        ` : ''}
                                        ${notes ? `
                                            <div class="col-span-2">
                                                <i class="fas fa-sticky-note mr-1"></i>
                                                å‚™è¨»: ${notes}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- ç‹€æ…‹ç·¨è¼¯å€åŸŸï¼ˆé è¨­éš±è—ï¼‰ -->
                                    <div id="edit-${record.id}" class="mt-3 p-3 bg-gray-50 rounded-lg hidden">
                                        <div class="flex items-center space-x-3">
                                            <label class="text-sm font-medium text-gray-700">ç‹€æ…‹:</label>
                                            <select id="status-select-${record.id}" class="border rounded px-2 py-1 text-sm">
                                                <option value="æº–å‚™ä¸­" ${status === 'æº–å‚™ä¸­' ? 'selected' : ''}>æº–å‚™ä¸­</option>
                                                <option value="è£½ä½œä¸­" ${status === 'è£½ä½œä¸­' ? 'selected' : ''}>è£½ä½œä¸­</option>
                                                <option value="å·²å®Œæˆ" ${status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                                                <option value="æš«åœ" ${status === 'æš«åœ' ? 'selected' : ''}>æš«åœ</option>
                                                <option value="å–æ¶ˆ" ${status === 'å–æ¶ˆ' ? 'selected' : ''}>å–æ¶ˆ</option>
                                            </select>
                                            <button onclick="saveRecordStatus('${record.id}')" 
                                                    class="bg-green-500 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                                                <i class="fas fa-save mr-1"></i>å„²å­˜
                                            </button>
                                            <button onclick="cancelEditStatus('${record.id}')" 
                                                    class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs">
                                                <i class="fas fa-times mr-1"></i>å–æ¶ˆ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : 
                        '<p class="text-gray-500 text-center py-8">æš«ç„¡è£½ä½œè¨˜éŒ„</p>';
                    
                    // æ›´æ–°å…§å®¹
                    document.getElementById('modalContent').innerHTML = `
                        <div class="mb-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold">æœ€è¿‘è£½ä½œè¨˜éŒ„</h3>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-500">å…± ${records.length} ç­†è¨˜éŒ„</span>
                                    <button onclick="refreshProductionLog()" 
                                            class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                        <i class="fas fa-sync-alt mr-1"></i>é‡æ–°æ•´ç†
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    é»æ“Šè£½ä½œè¨˜éŒ„å³å´çš„ç·¨è¼¯æŒ‰éˆ• <i class="fas fa-edit text-blue-500"></i> å¯ä»¥ä¿®æ”¹ç‹€æ…‹
                                </p>
                            </div>
                        </div>
                        <div class="production-log max-h-96 overflow-y-auto">
                            ${logContent}
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è£½ä½œè¨˜éŒ„å¤±æ•—:', error);
                    document.getElementById('modalContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-400 mb-4"></i>
                            <p class="text-red-500">è¼‰å…¥è£½ä½œè¨˜éŒ„å¤±æ•—</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        </div>
                    `;
                }
            }

            // è¼‰å…¥è£½ä½œè¨˜éŒ„
            async loadProductionRecords(limit = 20) {
                try {
                    // ä½¿ç”¨åŸºæœ¬çš„ Notion API ç›´æ¥æŸ¥è©¢
                    const queryData = {
                        sorts: [
                            {
                                property: 'è£½ä½œæ—¥æœŸ',
                                direction: 'descending'
                            }
                        ],
                        page_size: limit
                    };

                    const response = await fetch('/api/notion/pages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            parent: { database_id: this.databaseIds.productionRecords },
                            ...queryData
                        })
                    });

                    if (!response.ok) {
                        // å˜—è©¦æ›¿ä»£æ–¹æ³•
                        console.log('ğŸ”„ å˜—è©¦æ›¿ä»£æŸ¥è©¢æ–¹æ³•...');
                        const altResponse = await this.loadDatabase(this.databaseIds.productionRecords, 'è£½ä½œè¨˜éŒ„');
                        return altResponse || [];
                    }

                    const data = await response.json();
                    return data.results || [];
                    
                } catch (error) {
                    console.warn('âš ï¸ ä¸»è¦æŸ¥è©¢æ–¹æ³•å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ³•:', error);
                    try {
                        // å‚™ç”¨æ–¹æ³•ï¼šä½¿ç”¨ç¾æœ‰çš„ loadDatabase æ–¹æ³•
                        const records = await this.loadDatabase(this.databaseIds.productionRecords, 'è£½ä½œè¨˜éŒ„');
                        return records || [];
                    } catch (backupError) {
                        console.error('âŒ å‚™ç”¨æŸ¥è©¢æ–¹æ³•ä¹Ÿå¤±æ•—:', backupError);
                        return [];
                    }
                }
            }

            // é¡¯ç¤ºåº«å­˜ç‹€æ³
            showInventoryStatus() {
                const lowStockItems = this.inventory.filter(item => {
                    const stock = this.getPropertyNumber(item, 'åº«å­˜é‡') || 0;
                    const safeStock = this.getPropertyNumber(item, 'å®‰å…¨åº«å­˜é‡') || 10;
                    return stock <= safeStock;
                });
                
                const statusContent = lowStockItems.length > 0 ?
                    lowStockItems.map(item => {
                        const name = this.getPropertyTitle(item, 'å“é …åç¨±') || this.getPropertyTitle(item, 'åç¨±');
                        const stock = this.getPropertyNumber(item, 'åº«å­˜é‡') || 0;
                        const safeStock = this.getPropertyNumber(item, 'å®‰å…¨åº«å­˜é‡') || 10;
                        
                        return `
                            <div class="border-b border-gray-200 py-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${name}</span>
                                    <span class="text-sm ${stock <= 0 ? 'status-insufficient' : 'status-warning'}">
                                        ${stock}g / ${safeStock}g
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('') :
                    '<p class="text-green-600 text-center py-4">æ‰€æœ‰é£Ÿæåº«å­˜å……è¶³</p>';
                
                document.getElementById('modalRecipeName').textContent = 'åº«å­˜è­¦ç¤º';
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <p class="text-gray-600">ä»¥ä¸‹é£Ÿæåº«å­˜ä¸è¶³æˆ–æ¥è¿‘å®‰å…¨åº«å­˜é‡ï¼š</p>
                        <div>${statusContent}</div>
                    </div>
                `;
                document.getElementById('productionModal').classList.remove('hidden');
            }

            // æ‰¹é‡è£½ä½œ
            showBatchProduction() {
                const availableRecipes = this.recipes.filter(r => r.productionStatus.canProduce);
                
                if (availableRecipes.length === 0) {
                    alert('ç›®å‰æ²’æœ‰å¯è£½ä½œçš„åŠæˆå“');
                    return;
                }
                
                const batchContent = availableRecipes.map(recipe => {
                    const name = this.getPropertyTitle(recipe, 'å“é …åç¨±') || this.getPropertyTitle(recipe, 'åç¨±');
                    const maxProducible = recipe.productionStatus.maxProducible;
                    const unit = this.getPropertyRichText(recipe, 'å–®ä½') || 'ä»½';
                    
                    return `
                        <div class="border border-gray-200 rounded p-3 mb-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${name}</span>
                                <div class="flex items-center space-x-2">
                                    <input type="number" min="0" max="${maxProducible}" value="0" 
                                           class="w-16 border rounded px-2 py-1 text-sm" 
                                           id="batch_${recipe.id}">
                                    <span class="text-sm text-gray-500">${unit} (æœ€å¤š ${maxProducible})</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('modalRecipeName').textContent = 'æ‰¹é‡è£½ä½œ';
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <p class="text-gray-600">é¸æ“‡è¦æ‰¹é‡è£½ä½œçš„åŠæˆå“åŠæ•¸é‡ï¼š</p>
                        <div>${batchContent}</div>
                        <button onclick="executeBatchProduction()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded">
                            <i class="fas fa-play mr-2"></i>é–‹å§‹æ‰¹é‡è£½ä½œ
                        </button>
                    </div>
                `;
                document.getElementById('productionModal').classList.remove('hidden');
            }

            // åŸ·è¡Œæ‰¹é‡è£½ä½œ
            async executeBatchProduction() {
                const availableRecipes = this.recipes.filter(r => r.productionStatus.canProduce);
                const batchJobs = [];
                
                for (const recipe of availableRecipes) {
                    const quantityInput = document.getElementById(`batch_${recipe.id}`);
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    if (quantity > 0) {
                        batchJobs.push({ recipe, quantity });
                    }
                }
                
                if (batchJobs.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è¦è£½ä½œçš„åŠæˆå“');
                    return;
                }
                
                try {
                    document.getElementById('productionModal').classList.add('hidden');
                    
                    for (const job of batchJobs) {
                        this.currentProduction = job;
                        await this.executeProduction();
                    }
                    
                    alert(`âœ… æ‰¹é‡è£½ä½œå®Œæˆï¼å…±è£½ä½œ ${batchJobs.length} é …åŠæˆå“`);
                    
                } catch (error) {
                    console.error('âŒ æ‰¹é‡è£½ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡è£½ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥çµæœ');
                }
            }

            // é—œé–‰æ¨¡æ…‹æ¡†
            closeProductionModal() {
                document.getElementById('productionModal').classList.add('hidden');
            }

            closeConfirmModal() {
                document.getElementById('confirmModal').classList.add('hidden');
            }

            // é¡¯ç¤ºé€²åº¦æ¨¡æ…‹æ¡†
            showProgressModal() {
                // é‡è¨­é€²åº¦æ¢
                this.updateProgress(0, 'æº–å‚™é–‹å§‹è£½ä½œ...', 0);
                document.getElementById('progressModal').classList.remove('hidden');
            }

            // éš±è—é€²åº¦æ¨¡æ…‹æ¡†
            hideProgressModal() {
                document.getElementById('progressModal').classList.add('hidden');
            }

            // æ›´æ–°é€²åº¦
            updateProgress(stepNumber, message, percentage) {
                // æ›´æ–°é€²åº¦æ¢
                document.getElementById('progressBar').style.width = `${percentage}%`;
                document.getElementById('progressPercent').textContent = `${percentage}%`;
                
                // æ›´æ–°ç•¶å‰æ­¥é©Ÿè¨Šæ¯
                document.getElementById('currentStep').textContent = message;
                
                // é‡è¨­æ‰€æœ‰æ­¥é©Ÿåœ–ç¤º
                for (let i = 1; i <= 4; i++) {
                    const stepElement = document.getElementById(`step${i}`);
                    const icon = stepElement.querySelector('i');
                    const text = stepElement.querySelector('span');
                    
                    if (i < stepNumber) {
                        // å·²å®Œæˆçš„æ­¥é©Ÿ
                        icon.className = 'fas fa-check-circle text-green-500 mr-2';
                        text.classList.add('text-green-600');
                    } else if (i === stepNumber) {
                        // é€²è¡Œä¸­çš„æ­¥é©Ÿ
                        icon.className = 'fas fa-spinner fa-spin text-blue-500 mr-2';
                        text.classList.remove('text-green-600');
                        text.classList.add('text-blue-600');
                    } else {
                        // å°šæœªé–‹å§‹çš„æ­¥é©Ÿ
                        icon.className = 'fas fa-circle text-gray-300 mr-2';
                        text.classList.remove('text-green-600', 'text-blue-600');
                    }
                }
                
                // å¦‚æœæ˜¯å®Œæˆç‹€æ…‹ï¼Œæ¨™è¨˜æ‰€æœ‰æ­¥é©Ÿç‚ºå®Œæˆ
                if (percentage === 100) {
                    for (let i = 1; i <= 4; i++) {
                        const stepElement = document.getElementById(`step${i}`);
                        const icon = stepElement.querySelector('i');
                        const text = stepElement.querySelector('span');
                        
                        icon.className = 'fas fa-check-circle text-green-500 mr-2';
                        text.classList.add('text-green-600');
                        text.classList.remove('text-blue-600');
                    }
                }
            }

            // ç·¨è¼¯è£½ä½œè¨˜éŒ„ç‹€æ…‹
            editRecordStatus(recordId, currentStatus) {
                // éš±è—æ‰€æœ‰å…¶ä»–çš„ç·¨è¼¯å€åŸŸ
                document.querySelectorAll('[id^="edit-"]').forEach(el => {
                    el.classList.add('hidden');
                });
                
                // é¡¯ç¤ºç•¶å‰è¨˜éŒ„çš„ç·¨è¼¯å€åŸŸ
                const editArea = document.getElementById(`edit-${recordId}`);
                if (editArea) {
                    editArea.classList.remove('hidden');
                }
            }

            // å–æ¶ˆç·¨è¼¯ç‹€æ…‹
            cancelEditStatus(recordId) {
                const editArea = document.getElementById(`edit-${recordId}`);
                if (editArea) {
                    editArea.classList.add('hidden');
                }
            }

            // å„²å­˜è£½ä½œè¨˜éŒ„ç‹€æ…‹
            async saveRecordStatus(recordId) {
                try {
                    const selectElement = document.getElementById(`status-select-${recordId}`);
                    const newStatus = selectElement.value;
                    
                    console.log(`ğŸ”„ æ›´æ–°è£½ä½œè¨˜éŒ„ç‹€æ…‹: ${recordId} -> ${newStatus}`);
                    
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    const saveButton = document.querySelector(`button[onclick="saveRecordStatus('${recordId}')"]`);
                    const originalText = saveButton.innerHTML;
                    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>å„²å­˜ä¸­...';
                    saveButton.disabled = true;
                    
                    // æº–å‚™æ›´æ–°è³‡æ–™
                    const updateData = {
                        properties: {
                            'è£½ä½œç‹€æ…‹': {
                                select: {
                                    name: newStatus
                                }
                            }
                        }
                    };
                    
                    // å¦‚æœç‹€æ…‹æ”¹ç‚ºå·²å®Œæˆï¼ŒåŒæ™‚æ›´æ–°å®Œæˆæ™‚é–“
                    if (newStatus === 'å·²å®Œæˆ') {
                        updateData.properties['å®Œæˆæ™‚é–“'] = {
                            date: {
                                start: new Date().toISOString()
                            }
                        };
                    }
                    
                    // ç™¼é€ API è«‹æ±‚æ›´æ–°ç‹€æ…‹
                    const response = await fetch(`/api/notion/pages/${recordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (!response.ok) {
                        const errorDetails = await response.text();
                        throw new Error(`æ›´æ–°ç‹€æ…‹å¤±æ•—: ${response.status} - ${errorDetails}`);
                    }
                    
                    // æ›´æ–°ç•Œé¢é¡¯ç¤º
                    const statusElement = document.getElementById(`status-${recordId}`);
                    if (statusElement) {
                        // æ›´æ–°ç‹€æ…‹æ–‡å­—å’Œé¡è‰²
                        const statusColor = newStatus === 'å·²å®Œæˆ' ? 'text-green-600' : 
                                          newStatus === 'è£½ä½œä¸­' ? 'text-orange-600' : 
                                          newStatus === 'æº–å‚™ä¸­' ? 'text-blue-600' : 
                                          newStatus === 'æš«åœ' ? 'text-yellow-600' :
                                          newStatus === 'å–æ¶ˆ' ? 'text-red-600' : 'text-gray-600';
                        
                        statusElement.className = `text-sm ${statusColor} font-medium`;
                        statusElement.textContent = newStatus;
                    }
                    
                    // éš±è—ç·¨è¼¯å€åŸŸ
                    this.cancelEditStatus(recordId);
                    
                    console.log(`âœ… è£½ä½œè¨˜éŒ„ç‹€æ…‹æ›´æ–°æˆåŠŸ: ${recordId} -> ${newStatus}`);
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    this.showStatusMessage(`âœ… ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œ${newStatus}ã€`, 'success');
                    
                } catch (error) {
                    console.error('âŒ æ›´æ–°è£½ä½œè¨˜éŒ„ç‹€æ…‹å¤±æ•—:', error);
                    this.showStatusMessage(`âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    const saveButton = document.querySelector(`button[onclick="saveRecordStatus('${recordId}')"]`);
                    if (saveButton) {
                        saveButton.innerHTML = '<i class="fas fa-save mr-1"></i>å„²å­˜';
                        saveButton.disabled = false;
                    }
                }
            }

            // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
            showStatusMessage(message, type = 'info') {
                // å‰µå»ºè¨Šæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                messageDiv.innerHTML = message;
                
                // æ·»åŠ åˆ°é é¢
                document.body.appendChild(messageDiv);
                
                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }

            // Notion å±¬æ€§å–å¾—æ–¹æ³•
            getPropertyTitle(item, propertyName) {
                return item.properties[propertyName]?.title?.[0]?.plain_text || '';
            }

            getPropertyRichText(item, propertyName) {
                return item.properties[propertyName]?.rich_text?.[0]?.plain_text || '';
            }

            getPropertyNumber(item, propertyName) {
                return item.properties[propertyName]?.number || null;
            }

            getPropertySelect(item, propertyName) {
                return item.properties[propertyName]?.select?.name || '';
            }

            getPropertyRelation(item, propertyName) {
                return item.properties[propertyName]?.relation || [];
            }
        }

        // å…¨åŸŸå¯¦ä¾‹
        let productionSystem;

        // åˆå§‹åŒ–ç³»çµ±
        document.addEventListener('DOMContentLoaded', function() {
            productionSystem = new ProductionSystem();
            loadAllData();
        });

        // å…¨åŸŸå‡½æ•¸
        function loadAllData() {
            productionSystem.loadAllData();
        }

        function filterRecipes() {
            productionSystem.filterRecipes();
        }

        function showProductionDetail(recipeId) {
            productionSystem.showProductionDetail(recipeId);
        }

        function startProduction(recipeId) {
            productionSystem.startProduction(recipeId);
        }

        function confirmProduction(recipeId) {
            productionSystem.confirmProduction(recipeId);
        }

        function executeProduction() {
            productionSystem.executeProduction();
        }

        function executeBatchProduction() {
            productionSystem.executeBatchProduction();
        }

        function showProductionLog() {
            productionSystem.showProductionLog();
        }

        function editRecordStatus(recordId, currentStatus) {
            productionSystem.editRecordStatus(recordId, currentStatus);
        }

        function cancelEditStatus(recordId) {
            productionSystem.cancelEditStatus(recordId);
        }

        function saveRecordStatus(recordId) {
            productionSystem.saveRecordStatus(recordId);
        }

        function refreshProductionLog() {
            productionSystem.showProductionLog();
        }

        function showInventoryStatus() {
            productionSystem.showInventoryStatus();
        }

        function showBatchProduction() {
            productionSystem.showBatchProduction();
        }

        function closeProductionModal() {
            productionSystem.closeProductionModal();
        }

        function closeConfirmModal() {
            productionSystem.closeConfirmModal();
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰æ¨¡æ…‹æ¡†
        document.getElementById('productionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductionModal();
            }
        });

        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>
