<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™ç³»çµ±æ¸¬è©¦ - Tanawat Restaurant</title>
    <link rel="stylesheet" href="../assets/css/unified-design.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .test-section {
            margin-bottom: var(--space-8);
        }
        
        .test-result {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-4);
            font-family: monospace;
            font-size: var(--text-sm);
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: var(--space-2);
        }
        
        .status-success { background: var(--success-500); }
        .status-error { background: var(--error-500); }
        .status-warning { background: var(--warning-500); }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="fas fa-database text-primary-500"></i>
                    è³‡æ–™ç³»çµ±æ¸¬è©¦é¢æ¿
                </h1>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-6">
                    <i class="fas fa-info-circle"></i>
                    æ­¤é é¢ç”¨æ–¼æ¸¬è©¦è³‡æ–™å„²å­˜ç³»çµ±çš„å„é …åŠŸèƒ½ã€‚è«‹åœ¨é–‹ç™¼ç’°å¢ƒä¸­ä½¿ç”¨ã€‚
                </div>

                <!-- ç³»çµ±ç‹€æ…‹ -->
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4">ğŸ” ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="font-medium mb-2">è³‡æ–™åº«é€£ç·š</h3>
                                <div id="db-status" class="flex items-center">
                                    <span class="status-indicator status-warning"></span>
                                    <span>æª¢æŸ¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h3 class="font-medium mb-2">Notion API</h3>
                                <div id="notion-status" class="flex items-center">
                                    <span class="status-indicator status-warning"></span>
                                    <span>æª¢æŸ¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŸºæœ¬ CRUD æ¸¬è©¦ -->
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4">ğŸ§ª åŸºæœ¬ CRUD æ¸¬è©¦</h2>
                    <div class="flex gap-3 mb-4">
                        <button id="test-create" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            <span>æ¸¬è©¦æ–°å¢</span>
                        </button>
                        <button id="test-read" class="btn btn-secondary">
                            <i class="fas fa-search"></i>
                            <span>æ¸¬è©¦æŸ¥è©¢</span>
                        </button>
                        <button id="test-update" class="btn btn-warning">
                            <i class="fas fa-edit"></i>
                            <span>æ¸¬è©¦æ›´æ–°</span>
                        </button>
                        <button id="test-delete" class="btn btn-error">
                            <i class="fas fa-trash"></i>
                            <span>æ¸¬è©¦åˆªé™¤</span>
                        </button>
                    </div>
                    <div id="crud-result" class="test-result" style="display: none;"></div>
                </div>

                <!-- è³‡æ–™è¡¨ç‹€æ…‹ -->
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“Š è³‡æ–™è¡¨ç‹€æ…‹</h2>
                    <button id="check-tables" class="btn btn-info mb-4">
                        <i class="fas fa-table"></i>
                        <span>æª¢æŸ¥æ‰€æœ‰è³‡æ–™è¡¨</span>
                    </button>
                    <div id="tables-result" class="test-result" style="display: none;"></div>
                </div>

                <!-- è³‡æ–™æ“ä½œ -->
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4">âš¡ å¿«é€Ÿæ“ä½œ</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="clear-all-data" class="btn btn-error">
                            <i class="fas fa-trash-alt"></i>
                            <span>æ¸…ç©ºè³‡æ–™</span>
                        </button>
                        <button id="init-sample-data" class="btn btn-success">
                            <i class="fas fa-seedling"></i>
                            <span>è¼‰å…¥ç¯„ä¾‹è³‡æ–™</span>
                        </button>
                        <button id="performance-test" class="btn btn-warning">
                            <i class="fas fa-stopwatch"></i>
                            <span>æ•ˆèƒ½æ¸¬è©¦</span>
                        </button>
                        <button id="test-notion-sync" class="btn btn-info">
                            <i class="fas fa-cloud"></i>
                            <span>æ¸¬è©¦ Notion åŒæ­¥</span>
                        </button>
                    </div>
                </div>

                <!-- æ—¥èªŒé¡¯ç¤º -->
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“ æ“ä½œæ—¥èªŒ</h2>
                    <button id="clear-log" class="btn btn-secondary btn-sm mb-4">
                        <i class="fas fa-eraser"></i>
                        <span>æ¸…ç©ºæ—¥èªŒ</span>
                    </button>
                    <div id="operation-log" class="test-result" style="height: 300px; overflow-y: auto;">
                        ç³»çµ±æ—¥èªŒå°‡åœ¨æ­¤é¡¯ç¤º...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥è³‡æ–™ç®¡ç†ç³»çµ± -->
    <script src="../config/config.js"></script>
    <script src="../assets/js/notion-manager.js"></script>
    <script src="../assets/js/data-manager.js"></script>
    <script src="../assets/js/data-initializer.js"></script>

    <script>
        class DataSystemTester {
            constructor() {
                this.logElement = document.getElementById('operation-log');
                this.testData = {
                    id: null,
                    name: 'æ¸¬è©¦èœå“',
                    category: 'æ¸¬è©¦åˆ†é¡',
                    price: 100,
                    available: true
                };
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
                this.logElement.textContent += logEntry;
                this.logElement.scrollTop = this.logElement.scrollHeight;
                
                if (type === 'error') {
                    console.error(message);
                } else {
                    console.log(message);
                }
            }

            async checkSystemStatus() {
                // æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹
                try {
                    if (window.DataManager && window.DataManager.db) {
                        document.getElementById('db-status').innerHTML = 
                            '<span class="status-indicator status-success"></span><span>å·²é€£ç·š</span>';
                        this.log('è³‡æ–™åº«é€£ç·šæ­£å¸¸');
                    } else {
                        throw new Error('è³‡æ–™åº«æœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    document.getElementById('db-status').innerHTML = 
                        '<span class="status-indicator status-error"></span><span>é€£ç·šå¤±æ•—</span>';
                    this.log(`è³‡æ–™åº«é€£ç·šå¤±æ•—: ${error.message}`, 'error');
                }

                // æª¢æŸ¥ Notion API ç‹€æ…‹
                try {
                    if (window.notionManager) {
                        const connectionResult = await window.notionManager.checkConnection();
                        if (connectionResult.connected) {
                            document.getElementById('notion-status').innerHTML = 
                                `<span class="status-indicator status-success"></span><span>å·²é€£ç·š (${connectionResult.user})</span>`;
                            this.log(`Notion API é€£ç·šæ­£å¸¸ï¼Œä½¿ç”¨è€…: ${connectionResult.user}`);
                        } else {
                            throw new Error(connectionResult.error);
                        }
                    } else {
                        throw new Error('Notion Manager æœªè¼‰å…¥');
                    }
                } catch (error) {
                    document.getElementById('notion-status').innerHTML = 
                        '<span class="status-indicator status-error"></span><span>é€£ç·šå¤±æ•—</span>';
                    this.log(`Notion API é€£ç·šå¤±æ•—: ${error.message}`, 'error');
                }
            }

            async testCreate() {
                try {
                    const result = await window.DataManager.add('menu', this.testData);
                    this.testData.id = result;
                    const message = `æ–°å¢æ¸¬è©¦æˆåŠŸï¼ŒID: ${result}`;
                    this.log(message);
                    this.showResult('crud-result', message);
                } catch (error) {
                    const message = `æ–°å¢æ¸¬è©¦å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('crud-result', message);
                }
            }

            async testRead() {
                try {
                    const allItems = await window.DataManager.getAll('menu');
                    const message = `æŸ¥è©¢æ¸¬è©¦æˆåŠŸï¼Œå…± ${allItems.length} ç­†è³‡æ–™:\n${JSON.stringify(allItems, null, 2)}`;
                    this.log(`æŸ¥è©¢æ¸¬è©¦æˆåŠŸï¼Œå…± ${allItems.length} ç­†è³‡æ–™`);
                    this.showResult('crud-result', message);
                } catch (error) {
                    const message = `æŸ¥è©¢æ¸¬è©¦å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('crud-result', message);
                }
            }

            async testUpdate() {
                if (!this.testData.id) {
                    await this.testCreate();
                }

                try {
                    const updateData = { ...this.testData, name: 'æ›´æ–°å¾Œçš„æ¸¬è©¦èœå“', price: 150 };
                    await window.DataManager.update('menu', updateData);
                    const message = `æ›´æ–°æ¸¬è©¦æˆåŠŸ:\n${JSON.stringify(updateData, null, 2)}`;
                    this.log('æ›´æ–°æ¸¬è©¦æˆåŠŸ');
                    this.showResult('crud-result', message);
                } catch (error) {
                    const message = `æ›´æ–°æ¸¬è©¦å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('crud-result', message);
                }
            }

            async testDelete() {
                if (!this.testData.id) {
                    await this.testCreate();
                }

                try {
                    await window.DataManager.delete('menu', this.testData.id);
                    const message = `åˆªé™¤æ¸¬è©¦æˆåŠŸï¼Œå·²åˆªé™¤ ID: ${this.testData.id}`;
                    this.log(message);
                    this.showResult('crud-result', message);
                    this.testData.id = null;
                } catch (error) {
                    const message = `åˆªé™¤æ¸¬è©¦å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('crud-result', message);
                }
            }

            async checkTables() {
                try {
                    const tables = window.DataManager.tables;
                    let result = 'è³‡æ–™è¡¨ç‹€æ…‹æª¢æŸ¥:\n\n';
                    
                    for (const [key, tableName] of Object.entries(tables)) {
                        const data = await window.DataManager.getAll(tableName);
                        result += `${tableName}: ${data.length} ç­†è³‡æ–™\n`;
                    }
                    
                    this.log('è³‡æ–™è¡¨ç‹€æ…‹æª¢æŸ¥å®Œæˆ');
                    this.showResult('tables-result', result);
                } catch (error) {
                    const message = `è³‡æ–™è¡¨æª¢æŸ¥å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('tables-result', message);
                }
            }

            async clearAllData() {
                if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;

                try {
                    const tables = Object.values(window.DataManager.tables);
                    for (const tableName of tables) {
                        const transaction = window.DataManager.db.transaction([tableName], 'readwrite');
                        const store = transaction.objectStore(tableName);
                        await store.clear();
                    }
                    this.log('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º');
                    alert('è³‡æ–™æ¸…ç©ºå®Œæˆï¼');
                } catch (error) {
                    this.log(`æ¸…ç©ºè³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                }
            }

            async initSampleData() {
                try {
                    await window.dataInitializer.initializeAllData();
                    this.log('ç¯„ä¾‹è³‡æ–™è¼‰å…¥å®Œæˆ');
                    alert('ç¯„ä¾‹è³‡æ–™è¼‰å…¥å®Œæˆï¼');
                } catch (error) {
                    this.log(`ç¯„ä¾‹è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                }
            }

            async testNotionSync() {
                this.log('é–‹å§‹æ¸¬è©¦ Notion åŒæ­¥åŠŸèƒ½...');
                
                try {
                    // æ¸¬è©¦æ–°å¢è³‡æ–™åˆ° Notion
                    const testData = {
                        name: 'Notion æ¸¬è©¦èœå“',
                        category: 'API æ¸¬è©¦',
                        price: 99,
                        description: 'é€™æ˜¯é€é API å»ºç«‹çš„æ¸¬è©¦èœå“',
                        available: true
                    };
                    
                    const result = await window.notionManager.syncToNotion('menu', testData, 'create');
                    
                    if (result && result.id) {
                        const message = `âœ… Notion åŒæ­¥æ¸¬è©¦æˆåŠŸï¼\né é¢ ID: ${result.id}`;
                        this.log('Notion åŒæ­¥æ¸¬è©¦æˆåŠŸ');
                        this.showResult('crud-result', message);
                        
                        // æ¸¬è©¦å¾ Notion è®€å–è³‡æ–™
                        setTimeout(async () => {
                            try {
                                const notionData = await window.notionManager.getFromNotion('menu', 5);
                                this.log(`å¾ Notion è®€å–åˆ° ${notionData.length} ç­†èœå–®è³‡æ–™`);
                            } catch (error) {
                                this.log(`å¾ Notion è®€å–è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                            }
                        }, 2000);
                        
                    } else {
                        throw new Error('æœªæ”¶åˆ°æœ‰æ•ˆçš„å›æ‡‰');
                    }
                    
                } catch (error) {
                    const message = `âŒ Notion åŒæ­¥æ¸¬è©¦å¤±æ•—: ${error.message}`;
                    this.log(message, 'error');
                    this.showResult('crud-result', message);
                }
            }

            async exportBackup() {
                try {
                    await window.dataInitializer.exportAllData();
                    this.log('è³‡æ–™å‚™ä»½åŒ¯å‡ºå®Œæˆ');
                } catch (error) {
                    this.log(`è³‡æ–™å‚™ä»½åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
                }
            }

            async performanceTest() {
                this.log('é–‹å§‹æ•ˆèƒ½æ¸¬è©¦...');
                const startTime = performance.now();
                
                try {
                    // æ¸¬è©¦å¤§é‡å¯«å…¥
                    for (let i = 0; i < 100; i++) {
                        await window.DataManager.add('menu', {
                            name: `æ•ˆèƒ½æ¸¬è©¦èœå“ ${i}`,
                            category: 'æ¸¬è©¦',
                            price: Math.floor(Math.random() * 500) + 50,
                            available: true
                        });
                    }
                    
                    // æ¸¬è©¦å¤§é‡æŸ¥è©¢
                    const allData = await window.DataManager.getAll('menu');
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    const message = `æ•ˆèƒ½æ¸¬è©¦å®Œæˆ:\n- å¯«å…¥ 100 ç­†è³‡æ–™\n- æŸ¥è©¢ ${allData.length} ç­†è³‡æ–™\n- è€—æ™‚: ${duration.toFixed(2)} ms`;
                    this.log(`æ•ˆèƒ½æ¸¬è©¦å®Œæˆï¼Œè€—æ™‚ ${duration.toFixed(2)} ms`);
                    alert(message);
                } catch (error) {
                    this.log(`æ•ˆèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                }
            }

            showResult(elementId, content) {
                const element = document.getElementById(elementId);
                element.textContent = content;
                element.style.display = 'block';
            }

            clearLog() {
                this.logElement.textContent = 'æ—¥èªŒå·²æ¸…ç©º...\n';
            }

            init() {
                // ç­‰å¾…è³‡æ–™ç³»çµ±è¼‰å…¥
                setTimeout(() => {
                    this.checkSystemStatus();
                }, 2000);

                // ç¶å®šäº‹ä»¶
                document.getElementById('test-create').addEventListener('click', () => this.testCreate());
                document.getElementById('test-read').addEventListener('click', () => this.testRead());
                document.getElementById('test-update').addEventListener('click', () => this.testUpdate());
                document.getElementById('test-delete').addEventListener('click', () => this.testDelete());
                document.getElementById('check-tables').addEventListener('click', () => this.checkTables());
                document.getElementById('clear-all-data').addEventListener('click', () => this.clearAllData());
                document.getElementById('init-sample-data').addEventListener('click', () => this.initSampleData());
                document.getElementById('test-notion-sync').addEventListener('click', () => this.testNotionSync());
                document.getElementById('performance-test').addEventListener('click', () => this.performanceTest());
                document.getElementById('clear-log').addEventListener('click', () => this.clearLog());
            }
        }

        // åˆå§‹åŒ–æ¸¬è©¦ç³»çµ±
        const tester = new DataSystemTester();
        document.addEventListener('DOMContentLoaded', () => {
            tester.init();
        });
    </script>
</body>
</html>
