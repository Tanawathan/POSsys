<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV åˆ° Notion åŒæ­¥å·¥å…·</title>
    <link rel="stylesheet" href="../assets/css/unified-design.css">
    <style>
        .sync-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sync-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .sync-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .sync-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .csv-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .csv-preview h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .csv-table th,
        .csv-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            text-align: left;
        }
        
        .csv-table th {
            background: #e9ecef;
            font-weight: bold;
        }
        
        .csv-table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sync-controls {
            text-align: center;
            margin: 2rem 0;
        }
        
        .sync-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 0.5rem;
        }
        
        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .sync-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-container {
            margin: 2rem 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: #495057;
        }
        
        .log-container {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-info {
            color: #007bff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="sync-container">
        <div class="sync-header">
            <h1>ğŸ”„ CSV åˆ° Notion åŒæ­¥å·¥å…·</h1>
            <p>å°‡æœ€çµ‚èœè‰².csv è³‡æ–™åŒæ­¥åˆ° Notion èœå–®è³‡æ–™åº«</p>
        </div>
        
        <!-- CSV é è¦½å€ -->
        <div class="csv-preview" id="csvPreview">
            <h3>ğŸ“„ CSV è³‡æ–™é è¦½</h3>
            <div id="csvContent">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        
        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div class="stat-label">ç¸½è¨ˆé …ç›®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableItems">0</div>
                <div class="stat-label">å¯ä¾›æ‡‰é …ç›®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averagePrice">$0</div>
                <div class="stat-label">å¹³å‡åƒ¹æ ¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="syncedItems">0</div>
                <div class="stat-label">å·²åŒæ­¥é …ç›®</div>
            </div>
        </div>
        
        <!-- åŒæ­¥æ§åˆ¶å€ -->
        <div class="sync-controls">
            <button class="sync-btn" id="previewBtn" onclick="loadCSVPreview()">
                ğŸ“‹ é è¦½ CSV è³‡æ–™
            </button>
            <button class="sync-btn" id="testBtn" onclick="testFunction()" style="background: #17a2b8;">
                ğŸ§ª æ¸¬è©¦é€£ç·š
            </button>
            <button class="sync-btn" id="syncBtn" onclick="startSync()">
                ğŸš€ é–‹å§‹åŒæ­¥åˆ° Notion
            </button>
            <button class="sync-btn" id="clearBtn" onclick="clearNotionData()" style="background: #e74c3c;">
                ğŸ—‘ï¸ æ¸…ç©º Notion è³‡æ–™åº«
            </button>
        </div>
        
        <!-- é€²åº¦æ¢ -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
        </div>
        
        <!-- è¨Šæ¯å€ -->
        <div id="messageContainer"></div>
        
        <!-- æ—¥èªŒå€ -->
        <div class="log-container" id="logContainer">
            <h4>ğŸ“‹ åŒæ­¥æ—¥èªŒ</h4>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let csvData = [];
        let syncInProgress = false;
        
        // åœ¨é é¢è¼‰å…¥æ™‚é€²è¡Œèª¿è©¦
        window.addEventListener('load', () => {
            console.log('ğŸ”§ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            console.log('ğŸ“Š åˆå§‹ csvData:', csvData);
            console.log('ğŸ”„ åˆå§‹ syncInProgress:', syncInProgress);
            
            // è‡ªå‹•è¼‰å…¥CSVé è¦½
            loadCSVPreview();
        });
        
        // è¼‰å…¥ CSV é è¦½
        async function loadCSVPreview() {
            console.log('ğŸ“„ é–‹å§‹è¼‰å…¥ CSV é è¦½...');
            try {
                showMessage('æ­£åœ¨è¼‰å…¥ CSV è³‡æ–™...', 'info');
                
                console.log('ğŸŒ ç™¼é€è«‹æ±‚åˆ° /api/csv-preview');
                const response = await fetch('/api/csv-preview');
                console.log('ğŸ“¡ æ”¶åˆ°å›æ‡‰:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š è§£æçš„è³‡æ–™:', data);
                
                // ç›´æ¥è™•ç†é™£åˆ—å›æ‡‰
                if (Array.isArray(data)) {
                    csvData = data;
                    console.log('âœ… CSV è³‡æ–™è¼‰å…¥æˆåŠŸ:', csvData.length, 'ç­†');
                    displayCSVPreview(data);
                    updateStats(data);
                    showMessage(`æˆåŠŸè¼‰å…¥ ${data.length} ç­†èœå–®è³‡æ–™`, 'success');
                } else if (data.success) {
                    // å‚™ç”¨ï¼šè™•ç†åŒ…è£æ ¼å¼
                    csvData = data.data;
                    console.log('âœ… CSV è³‡æ–™è¼‰å…¥æˆåŠŸ:', csvData.length, 'ç­†');
                    displayCSVPreview(data.data);
                    updateStats(data.data);
                    showMessage(`æˆåŠŸè¼‰å…¥ ${data.data.length} ç­†èœå–®è³‡æ–™`, 'success');
                } else {
                    console.error('âŒ CSV è¼‰å…¥å¤±æ•—:', data.error || 'æœªçŸ¥éŒ¯èª¤');
                    showMessage(`è¼‰å…¥å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                console.error('âŒ CSV è¼‰å…¥éŒ¯èª¤:', error);
                showMessage(`è¼‰å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // é¡¯ç¤º CSV é è¦½
        function displayCSVPreview(data) {
            console.log('ğŸ¨ é–‹å§‹é¡¯ç¤º CSV é è¦½ï¼Œè³‡æ–™ç­†æ•¸:', data.length);
            
            if (data.length === 0) {
                document.getElementById('csvContent').innerHTML = '<p>æ²’æœ‰è³‡æ–™</p>';
                return;
            }
            
            const headers = Object.keys(data[0]);
            const previewData = data.slice(0, 10); // åªé¡¯ç¤ºå‰10ç­†
            
            let html = `
                <table class="csv-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => `
                            <tr>
                                ${headers.map(h => `<td title="${row[h] || ''}">${row[h] || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            if (data.length > 10) {
                html += `<p style="text-align: center; margin-top: 1rem; color: #7f8c8d;">... é‚„æœ‰ ${data.length - 10} ç­†è³‡æ–™</p>`;
            }
            
            document.getElementById('csvContent').innerHTML = html;
            document.getElementById('statsGrid').style.display = 'grid';
            console.log('âœ… CSV é è¦½é¡¯ç¤ºå®Œæˆ');
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats(data) {
            console.log('ğŸ“Š æ›´æ–°çµ±è¨ˆè³‡è¨Š...');
            const totalItems = data.length;
            const availableItems = data.filter(item => item['ç„¡æ³•ä¾›æ‡‰'] !== 'Yes').length;
            const prices = data.map(item => parseFloat(item['åƒ¹æ ¼']) || 0).filter(p => p > 0);
            const averagePrice = prices.length > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('availableItems').textContent = availableItems;
            document.getElementById('averagePrice').textContent = `$${averagePrice}`;
            
            console.log('ğŸ“ˆ çµ±è¨ˆæ›´æ–°å®Œæˆ:', { totalItems, availableItems, averagePrice });
        }
        
        // é–‹å§‹åŒæ­¥
        async function startSync() {
            alert('ğŸš€ åŒæ­¥æŒ‰éˆ•è¢«é»æ“Šï¼startSync å‡½æ•¸æ­£åœ¨åŸ·è¡Œ');
            console.log('ğŸš€ startSync å‡½æ•¸è¢«èª¿ç”¨');
            console.log('ğŸ”„ syncInProgress:', syncInProgress);
            console.log('ğŸ“Š csvData.length:', csvData.length);
            
            if (syncInProgress) {
                console.log('âš ï¸ åŒæ­¥æ­£åœ¨é€²è¡Œä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡èª¿ç”¨');
                return;
            }
            
            if (csvData.length === 0) {
                console.log('âš ï¸ CSV è³‡æ–™ç‚ºç©ºï¼Œå…ˆè¼‰å…¥è³‡æ–™');
                showMessage('è«‹å…ˆè¼‰å…¥ CSV è³‡æ–™', 'warning');
                await loadCSVPreview();
                if (csvData.length === 0) {
                    return;
                }
            }
            
            const confirmMessage = `ç¢ºå®šè¦åŒæ­¥ ${csvData.length} ç­†è³‡æ–™åˆ° Notion å—ï¼Ÿ`;
            console.log('â“ é¡¯ç¤ºç¢ºèªå°è©±æ¡†:', confirmMessage);
            
            if (!confirm(confirmMessage)) {
                console.log('âŒ ç”¨æˆ¶å–æ¶ˆåŒæ­¥');
                return;
            }
            
            console.log('âœ… ç”¨æˆ¶ç¢ºèªåŒæ­¥ï¼Œé–‹å§‹åŸ·è¡Œ...');
            
            syncInProgress = true;
            document.getElementById('syncBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('logContainer').style.display = 'block';
            
            clearLog();
            logMessage('ğŸš€ é–‹å§‹åŒæ­¥ç¨‹åº...', 'info');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < csvData.length; i++) {
                    const item = csvData[i];
                    const progress = ((i + 1) / csvData.length) * 100;
                    
                    updateProgress(progress, `åŒæ­¥ä¸­... ${i + 1}/${csvData.length}`);
                    logMessage(`è™•ç†: ${item['é¤é»åç¨±']}`, 'info');
                    console.log(`ğŸ”„ è™•ç†ç¬¬ ${i + 1} é …:`, item['é¤é»åç¨±']);
                    
                    try {
                        const response = await fetch('/api/sync-menu-item', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(item)
                        });
                        
                        console.log(`ğŸ“¡ API å›æ‡‰ç‹€æ…‹:`, response.status);
                        const result = await response.json();
                        console.log(`ğŸ“Š API å›æ‡‰çµæœ:`, result);
                        
                        if (result.success) {
                            successCount++;
                            logMessage(`âœ… ${item['é¤é»åç¨±']} åŒæ­¥æˆåŠŸ`, 'success');
                        } else {
                            errorCount++;
                            logMessage(`âŒ ${item['é¤é»åç¨±']} åŒæ­¥å¤±æ•—: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`âŒ è™•ç†éŒ¯èª¤:`, error);
                        logMessage(`âŒ ${item['é¤é»åç¨±']} è™•ç†éŒ¯èª¤: ${error.message}`, 'error');
                    }
                    
                    // é¿å… API é™åˆ¶
                    if (i < csvData.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }
                
                updateProgress(100, 'åŒæ­¥å®Œæˆï¼');
                document.getElementById('syncedItems').textContent = successCount;
                
                const finalMessage = `ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${errorCount}`;
                logMessage(finalMessage, successCount > errorCount ? 'success' : 'error');
                showMessage(`åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥ ${successCount} ç­†è³‡æ–™ï¼Œ${errorCount} ç­†å¤±æ•—`, 'success');
                
                console.log('âœ… åŒæ­¥æµç¨‹å…¨éƒ¨å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åŒæ­¥éç¨‹ç™¼ç”Ÿåš´é‡éŒ¯èª¤:', error);
                logMessage(`âŒ åŒæ­¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                showMessage(`åŒæ­¥å¤±æ•—: ${error.message}`, 'error');
            } finally {
                syncInProgress = false;
                document.getElementById('syncBtn').disabled = false;
                console.log('ğŸ”„ é‡ç½®åŒæ­¥ç‹€æ…‹');
            }
        }
        
        // æ¸¬è©¦å‡½æ•¸
        async function testFunction() {
            alert('ğŸ§ª æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Šï¼testFunction å‡½æ•¸æ­£åœ¨åŸ·è¡Œ');
            console.log('ğŸ§ª æ¸¬è©¦å‡½æ•¸è¢«èª¿ç”¨');
            showMessage('æ¸¬è©¦é€£ç·šä¸­...', 'info');
            
            try {
                // æ¸¬è©¦å¥åº·æª¢æŸ¥
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                console.log('ğŸ¥ å¥åº·æª¢æŸ¥çµæœ:', healthData);
                
                if (healthData.status === 'ok') {
                    showMessage('âœ… ä¼ºæœå™¨é€£ç·šæ­£å¸¸', 'success');
                    logMessage(`âœ… ä¼ºæœå™¨ç‹€æ…‹: ${healthData.status}`, 'success');
                    logMessage(`ğŸ”‘ Notion API è¨­å®š: ${healthData.notion_api_configured ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}`, 'info');
                } else {
                    showMessage('âŒ ä¼ºæœå™¨é€£ç·šç•°å¸¸', 'error');
                }
                
                // æ¸¬è©¦CSVç«¯é»
                const csvResponse = await fetch('/api/csv-preview');
                if (csvResponse.ok) {
                    logMessage('âœ… CSV ç«¯é»æ­£å¸¸', 'success');
                } else {
                    logMessage('âŒ CSV ç«¯é»ç•°å¸¸', 'error');
                }
                
            } catch (error) {
                console.error('âŒ æ¸¬è©¦éŒ¯èª¤:', error);
                showMessage(`æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                logMessage(`âŒ æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // æ¸…ç©º Notion è³‡æ–™åº«
        async function clearNotionData() {
            alert('ğŸ—‘ï¸ æ¸…ç©ºæŒ‰éˆ•è¢«é»æ“Šï¼clearNotionData å‡½æ•¸æ­£åœ¨åŸ·è¡Œ');
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©º Notion èœå–®è³‡æ–™åº«å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            try {
                const clearBtn = document.getElementById('clearBtn');
                clearBtn.disabled = true;
                clearBtn.textContent = 'ğŸ—‘ï¸ æ¸…ç©ºä¸­...';
                
                showMessage('æ­£åœ¨æ¸…ç©º Notion è³‡æ–™åº«...', 'info');
                logMessage('é–‹å§‹æ¸…ç©º Notion è³‡æ–™åº«...', 'info');
                
                const response = await fetch('/api/clear-notion-menu', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const message = result.failedCount > 0 
                        ? `æˆåŠŸæ¸…ç©º ${result.deletedCount} ç­†è³‡æ–™ï¼Œ${result.failedCount} ç­†å¤±æ•—`
                        : `æˆåŠŸæ¸…ç©º ${result.deletedCount} ç­†è³‡æ–™`;
                    
                    showMessage(message, 'success');
                    logMessage(`âœ… ${message}`, 'success');
                    document.getElementById('syncedItems').textContent = '0';
                } else {
                    showMessage(`æ¸…ç©ºå¤±æ•—: ${result.error}`, 'error');
                    logMessage(`âŒ æ¸…ç©ºå¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Clear error:', error);
                showMessage(`æ¸…ç©ºéŒ¯èª¤: ${error.message}`, 'error');
                logMessage(`âŒ æ¸…ç©ºéŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                const clearBtn = document.getElementById('clearBtn');
                clearBtn.disabled = false;
                clearBtn.textContent = 'ğŸ—‘ï¸ æ¸…ç©º Notion è³‡æ–™åº«';
            }
        }
        
        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = text;
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            // è‡ªå‹•æ¸…é™¤æˆåŠŸè¨Šæ¯
            if (type === 'success') {
                setTimeout(() => {
                    if (container.contains(alert)) {
                        container.removeChild(alert);
                    }
                }, 5000);
            }
        }
        
        // æ—¥èªŒç›¸é—œå‡½æ•¸
        function logMessage(message, type) {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
        }
    </script>
</body>
</html>
