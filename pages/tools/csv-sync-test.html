<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV åŒæ­¥æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 1rem 2rem;
            margin: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª CSV åŒæ­¥æ¸¬è©¦å·¥å…·</h1>
        
        <div>
            <button onclick="testConnection()">ğŸ”— æ¸¬è©¦é€£ç·š</button>
            <button onclick="loadCSV()">ğŸ“„ è¼‰å…¥ CSV</button>
            <button onclick="syncOne()">ğŸš€ åŒæ­¥ä¸€ç­†</button>
            <button onclick="syncAll()" id="syncAllBtn">ğŸ¯ å…¨éƒ¨åŒæ­¥</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
        </div>
        
        <div class="log" id="log"></div>
        
        <div id="stats">
            <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­</span></p>
            <p>CSV è³‡æ–™ï¼š<span id="csvCount">0</span> ç­†</p>
            <p>åŒæ­¥é€²åº¦ï¼š<span id="progress">0/0</span></p>
        </div>
    </div>

    <script>
        let csvData = [];
        let currentIndex = 0;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${time}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤');
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function updateStats() {
            document.getElementById('csvCount').textContent = csvData.length;
            document.getElementById('progress').textContent = `${currentIndex}/${csvData.length}`;
        }
        
        async function testConnection() {
            log('ğŸ”— æ¸¬è©¦ä¼ºæœå™¨é€£ç·š...');
            try {
                const response = await fetch('/.netlify/functions/notion-api/health');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    log('âœ… ä¼ºæœå™¨é€£ç·šæ­£å¸¸', 'success');
                    log(`ğŸ”‘ Notion API: ${data.notion_api_configured ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}`, 'info');
                    updateStatus('é€£ç·šæ­£å¸¸');
                } else {
                    log('âŒ ä¼ºæœå™¨ç‹€æ…‹ç•°å¸¸', 'error');
                    updateStatus('é€£ç·šç•°å¸¸');
                }
            } catch (error) {
                log(`âŒ é€£ç·šå¤±æ•—: ${error.message}`, 'error');
                updateStatus('é€£ç·šå¤±æ•—');
            }
        }
        
        async function loadCSV() {
            log('ğŸ“„ è¼‰å…¥ CSV è³‡æ–™...');
            try {
                const response = await fetch('/api/csv-preview');
                const data = await response.json();
                
                if (data.success) {
                    csvData = data.data;
                    currentIndex = 0;
                    updateStats();
                    log(`âœ… æˆåŠŸè¼‰å…¥ ${csvData.length} ç­†èœå–®è³‡æ–™`, 'success');
                    updateStatus('è³‡æ–™å·²è¼‰å…¥');
                    
                    // é¡¯ç¤ºå‰3ç­†è³‡æ–™
                    for (let i = 0; i < Math.min(3, csvData.length); i++) {
                        log(`ğŸ“‹ ${i + 1}. ${csvData[i]['é¤é»åç¨±']} - $${csvData[i]['åƒ¹æ ¼']}`, 'info');
                    }
                } else {
                    log(`âŒ è¼‰å…¥å¤±æ•—: ${data.error}`, 'error');
                    updateStatus('è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                log(`âŒ è¼‰å…¥éŒ¯èª¤: ${error.message}`, 'error');
                updateStatus('è¼‰å…¥éŒ¯èª¤');
            }
        }
        
        async function syncOne() {
            if (csvData.length === 0) {
                log('âš ï¸ è«‹å…ˆè¼‰å…¥ CSV è³‡æ–™', 'error');
                return;
            }
            
            if (currentIndex >= csvData.length) {
                log('âœ… æ‰€æœ‰è³‡æ–™å·²åŒæ­¥å®Œæˆ', 'success');
                return;
            }
            
            const item = csvData[currentIndex];
            log(`ğŸš€ åŒæ­¥ç¬¬ ${currentIndex + 1} ç­†: ${item['é¤é»åç¨±']}`);
            
            try {
                const response = await fetch('/api/sync-menu-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… ${item['é¤é»åç¨±']} åŒæ­¥æˆåŠŸ`, 'success');
                } else {
                    log(`âŒ ${item['é¤é»åç¨±']} åŒæ­¥å¤±æ•—: ${result.error}`, 'error');
                }
                
                currentIndex++;
                updateStats();
                
            } catch (error) {
                log(`âŒ åŒæ­¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function syncAll() {
            if (csvData.length === 0) {
                log('âš ï¸ è«‹å…ˆè¼‰å…¥ CSV è³‡æ–™', 'error');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åŒæ­¥å…¨éƒ¨ ${csvData.length} ç­†è³‡æ–™å—ï¼Ÿ`)) {
                return;
            }
            
            document.getElementById('syncAllBtn').disabled = true;
            updateStatus('æ‰¹æ¬¡åŒæ­¥ä¸­');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < csvData.length; i++) {
                const item = csvData[i];
                currentIndex = i;
                updateStats();
                
                log(`ğŸ”„ è™•ç† ${i + 1}/${csvData.length}: ${item['é¤é»åç¨±']}`);
                
                try {
                    const response = await fetch('/api/sync-menu-item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                        log(`âœ… ${item['é¤é»åç¨±']} æˆåŠŸ`, 'success');
                    } else {
                        errorCount++;
                        log(`âŒ ${item['é¤é»åç¨±']} å¤±æ•—: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    errorCount++;
                    log(`âŒ ${item['é¤é»åç¨±']} éŒ¯èª¤: ${error.message}`, 'error');
                }
                
                // é¿å… API é™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            log(`ğŸ‰ æ‰¹æ¬¡åŒæ­¥å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${errorCount}`, 'success');
            updateStatus('åŒæ­¥å®Œæˆ');
            document.getElementById('syncAllBtn').disabled = false;
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
        window.addEventListener('load', () => {
            log('ğŸŒŸ CSV åŒæ­¥æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            testConnection();
        });
    </script>
</body>
</html>
