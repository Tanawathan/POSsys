<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion è³‡æ–™åº«è¨­å®šåŠ©æ‰‹ - Tanawat Restaurant</title>
    <link rel="stylesheet" href="../assets/css/unified-design.css">
    <style>
        .setup-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .database-card {
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            background: var(--white);
        }
        
        .database-card.connected {
            border-color: var(--success-500);
            background: var(--success-50);
        }
        
        .property-list {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .property-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .property-item:last-child {
            border-bottom: none;
        }
        
        .property-type {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 600;
        }
        
        .copy-button {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            cursor: pointer;
        }
        
        .copy-button:hover {
            background: var(--gray-200);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: var(--space-2);
        }
        
        .status-pending { background: var(--warning-500); }
        .status-success { background: var(--success-500); }
        .status-error { background: var(--error-500); }
        
        .instruction-step {
            background: var(--blue-50);
            border-left: 4px solid var(--blue-500);
            padding: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .database-id-input {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: var(--text-sm);
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="fas fa-database text-primary-500"></i>
                    Notion è³‡æ–™åº«è¨­å®šåŠ©æ‰‹
                </h1>
                <p class="text-gray-600">ç‚º Tanawat Restaurant ç³»çµ±å»ºç«‹ Notion è³‡æ–™åº«</p>
            </div>
            
            <div class="card-body">
                <!-- API é€£ç·šç‹€æ…‹ -->
                <div class="alert alert-info mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <i class="fas fa-info-circle"></i>
                            <strong>API é€£ç·šç‹€æ…‹ï¼š</strong>
                            <span id="api-status">æª¢æŸ¥ä¸­...</span>
                        </div>
                        <button id="test-connection" class="btn btn-sm btn-primary">
                            <i class="fas fa-sync"></i>
                            æ¸¬è©¦é€£ç·š
                        </button>
                    </div>
                </div>

                <!-- è¨­å®šæ­¥é©Ÿ -->
                <div class="instruction-step">
                    <h3 class="font-semibold mb-2">ğŸ“‹ è¨­å®šæ­¥é©Ÿ</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>åœ¨ Notion ä¸­ç‚ºæ¯å€‹è³‡æ–™åº«å»ºç«‹å°æ‡‰çš„è³‡æ–™åº«é é¢</li>
                        <li>æŒ‰ç…§ä¸‹æ–¹çš„å±¬æ€§è¨­å®šè¦æ±‚å»ºç«‹å±¬æ€§</li>
                        <li>å°‡æ‚¨çš„ Integration åŠ å…¥åˆ°æ¯å€‹è³‡æ–™åº«çš„é€£ç·šä¸­</li>
                        <li>è¤‡è£½è³‡æ–™åº« ID ä¸¦å¡«å…¥ä¸‹æ–¹çš„è¼¸å…¥æ¡†</li>
                        <li>é»æ“Šã€Œæ¸¬è©¦é€£ç·šã€æŒ‰éˆ•é©—è­‰è¨­å®š</li>
                    </ol>
                </div>

                <!-- èœå–®è³‡æ–™åº« -->
                <div class="database-card" id="menu-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">
                            <span class="status-indicator status-pending" id="menu-status"></span>
                            ğŸ½ï¸ èœå–®è³‡æ–™åº« (Menu)
                        </h3>
                        <button class="copy-button" onclick="copyDatabaseStructure('menu')">
                            <i class="fas fa-copy"></i> è¤‡è£½çµæ§‹
                        </button>
                    </div>
                    
                    <div class="property-list">
                        <div class="property-item">
                            <span><strong>åç¨±</strong> - èœå“åç¨±</span>
                            <span class="property-type">Title</span>
                        </div>
                        <div class="property-item">
                            <span><strong>åˆ†é¡</strong> - èœå“åˆ†é¡</span>
                            <span class="property-type">Text</span>
                        </div>
                        <div class="property-item">
                            <span><strong>åƒ¹æ ¼</strong> - åƒ¹æ ¼é‡‘é¡</span>
                            <span class="property-type">Number</span>
                        </div>
                        <div class="property-item">
                            <span><strong>æè¿°</strong> - èœå“æè¿°</span>
                            <span class="property-type">Text</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ä¾›æ‡‰ç‹€æ…‹</strong> - æ˜¯å¦ä¾›æ‡‰ä¸­</span>
                            <span class="property-type">Checkbox</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">è³‡æ–™åº« IDï¼š</label>
                        <input type="text" 
                               id="menu-id" 
                               class="database-id-input" 
                               placeholder="è«‹è²¼ä¸Šèœå–®è³‡æ–™åº«çš„ ID"
                               onchange="updateDatabaseId('menu', this.value)">
                    </div>
                </div>

                <!-- è¨‚å–®è³‡æ–™åº« -->
                <div class="database-card" id="orders-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">
                            <span class="status-indicator status-pending" id="orders-status"></span>
                            ğŸ“ è¨‚å–®è³‡æ–™åº« (Orders)
                        </h3>
                        <button class="copy-button" onclick="copyDatabaseStructure('orders')">
                            <i class="fas fa-copy"></i> è¤‡è£½çµæ§‹
                        </button>
                    </div>
                    
                    <div class="property-list">
                        <div class="property-item">
                            <span><strong>æ¡Œè™Ÿ</strong> - æ¡Œä½ç·¨è™Ÿ</span>
                            <span class="property-type">Title</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ç‹€æ…‹</strong> - è¨‚å–®ç‹€æ…‹ (é€²è¡Œä¸­ã€å·²å®Œæˆã€å·²å–æ¶ˆ)</span>
                            <span class="property-type">Select</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ç¸½é‡‘é¡</strong> - è¨‚å–®ç¸½é‡‘é¡</span>
                            <span class="property-type">Number</span>
                        </div>
                        <div class="property-item">
                            <span><strong>è¨‚å–®é …ç›®</strong> - JSON æ ¼å¼è¨‚å–®æ˜ç´°</span>
                            <span class="property-type">Text</span>
                        </div>
                        <div class="property-item">
                            <span><strong>å»ºç«‹æ™‚é–“</strong> - è¨‚å–®å»ºç«‹æ™‚é–“</span>
                            <span class="property-type">Date</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">è³‡æ–™åº« IDï¼š</label>
                        <input type="text" 
                               id="orders-id" 
                               class="database-id-input" 
                               placeholder="è«‹è²¼ä¸Šè¨‚å–®è³‡æ–™åº«çš„ ID"
                               onchange="updateDatabaseId('orders', this.value)">
                    </div>
                </div>

                <!-- æ¡Œæ³è³‡æ–™åº« -->
                <div class="database-card" id="tables-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">
                            <span class="status-indicator status-pending" id="tables-status"></span>
                            ğŸª‘ æ¡Œæ³è³‡æ–™åº« (Tables)
                        </h3>
                        <button class="copy-button" onclick="copyDatabaseStructure('tables')">
                            <i class="fas fa-copy"></i> è¤‡è£½çµæ§‹
                        </button>
                    </div>
                    
                    <div class="property-list">
                        <div class="property-item">
                            <span><strong>æ¡Œè™Ÿ</strong> - æ¡Œä½ç·¨è™Ÿ</span>
                            <span class="property-type">Title</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ç‹€æ…‹</strong> - æ¡Œä½ç‹€æ…‹ (ç©ºæ¡Œã€å·²ä½”ç”¨ã€æ¸…æ½”ä¸­)</span>
                            <span class="property-type">Select</span>
                        </div>
                        <div class="property-item">
                            <span><strong>å®¹ç´äººæ•¸</strong> - å¯å®¹ç´äººæ•¸</span>
                            <span class="property-type">Number</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ä½ç½®</strong> - æ¡Œä½ä½ç½®æè¿°</span>
                            <span class="property-type">Text</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">è³‡æ–™åº« IDï¼š</label>
                        <input type="text" 
                               id="tables-id" 
                               class="database-id-input" 
                               placeholder="è«‹è²¼ä¸Šæ¡Œæ³è³‡æ–™åº«çš„ ID"
                               onchange="updateDatabaseId('tables', this.value)">
                    </div>
                </div>

                <!-- åº«å­˜è³‡æ–™åº« -->
                <div class="database-card" id="inventory-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">
                            <span class="status-indicator status-pending" id="inventory-status"></span>
                            ğŸ“¦ åº«å­˜è³‡æ–™åº« (Inventory)
                        </h3>
                        <button class="copy-button" onclick="copyDatabaseStructure('inventory')">
                            <i class="fas fa-copy"></i> è¤‡è£½çµæ§‹
                        </button>
                    </div>
                    
                    <div class="property-list">
                        <div class="property-item">
                            <span><strong>å•†å“åç¨±</strong> - åº«å­˜å•†å“åç¨±</span>
                            <span class="property-type">Title</span>
                        </div>
                        <div class="property-item">
                            <span><strong>åˆ†é¡</strong> - å•†å“åˆ†é¡</span>
                            <span class="property-type">Text</span>
                        </div>
                        <div class="property-item">
                            <span><strong>ç›®å‰åº«å­˜</strong> - ç›®å‰åº«å­˜æ•¸é‡</span>
                            <span class="property-type">Number</span>
                        </div>
                        <div class="property-item">
                            <span><strong>æœ€ä½åº«å­˜</strong> - æœ€ä½åº«å­˜è­¦æˆ’ç·š</span>
                            <span class="property-type">Number</span>
                        </div>
                        <div class="property-item">
                            <span><strong>å–®ä½</strong> - è¨ˆé‡å–®ä½</span>
                            <span class="property-type">Text</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">è³‡æ–™åº« IDï¼š</label>
                        <input type="text" 
                               id="inventory-id" 
                               class="database-id-input" 
                               placeholder="è«‹è²¼ä¸Šåº«å­˜è³‡æ–™åº«çš„ ID"
                               onchange="updateDatabaseId('inventory', this.value)">
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex gap-4 mt-8">
                    <button id="save-config" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        å„²å­˜è¨­å®š
                    </button>
                    <button id="test-all-databases" class="btn btn-secondary">
                        <i class="fas fa-check-circle"></i>
                        æ¸¬è©¦æ‰€æœ‰è³‡æ–™åº«
                    </button>
                    <button id="create-sample-data" class="btn btn-success">
                        <i class="fas fa-seedling"></i>
                        å»ºç«‹ç¯„ä¾‹è³‡æ–™
                    </button>
                </div>

                <!-- ç‹€æ…‹å›é¥‹ -->
                <div id="status-feedback" class="mt-6" style="display: none;">
                    <div class="alert alert-info">
                        <div id="status-message">è™•ç†ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦è…³æœ¬ -->
    <script src="../config/config.js"></script>
    <script src="../assets/js/notion-manager.js"></script>

    <script>
        // è³‡æ–™åº«çµæ§‹å®šç¾©
        const databaseStructures = {
            menu: {
                name: "èœå–®è³‡æ–™åº«",
                properties: {
                    "åç¨±": "Title",
                    "åˆ†é¡": "Text", 
                    "åƒ¹æ ¼": "Number",
                    "æè¿°": "Text",
                    "ä¾›æ‡‰ç‹€æ…‹": "Checkbox"
                }
            },
            orders: {
                name: "è¨‚å–®è³‡æ–™åº«",
                properties: {
                    "æ¡Œè™Ÿ": "Title",
                    "ç‹€æ…‹": "Select (é€²è¡Œä¸­ã€å·²å®Œæˆã€å·²å–æ¶ˆ)",
                    "ç¸½é‡‘é¡": "Number",
                    "è¨‚å–®é …ç›®": "Text",
                    "å»ºç«‹æ™‚é–“": "Date"
                }
            },
            tables: {
                name: "æ¡Œæ³è³‡æ–™åº«", 
                properties: {
                    "æ¡Œè™Ÿ": "Title",
                    "ç‹€æ…‹": "Select (ç©ºæ¡Œã€å·²ä½”ç”¨ã€æ¸…æ½”ä¸­)",
                    "å®¹ç´äººæ•¸": "Number",
                    "ä½ç½®": "Text"
                }
            },
            inventory: {
                name: "åº«å­˜è³‡æ–™åº«",
                properties: {
                    "å•†å“åç¨±": "Title",
                    "åˆ†é¡": "Text",
                    "ç›®å‰åº«å­˜": "Number", 
                    "æœ€ä½åº«å­˜": "Number",
                    "å–®ä½": "Text"
                }
            }
        };

        let currentConfig = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkApiConnection();
            loadCurrentConfig();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('test-connection').addEventListener('click', checkApiConnection);
            document.getElementById('save-config').addEventListener('click', saveConfiguration);
            document.getElementById('test-all-databases').addEventListener('click', testAllDatabases);
            document.getElementById('create-sample-data').addEventListener('click', createSampleData);
        });

        // æª¢æŸ¥ API é€£ç·š
        async function checkApiConnection() {
            const statusElement = document.getElementById('api-status');
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æª¢æŸ¥ä¸­...';
            
            try {
                if (window.notionManager) {
                    const result = await window.notionManager.checkConnection();
                    if (result.connected) {
                        statusElement.innerHTML = `<span class="text-success-600">âœ… å·²é€£ç·š (${result.user})</span>`;
                    } else {
                        statusElement.innerHTML = `<span class="text-error-600">âŒ é€£ç·šå¤±æ•—: ${result.error}</span>`;
                    }
                } else {
                    statusElement.innerHTML = '<span class="text-warning-600">âš ï¸ Notion Manager æœªè¼‰å…¥</span>';
                }
            } catch (error) {
                statusElement.innerHTML = `<span class="text-error-600">âŒ éŒ¯èª¤: ${error.message}</span>`;
            }
        }

        // è¼‰å…¥ç•¶å‰è¨­å®š
        function loadCurrentConfig() {
            if (window.APP_CONFIG && window.APP_CONFIG.notion && window.APP_CONFIG.notion.databaseIds) {
                currentConfig = window.APP_CONFIG.notion.databaseIds;
                
                Object.keys(currentConfig).forEach(key => {
                    const input = document.getElementById(`${key}-id`);
                    if (input && currentConfig[key] !== `your-${key}-database-id`) {
                        input.value = currentConfig[key];
                        updateDatabaseStatus(key, 'pending');
                    }
                });
            }
        }

        // è¤‡è£½è³‡æ–™åº«çµæ§‹åˆ°å‰ªè²¼ç°¿
        function copyDatabaseStructure(dbType) {
            const structure = databaseStructures[dbType];
            if (!structure) return;
            
            let text = `${structure.name} å±¬æ€§è¨­å®š:\n\n`;
            Object.entries(structure.properties).forEach(([name, type]) => {
                text += `${name}: ${type}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showStatusMessage(`å·²è¤‡è£½ ${structure.name} çµæ§‹åˆ°å‰ªè²¼ç°¿`, 'success');
            });
        }

        // æ›´æ–°è³‡æ–™åº« ID
        function updateDatabaseId(dbType, id) {
            if (id.trim()) {
                currentConfig[dbType] = id.trim();
                updateDatabaseStatus(dbType, 'pending');
            }
        }

        // æ›´æ–°è³‡æ–™åº«ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateDatabaseStatus(dbType, status) {
            const indicator = document.getElementById(`${dbType}-status`);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
            
            const card = document.getElementById(`${dbType}-card`);
            if (card) {
                card.classList.toggle('connected', status === 'success');
            }
        }

        // å„²å­˜è¨­å®š
        async function saveConfiguration() {
            showStatusMessage('æ­£åœ¨å„²å­˜è¨­å®š...', 'info');
            
            try {
                // é€™è£¡å¯ä»¥å¯¦ä½œå„²å­˜åˆ°è¨­å®šæª”çš„é‚è¼¯
                // ç›®å‰å…ˆæ›´æ–°è¨˜æ†¶é«”ä¸­çš„è¨­å®š
                if (window.APP_CONFIG && window.APP_CONFIG.notion) {
                    window.APP_CONFIG.notion.databaseIds = { ...currentConfig };
                }
                
                showStatusMessage('è¨­å®šå·²å„²å­˜ï¼è«‹è¨˜å¾—æ›´æ–° config.js æª”æ¡ˆ', 'success');
                
                // ç”Ÿæˆè¨­å®šä»£ç¢¼
                generateConfigCode();
                
            } catch (error) {
                showStatusMessage(`å„²å­˜å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦æ‰€æœ‰è³‡æ–™åº«é€£ç·š
        async function testAllDatabases() {
            showStatusMessage('æ­£åœ¨æ¸¬è©¦æ‰€æœ‰è³‡æ–™åº«é€£ç·š...', 'info');
            
            const databases = ['menu', 'orders', 'tables', 'inventory'];
            
            for (const dbType of databases) {
                const dbId = currentConfig[dbType];
                if (dbId && dbId !== `your-${dbType}-database-id`) {
                    try {
                        updateDatabaseStatus(dbType, 'pending');
                        
                        // æ¸¬è©¦è³‡æ–™åº«é€£ç·š (é€™è£¡å¯ä»¥å¯¦ä½œå¯¦éš›çš„æ¸¬è©¦é‚è¼¯)
                        await new Promise(resolve => setTimeout(resolve, 1000)); // æ¨¡æ“¬æ¸¬è©¦
                        
                        updateDatabaseStatus(dbType, 'success');
                    } catch (error) {
                        updateDatabaseStatus(dbType, 'error');
                    }
                } else {
                    updateDatabaseStatus(dbType, 'error');
                }
            }
            
            showStatusMessage('è³‡æ–™åº«é€£ç·šæ¸¬è©¦å®Œæˆ', 'success');
        }

        // å»ºç«‹ç¯„ä¾‹è³‡æ–™
        async function createSampleData() {
            showStatusMessage('æ­£åœ¨å»ºç«‹ç¯„ä¾‹è³‡æ–™...', 'info');
            
            try {
                if (window.notionManager) {
                    // å»ºç«‹ç¯„ä¾‹èœå–®
                    const sampleMenu = {
                        name: 'æ‹›ç‰Œç‚’é£¯',
                        category: 'ä¸»èœ',
                        price: 120,
                        description: 'ç¶“å…¸æ³°å¼ç‚’é£¯ï¼Œé¦™æ°£èª˜äºº',
                        available: true
                    };
                    
                    await window.notionManager.syncToNotion('menu', sampleMenu, 'create');
                    showStatusMessage('ç¯„ä¾‹è³‡æ–™å»ºç«‹æˆåŠŸï¼', 'success');
                } else {
                    throw new Error('Notion Manager æœªè¼‰å…¥');
                }
            } catch (error) {
                showStatusMessage(`å»ºç«‹ç¯„ä¾‹è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆè¨­å®šä»£ç¢¼
        function generateConfigCode() {
            const configCode = `
// è«‹å°‡ä»¥ä¸‹è¨­å®šæ›´æ–°åˆ°æ‚¨çš„ config.js æª”æ¡ˆä¸­
notion: {
    apiKey: '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',
    apiVersion: '2022-06-28',
    databaseIds: {
        menu: '${currentConfig.menu || 'your-menu-database-id'}',
        orders: '${currentConfig.orders || 'your-orders-database-id'}',
        tables: '${currentConfig.tables || 'your-tables-database-id'}',
        inventory: '${currentConfig.inventory || 'your-inventory-database-id'}',
        reservations: '${currentConfig.reservations || 'your-reservations-database-id'}',
        purchases: '${currentConfig.purchases || 'your-purchases-database-id'}',
        recipes: '${currentConfig.recipes || 'your-recipes-database-id'}',
        suppliers: '${currentConfig.suppliers || 'your-suppliers-database-id'}'
    }
}`;
            
            console.log(configCode);
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatusMessage(message, type) {
            const feedback = document.getElementById('status-feedback');
            const messageEl = document.getElementById('status-message');
            
            messageEl.textContent = message;
            feedback.style.display = 'block';
            
            // è‡ªå‹•éš±è—
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
