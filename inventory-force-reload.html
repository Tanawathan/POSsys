<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜ç®¡ç† - TANAWAT POS (å¼·åˆ¶æ›´æ–°ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- è¼‰å…¥ InventoryManager é¡åˆ¥ -->
    <script src="/assets/js/inventory-management.js"></script>
    <!-- åŠ å…¥æ™‚é–“æˆ³é˜²æ­¢å¿«å– -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-safe { background-color: #10b981; }
        .status-low { background-color: #f59e0b; }
        .status-critical { background-color: #ef4444; }
        .loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loading-indicator" class="loading-indicator">
        ğŸ”„ æ­£åœ¨è¼‰å…¥ Notion è³‡æ–™...
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- è¿”å›å°èˆªæŒ‰éˆ• -->
        <div class="mb-6 flex gap-3">
            <a href="../../index.html" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm flex items-center">
                â† ä¸»ç³»çµ±
            </a>
            <a href="../../main-dashboard.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center">
                ğŸ“Š å„€è¡¨æ¿
            </a>
        </div>
        
        <!-- é é¢æ¨™é¡Œ -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-warehouse text-blue-600 mr-3"></i>
                åº«å­˜ç®¡ç†ç³»çµ± (å¼·åˆ¶æ›´æ–°ç‰ˆ)
            </h1>
            <p class="text-gray-600">ç®¡ç†162é …é£Ÿæåº«å­˜ï¼Œä»¥å…¬å…‹ç‚ºä¸»è¦è¨ˆé‡å–®ä½ï¼Œç›£æ§å®‰å…¨åº«å­˜é‡ï¼Œå„ªåŒ–æ¡è³¼æ±ºç­–</p>
            <div id="system-status" class="mt-2 text-sm">
                ğŸ” æ­£åœ¨æª¢æŸ¥ç³»çµ±ç‹€æ…‹...
            </div>
        </div>

        <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">ç¸½å“é …æ•¸</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-items">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-boxes text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">å®‰å…¨åº«å­˜</p>
                        <p class="text-2xl font-bold text-green-600" id="safe-stock">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">åº«å­˜åä½</p>
                        <p class="text-2xl font-bold text-yellow-600" id="low-stock">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">æ€¥éœ€è£œè²¨</p>
                        <p class="text-2xl font-bold text-red-600" id="critical-stock">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="æœå°‹é£Ÿæåç¨±..." 
                               class="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 w-64">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    
                    <select id="supplier-filter" class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">æ‰€æœ‰ä¾›æ‡‰å•†</option>
                    </select>
                    
                    <select id="category-filter" class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">æ‰€æœ‰å“é …é¡åˆ¥</option>
                    </select>
                    
                    <select id="status-filter" class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">åº«å­˜ç‹€æ…‹</option>
                        <option value="safe">å®‰å…¨åº«å­˜</option>
                        <option value="low">åº«å­˜åä½</option>
                        <option value="critical">æ€¥éœ€è£œè²¨</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button id="force-reload-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-bomb mr-2"></i>å¼·åˆ¶é‡è¼‰
                    </button>
                    <button id="refresh-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>
        </div>

        <!-- åº«å­˜è¡¨æ ¼ -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">é£Ÿæåº«å­˜æ¸…å–®</h3>
                <div id="data-source-info" class="text-sm text-gray-500 mt-1">
                    è³‡æ–™ä¾†æºæª¢æŸ¥ä¸­...
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scrollbar" style="max-height: 600px;">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="select-all" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é£Ÿæåç¨±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¾›æ‡‰å•†</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¦æ ¼/å–®ä½</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº«å­˜é‡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å®‰å…¨åº«å­˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®ä½æˆæœ¬</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº«å­˜åƒ¹å€¼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€å¾Œé€²è²¨</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="11" class="px-6 py-8 text-center text-gray-500">
                                ğŸ”„ æ­£åœ¨è¼‰å…¥ Notion è³‡æ–™...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åˆ†é æ§åˆ¶ -->
        <div class="bg-white rounded-xl shadow-lg p-4 mt-6">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    é¡¯ç¤º <span id="showing-start">-</span> åˆ° <span id="showing-end">-</span> é …ï¼Œå…± <span id="total-count">è¼‰å…¥ä¸­</span> é …
                </div>
                <div class="flex space-x-2">
                    <button id="prev-page" class="px-4 py-2 border rounded-lg hover:bg-gray-50 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info" class="px-4 py-2">è¼‰å…¥ä¸­...</span>
                    <button id="next-page" class="px-4 py-2 border rounded-lg hover:bg-gray-50 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let inventoryManager = null;
        let isDataLoaded = false;
        const timestamp = Date.now();
        
        // ä½¿ç”¨ InventoryManager é¡åˆ¥è¼‰å…¥è³‡æ–™
        async function loadNotionData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const statusDiv = document.getElementById('system-status');
            const dataSourceDiv = document.getElementById('data-source-info');
            
            try {
                // æª¢æŸ¥ InventoryManager æ˜¯å¦å·²è¼‰å…¥
                if (typeof InventoryManager === 'undefined') {
                    throw new Error('InventoryManager é¡åˆ¥æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ JavaScript æ–‡ä»¶');
                }
                
                statusDiv.innerHTML = 'ğŸ”„ åˆå§‹åŒ– InventoryManager...';
               
                
                statusDiv.innerHTML = 'ğŸ”„ é€£æ¥ Notion API...';
                
                // ä½¿ç”¨ InventoryManager çš„ loadFromNotion æ–¹æ³•
                await inventoryManager.loadFromNotion();
                
                statusDiv.innerHTML = `âœ… æˆåŠŸè¼‰å…¥ ${inventoryManager.inventoryData.length} é … Notion è³‡æ–™`;
                dataSourceDiv.innerHTML = `ğŸ“¡ è³‡æ–™ä¾†æº: Notion API (${inventoryManager.inventoryData.length} é …) - ${new Date().toLocaleTimeString()}`;
                loadingIndicator.style.display = 'none';
                isDataLoaded = true;
                
                // æ¸²æŸ“è³‡æ–™
                renderTable();
                updateStatistics();
                
                // é¡¯ç¤ºå‰3é …ä½œç‚ºç¢ºèª
                const sampleNames = inventoryManager.inventoryData.slice(0, 3).map(item => item.name).join(', ');
                console.log(`âœ… è¼‰å…¥çš„é£Ÿæç¯„ä¾‹: ${sampleNames}`);
                
            } catch (error) {
                console.error('âŒ Notion è¼‰å…¥å¤±æ•—:', error);
                statusDiv.innerHTML = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
                dataSourceDiv.innerHTML = `âš ï¸ è³‡æ–™ä¾†æº: è¼‰å…¥å¤±æ•— - <a href="/inventory-debug.html" class="text-blue-600 underline">åŸ·è¡Œè¨ºæ–·</a>`;
                loadingIndicator.innerHTML = 'âŒ è¼‰å…¥å¤±æ•—';
                loadingIndicator.style.backgroundColor = '#ef4444';
                
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è³‡è¨Šå’Œå»ºè­°è§£æ±ºæ–¹æ¡ˆ
                const errorDetails = document.createElement('div');
                errorDetails.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                errorDetails.innerHTML = `
                    <h3 class="font-semibold text-red-800 mb-2">ğŸ”§ æ•…éšœæ’é™¤å»ºè­°</h3>
                    <div class="text-sm text-red-700 space-y-2">
                        <div>â€¢ <strong>æª¢æŸ¥ç¶²è·¯é€£æ¥:</strong> ç¢ºèªç¶²è·¯é€£æ¥æ­£å¸¸</div>
                        <div>â€¢ <strong>æª¢æŸ¥ API ç‹€æ…‹:</strong> <a href="/.netlify/functions/notion-api/health" target="_blank" class="text-blue-600 underline">æ¸¬è©¦ API ç«¯é»</a></div>
                        <div>â€¢ <strong>åŸ·è¡Œç³»çµ±è¨ºæ–·:</strong> <a href="/inventory-debug.html" class="text-blue-600 underline">é–‹å•Ÿè¨ºæ–·å·¥å…·</a></div>
                        <div>â€¢ <strong>éŒ¯èª¤è©³æƒ…:</strong> ${error.message}</div>
                        ${error.status ? `<div>â€¢ <strong>HTTP ç‹€æ…‹ç¢¼:</strong> ${error.status}</div>` : ''}
                    </div>
                    <button onclick="loadNotionData()" class="mt-3 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                        <i class="fas fa-redo"></i> é‡æ–°è¼‰å…¥
                    </button>
                `;
                statusDiv.appendChild(errorDetails);
            }
        }
        
        // æ ¼å¼åŒ–é‡é‡é¡¯ç¤º
        function formatWeight(grams) {
            if (!grams || grams === 0) return '0';
            if (grams >= 1000) {
                const kg = grams / 1000;
                return kg % 1 === 0 ? `${kg}` : `${kg.toFixed(1)}`;
            }
            return grams.toLocaleString();
        }
        
        // ç²å–é‡é‡å–®ä½
        function getWeightUnit(grams) {
            if (!grams || grams === 0) return 'å…¬å…‹';
            return grams >= 1000 ? 'å…¬æ–¤' : 'å…¬å…‹';
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('inventory-table-body');
            
            if (!isDataLoaded || !inventoryManager || inventoryManager.inventoryData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-8 text-center text-gray-500">ç„¡è³‡æ–™</td></tr>';
                return;
            }
            
            const statusConfig = {
                'critical': { class: 'text-red-600', text: 'ç¼ºè²¨', dot: 'status-critical' },
                'low': { class: 'text-yellow-600', text: 'åº«å­˜åä½', dot: 'status-low' },
                'safe': { class: 'text-green-600', text: 'å®‰å…¨åº«å­˜', dot: 'status-safe' }
            };
            
            const displayData = inventoryManager.inventoryData.slice(0, 20); // é¡¯ç¤ºå‰20é …
            
            tbody.innerHTML = displayData.map(item => {
                const config = statusConfig[item.status] || statusConfig.safe;
                const stockValue = (item.stock * item.unitCost).toFixed(2);
                
                // ç‚ºå…¬å…‹å–®ä½ä½¿ç”¨ç‰¹æ®Šæ ¼å¼åŒ–
                const displayStock = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    formatWeight(item.stock) : item.stock.toLocaleString();
                const displaySafetyStock = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    formatWeight(item.safetyStock) : item.safetyStock.toLocaleString();
                const stockUnit = item.unit === 'å…‹' || item.unit === 'å…¬å…‹' ? 
                    getWeightUnit(item.stock) : item.unit;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="rounded" data-id="${item.id}">
                        </td>
                        <td class="px-6 py-4">
                            <span class="status-dot ${config.dot}"></span>
                            <span class="${config.class} text-sm font-medium">
                                ${config.text}
                            </span>
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${item.name}
                            ${item.itemId ? `<br><span class="text-xs text-gray-500">${item.itemId}</span>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${item.supplier}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.specification}</td>
                        <td class="px-6 py-4">
                            <span class="font-semibold ${config.class}">
                                ${displayStock} ${stockUnit}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${displaySafetyStock} ${stockUnit}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">NT$ ${item.unitCost.toFixed(2)}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">NT$ ${stockValue}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.lastPurchase}</td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button class="text-blue-600 hover:text-blue-900 p-1" title="ç·¨è¼¯">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-900 p-1" title="åˆªé™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ›´æ–°çµ±è¨ˆ
        function updateStatistics() {
            if (!isDataLoaded || !inventoryManager) return;
            
            const stats = inventoryManager.inventoryData.reduce((acc, item) => {
                acc.total++;
                if (item.status === 'safe') acc.safe++;
                else if (item.status === 'low') acc.low++;
                else if (item.status === 'critical') acc.critical++;
                return acc;
            }, { total: 0, safe: 0, low: 0, critical: 0 });
            
            document.getElementById('total-items').textContent = stats.total;
            document.getElementById('safe-stock').textContent = stats.safe;
            document.getElementById('low-stock').textContent = stats.low;
            document.getElementById('critical-stock').textContent = stats.critical;
            
            document.getElementById('total-count').textContent = stats.total;
            document.getElementById('showing-start').textContent = '1';
            document.getElementById('showing-end').textContent = Math.min(20, stats.total);
            document.getElementById('page-info').textContent = `ç¬¬ 1 é ï¼Œå…± ${Math.ceil(stats.total / 20)} é `;
        }
        
        // å¼·åˆ¶é‡è¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // å¼·åˆ¶é‡è¼‰æŒ‰éˆ•
            document.getElementById('force-reload-btn').addEventListener('click', function() {
                location.reload(true);
            });
            
            // é‡æ–°æ•´ç†æŒ‰éˆ•
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadNotionData();
            });
            
            // é–‹å§‹è¼‰å…¥
            loadNotionData();
        });
    </script>
</body>
</html>
