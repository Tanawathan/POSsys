<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify API æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Netlify API é€£æ¥æ¸¬è©¦</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ç’°å¢ƒæª¢æ¸¬</h2>
            <div id="environment-info" class="space-y-2"></div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API æ¸¬è©¦</h2>
            <button id="test-api" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                æ¸¬è©¦ Notion API é€£æ¥
            </button>
            <div id="api-result" class="mt-4"></div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <pre id="test-log" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96"></pre>
        </div>
    </div>

    <script>
        // API èª¿ç”¨è¼”åŠ©å‡½æ•¸
        async function callNotionAPI(path, method = 'GET', body = null) {
            const isNetlify = window.location.hostname.includes('netlify.app') || 
                             window.location.hostname.includes('netlify.com') ||
                             !window.location.hostname.includes('localhost');
            
            log(`ğŸŒ æª¢æ¸¬ç’°å¢ƒ: ${isNetlify ? 'Netlify' : 'æœ¬åœ°é–‹ç™¼'}`);
            
            if (isNetlify) {
                log(`ğŸ“¡ ä½¿ç”¨ Netlify Functions: /.netlify/functions/notion-api`);
                return await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: path,
                        method: method,
                        body: body
                    })
                });
            } else {
                log(`ğŸ”§ ä½¿ç”¨æœ¬åœ° proxy-server: /api/notion${path}`);
                const fetchOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body && (method === 'POST' || method === 'PATCH')) {
                    fetchOptions.body = JSON.stringify(body);
                }
                
                return await fetch(`/api/notion${path}`, fetchOptions);
            }
        }

        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showEnvironmentInfo() {
            const envInfo = document.getElementById('environment-info');
            const isNetlify = window.location.hostname.includes('netlify.app') || 
                             window.location.hostname.includes('netlify.com') ||
                             !window.location.hostname.includes('localhost');
            
            envInfo.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">ç’°å¢ƒ:</span>
                    <span class="px-2 py-1 rounded text-sm ${isNetlify ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                        ${isNetlify ? 'Netlify éƒ¨ç½²' : 'æœ¬åœ°é–‹ç™¼'}
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">ä¸»æ©Ÿå:</span>
                    <span class="text-gray-600">${window.location.hostname}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">å®Œæ•´ URL:</span>
                    <span class="text-gray-600">${window.location.href}</span>
                </div>
            `;
        }

        async function testAPI() {
            const button = document.getElementById('test-api');
            const result = document.getElementById('api-result');
            
            button.disabled = true;
            button.textContent = 'æ¸¬è©¦ä¸­...';
            result.innerHTML = '';
            
            try {
                log('ğŸš€ é–‹å§‹æ¸¬è©¦ Notion API é€£æ¥...');
                
                // æ¸¬è©¦è¨‚å–®è³‡æ–™åº«æŸ¥è©¢
                const response = await callNotionAPI('/databases/23afd5adc30b80c39e71d1a640ccfb5d/query', 'POST', {
                    page_size: 5
                });
                
                log(`ğŸ“Š API å›æ‡‰ç‹€æ…‹: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… API èª¿ç”¨æˆåŠŸï¼`);
                    log(`ğŸ“‹ ç²å¾— ${data.results ? data.results.length : 0} ç­†è¨‚å–®è¨˜éŒ„`);
                    
                    result.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <strong>âœ… æ¸¬è©¦æˆåŠŸï¼</strong><br>
                            æˆåŠŸé€£æ¥åˆ° Notion APIï¼Œç²å¾— ${data.results ? data.results.length : 0} ç­†è¨˜éŒ„
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    log(`âŒ API èª¿ç”¨å¤±æ•—: ${response.status}`);
                    log(`ğŸ” éŒ¯èª¤è©³æƒ…: ${JSON.stringify(errorData, null, 2)}`);
                    
                    result.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong>âŒ æ¸¬è©¦å¤±æ•—</strong><br>
                            ç‹€æ…‹ç¢¼: ${response.status}<br>
                            éŒ¯èª¤: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`ğŸ’¥ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                result.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                        <strong>âš ï¸ é€£æ¥éŒ¯èª¤</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.textContent = 'æ¸¬è©¦ Notion API é€£æ¥';
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showEnvironmentInfo();
            log('ğŸ¯ é é¢è¼‰å…¥å®Œæˆï¼Œæº–å‚™é€²è¡Œæ¸¬è©¦');
            
            document.getElementById('test-api').addEventListener('click', testAPI);
        });
    </script>
</body>
</html>