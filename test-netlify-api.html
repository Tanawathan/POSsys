<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify API 測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Netlify API 連接測試</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">環境檢測</h2>
            <div id="environment-info" class="space-y-2"></div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API 測試</h2>
            <button id="test-api" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                測試 Notion API 連接
            </button>
            <div id="api-result" class="mt-4"></div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">測試結果</h2>
            <pre id="test-log" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96"></pre>
        </div>
    </div>

    <script>
        // API 調用輔助函數
        async function callNotionAPI(path, method = 'GET', body = null) {
            const isNetlify = window.location.hostname.includes('netlify.app') || 
                             window.location.hostname.includes('netlify.com') ||
                             !window.location.hostname.includes('localhost');
            
            log(`🌐 檢測環境: ${isNetlify ? 'Netlify' : '本地開發'}`);
            
            if (isNetlify) {
                log(`📡 使用 Netlify Functions: /.netlify/functions/notion-api`);
                return await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: path,
                        method: method,
                        body: body
                    })
                });
            } else {
                log(`🔧 使用本地 proxy-server: /api/notion${path}`);
                const fetchOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body && (method === 'POST' || method === 'PATCH')) {
                    fetchOptions.body = JSON.stringify(body);
                }
                
                return await fetch(`/api/notion${path}`, fetchOptions);
            }
        }

        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showEnvironmentInfo() {
            const envInfo = document.getElementById('environment-info');
            const isNetlify = window.location.hostname.includes('netlify.app') || 
                             window.location.hostname.includes('netlify.com') ||
                             !window.location.hostname.includes('localhost');
            
            envInfo.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">環境:</span>
                    <span class="px-2 py-1 rounded text-sm ${isNetlify ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                        ${isNetlify ? 'Netlify 部署' : '本地開發'}
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">主機名:</span>
                    <span class="text-gray-600">${window.location.hostname}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">完整 URL:</span>
                    <span class="text-gray-600">${window.location.href}</span>
                </div>
            `;
        }

        async function testAPI() {
            const button = document.getElementById('test-api');
            const result = document.getElementById('api-result');
            
            button.disabled = true;
            button.textContent = '測試中...';
            result.innerHTML = '';
            
            try {
                log('🚀 開始測試 Notion API 連接...');
                
                // 測試訂單資料庫查詢
                const response = await callNotionAPI('/databases/23afd5adc30b80c39e71d1a640ccfb5d/query', 'POST', {
                    page_size: 5
                });
                
                log(`📊 API 回應狀態: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ API 調用成功！`);
                    log(`📋 獲得 ${data.results ? data.results.length : 0} 筆訂單記錄`);
                    
                    result.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <strong>✅ 測試成功！</strong><br>
                            成功連接到 Notion API，獲得 ${data.results ? data.results.length : 0} 筆記錄
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    log(`❌ API 調用失敗: ${response.status}`);
                    log(`🔍 錯誤詳情: ${JSON.stringify(errorData, null, 2)}`);
                    
                    result.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong>❌ 測試失敗</strong><br>
                            狀態碼: ${response.status}<br>
                            錯誤: ${errorData.message || '未知錯誤'}
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`💥 測試過程中發生錯誤: ${error.message}`);
                result.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                        <strong>⚠️ 連接錯誤</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.textContent = '測試 Notion API 連接';
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            showEnvironmentInfo();
            log('🎯 頁面載入完成，準備進行測試');
            
            document.getElementById('test-api').addEventListener('click', testAPI);
        });
    </script>
</body>
</html>