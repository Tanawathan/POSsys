<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…æ–¹ç®¡ç†æ¸¬è©¦ - Debugç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            é…æ–¹ç®¡ç† Debug æ¸¬è©¦
        </h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- æ¸¬è©¦æ§åˆ¶ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦æ§åˆ¶</h2>
                <div class="space-y-3">
                    <button id="test-basic-api" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                        ğŸ”— æ¸¬è©¦åŸºæœ¬ API é€£æ¥
                    </button>
                    <button id="test-manager-load" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                        ğŸ“Š æ¸¬è©¦ç®¡ç†å™¨è¼‰å…¥
                    </button>
                    <button id="test-full-system" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">
                        ğŸš€ å®Œæ•´ç³»çµ±æ¸¬è©¦
                    </button>
                </div>
            </div>
            
            <!-- æ¸¬è©¦çµæœ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
                <div id="test-output" class="space-y-2 text-sm">
                    æº–å‚™é–‹å§‹æ¸¬è©¦...
                </div>
            </div>
        </div>
        
        <!-- è³‡æ–™å±•ç¤º -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">è³‡æ–™é è¦½</h2>
            <div id="data-display" class="text-sm text-gray-600">
                ç­‰å¾…è³‡æ–™è¼‰å…¥...
            </div>
        </div>
    </div>

    <!-- å…§åµŒ RecipeNotionManager -->
    <script>
        class RecipeNotionManager {
            constructor() {
                this.baseUrl = '/api/notion/databases';
                this.recipesDbId = '237fd5adc30b80c09b59c03cd67c6432';
                this.ingredientsDbId = '237fd5adc30b80f7aedfe94804d80218';
                this.recipesData = [];
                this.ingredientsData = [];
                this.isDataLoaded = false;
            }

            async loadDatabaseData(databaseId, databaseName = '') {
                console.log(`ğŸ”„ é–‹å§‹è¼‰å…¥ ${databaseName} è³‡æ–™åº«...`);
                
                let allResults = [];
                let hasMore = true;
                let startCursor = null;
                let pageCount = 0;
                
                try {
                    while (hasMore) {
                        pageCount++;
                        console.log(`ğŸ“„ è¼‰å…¥ ${databaseName} ç¬¬ ${pageCount} é ...`);
                        
                        const requestBody = {
                            page_size: 100
                        };
                        
                        // åªæœ‰ç•¶ startCursor ä¸ç‚ºç©ºæ™‚æ‰æ·»åŠ åˆ°è«‹æ±‚ä¸­
                        if (startCursor) {
                            requestBody.start_cursor = startCursor;
                        }
                        
                        const response = await fetch(`${this.baseUrl}/${databaseId}/query?t=${Date.now()}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const pageData = await response.json();
                        allResults = allResults.concat(pageData.results);
                        hasMore = pageData.has_more;
                        startCursor = pageData.next_cursor;
                        
                        addLog(`âœ… ${databaseName} ç¬¬ ${pageCount} é è¼‰å…¥å®Œæˆï¼Œç´¯è¨ˆ ${allResults.length} é …`);
                    }
                    
                    console.log(`ğŸ‰ ${databaseName} è³‡æ–™è¼‰å…¥å®Œæˆï¼Œç¸½è¨ˆ ${allResults.length} é …`);
                    return allResults;
                    
                } catch (error) {
                    console.error(`âŒ è¼‰å…¥ ${databaseName} å¤±æ•—:`, error);
                    throw error;
                }
            }

            async loadRecipes() {
                const rawData = await this.loadDatabaseData(this.recipesDbId, 'åŠæˆå“é…æ–¹è³‡æ–™åº«');
                
                this.recipesData = rawData.map((item, index) => {
                    const properties = item.properties;
                    
                    return {
                        id: item.id,
                        name: properties['åç¨±']?.title?.[0]?.plain_text || `é…æ–¹-${index + 1}`,
                        weight: properties['é‡é‡']?.rollup?.number || 0,
                        totalCost: properties['ç¸½ç‰©æ–™æˆæœ¬']?.rollup?.number || 0,
                        unitCost: properties['å…ƒ/100g']?.formula?.number || 0,
                        currentStock: properties['å¯¦éš›åº«å­˜é‡']?.number || 0,
                        maxProduction: properties['ç¸½å¯è£½ä½œä»½æ•¸']?.rollup?.number || 0,
                        category: this.extractCategoryFromName(properties['åç¨±']?.title?.[0]?.plain_text || ''),
                        lastUpdated: item.last_edited_time
                    };
                });
                
                console.log(`âœ… åŠæˆå“é…æ–¹è™•ç†å®Œæˆ: ${this.recipesData.length} é …é…æ–¹`);
                return this.recipesData;
            }

            async loadIngredients() {
                const rawData = await this.loadDatabaseData(this.ingredientsDbId, 'åŠæˆå“çµ„æˆé …ç›®è³‡æ–™åº«');
                
                this.ingredientsData = rawData.map((item, index) => {
                    const properties = item.properties;
                    
                    return {
                        id: item.id,
                        name: properties['é …ç›®åç¨±']?.title?.[0]?.plain_text || `çµ„æˆé …ç›®-${index + 1}`,
                        usageAmount: properties['ä½¿ç”¨æ•¸é‡(å…‹)']?.number || 0,
                        itemCost: properties['é …ç›®æˆæœ¬']?.formula?.number || 0,
                        ingredientStock: properties['é£Ÿæåº«å­˜é‡']?.rollup?.number || 0,
                        maxProduciblePieces: properties['å–®é …å¯è£½ä½œä»½æ•¸']?.formula?.number || 0,
                        lastUpdated: item.last_edited_time
                    };
                });
                
                console.log(`âœ… åŠæˆå“çµ„æˆé …ç›®è™•ç†å®Œæˆ: ${this.ingredientsData.length} é …çµ„æˆé …ç›®`);
                return this.ingredientsData;
            }

            extractCategoryFromName(name) {
                if (!name) return 'å…¶ä»–';
                
                const categoryMap = {
                    'é†¬': 'é†¬æ–™',
                    'æ¹¯': 'æ¹¯å“', 
                    'é£¯': 'ä¸»èœ',
                    'éºµ': 'ä¸»èœ',
                    'ç²‰': 'ä¸»èœ'
                };
                
                for (const [keyword, category] of Object.entries(categoryMap)) {
                    if (name.includes(keyword)) {
                        return category;
                    }
                }
                
                return 'å…¶ä»–';
            }

            async loadAllData() {
                try {
                    console.log('ğŸš€ é–‹å§‹è¼‰å…¥é…æ–¹ç®¡ç†ç³»çµ±è³‡æ–™...');
                    this.isDataLoaded = false;
                    
                    const [recipes, ingredients] = await Promise.all([
                        this.loadRecipes(),
                        this.loadIngredients()
                    ]);
                    
                    this.isDataLoaded = true;
                    console.log('ğŸ‰ é…æ–¹ç®¡ç†ç³»çµ±è³‡æ–™è¼‰å…¥å®Œæˆï¼');
                    
                    return {
                        recipes: this.recipesData,
                        ingredients: this.ingredientsData,
                        summary: {
                            totalRecipes: recipes.length,
                            totalIngredients: ingredients.length
                        }
                    };
                    
                } catch (error) {
                    console.error('âŒ é…æ–¹è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
                    this.isDataLoaded = false;
                    throw error;
                }
            }
        }

        // æ¸¬è©¦å‡½æ•¸
        let testManager;

        function addLog(message) {
            const output = document.getElementById('test-output');
            const div = document.createElement('div');
            div.className = 'p-2 bg-gray-50 rounded border-l-4 border-blue-500';
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function showData(data) {
            const display = document.getElementById('data-display');
            display.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">é…æ–¹é è¦½ (å‰5é …)</h3>
                        ${data.recipes.slice(0, 5).map(recipe => `
                            <div class="p-3 bg-blue-50 rounded border mb-2">
                                <div class="font-medium text-blue-800">${recipe.name}</div>
                                <div class="text-xs text-blue-600">
                                    åˆ†é¡: ${recipe.category} | é‡é‡: ${recipe.weight}g | 
                                    æˆæœ¬: $${recipe.unitCost.toFixed(2)}/100g
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">çµ„æˆé …ç›®é è¦½ (å‰5é …)</h3>
                        ${data.ingredients.slice(0, 5).map(ingredient => `
                            <div class="p-3 bg-green-50 rounded border mb-2">
                                <div class="font-medium text-green-800">${ingredient.name}</div>
                                <div class="text-xs text-green-600">
                                    ç”¨é‡: ${ingredient.usageAmount}g | æˆæœ¬: $${ingredient.itemCost.toFixed(2)} | 
                                    åº«å­˜: ${ingredient.ingredientStock}g
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-4 p-4 bg-gray-100 rounded">
                    <strong>çµ±è¨ˆç¸½çµ:</strong> 
                    ${data.summary.totalRecipes} é …é…æ–¹ï¼Œ${data.summary.totalIngredients} é …çµ„æˆé …ç›®
                </div>
            `;
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('test-basic-api').addEventListener('click', async () => {
            addLog('ğŸ”— é–‹å§‹æ¸¬è©¦åŸºæœ¬ API é€£æ¥...');
            try {
                const response = await fetch('/api/notion/databases/237fd5adc30b80c09b59c03cd67c6432/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_size: 3 })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                addLog(`âœ… API é€£æ¥æˆåŠŸï¼è¿”å› ${data.results.length} é …è³‡æ–™`);
                addLog(`ğŸ“ ç¬¬ä¸€é …é…æ–¹: ${data.results[0].properties.åç¨±.title[0].plain_text}`);
                
            } catch (error) {
                addLog(`âŒ API é€£æ¥å¤±æ•—: ${error.message}`);
            }
        });

        document.getElementById('test-manager-load').addEventListener('click', async () => {
            addLog('ğŸ“Š é–‹å§‹æ¸¬è©¦ç®¡ç†å™¨è¼‰å…¥...');
            try {
                testManager = new RecipeNotionManager();
                addLog('âœ… ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                
                const recipes = await testManager.loadRecipes();
                addLog(`âœ… é…æ–¹è¼‰å…¥å®Œæˆ: ${recipes.length} é …`);
                
                const ingredients = await testManager.loadIngredients();
                addLog(`âœ… çµ„æˆé …ç›®è¼‰å…¥å®Œæˆ: ${ingredients.length} é …`);
                
            } catch (error) {
                addLog(`âŒ ç®¡ç†å™¨è¼‰å…¥å¤±æ•—: ${error.message}`);
            }
        });

        document.getElementById('test-full-system').addEventListener('click', async () => {
            addLog('ğŸš€ é–‹å§‹å®Œæ•´ç³»çµ±æ¸¬è©¦...');
            try {
                testManager = new RecipeNotionManager();
                const data = await testManager.loadAllData();
                
                addLog('ğŸ‰ å®Œæ•´ç³»çµ±æ¸¬è©¦æˆåŠŸï¼');
                showData(data);
                
            } catch (error) {
                addLog(`âŒ å®Œæ•´ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        });
    </script>
</body>
</html>
