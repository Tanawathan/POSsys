<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é è¼‰å…¥æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ç’°å¢ƒé…ç½® -->
    <script src="/public/env-config.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ“‹ é£Ÿæåº«åˆ†é è¼‰å…¥æ¸¬è©¦</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“Š è¼‰å…¥é€²åº¦</h2>
                <div id="loading-progress" class="space-y-2">
                    <div class="text-gray-600">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“ˆ çµ±è¨ˆè³‡è¨Š</h2>
                <div id="statistics" class="space-y-2">
                    <div class="text-gray-600">ç­‰å¾…è¼‰å…¥...</div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”§ æ¸¬è©¦é¸é …</h2>
            <div class="flex gap-4">
                <button onclick="testPaginationLoad()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    ğŸ”„ æ¸¬è©¦åˆ†é è¼‰å…¥
                </button>
                <button onclick="testInventoryManager()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    ğŸ“¦ æ¸¬è©¦åº«å­˜ç®¡ç†å™¨
                </button>
                <button onclick="showSampleData()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    ğŸ‘ï¸ é¡¯ç¤ºç¯„ä¾‹è³‡æ–™
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è¼‰å…¥çš„é£Ÿææ¸…å–®ï¼ˆå‰20é …ï¼‰</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é£Ÿæåç¨±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¾›æ‡‰å•†</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¦æ ¼/å–®ä½</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">åº«å­˜é‡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="sample-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">é»æ“Šæ¸¬è©¦æŒ‰éˆ•è¼‰å…¥è³‡æ–™</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let loadedData = [];
        
        async function testPaginationLoad() {
            const progressDiv = document.getElementById('loading-progress');
            const statsDiv = document.getElementById('statistics');
            
            progressDiv.innerHTML = '<div class="text-blue-600">ğŸ”„ é–‹å§‹è¼‰å…¥...</div>';
            
            try {
                let allResults = [];
                let hasMore = true;
                let startCursor = null;
                let pageCount = 0;
                
                while (hasMore) {
                    pageCount++;
                    progressDiv.innerHTML += `<div>ğŸ“„ è¼‰å…¥ç¬¬ ${pageCount} é ...</div>`;
                    
                    const requestBody = startCursor ? 
                        JSON.stringify({ start_cursor: startCursor }) : 
                        JSON.stringify({});
                    
                    const response = await fetch("/.netlify/functions/notion-api/databases/237fd5adc30b808cbba3c03f8f2065fd/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: requestBody
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const pageData = await response.json();
                    allResults = allResults.concat(pageData.results);
                    hasMore = pageData.has_more;
                    startCursor = pageData.next_cursor;
                    
                    progressDiv.innerHTML += `<div class="text-green-600">âœ… ç¬¬ ${pageCount} é å®Œæˆ: ${pageData.results.length} é …ï¼Œç´¯è¨ˆ: ${allResults.length} é …</div>`;
                }
                
                loadedData = allResults;
                progressDiv.innerHTML += `<div class="text-green-600 font-bold">ğŸ‰ æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆï¼</div>`;
                
                // æ›´æ–°çµ±è¨ˆ
                updateStatistics(allResults);
                
            } catch (error) {
                progressDiv.innerHTML += `<div class="text-red-600">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        async function testInventoryManager() {
            const progressDiv = document.getElementById('loading-progress');
            
            progressDiv.innerHTML = '<div class="text-blue-600">ğŸ”„ æ¸¬è©¦åº«å­˜ç®¡ç†å™¨...</div>';
            
            try {
                // ç­‰å¾… InventoryManager è¼‰å…¥
                if (typeof InventoryManager === 'undefined') {
                    progressDiv.innerHTML += '<div class="text-red-600">âŒ InventoryManager æœªè¼‰å…¥</div>';
                    return;
                }
                
                const manager = new InventoryManager(false);
                await manager.loadFromNotion();
                
                loadedData = manager.inventoryData;
                progressDiv.innerHTML += `<div class="text-green-600">âœ… åº«å­˜ç®¡ç†å™¨æ¸¬è©¦å®Œæˆ: ${manager.inventoryData.length} é …</div>`;
                
                updateStatistics(manager.inventoryData);
                showSampleData(manager.inventoryData);
                
            } catch (error) {
                progressDiv.innerHTML += `<div class="text-red-600">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        function updateStatistics(data) {
            const statsDiv = document.getElementById('statistics');
            
            const total = data.length;
            const suppliers = [...new Set(data.map(item => 
                item.properties?.['ä¾›æ‡‰å•†']?.select?.name || 
                item.supplier || 'æœªçŸ¥'
            ))];
            
            const stockStatus = data.reduce((acc, item) => {
                const stock = item.properties?.['åº«å­˜é‡']?.number || item.stock || 0;
                const safetyStock = item.properties?.['å®‰å…¨åº«å­˜é‡']?.number || item.safetyStock || 100;
                
                if (stock === 0) acc.critical++;
                else if (stock <= safetyStock) acc.low++;
                else acc.safe++;
                
                return acc;
            }, { safe: 0, low: 0, critical: 0 });
            
            statsDiv.innerHTML = `
                <div><strong>ç¸½é …ç›®æ•¸:</strong> ${total}</div>
                <div><strong>ä¾›æ‡‰å•†æ•¸é‡:</strong> ${suppliers.length}</div>
                <div><strong>å®‰å…¨åº«å­˜:</strong> <span class="text-green-600">${stockStatus.safe}</span></div>
                <div><strong>åº«å­˜åä½:</strong> <span class="text-yellow-600">${stockStatus.low}</span></div>
                <div><strong>æ€¥éœ€è£œè²¨:</strong> <span class="text-red-600">${stockStatus.critical}</span></div>
                <div class="mt-2"><strong>ä¾›æ‡‰å•†:</strong> ${suppliers.join(', ')}</div>
            `;
        }
        
        function showSampleData(data = loadedData) {
            const tableBody = document.getElementById('sample-table');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ç„¡è³‡æ–™</td></tr>';
                return;
            }
            
            const sample = data.slice(0, 20);
            
            tableBody.innerHTML = sample.map((item, index) => {
                const name = item.properties ? 
                    (item.properties['é£Ÿæåç¨±']?.rich_text?.[0]?.text?.content || 
                     item.properties['å“é …ID']?.title?.[0]?.text?.content) :
                    item.name;
                
                const supplier = item.properties ? 
                    item.properties['ä¾›æ‡‰å•†']?.select?.name :
                    item.supplier;
                
                const spec = item.properties ? 
                    item.properties['è¦æ ¼/å–®ä½']?.rich_text?.[0]?.text?.content :
                    item.specification;
                
                const stock = item.properties ? 
                    item.properties['åº«å­˜é‡']?.number :
                    item.stock;
                
                const status = stock === 0 ? 'ç¼ºè²¨' : stock <= 100 ? 'åä½' : 'æ­£å¸¸';
                const statusColor = stock === 0 ? 'text-red-600' : stock <= 100 ? 'text-yellow-600' : 'text-green-600';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                        <td class="px-4 py-3 font-medium">${name || 'æœªå‘½å'}</td>
                        <td class="px-4 py-3 text-sm">${supplier || 'æœªçŸ¥'}</td>
                        <td class="px-4 py-3 text-sm">${spec || '-'}</td>
                        <td class="px-4 py-3 text-sm">${stock || 0}</td>
                        <td class="px-4 py-3 text-sm ${statusColor}">${status}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
    
    <!-- è¼‰å…¥åº«å­˜ç®¡ç†å™¨ç”¨æ–¼æ¸¬è©¦ -->
    <script src="/config/config.js"></script>
    <script src="/assets/js/notion-manager.js"></script>
    <script src="/assets/js/inventory-management.js"></script>
</body>
</html>
