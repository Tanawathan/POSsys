<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®æäº¤æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">ğŸ§ª è¨‚å–®æäº¤åŠŸèƒ½æ¸¬è©¦</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- æ¸¬è©¦è¨‚å–®å»ºç«‹ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“ æ¸¬è©¦è¨‚å–®å»ºç«‹</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">æ¡Œè™Ÿ</label>
                        <input type="text" id="testTableNumber" value="æ¸¬è©¦æ¡Œ1" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">ç¸½é‡‘é¡</label>
                        <input type="number" id="testTotalPrice" value="350" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">å‚™è¨»</label>
                        <textarea id="testNotes" placeholder="æ¸¬è©¦å‚™è¨»..." 
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg"></textarea>
                    </div>
                    
                    <button onclick="testCreateOrder()" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ğŸš€ æ¸¬è©¦å»ºç«‹è¨‚å–®
                    </button>
                </div>
                
                <div id="createResult" class="mt-4 p-3 bg-gray-700 rounded-lg hidden">
                    <h3 class="font-semibold mb-2">ğŸ“‹ å»ºç«‹çµæœ:</h3>
                    <pre id="createResultData" class="text-sm text-green-400"></pre>
                </div>
            </div>
            
            <!-- æ¸¬è©¦è¨‚å–®æŸ¥è©¢ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ” æ¸¬è©¦è¨‚å–®æŸ¥è©¢</h2>
                
                <button onclick="testQueryOrders()" 
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mb-4">
                    ğŸ“Š æŸ¥è©¢æ‰€æœ‰è¨‚å–®
                </button>
                
                <div id="queryResult" class="mt-4 p-3 bg-gray-700 rounded-lg hidden">
                    <h3 class="font-semibold mb-2">ğŸ“‹ æŸ¥è©¢çµæœ:</h3>
                    <div id="queryResultData" class="text-sm"></div>
                </div>
            </div>
        </div>
        
        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div class="mt-8 bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”§ ç³»çµ±ç‹€æ…‹</h2>
            <div id="systemStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">ä¼ºæœå™¨ç‹€æ…‹</div>
                    <div id="serverStatus" class="text-lg font-semibold">æª¢æŸ¥ä¸­...</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">Notion é€£æ¥</div>
                    <div id="notionStatus" class="text-lg font-semibold">æª¢æŸ¥ä¸­...</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">è³‡æ–™åº«ç‹€æ…‹</div>
                    <div id="databaseStatus" class="text-lg font-semibold">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- æ—¥èªŒ -->
        <div class="mt-8 bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š æ¸¬è©¦æ—¥èªŒ</h2>
            <div id="testLog" class="bg-black rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                <div class="text-green-400">ğŸš€ æ¸¬è©¦ç³»çµ±å·²å•Ÿå‹•</div>
            </div>
        </div>
    </div>

    <script>
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-white',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-white';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ¸¬è©¦å»ºç«‹è¨‚å–®
        async function testCreateOrder() {
            const tableNumber = document.getElementById('testTableNumber').value;
            const totalPrice = parseInt(document.getElementById('testTotalPrice').value);
            const notes = document.getElementById('testNotes').value;
            
            log(`ğŸ§ª é–‹å§‹æ¸¬è©¦è¨‚å–®å»ºç«‹ - æ¡Œè™Ÿ: ${tableNumber}, é‡‘é¡: ${totalPrice}`);
            
            try {
                // æ¨¡æ“¬è¨‚å–®é …ç›®
                const testItems = [
                    { name: 'æ‰“æ‹‹è±¬é£¯', quantity: 1, price: 220, note: { spiciness: 'å¾®è¾£' } },
                    { name: 'æ³°å¼å¥¶èŒ¶', quantity: 2, price: 80, note: { ice: 'å°‘å†°', sugar: 'åŠç³–' } }
                ];
                
                // æº–å‚™è¨‚å–®è³‡æ–™
                const orderData = {
                    è¨‚å–®ç·¨è™Ÿ: `TEST-${Date.now().toString().slice(-8)}`,
                    æ¡Œè™Ÿ: tableNumber,
                    ç‹€æ…‹: 'é€²è¡Œä¸­',
                    ç¸½é‡‘é¡: totalPrice,
                    è¨‚å–®é …ç›®: testItems.map(item => 
                        `${item.name} x${item.quantity} - NT$${item.price * item.quantity}`
                    ).join('\n'),
                    'è¨‚å–®é …ç›®(JSON)': JSON.stringify({ items: testItems, totalPrice: totalPrice }),
                    å»ºç«‹æ™‚é–“: new Date().toISOString(),
                    ç”¨é¤äººæ•¸: 1,
                    å‚™è¨»: notes || 'æ¸¬è©¦è¨‚å–®'
                };
                
                log('ğŸ“¤ ç™¼é€è¨‚å–®è³‡æ–™åˆ° Notion API...');
                
                // ç™¼é€åˆ° Notion
                const response = await fetch('/api/notion/pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent: { database_id: '23afd5adc30b80c39e71d1a640ccfb5d' },
                        properties: {
                            è¨‚å–®ç·¨è™Ÿ: { title: [{ text: { content: orderData.è¨‚å–®ç·¨è™Ÿ } }] },
                            æ¡Œè™Ÿ: { rich_text: [{ text: { content: orderData.æ¡Œè™Ÿ } }] },
                            ç‹€æ…‹: { select: { name: 'é€²è¡Œä¸­' } },
                            ç¸½é‡‘é¡: { number: orderData.ç¸½é‡‘é¡ },
                            è¨‚å–®é …ç›®: { rich_text: [{ text: { content: orderData.è¨‚å–®é …ç›® } }] },
                            å»ºç«‹æ™‚é–“: { date: { start: orderData.å»ºç«‹æ™‚é–“ } },
                            ç”¨é¤äººæ•¸: { number: orderData.ç”¨é¤äººæ•¸ },
                            å‚™è¨»: { rich_text: [{ text: { content: orderData.å‚™è¨» } }] },
                            ä»˜æ¬¾ç‹€æ…‹: { select: { name: 'æœªä»˜æ¬¾' } },
                            æœå‹™ç”Ÿ: { rich_text: [{ text: { content: 'ç³»çµ±æ¸¬è©¦' } }] }
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼', 'success');
                    
                    document.getElementById('createResult').classList.remove('hidden');
                    document.getElementById('createResultData').textContent = JSON.stringify({
                        orderId: orderData.è¨‚å–®ç·¨è™Ÿ,
                        pageId: result.id,
                        status: 'æˆåŠŸå»ºç«‹'
                    }, null, 2);
                    
                } else {
                    const error = await response.text();
                    log(`âŒ è¨‚å–®å»ºç«‹å¤±æ•—: ${response.status} ${error}`, 'error');
                    
                    document.getElementById('createResult').classList.remove('hidden');
                    document.getElementById('createResultData').textContent = `éŒ¯èª¤: ${error}`;
                }
                
            } catch (error) {
                log(`âŒ è¨‚å–®å»ºç«‹ç•°å¸¸: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æ¸¬è©¦æŸ¥è©¢è¨‚å–®
        async function testQueryOrders() {
            log('ğŸ” æŸ¥è©¢æ‰€æœ‰è¨‚å–®...');
            
            try {
                const response = await fetch('/api/notion/databases/23afd5adc30b80c39e71d1a640ccfb5d/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_size: 10,
                        sorts: [{ property: 'å»ºç«‹æ™‚é–“', direction: 'descending' }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… æŸ¥è©¢æˆåŠŸï¼Œæ‰¾åˆ° ${data.results.length} ç­†è¨‚å–®`, 'success');
                    
                    document.getElementById('queryResult').classList.remove('hidden');
                    
                    const ordersHtml = data.results.map(page => {
                        const props = page.properties;
                        const orderId = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || 'æœªçŸ¥';
                        const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 'æœªçŸ¥';
                        const status = props['ç‹€æ…‹']?.select?.name || 'æœªçŸ¥';
                        const total = props['ç¸½é‡‘é¡']?.number || 0;
                        
                        return `
                            <div class="bg-gray-600 rounded-lg p-3 mb-2">
                                <div class="font-semibold">${orderId}</div>
                                <div class="text-sm text-gray-300">æ¡Œè™Ÿ: ${tableNumber} | ç‹€æ…‹: ${status} | é‡‘é¡: NT$${total}</div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('queryResultData').innerHTML = ordersHtml || '<div class="text-gray-400">æ²’æœ‰æ‰¾åˆ°è¨‚å–®</div>';
                    
                } else {
                    const error = await response.text();
                    log(`âŒ æŸ¥è©¢å¤±æ•—: ${response.status} ${error}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ æŸ¥è©¢ç•°å¸¸: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        async function checkSystemStatus() {
            // æª¢æŸ¥ä¼ºæœå™¨
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = 'âœ… æ­£å¸¸';
                    document.getElementById('serverStatus').className = 'text-lg font-semibold text-green-400';
                } else {
                    document.getElementById('serverStatus').textContent = 'âŒ ç•°å¸¸';
                    document.getElementById('serverStatus').className = 'text-lg font-semibold text-red-400';
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = 'âŒ é›¢ç·š';
                document.getElementById('serverStatus').className = 'text-lg font-semibold text-red-400';
            }

            // æª¢æŸ¥ Notion é€£æ¥
            try {
                const response = await fetch('/api/test-notion');
                if (response.ok) {
                    document.getElementById('notionStatus').textContent = 'âœ… å·²é€£æ¥';
                    document.getElementById('notionStatus').className = 'text-lg font-semibold text-green-400';
                    log('âœ… Notion API é€£æ¥æ­£å¸¸', 'success');
                } else {
                    document.getElementById('notionStatus').textContent = 'âŒ é€£æ¥å¤±æ•—';
                    document.getElementById('notionStatus').className = 'text-lg font-semibold text-red-400';
                    log('âŒ Notion API é€£æ¥å¤±æ•—', 'error');
                }
            } catch (error) {
                document.getElementById('notionStatus').textContent = 'âŒ ç„¡æ³•é€£æ¥';
                document.getElementById('notionStatus').className = 'text-lg font-semibold text-red-400';
                log('âŒ Notion API ç„¡æ³•é€£æ¥', 'error');
            }

            // æª¢æŸ¥è³‡æ–™åº«
            try {
                const response = await fetch('/api/notion/databases/23afd5adc30b80c39e71d1a640ccfb5d/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_size: 1 })
                });
                
                if (response.ok) {
                    document.getElementById('databaseStatus').textContent = 'âœ… å¯è¨ªå•';
                    document.getElementById('databaseStatus').className = 'text-lg font-semibold text-green-400';
                    log('âœ… è¨‚å–®è³‡æ–™åº«å¯æ­£å¸¸è¨ªå•', 'success');
                } else {
                    document.getElementById('databaseStatus').textContent = 'âŒ è¨ªå•å¤±æ•—';
                    document.getElementById('databaseStatus').className = 'text-lg font-semibold text-red-400';
                    log('âŒ è¨‚å–®è³‡æ–™åº«è¨ªå•å¤±æ•—', 'error');
                }
            } catch (error) {
                document.getElementById('databaseStatus').textContent = 'âŒ ç„¡æ³•è¨ªå•';
                document.getElementById('databaseStatus').className = 'text-lg font-semibold text-red-400';
                log('âŒ è¨‚å–®è³‡æ–™åº«ç„¡æ³•è¨ªå•', 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ åˆå§‹åŒ–æ¸¬è©¦ç³»çµ±...');
            checkSystemStatus();
        });
    </script>
</body>
</html>
