<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ“± æ‰‹æ©Ÿé»é¤ç³»çµ± - Tanawat Restaurant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .menu-item {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .menu-item:active {
            transform: scale(0.98);
        }
        .category-tab {
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .category-tab.active {
            background: #3b82f6;
            color: white;
        }
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
        .cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .cart-panel {
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .cart-panel.show {
            transform: translateY(0);
        }
        .quantity-control {
            display: flex;
            align-items: center;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-weight: bold;
            transition: all 0.1s;
        }
        .quantity-btn:active {
            transform: scale(0.9);
        }
        .category-scroll {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <!-- æ‰‹æ©Ÿå°ˆç”¨é ­éƒ¨ -->
    <header class="mobile-header bg-white shadow-sm border-b">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-gray-900">ğŸ½ï¸ é»é¤ç³»çµ±</h1>
                    <p class="text-xs text-gray-500" id="tableInfo">è«‹é¸æ“‡æ¡Œè™Ÿ</p>
                </div>
                <button id="refreshBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
                    ğŸ”„
                </button>
            </div>
        </div>
    </header>

    <!-- æ¡Œè™Ÿé¸æ“‡ï¼ˆåˆå§‹ç‹€æ…‹ï¼‰ -->
    <div id="tableSelection" class="p-4">
        <div class="bg-white rounded-lg p-4 mb-4">
            <h2 class="text-lg font-semibold mb-3">ğŸª‘ é¸æ“‡æ¡Œè™Ÿ</h2>
            <div id="tableGrid" class="grid grid-cols-3 gap-3">
                <!-- è¼‰å…¥ä¸­ -->
                <div class="col-span-3 text-center py-8">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <p class="text-sm text-gray-500">è¼‰å…¥æ¡Œä½...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦é»é¤ç•Œé¢ -->
    <div id="orderingInterface" class="hidden">
        <!-- åˆ†é¡æ¨™ç±¤ -->
        <div class="bg-white border-b px-4 py-2">
            <div class="category-scroll flex space-x-2 overflow-x-auto">
                <button class="category-tab px-4 py-2 rounded-full text-sm font-medium bg-blue-500 text-white" data-category="all">
                    å…¨éƒ¨
                </button>
                <button class="category-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100" data-category="appetizer">
                    ğŸ¥— é–‹èƒƒèœ
                </button>
                <button class="category-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100" data-category="main">
                    ğŸ– ä¸»é¤
                </button>
                <button class="category-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100" data-category="drink">
                    ğŸ¥¤ é£²å“
                </button>
                <button class="category-tab px-4 py-2 rounded-full text-sm font-medium bg-gray-100" data-category="dessert">
                    ğŸ° ç”œé»
                </button>
            </div>
        </div>

        <!-- èœå–®é …ç›® -->
        <div class="p-4">
            <!-- è¼‰å…¥ç‹€æ…‹ -->
            <div id="menuLoading" class="text-center py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p class="text-sm text-gray-500">è¼‰å…¥èœå–®...</p>
            </div>

            <!-- èœå–®åˆ—è¡¨ -->
            <div id="menuList" class="space-y-3 hidden"></div>

            <!-- éŒ¯èª¤ç‹€æ…‹ -->
            <div id="menuError" class="text-center py-8 hidden">
                <div class="text-4xl mb-2 text-red-400">âš ï¸</div>
                <p class="text-sm text-red-500 mb-3">è¼‰å…¥èœå–®å¤±æ•—</p>
                <button onclick="loadMenu()" class="bg-red-500 text-white px-4 py-2 rounded text-sm">
                    é‡è©¦
                </button>
            </div>
        </div>
    </div>

    <!-- è³¼ç‰©è»ŠæŒ‰éˆ• -->
    <button id="cartButton" class="cart-button bg-blue-500 text-white p-4 rounded-full shadow-lg hidden">
        <div class="flex items-center">
            <span class="text-2xl mr-2">ğŸ›’</span>
            <div class="text-left">
                <div class="text-xs">è³¼ç‰©è»Š</div>
                <div class="font-bold" id="cartCount">0</div>
            </div>
        </div>
    </button>

    <!-- è³¼ç‰©è»Šé¢æ¿ -->
    <div id="cartPanel" class="cart-panel fixed inset-x-0 bottom-0 bg-white rounded-t-lg shadow-lg max-h-96 overflow-hidden">
        <div class="p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">ğŸ›’ è³¼ç‰©è»Š</h3>
                <button id="closeCart" class="text-gray-400 text-xl">Ã—</button>
            </div>
            
            <!-- è³¼ç‰©è»Šå…§å®¹ -->
            <div id="cartContent" class="space-y-3 max-h-48 overflow-y-auto mb-4">
                <div class="text-center py-4 text-gray-500">
                    è³¼ç‰©è»Šæ˜¯ç©ºçš„
                </div>
            </div>
            
            <!-- ç¸½è¨ˆå’Œé€å‡º -->
            <div class="border-t pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold">ç¸½è¨ˆï¼š</span>
                    <span id="totalAmount" class="text-xl font-bold text-green-600">NT$ 0</span>
                </div>
                <div class="space-y-2">
                    <button id="submitOrder" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold disabled:bg-gray-300" disabled>
                        ğŸ“ é€å‡ºè¨‚å–®
                    </button>
                    <button id="clearCart" class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg">
                        ğŸ—‘ï¸ æ¸…ç©ºè³¼ç‰©è»Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨‚å–®ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 max-w-sm w-full max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-3">ğŸ“ ç¢ºèªè¨‚å–®</h3>
            <div class="text-sm text-gray-600 mb-4">
                <p>æ¡Œè™Ÿï¼š<span id="modalTableNumber" class="font-semibold text-blue-600"></span></p>
            </div>
            <div id="orderSummary" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-4">
                    <span class="font-semibold">ç¸½è¨ˆï¼š</span>
                    <span id="modalTotalAmount" class="font-bold text-green-600"></span>
                </div>
                <div class="flex space-x-2">
                    <button id="confirmOrder" class="flex-1 bg-green-600 text-white py-2 px-3 rounded text-sm font-semibold">
                        ç¢ºèªé€å‡º
                    </button>
                    <button id="cancelOrder" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæ¨¡æ…‹æ¡† -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center">
            <div class="text-6xl mb-4">âœ…</div>
            <h3 class="text-xl font-semibold mb-2">è¨‚å–®å·²é€å‡ºï¼</h3>
            <p class="text-gray-600 mb-4">æ‚¨çš„è¨‚å–®æ­£åœ¨æº–å‚™ä¸­</p>
            <div class="space-y-2">
                <button id="continueOrdering" class="w-full bg-blue-500 text-white py-2 rounded">
                    ç¹¼çºŒé»é¤
                </button>
                <button id="finishOrdering" class="w-full bg-gray-300 text-gray-700 py-2 rounded">
                    çµæŸé»é¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½® ===
        const VERSION = 'mobile-customer-v1.0-' + Date.now();
        console.log('ğŸ“± æ‰‹æ©Ÿé»é¤ç³»çµ±ç‰ˆæœ¬:', VERSION);

        // æ ¹æ“šç’°å¢ƒè‡ªå‹•åˆ‡æ› API è·¯å¾‘
        function getApiBase() {
            // Netlify Functions éƒ¨ç½²æ™‚ window.location.pathname æœƒä»¥ /.netlify/functions/ é–‹é ­
            if (window.location.hostname.endsWith('netlify.app') || window.location.origin.includes('netlify')) {
                return '/.netlify/functions/notion-api';
            }
            // å…¶ä»–æƒ…å¢ƒï¼ˆæœ¬åœ°é–‹ç™¼ï¼‰
            return `${window.location.origin}/api/notion`;
        }

        const CONFIG = {
            apiBase: getApiBase(),
            databases: {
                tables: '23afd5adc30b80fe86c9e086a54a0d61',
                menu: '23afd5adc30b80a2818ffeb6b2d22265',
                orders: '23afd5adc30b80c39e71d1a640ccfb5d'
            }
        };

        // === å…¨åŸŸè®Šæ•¸ ===
        let allTables = [];
        let allMenuItems = [];
        let selectedTableId = null;
        let selectedTableNumber = null;
        let cart = [];
        let currentCategory = 'all';

        // === API å‡½æ•¸ ===
        async function callNotionAPI(path, method = 'GET', body = null) {
            try {
                const response = await fetch(CONFIG.apiBase + path, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });

                if (!response.ok) {
                    throw new Error(`API éŒ¯èª¤: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('âŒ API å‘¼å«å¤±æ•—:', error);
                throw error;
            }
        }

        // === è³‡æ–™è¼‰å…¥ ===
        async function loadTables() {
            try {
                const data = await callNotionAPI(`/databases/${CONFIG.databases.tables}/query`, 'POST', {
                    page_size: 100,
                    sorts: [{ property: 'æ¡Œè™Ÿ', direction: 'ascending' }]
                });
                
                allTables = data.results || [];
                return allTables;
            } catch (error) {
                console.error('è¼‰å…¥æ¡Œä½å¤±æ•—:', error);
                throw error;
            }
        }

        async function loadMenu() {
            try {
                const data = await callNotionAPI(`/databases/${CONFIG.databases.menu}/query`, 'POST', {
                    page_size: 100,
                    filter: {
                        property: 'ç‹€æ…‹',
                        select: { equals: 'å¯ä¾›æ‡‰' }
                    },
                    sorts: [{ property: 'å“é …åç¨±', direction: 'ascending' }]
                });
                
                allMenuItems = data.results || [];
                return allMenuItems;
            } catch (error) {
                console.error('è¼‰å…¥èœå–®å¤±æ•—:', error);
                throw error;
            }
        }

        // === è³‡æ–™è§£æ ===
        function getProperty(obj, propName, type = 'text') {
            try {
                const prop = obj.properties?.[propName];
                if (!prop) return null;

                switch (type) {
                    case 'title': return prop.title?.[0]?.text?.content || null;
                    case 'text': return prop.rich_text?.[0]?.text?.content || null;
                    case 'number': return prop.number || 0;
                    case 'select': return prop.select?.name || null;
                    default: return null;
                }
            } catch (error) {
                return null;
            }
        }

        function parseTable(table) {
            return {
                id: table.id,
                number: getProperty(table, 'æ¡Œè™Ÿ', 'title'),
                status: getProperty(table, 'ç‹€æ…‹', 'select'),
                capacity: getProperty(table, 'å®¹ç´äººæ•¸', 'number')
            };
        }

        function parseMenuItem(item) {
            return {
                id: item.id,
                name: getProperty(item, 'å“é …åç¨±', 'title'),
                category: getProperty(item, 'åˆ†é¡', 'select'),
                price: getProperty(item, 'åƒ¹æ ¼', 'number'),
                description: getProperty(item, 'æè¿°', 'text'),
                status: getProperty(item, 'ç‹€æ…‹', 'select')
            };
        }

        // === UI æ¸²æŸ“ ===
        function renderTables() {
            const grid = document.getElementById('tableGrid');
            
            if (allTables.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-gray-500">æ²’æœ‰å¯ç”¨æ¡Œä½</div>';
                return;
            }

            const availableTables = allTables
                .map(parseTable)
                .filter(table => table.status === 'ç©ºé–’ä¸­' || table.status === 'ä½¿ç”¨ä¸­');

            if (availableTables.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-gray-500">æ²’æœ‰å¯ç”¨æ¡Œä½</div>';
                return;
            }

            grid.innerHTML = availableTables.map(table => `
                <button onclick="selectTable('${table.id}', '${table.number}')" 
                        class="p-4 border rounded-lg text-center hover:bg-blue-50 transition-colors">
                    <div class="text-2xl mb-1">ğŸª‘</div>
                    <div class="font-semibold">æ¡Œ ${table.number}</div>
                    <div class="text-xs text-gray-500">${table.capacity}äººæ¡Œ</div>
                    <div class="text-xs mt-1 px-2 py-1 rounded-full ${getTableStatusColor(table.status)}">
                        ${table.status}
                    </div>
                </button>
            `).join('');
        }

        function getTableStatusColor(status) {
            switch (status) {
                case 'ç©ºé–’ä¸­': return 'bg-green-100 text-green-800';
                case 'ä½¿ç”¨ä¸­': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function renderMenu() {
            const loading = document.getElementById('menuLoading');
            const list = document.getElementById('menuList');
            const error = document.getElementById('menuError');

            [loading, list, error].forEach(el => el.classList.add('hidden'));

            try {
                const filteredItems = allMenuItems
                    .map(parseMenuItem)
                    .filter(item => currentCategory === 'all' || getCategoryKey(item.category) === currentCategory);

                if (filteredItems.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-500">æ­¤åˆ†é¡æ²’æœ‰å•†å“</div>';
                    list.classList.remove('hidden');
                    return;
                }

                list.innerHTML = filteredItems.map(item => {
                    const cartItem = cart.find(c => c.id === item.id);
                    const quantity = cartItem ? cartItem.quantity : 0;
                    
                    return `
                        <div class="menu-item bg-white rounded-lg p-4 shadow-sm border">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-base mb-1">${item.name}</h3>
                                    <p class="text-sm text-gray-600 mb-2">${item.description || 'ç¾å‘³æ–™ç†'}</p>
                                    <div class="text-lg font-bold text-green-600">NT$ ${item.price}</div>
                                </div>
                                <div class="ml-4">
                                    ${quantity > 0 ? `
                                        <div class="quantity-control">
                                            <button class="quantity-btn" onclick="updateCart('${item.id}', ${quantity - 1})">-</button>
                                            <span class="px-3 font-semibold">${quantity}</span>
                                            <button class="quantity-btn" onclick="updateCart('${item.id}', ${quantity + 1})">+</button>
                                        </div>
                                    ` : `
                                        <button onclick="updateCart('${item.id}', 1)" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                            åŠ å…¥
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                list.classList.remove('hidden');
                
            } catch (error) {
                error.classList.remove('hidden');
            }
        }

        function getCategoryKey(category) {
            const mapping = {
                'é–‹èƒƒèœ': 'appetizer',
                'ä¸»é¤': 'main', 
                'é£²å“': 'drink',
                'ç”œé»': 'dessert'
            };
            return mapping[category] || 'other';
        }

        // === æ¡Œä½é¸æ“‡ ===
        function selectTable(tableId, tableNumber) {
            selectedTableId = tableId;
            selectedTableNumber = tableNumber;
            
            // æ›´æ–°è¡¨é ­è³‡è¨Š
            document.getElementById('tableInfo').textContent = `æ¡Œè™Ÿ: ${tableNumber}`;
            
            // éš±è—æ¡Œä½é¸æ“‡ï¼Œé¡¯ç¤ºé»é¤ç•Œé¢
            document.getElementById('tableSelection').classList.add('hidden');
            document.getElementById('orderingInterface').classList.remove('hidden');
            document.getElementById('cartButton').classList.remove('hidden');
            
            // è¼‰å…¥èœå–®
            initMenu();
        }

        // === åˆ†é¡åˆ‡æ› ===
        function switchCategory(category) {
            currentCategory = category;
            
            // æ›´æ–°åˆ†é¡æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-blue-500', 'text-white');
                tab.classList.add('bg-gray-100');
            });
            
            const activeTab = document.querySelector(`[data-category="${category}"]`);
            activeTab.classList.add('active', 'bg-blue-500', 'text-white');
            activeTab.classList.remove('bg-gray-100');
            
            renderMenu();
        }

        // === è³¼ç‰©è»ŠåŠŸèƒ½ ===
        function updateCart(itemId, quantity) {
            const menuItem = allMenuItems.find(item => item.id === itemId);
            if (!menuItem) return;

            const parsed = parseMenuItem(menuItem);
            const existingIndex = cart.findIndex(item => item.id === itemId);

            if (quantity <= 0) {
                if (existingIndex >= 0) {
                    cart.splice(existingIndex, 1);
                }
            } else {
                if (existingIndex >= 0) {
                    cart[existingIndex].quantity = quantity;
                } else {
                    cart.push({
                        id: itemId,
                        name: parsed.name,
                        price: parsed.price,
                        quantity: quantity
                    });
                }
            }

            updateCartDisplay();
            renderMenu(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ•¸é‡é¡¯ç¤º
        }

        function updateCartDisplay() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // æ›´æ–°è³¼ç‰©è»ŠæŒ‰éˆ•
            document.getElementById('cartCount').textContent = cartCount;
            
            // æ›´æ–°è³¼ç‰©è»Šå…§å®¹
            const cartContent = document.getElementById('cartContent');
            const submitBtn = document.getElementById('submitOrder');
            
            if (cart.length === 0) {
                cartContent.innerHTML = '<div class="text-center py-4 text-gray-500">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
                submitBtn.disabled = true;
            } else {
                cartContent.innerHTML = cart.map(item => `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-gray-500">NT$ ${item.price}</div>
                        </div>
                        <div class="quantity-control ml-4">
                            <button class="quantity-btn" onclick="updateCart('${item.id}', ${item.quantity - 1})">-</button>
                            <span class="px-3 font-semibold">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateCart('${item.id}', ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                `).join('');
                submitBtn.disabled = false;
            }
            
            document.getElementById('totalAmount').textContent = `NT$ ${totalAmount}`;
        }

        function showCart() {
            document.getElementById('cartPanel').classList.add('show');
        }

        function hideCart() {
            document.getElementById('cartPanel').classList.remove('show');
        }

        function clearCart() {
            cart = [];
            updateCartDisplay();
            renderMenu();
        }

        // === è¨‚å–®æäº¤ ===
        function showOrderModal() {
            if (cart.length === 0) return;

            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('modalTableNumber').textContent = selectedTableNumber;
            document.getElementById('modalTotalAmount').textContent = `NT$ ${totalAmount}`;
            
            const summary = document.getElementById('orderSummary');
            summary.innerHTML = cart.map(item => `
                <div class="flex justify-between text-sm">
                    <span>${item.name} Ã— ${item.quantity}</span>
                    <span>NT$ ${item.price * item.quantity}</span>
                </div>
            `).join('');
            
            document.getElementById('orderModal').classList.remove('hidden');
            document.getElementById('orderModal').classList.add('flex');
            hideCart();
        }

        function hideOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
            document.getElementById('orderModal').classList.remove('flex');
        }

        async function submitOrder() {
            if (cart.length === 0 || !selectedTableId) return;

            const confirmBtn = document.getElementById('confirmOrder');
            const originalText = confirmBtn.textContent;
            
            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'é€å‡ºä¸­...';

                const orderNumber = 'ORD' + Date.now();
                const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // å»ºç«‹è¨‚å–®
                await callNotionAPI('/pages', 'POST', {
                    parent: { database_id: CONFIG.databases.orders },
                    properties: {
                        'è¨‚å–®ç·¨è™Ÿ': { title: [{ text: { content: orderNumber } }] },
                        'æ¡Œè™Ÿ': { rich_text: [{ text: { content: selectedTableNumber } }] },
                        'è¨‚å–®é …ç›®': { rich_text: [{ text: { content: JSON.stringify(cart) } }] },
                        'ç¸½é‡‘é¡': { number: totalAmount },
                        'ç‹€æ…‹': { select: { name: 'é»é¤ä¸­' } },
                        'ä»˜æ¬¾ç‹€æ…‹': { select: { name: 'æœªä»˜æ¬¾' } },
                        'å»ºç«‹æ™‚é–“': { rich_text: [{ text: { content: new Date().toISOString() } }] }
                    }
                });

                // æ›´æ–°æ¡Œä½ç‹€æ…‹
                const currentOrders = selectedTableNumber;
                await callNotionAPI(`/pages/${selectedTableId}`, 'PATCH', {
                    properties: {
                        'ç‹€æ…‹': { select: { name: 'å·²é»é¤' } },
                        'ç›®å‰æ¶ˆè²»': { number: totalAmount },
                        'ç›®å‰è¨‚å–®': { rich_text: [{ text: { content: orderNumber } }] }
                    }
                });

                hideOrderModal();
                showSuccessModal();

            } catch (error) {
                alert(`âŒ é€å‡ºå¤±æ•—ï¼š${error.message}`);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
        }

        function hideSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        function continueOrdering() {
            clearCart();
            hideSuccessModal();
        }

        function finishOrdering() {
            clearCart();
            hideSuccessModal();
            // è¿”å›æ¡Œä½é¸æ“‡
            selectedTableId = null;
            selectedTableNumber = null;
            document.getElementById('tableInfo').textContent = 'è«‹é¸æ“‡æ¡Œè™Ÿ';
            document.getElementById('orderingInterface').classList.add('hidden');
            document.getElementById('tableSelection').classList.remove('hidden');
            document.getElementById('cartButton').classList.add('hidden');
        }

        // === åˆå§‹åŒ– ===
        async function initTables() {
            try {
                await loadTables();
                renderTables();
            } catch (error) {
                console.error('åˆå§‹åŒ–æ¡Œä½å¤±æ•—:', error);
                document.getElementById('tableGrid').innerHTML = 
                    '<div class="col-span-3 text-center text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
            }
        }

        async function initMenu() {
            try {
                await loadMenu();
                renderMenu();
            } catch (error) {
                document.getElementById('menuError').classList.remove('hidden');
            }
        }

        function setupEventListeners() {
            // åˆ†é¡æ¨™ç±¤
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => switchCategory(tab.dataset.category));
            });

            // è³¼ç‰©è»Š
            document.getElementById('cartButton').addEventListener('click', showCart);
            document.getElementById('closeCart').addEventListener('click', hideCart);
            document.getElementById('clearCart').addEventListener('click', clearCart);
            document.getElementById('submitOrder').addEventListener('click', showOrderModal);

            // è¨‚å–®ç¢ºèª
            document.getElementById('confirmOrder').addEventListener('click', submitOrder);
            document.getElementById('cancelOrder').addEventListener('click', hideOrderModal);

            // æˆåŠŸæ¨¡æ…‹æ¡†
            document.getElementById('continueOrdering').addEventListener('click', continueOrdering);
            document.getElementById('finishOrdering').addEventListener('click', finishOrdering);

            // åˆ·æ–°æŒ‰éˆ•
            document.getElementById('refreshBtn').addEventListener('click', () => {
                if (selectedTableId) {
                    initMenu();
                } else {
                    initTables();
                }
            });

            // æ¨¡æ…‹æ¡†èƒŒæ™¯é»æ“Šé—œé–‰
            document.getElementById('orderModal').addEventListener('click', (e) => {
                if (e.target.id === 'orderModal') hideOrderModal();
            });
        }

        // === å•Ÿå‹•ç³»çµ± ===
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initTables();
        });
    </script>
</body>
</html>
