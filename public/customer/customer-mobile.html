<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ“± æ‰‹æ©Ÿé»é¤ç³»çµ± - Tanawat Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a202c; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(45deg, #6366f1, #8b5cf6); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(45deg, #7c3aed, #a855f7); }
        
        /* æ‰‹æ©Ÿå°ˆç”¨å‹•ç•« */
        .mobile-fade-in {
            animation: mobileSlideUp 0.4s ease-out forwards;
        }
        
        @keyframes mobileSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* è³¼ç‰©è»Šé¢æ¿ */
        .cart-panel {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .cart-panel.show {
            transform: translateY(0);
        }
        
        /* èœå–®å¡ç‰‡å‹•ç•« */
        .menu-card {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .menu-card:active {
            transform: scale(0.98);
        }
        
        .menu-card:hover {
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.4);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        /* åˆ†é¡æŒ‰éˆ• */
        .category-btn {
            transition: all 0.3s ease;
            white-space: nowrap;
            touch-action: manipulation;
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .category-btn:active {
            transform: scale(0.95);
        }
        
        /* æ•¸é‡æ§åˆ¶å™¨ */
        .quantity-control {
            display: flex;
            align-items: center;
            background: #374151;
            border-radius: 12px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .quantity-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #4b5563;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.1s;
            touch-action: manipulation;
        }
        
        .quantity-btn:active {
            transform: scale(0.9);
            background: #374151;
        }
        
        /* æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ• */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .floating-cart:active {
            transform: scale(0.95);
        }
        
        .cart-pulse {
            animation: pulse-cart 2s infinite;
        }
        
        @keyframes pulse-cart {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* æ¨¡æ…‹æ¡† */
        .modal-overlay {
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            transform: scale(0.9) translateY(30px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-content.show {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* åˆ†é¡æ»¾å‹• */
        .category-scroll {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
        
        /* æ‰‹æ©Ÿå°ˆç”¨é–“è· */
        .mobile-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* è§¸æ§å‹å¥½æŒ‰éˆ• */
        .touch-btn {
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>
<body class="text-white mobile-safe">
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="sticky top-0 z-50 bg-gray-900/95 backdrop-blur-md border-b border-gray-700">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h1 class="text-xl font-bold">ğŸ½ï¸ æ‰‹æ©Ÿé»é¤</h1>
                    <p class="text-sm text-gray-400" id="status-text">è¼‰å…¥ä¸­...</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="refresh-btn" class="touch-btn bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm font-medium">
                        ğŸ”„
                    </button>
                    <button id="table-selector-btn" class="touch-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm font-medium">
                        <span id="selected-table-text">é¸æ“‡æ¡Œè™Ÿ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡é¸æ“‡å™¨ -->
    <div class="bg-gray-800/95 backdrop-blur-md border-b border-gray-700 px-4 py-3">
        <div id="category-container" class="category-scroll flex space-x-3 overflow-x-auto">
            <!-- åˆ†é¡æŒ‰éˆ•å°‡å‹•æ…‹è¼‰å…¥ -->
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="flex-1 pb-24">
        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loading-state" class="flex flex-col items-center justify-center py-16">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-400">è¼‰å…¥èœå–®ä¸­...</p>
        </div>

        <!-- èœå–®åˆ—è¡¨ -->
        <div id="menu-container" class="hidden p-4 space-y-4">
            <!-- èœå–®é …ç›®å°‡å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="error-state" class="hidden flex flex-col items-center justify-center py-16">
            <div class="text-6xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-semibold text-red-400 mb-2">è¼‰å…¥å¤±æ•—</h3>
            <p class="text-gray-400 text-center mb-6">ç„¡æ³•è¼‰å…¥èœå–®è³‡æ–™<br>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</p>
            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-medium">
                é‡æ–°è¼‰å…¥
            </button>
        </div>
    </div>

    <!-- æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ• -->
    <button id="floating-cart" class="floating-cart hidden bg-gradient-to-r from-blue-600 to-purple-600 w-16 h-16 text-white font-bold shadow-lg">
        <div class="text-center">
            <div class="text-2xl">ğŸ›’</div>
            <div id="cart-count" class="text-xs -mt-1">0</div>
        </div>
    </button>

    <!-- è³¼ç‰©è»Šé¢æ¿ -->
    <div id="cart-panel" class="cart-panel fixed inset-x-0 bottom-0 bg-gray-900 rounded-t-3xl shadow-2xl border-t border-gray-700 z-50">
        <div class="p-6">
            <!-- è³¼ç‰©è»Šæ¨™é¡Œ -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">ğŸ›’ è³¼ç‰©è»Š</h3>
                <button id="close-cart" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            
            <!-- è³¼ç‰©è»Šå…§å®¹ -->
            <div id="cart-items" class="space-y-4 max-h-64 overflow-y-auto mb-6">
                <div class="text-center py-8 text-gray-400">
                    è³¼ç‰©è»Šæ˜¯ç©ºçš„
                </div>
            </div>
            
            <!-- å‚™è¨»è¼¸å…¥ -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">è¨‚å–®å‚™è¨»</label>
                <textarea id="order-notes" 
                         placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»..."
                         class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 resize-none h-16"></textarea>
            </div>
            
            <!-- ç¸½è¨ˆå’Œæ“ä½œæŒ‰éˆ• -->
            <div class="border-t border-gray-700 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold">ç¸½è¨ˆï¼š</span>
                    <span id="total-price" class="text-2xl font-bold text-green-400">NT$ 0</span>
                </div>
                
                <div class="space-y-3">
                    <button id="place-order-btn" 
                            class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-4 rounded-xl font-bold text-lg transition-colors"
                            disabled>
                        ğŸ“ ä¸‹è¨‚å–®
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="clear-cart-btn" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                        <button id="view-existing-orders-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium">
                            ğŸ“‹ æŸ¥çœ‹è¨‚å–®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¡Œè™Ÿé¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="table-modal" class="fixed inset-0 bg-black/70 modal-overlay flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-3xl shadow-2xl w-full max-w-md border border-gray-600">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold flex items-center">
                        <span class="mr-3">ğŸª‘</span>
                        é¸æ“‡æ¡Œè™Ÿ
                    </h2>
                    <button id="close-table-modal" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
                </div>
                <p class="text-gray-400 mt-2">è«‹é¸æ“‡æ‚¨çš„æ¡Œè™Ÿé–‹å§‹é»é¤</p>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
                <div id="table-options" class="grid grid-cols-2 gap-3">
                    <!-- æ¡Œè™Ÿé¸é …å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¨‚å–®ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="order-modal" class="fixed inset-0 bg-black/70 modal-overlay flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-3xl shadow-2xl w-full max-w-md border border-gray-600">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="mr-3">ğŸ“</span>
                    ç¢ºèªè¨‚å–®
                </h2>
                <p class="text-gray-400 mt-2">æ¡Œè™Ÿ: <span id="modal-table-number" class="text-blue-400 font-bold"></span></p>
            </div>
            <div class="p-6">
                <div id="order-summary" class="space-y-3 mb-6 max-h-48 overflow-y-auto">
                    <!-- è¨‚å–®æ‘˜è¦å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-lg font-bold">ç¸½è¨ˆï¼š</span>
                        <span id="modal-total" class="text-2xl font-bold text-green-400">NT$ 0</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="cancel-order" class="bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg font-medium">
                            å–æ¶ˆ
                        </button>
                        <button id="confirm-order" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold">
                            ç¢ºèªé€å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæ¨¡æ…‹æ¡† -->
    <div id="success-modal" class="fixed inset-0 bg-black/70 modal-overlay flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-3xl shadow-2xl w-full max-w-sm border border-gray-600 text-center">
            <div class="p-8">
                <div class="text-6xl mb-4">âœ…</div>
                <h3 class="text-2xl font-bold mb-4">è¨‚å–®å·²é€å‡ºï¼</h3>
                <p id="success-message" class="text-gray-300 mb-6">æ‚¨çš„è¨‚å–®æ­£åœ¨æº–å‚™ä¸­</p>
                <div class="space-y-3">
                    <button id="continue-ordering" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                        ç¹¼çºŒé»é¤
                    </button>
                    <button id="finish-ordering" class="w-full bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg font-medium">
                        çµæŸé»é¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾æœ‰è¨‚å–®æ¨¡æ…‹æ¡† -->
    <div id="existing-orders-modal" class="fixed inset-0 bg-black/70 modal-overlay flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] border border-gray-600 flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="mr-2">ğŸ“‹</span>
                        ç¾æœ‰è¨‚å–®
                    </h2>
                    <button id="close-existing-orders" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
                </div>
                <p id="existing-orders-title" class="text-gray-400 mt-2">æ¡Œè™Ÿè³‡è¨Š</p>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="existing-orders-content">
                    <!-- ç¾æœ‰è¨‚å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            <div class="p-6 border-t border-gray-700">
                <div class="flex justify-between items-center">
                    <span id="existing-orders-summary" class="text-sm text-gray-400">è¼‰å…¥ä¸­...</span>
                    <button id="refresh-existing-orders" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€é…ç½® =====
        const VERSION = 'mobile-v2.0-' + Date.now();
        console.log('ğŸ“± æ‰‹æ©Ÿé»é¤ç³»çµ±ç‰ˆæœ¬:', VERSION);

        // å¼·åˆ¶è¨­ç½®æ­£ç¢ºçš„é…ç½®
        window.APP_CONFIG = {
            notion: {
                apiKey: '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',
                apiVersion: '2022-06-28',
                databaseIds: {
                    menu: '23afd5adc30b80c58355fd93d05c66d6',
                    orders: '23afd5adc30b80c39e71d1a640ccfb5d',
                    tables: '23afd5adc30b80fe86c9e086a54a0d61',
                    inventory: '23afd5adc30b808cbba3c03f8f2065fd',
                    suppliers: '23afd5adc30b8056bbf4d4bb5c93eb8a',
                    purchases: '23afd5adc30b80cf96acd0e98b7651a1'
                }
            }
        };

        const config = {
            useNotion: true,
            notion: window.APP_CONFIG.notion,
            comboCategories: { appetizer: 'å‰èœ', main: 'ä¸»é¤', drink: 'é£²å“', dessert: 'ç”œé»' },
            quickNoteOptions: { spiciness: 'è¾£åº¦é¸é …', ice: 'å†°é‡é¸é …', sugar: 'ç”œåº¦é¸é …', temperature: 'æº«åº¦é¸é …' }
        };

        // DOM å…ƒç´ 
        const dom = {
            // ç‹€æ…‹å’Œå°èˆª
            statusText: document.getElementById('status-text'),
            refreshBtn: document.getElementById('refresh-btn'),
            tableSelectorBtn: document.getElementById('table-selector-btn'),
            selectedTableText: document.getElementById('selected-table-text'),
            
            // åˆ†é¡å’Œèœå–®
            categoryContainer: document.getElementById('category-container'),
            loadingState: document.getElementById('loading-state'),
            menuContainer: document.getElementById('menu-container'),
            errorState: document.getElementById('error-state'),
            
            // è³¼ç‰©è»Š
            floatingCart: document.getElementById('floating-cart'),
            cartCount: document.getElementById('cart-count'),
            cartPanel: document.getElementById('cart-panel'),
            closeCart: document.getElementById('close-cart'),
            cartItems: document.getElementById('cart-items'),
            orderNotes: document.getElementById('order-notes'),
            totalPrice: document.getElementById('total-price'),
            placeOrderBtn: document.getElementById('place-order-btn'),
            clearCartBtn: document.getElementById('clear-cart-btn'),
            viewExistingOrdersBtn: document.getElementById('view-existing-orders-btn'),
            
            // æ¡Œè™Ÿé¸æ“‡æ¨¡æ…‹æ¡†
            tableModal: document.getElementById('table-modal'),
            closeTableModal: document.getElementById('close-table-modal'),
            tableOptions: document.getElementById('table-options'),
            
            // è¨‚å–®ç¢ºèªæ¨¡æ…‹æ¡†
            orderModal: document.getElementById('order-modal'),
            modalTableNumber: document.getElementById('modal-table-number'),
            orderSummary: document.getElementById('order-summary'),
            modalTotal: document.getElementById('modal-total'),
            cancelOrder: document.getElementById('cancel-order'),
            confirmOrder: document.getElementById('confirm-order'),
            
            // æˆåŠŸæ¨¡æ…‹æ¡†
            successModal: document.getElementById('success-modal'),
            successMessage: document.getElementById('success-message'),
            continueOrdering: document.getElementById('continue-ordering'),
            finishOrdering: document.getElementById('finish-ordering'),
            
            // ç¾æœ‰è¨‚å–®æ¨¡æ…‹æ¡†
            existingOrdersModal: document.getElementById('existing-orders-modal'),
            existingOrdersTitle: document.getElementById('existing-orders-title'),
            existingOrdersContent: document.getElementById('existing-orders-content'),
            existingOrdersSummary: document.getElementById('existing-orders-summary'),
            closeExistingOrders: document.getElementById('close-existing-orders'),
            refreshExistingOrders: document.getElementById('refresh-existing-orders')
        };

        // å…¨å±€è®Šæ•¸
        let menu = [];
        let order = [];
        let selectedTable = null;
        let currentCategory = 'å…¨éƒ¨';
        let notionManager = null;

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ æ‰‹æ©Ÿé»é¤ç³»çµ±åˆå§‹åŒ–...');
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            setupEventListeners();
            
            // è¼‰å…¥è³‡æ–™
            await loadTables();
            await loadMenu();
            
            dom.statusText.textContent = 'è«‹é¸æ“‡æ¡Œè™Ÿé–‹å§‹é»é¤';
        });

        function setupEventListeners() {
            // åˆ·æ–°æŒ‰éˆ•
            dom.refreshBtn.addEventListener('click', async () => {
                dom.statusText.textContent = 'é‡æ–°æ•´ç†ä¸­...';
                await loadTables();
                await loadMenu();
                dom.statusText.textContent = selectedTable ? 'å¯ä»¥é–‹å§‹é»é¤' : 'è«‹é¸æ“‡æ¡Œè™Ÿé–‹å§‹é»é¤';
            });

            // æ¡Œè™Ÿé¸æ“‡
            dom.tableSelectorBtn.addEventListener('click', showTableModal);
            dom.closeTableModal.addEventListener('click', hideTableModal);

            // è³¼ç‰©è»Š
            dom.floatingCart.addEventListener('click', showCart);
            dom.closeCart.addEventListener('click', hideCart);
            dom.placeOrderBtn.addEventListener('click', showOrderModal);
            dom.clearCartBtn.addEventListener('click', clearCart);
            dom.viewExistingOrdersBtn.addEventListener('click', showExistingOrdersModal);

            // è¨‚å–®ç¢ºèª
            dom.cancelOrder.addEventListener('click', hideOrderModal);
            dom.confirmOrder.addEventListener('click', submitOrder);

            // æˆåŠŸæ¨¡æ…‹æ¡†
            dom.continueOrdering.addEventListener('click', continueOrdering);
            dom.finishOrdering.addEventListener('click', finishOrdering);

            // ç¾æœ‰è¨‚å–®
            dom.closeExistingOrders.addEventListener('click', hideExistingOrdersModal);
            dom.refreshExistingOrders.addEventListener('click', loadExistingOrders);

            // é»æ“ŠèƒŒæ™¯é—œé–‰æ¨¡æ…‹æ¡†
            [dom.tableModal, dom.orderModal, dom.successModal, dom.existingOrdersModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideAllModals();
                    }
                });
            });
        }

        // ===== è³‡æ–™è¼‰å…¥å‡½æ•¸ =====
        async function loadTables() {
            try {
                console.log('ğŸ—ï¸ è¼‰å…¥æ¡Œä½è³‡æ–™...');
                
                const response = await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: `/databases/${config.notion.databaseIds.tables}/query`,
                        method: 'POST',
                        body: {
                            page_size: 100,
                            sorts: [{ property: 'æ¡Œè™Ÿ', direction: 'ascending' }]
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`API éŒ¯èª¤: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“‹ æ¡Œä½è³‡æ–™:', data);
                
                if (data && data.results && data.results.length > 0) {
                    renderTables(data.results);
                } else {
                    renderDefaultTables();
                }
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æ¡Œä½å¤±æ•—:', error);
                renderDefaultTables();
            }
        }

        async function loadMenu() {
            try {
                console.log('ğŸ½ï¸ è¼‰å…¥èœå–®è³‡æ–™...');
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                dom.loadingState.classList.remove('hidden');
                dom.menuContainer.classList.add('hidden');
                dom.errorState.classList.add('hidden');
                
                const response = await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: `/databases/${config.notion.databaseIds.menu}/query`,
                        method: 'POST',
                        body: {
                            page_size: 100,
                            sorts: [{ property: 'åç¨±', direction: 'ascending' }]
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`API éŒ¯èª¤: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“‹ èœå–®è³‡æ–™:', data);
                
                if (data && data.results) {
                    // è½‰æ›èœå–®æ ¼å¼
                    menu = data.results.map(item => {
                        const properties = item.properties;
                        return {
                            id: item.id,
                            name: properties['åç¨±']?.title?.[0]?.text?.content || 
                                  properties['é¤é»åç¨±']?.title?.[0]?.text?.content || 'æœªå‘½åå•†å“',
                            price: properties['åƒ¹æ ¼']?.number || 0,
                            category: properties['åˆ†é¡']?.select?.name || 
                                     properties['é¤é»é¡å‹']?.select?.name || 'å…¶ä»–',
                            description: properties['æè¿°']?.rich_text?.[0]?.text?.content || '',
                            isUnavailable: properties['ä¾›æ‡‰ç‹€æ…‹']?.checkbox !== true
                        };
                    }).filter(item => !item.isUnavailable);
                    
                    console.log(`âœ… è¼‰å…¥ ${menu.length} å€‹èœå–®é …ç›®`);
                    
                    // æ¸²æŸ“åˆ†é¡å’Œèœå–®
                    renderCategories();
                    renderMenu();
                    
                    dom.loadingState.classList.add('hidden');
                    dom.menuContainer.classList.remove('hidden');
                } else {
                    throw new Error('èœå–®è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥èœå–®å¤±æ•—:', error);
                dom.loadingState.classList.add('hidden');
                dom.errorState.classList.remove('hidden');
            }
        }

        // ===== æ¸²æŸ“å‡½æ•¸ =====
        function renderTables(tables) {
            dom.tableOptions.innerHTML = '';
            
            if (!tables || tables.length === 0) {
                renderDefaultTables();
                return;
            }
            
            tables.forEach(tableData => {
                const props = tableData.properties || {};
                
                // è§£ææ¡Œè™Ÿ
                let tableNumber = null;
                if (props['æ¡Œè™Ÿ']) {
                    if (props['æ¡Œè™Ÿ'].title && props['æ¡Œè™Ÿ'].title.length > 0) {
                        tableNumber = props['æ¡Œè™Ÿ'].title[0].plain_text;
                    } else if (props['æ¡Œè™Ÿ'].rich_text && props['æ¡Œè™Ÿ'].rich_text.length > 0) {
                        tableNumber = props['æ¡Œè™Ÿ'].rich_text[0].plain_text;
                    } else if (props['æ¡Œè™Ÿ'].number !== undefined) {
                        tableNumber = props['æ¡Œè™Ÿ'].number.toString();
                    }
                }
                
                if (!tableNumber) return;
                
                // è§£æç‹€æ…‹
                let status = 'ç©ºé–’ä¸­';
                if (props['ç‹€æ…‹'] && props['ç‹€æ…‹'].select && props['ç‹€æ…‹'].select.name) {
                    status = props['ç‹€æ…‹'].select.name;
                }
                
                // è§£æå®¹ç´äººæ•¸
                let capacity = '';
                if (props['å®¹ç´äººæ•¸'] && typeof props['å®¹ç´äººæ•¸'].number === 'number') {
                    capacity = ` (${props['å®¹ç´äººæ•¸'].number}äºº)`;
                }
                
                // ç‹€æ…‹åœ–ç¤ºå’Œé¡è‰²
                let statusIcon = 'ğŸŸ¢';
                let statusClass = 'text-green-400';
                let isDisabled = false;
                
                if (status === 'ä½¿ç”¨ä¸­') {
                    statusIcon = 'ğŸ”´';
                    statusClass = 'text-red-400';
                } else if (status === 'æ¸…æ½”ä¸­') {
                    statusIcon = 'ğŸŸ¡';
                    statusClass = 'text-yellow-400';
                } else if (status === 'ç¶­ä¿®ä¸­') {
                    statusIcon = 'âš«';
                    statusClass = 'text-gray-500';
                    isDisabled = true;
                }
                
                const optionDiv = document.createElement('div');
                optionDiv.className = `p-4 bg-gray-700 rounded-xl border border-gray-600 text-center transition-all duration-200 ${
                    isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600 cursor-pointer hover:border-blue-500'
                }`;
                
                optionDiv.innerHTML = `
                    <div class="text-3xl mb-2">${statusIcon}</div>
                    <div class="text-white font-bold text-lg">${tableNumber}</div>
                    <div class="text-sm ${statusClass} mt-1">${status}</div>
                    ${capacity ? `<div class="text-xs text-gray-400 mt-1">${capacity}</div>` : ''}
                `;
                
                if (!isDisabled) {
                    optionDiv.addEventListener('click', () => {
                        selectTable(tableNumber, status);
                        hideTableModal();
                    });
                }
                
                dom.tableOptions.appendChild(optionDiv);
            });
        }

        function renderDefaultTables() {
            console.log('ğŸ”„ ä½¿ç”¨é è¨­æ¡Œè™Ÿ');
            
            const defaultTables = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
            dom.tableOptions.innerHTML = '';
            
            defaultTables.forEach(tableNum => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'p-4 bg-gray-700 hover:bg-gray-600 cursor-pointer rounded-xl border border-gray-600 hover:border-blue-500 text-center transition-all duration-200';
                
                optionDiv.innerHTML = `
                    <div class="text-3xl mb-2">ğŸŸ¢</div>
                    <div class="text-white font-bold text-lg">æ¡Œè™Ÿ ${tableNum}</div>
                    <div class="text-sm text-green-400 mt-1">ç©ºé–’ä¸­</div>
                    <div class="text-xs text-gray-400 mt-1">(é è¨­)</div>
                `;
                
                optionDiv.addEventListener('click', () => {
                    selectTable(tableNum, 'ç©ºé–’ä¸­');
                    hideTableModal();
                });
                
                dom.tableOptions.appendChild(optionDiv);
            });
        }

        function renderCategories() {
            const categories = ['å…¨éƒ¨', ...new Set(menu.map(item => item.category))];
            
            dom.categoryContainer.innerHTML = '';
            
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = `category-btn px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 ${
                    category === currentCategory ? 
                    'active text-white' : 
                    'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`;
                btn.textContent = category;
                
                btn.addEventListener('click', () => {
                    currentCategory = category;
                    renderCategories();
                    renderMenu();
                });
                
                dom.categoryContainer.appendChild(btn);
            });
        }

        function renderMenu() {
            const filteredMenu = menu.filter(item => 
                currentCategory === 'å…¨éƒ¨' || item.category === currentCategory
            );
            
            dom.menuContainer.innerHTML = '';
            
            if (filteredMenu.length === 0) {
                dom.menuContainer.innerHTML = '<div class="text-center py-8 text-gray-400">æ­¤åˆ†é¡æ²’æœ‰å•†å“</div>';
                return;
            }
            
            filteredMenu.forEach(item => {
                const menuCard = document.createElement('div');
                menuCard.className = 'menu-card bg-gray-800 border border-gray-700 rounded-2xl p-4 hover:border-blue-500 transition-all duration-200';
                
                // æª¢æŸ¥æ˜¯å¦å·²åœ¨è³¼ç‰©è»Šä¸­
                const cartItem = order.find(o => o.menuItemId === item.id);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                menuCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 pr-4">
                            <h3 class="font-bold text-lg text-white mb-2">${item.name}</h3>
                            ${item.description ? `<p class="text-sm text-gray-400 mb-3">${item.description}</p>` : ''}
                            <div class="text-xl font-bold text-green-400">NT$ ${item.price}</div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${quantity > 0 ? `
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="adjustQuantity('${item.id}', -1)">-</button>
                                    <span class="px-3 text-white font-bold">${quantity}</span>
                                    <button class="quantity-btn" onclick="adjustQuantity('${item.id}', 1)">+</button>
                                </div>
                            ` : `
                                <button onclick="addToOrder('${item.id}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition-colors touch-btn">
                                    åŠ å…¥
                                </button>
                            `}
                        </div>
                    </div>
                `;
                
                dom.menuContainer.appendChild(menuCard);
            });
        }

        // ===== è³¼ç‰©è»ŠåŠŸèƒ½ =====
        function addToOrder(menuItemId) {
            const menuItem = menu.find(item => item.id === menuItemId);
            if (!menuItem) return;
            
            const existingItem = order.find(item => item.menuItemId === menuItemId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                order.push({
                    lineItemId: crypto.randomUUID(),
                    menuItemId: menuItem.id,
                    name: menuItem.name,
                    price: menuItem.price,
                    category: menuItem.category,
                    quantity: 1,
                    customNote: ''
                });
            }
            
            updateCartDisplay();
            renderMenu(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        }

        function adjustQuantity(menuItemId, change) {
            const orderItem = order.find(item => item.menuItemId === menuItemId);
            if (!orderItem) return;
            
            orderItem.quantity += change;
            
            if (orderItem.quantity <= 0) {
                order = order.filter(item => item.menuItemId !== menuItemId);
            }
            
            updateCartDisplay();
            renderMenu(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        }

        function updateCartDisplay() {
            const totalItems = order.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = order.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // æ›´æ–°è³¼ç‰©è»Šè¨ˆæ•¸
            dom.cartCount.textContent = totalItems;
            
            // é¡¯ç¤º/éš±è—æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ•
            if (totalItems > 0) {
                dom.floatingCart.classList.remove('hidden');
                dom.floatingCart.classList.add('cart-pulse');
            } else {
                dom.floatingCart.classList.add('hidden');
                dom.floatingCart.classList.remove('cart-pulse');
            }
            
            // æ›´æ–°è³¼ç‰©è»Šå…§å®¹
            if (order.length === 0) {
                dom.cartItems.innerHTML = '<div class="text-center py-8 text-gray-400">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
                dom.placeOrderBtn.disabled = true;
            } else {
                dom.cartItems.innerHTML = order.map(item => `
                    <div class="flex justify-between items-center bg-gray-800 rounded-xl p-4 border border-gray-700">
                        <div class="flex-1">
                            <div class="font-bold text-white">${item.name}</div>
                            <div class="text-sm text-gray-400">NT$ ${item.price}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="adjustQuantity('${item.menuItemId}', -1)">-</button>
                                <span class="px-3 text-white font-bold">${item.quantity}</span>
                                <button class="quantity-btn" onclick="adjustQuantity('${item.menuItemId}', 1)">+</button>
                            </div>
                            <div class="text-white font-bold">NT$ ${item.price * item.quantity}</div>
                        </div>
                    </div>
                `).join('');
                
                dom.placeOrderBtn.disabled = !selectedTable;
            }
            
            // æ›´æ–°ç¸½åƒ¹
            dom.totalPrice.textContent = `NT$ ${totalPrice}`;
        }

        function clearCart() {
            if (order.length === 0) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
                order = [];
                updateCartDisplay();
                renderMenu();
            }
        }

        // ===== æ¡Œè™Ÿé¸æ“‡ =====
        function selectTable(tableNumber, status) {
            selectedTable = tableNumber;
            
            let statusIcon = 'ğŸŸ¢';
            if (status === 'ä½¿ç”¨ä¸­') statusIcon = 'ğŸ”´';
            else if (status === 'æ¸…æ½”ä¸­') statusIcon = 'ğŸŸ¡';
            
            dom.selectedTableText.textContent = `${statusIcon} ${tableNumber}`;
            dom.statusText.textContent = `å·²é¸æ“‡æ¡Œè™Ÿ ${tableNumber}ï¼Œå¯ä»¥é–‹å§‹é»é¤`;
            
            // æ›´æ–°ä¸‹è¨‚å–®æŒ‰éˆ•ç‹€æ…‹
            updateCartDisplay();
        }

        // ===== æ¨¡æ…‹æ¡†æ§åˆ¶ =====
        function showTableModal() {
            dom.tableModal.classList.remove('hidden');
            setTimeout(() => {
                dom.tableModal.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function hideTableModal() {
            dom.tableModal.querySelector('.modal-content').classList.remove('show');
            setTimeout(() => {
                dom.tableModal.classList.add('hidden');
            }, 300);
        }

        function showCart() {
            dom.cartPanel.classList.add('show');
        }

        function hideCart() {
            dom.cartPanel.classList.remove('show');
        }

        function showOrderModal() {
            if (order.length === 0 || !selectedTable) return;
            
            const totalPrice = order.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            dom.modalTableNumber.textContent = selectedTable;
            dom.modalTotal.textContent = `NT$ ${totalPrice}`;
            
            dom.orderSummary.innerHTML = order.map(item => `
                <div class="flex justify-between text-sm">
                    <span>${item.name} Ã— ${item.quantity}</span>
                    <span>NT$ ${item.price * item.quantity}</span>
                </div>
            `).join('');
            
            hideCart();
            dom.orderModal.classList.remove('hidden');
            setTimeout(() => {
                dom.orderModal.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function hideOrderModal() {
            dom.orderModal.querySelector('.modal-content').classList.remove('show');
            setTimeout(() => {
                dom.orderModal.classList.add('hidden');
            }, 300);
        }

        function showSuccessModal(message) {
            dom.successMessage.textContent = message;
            dom.successModal.classList.remove('hidden');
            setTimeout(() => {
                dom.successModal.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function hideSuccessModal() {
            dom.successModal.querySelector('.modal-content').classList.remove('show');
            setTimeout(() => {
                dom.successModal.classList.add('hidden');
            }, 300);
        }

        function showExistingOrdersModal() {
            if (!selectedTable) {
                alert('è«‹å…ˆé¸æ“‡æ¡Œè™Ÿ');
                return;
            }
            
            dom.existingOrdersTitle.textContent = `æ¡Œè™Ÿ ${selectedTable} çš„ç¾æœ‰è¨‚å–®`;
            dom.existingOrdersModal.classList.remove('hidden');
            setTimeout(() => {
                dom.existingOrdersModal.querySelector('.modal-content').classList.add('show');
            }, 10);
            
            loadExistingOrders();
        }

        function hideExistingOrdersModal() {
            dom.existingOrdersModal.querySelector('.modal-content').classList.remove('show');
            setTimeout(() => {
                dom.existingOrdersModal.classList.add('hidden');
            }, 300);
        }

        function hideAllModals() {
            [dom.tableModal, dom.orderModal, dom.successModal, dom.existingOrdersModal].forEach(modal => {
                const content = modal.querySelector('.modal-content');
                if (content) content.classList.remove('show');
                setTimeout(() => modal.classList.add('hidden'), 300);
            });
        }

        // ===== è¨‚å–®æäº¤ =====
        async function submitOrder() {
            if (order.length === 0 || !selectedTable) return;
            
            const originalText = dom.confirmOrder.textContent;
            dom.confirmOrder.disabled = true;
            dom.confirmOrder.textContent = 'é€å‡ºä¸­...';
            
            try {
                const orderId = `ORD-${Date.now().toString().slice(-8)}`;
                const totalPrice = order.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // æº–å‚™è¨‚å–®é …ç›®æ–‡å­—
                const orderItemsText = order.map(item => 
                    `${item.name} x${item.quantity} - NT$${item.price * item.quantity}`
                ).join('\n');
                
                // å‰µå»º Notion è¨‚å–®è¨˜éŒ„
                const orderData = {
                    parent: { database_id: config.notion.databaseIds.orders },
                    properties: {
                        'è¨‚å–®ç·¨è™Ÿ': { 
                            title: [{ text: { content: orderId } }] 
                        },
                        'æ¡Œè™Ÿ': { 
                            rich_text: [{ text: { content: String(selectedTable) } }] 
                        },
                        'ç‹€æ…‹': { 
                            select: { name: 'é€²è¡Œä¸­' } 
                        },
                        'ç¸½é‡‘é¡': { 
                            number: totalPrice 
                        },
                        'è¨‚å–®é …ç›®': { 
                            rich_text: [{ text: { content: orderItemsText } }] 
                        },
                        'å»ºç«‹æ™‚é–“': { 
                            date: { start: new Date().toISOString() } 
                        },
                        'å‚™è¨»': { 
                            rich_text: [{ text: { content: dom.orderNotes.value.trim() || 'ç„¡' } }] 
                        },
                        'ä»˜æ¬¾ç‹€æ…‹': { 
                            select: { name: 'æœªä»˜æ¬¾' } 
                        }
                    }
                };
                
                const response = await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: '/pages',
                        method: 'POST',
                        body: orderData
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('è¨‚å–®æäº¤éŒ¯èª¤:', errorText);
                    throw new Error(`è¨‚å–®æäº¤å¤±æ•—: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('âœ… è¨‚å–®å·²æäº¤:', result);
                
                // æ¸…ç©ºè¨‚å–®
                order = [];
                dom.orderNotes.value = '';
                updateCartDisplay();
                renderMenu();
                
                hideOrderModal();
                showSuccessModal(`è¨‚å–®å·²æˆåŠŸé€å‡ºï¼\nè¨‚å–®ç·¨è™Ÿ: ${orderId}`);
                
            } catch (error) {
                console.error('âŒ è¨‚å–®æäº¤å¤±æ•—:', error);
                alert(`è¨‚å–®æäº¤å¤±æ•—: ${error.message}`);
            } finally {
                dom.confirmOrder.disabled = false;
                dom.confirmOrder.textContent = originalText;
            }
        }

        // ===== ç¾æœ‰è¨‚å–®æŸ¥çœ‹ =====
        async function loadExistingOrders() {
            if (!selectedTable) return;
            
            dom.existingOrdersContent.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-400">è¼‰å…¥ä¸­...</p></div>';
            dom.existingOrdersSummary.textContent = 'è¼‰å…¥ä¸­...';
            
            try {
                const response = await fetch('/.netlify/functions/notion-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: `/databases/${config.notion.databaseIds.orders}/query`,
                        method: 'POST',
                        body: {
                            page_size: 100,
                            sorts: [{ property: 'å»ºç«‹æ™‚é–“', direction: 'descending' }]
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('è¼‰å…¥è¨‚å–®éŒ¯èª¤:', errorText);
                    throw new Error(`è¼‰å…¥å¤±æ•—: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                // éæ¿¾è©²æ¡Œè™Ÿçš„è¨‚å–®
                const tableOrders = data.results?.filter(orderRecord => {
                    const orderTableNumber = orderRecord.properties?.['æ¡Œè™Ÿ']?.number;
                    const orderTableText = orderRecord.properties?.['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content;
                    
                    return (orderTableNumber && orderTableNumber.toString() === selectedTable.toString()) ||
                           (orderTableText && (orderTableText === selectedTable || orderTableText.includes(selectedTable)));
                }) || [];
                
                if (tableOrders.length === 0) {
                    dom.existingOrdersContent.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ“­</div>
                            <h3 class="text-xl font-bold text-gray-300 mb-2">æ²’æœ‰è¨‚å–®</h3>
                            <p class="text-gray-400">æ¡Œè™Ÿ ${selectedTable} ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®</p>
                        </div>
                    `;
                    dom.existingOrdersSummary.textContent = 'æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨‚å–®';
                    return;
                }
                
                // æ¸²æŸ“è¨‚å–®åˆ—è¡¨
                const ordersHtml = tableOrders.map(order => {
                    const orderNumber = order.properties?.['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || 'æœªçŸ¥è¨‚å–®';
                    const status = order.properties?.['ç‹€æ…‹']?.select?.name || 'æœªçŸ¥ç‹€æ…‹';
                    const amount = order.properties?.['ç¸½é‡‘é¡']?.number || 0;
                    const itemsText = order.properties?.['è¨‚å–®é …ç›®']?.rich_text?.[0]?.text?.content || '';
                    const createTime = order.properties?.['å»ºç«‹æ™‚é–“']?.date?.start || '';
                    
                    let statusIcon = 'âšª';
                    let statusColor = 'bg-gray-600';
                    
                    if (status === 'é€²è¡Œä¸­') {
                        statusIcon = 'ğŸŸ¢';
                        statusColor = 'bg-green-600';
                    } else if (status === 'æº–å‚™ä¸­') {
                        statusIcon = 'ğŸŸ¡';
                        statusColor = 'bg-yellow-600';
                    } else if (status === 'å·²å®Œæˆ') {
                        statusIcon = 'ğŸ”µ';
                        statusColor = 'bg-blue-600';
                    } else if (status === 'å·²å–æ¶ˆ') {
                        statusIcon = 'ğŸ”´';
                        statusColor = 'bg-red-600';
                    }
                    
                    const formattedTime = createTime ? new Date(createTime).toLocaleString('zh-TW') : 'æœªçŸ¥æ™‚é–“';
                    
                    return `
                        <div class="bg-gray-700/50 rounded-xl p-4 border border-gray-600/50 mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-white">${orderNumber}</h4>
                                    <p class="text-sm text-gray-400 mt-1">ğŸ“… ${formattedTime}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium text-white ${statusColor}">
                                        ${statusIcon} ${status}
                                    </span>
                                    <p class="text-lg font-bold text-green-400 mt-1">NT$${amount}</p>
                                </div>
                            </div>
                            ${itemsText ? `
                                <div class="border-t border-gray-600 pt-3">
                                    <h5 class="text-sm font-medium text-gray-300 mb-2">ğŸ“‹ è¨‚å–®é …ç›®:</h5>
                                    <div class="text-sm text-gray-400 whitespace-pre-line pl-2">${itemsText}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                dom.existingOrdersContent.innerHTML = ordersHtml;
                
                // æ›´æ–°æ‘˜è¦
                const activeOrders = tableOrders.filter(order => {
                    const status = order.properties?.['ç‹€æ…‹']?.select?.name;
                    return status === 'é€²è¡Œä¸­' || status === 'æº–å‚™ä¸­';
                });
                
                const totalAmount = tableOrders.reduce((sum, order) => {
                    return sum + (order.properties?.['ç¸½é‡‘é¡']?.number || 0);
                }, 0);
                
                dom.existingOrdersSummary.textContent = `å…± ${tableOrders.length} å€‹è¨‚å–® (${activeOrders.length} å€‹é€²è¡Œä¸­) Â· ç¸½é‡‘é¡: NT$${totalAmount}`;
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥ç¾æœ‰è¨‚å–®å¤±æ•—:', error);
                dom.existingOrdersContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">âŒ</div>
                        <h3 class="text-xl font-bold text-red-400 mb-2">è¼‰å…¥å¤±æ•—</h3>
                        <p class="text-gray-400">${error.message}</p>
                        <button onclick="loadExistingOrders()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">é‡è©¦</button>
                    </div>
                `;
                dom.existingOrdersSummary.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        // ===== è¨‚å–®å®Œæˆå¾Œçš„æ“ä½œ =====
        function continueOrdering() {
            hideSuccessModal();
            // ä¿æŒç•¶å‰æ¡Œè™Ÿï¼Œå¯ä»¥ç¹¼çºŒé»é¤
        }

        function finishOrdering() {
            hideSuccessModal();
            // é‡ç½®ç³»çµ±
            selectedTable = null;
            order = [];
            dom.selectedTableText.textContent = 'é¸æ“‡æ¡Œè™Ÿ';
            dom.statusText.textContent = 'è«‹é¸æ“‡æ¡Œè™Ÿé–‹å§‹é»é¤';
            updateCartDisplay();
            renderMenu();
        }

        // è®“å‡½æ•¸å¯ä»¥åœ¨ HTML ä¸­èª¿ç”¨
        window.addToOrder = addToOrder;
        window.adjustQuantity = adjustQuantity;
        window.loadExistingOrders = loadExistingOrders;
    </script>
    
    <!-- è¼‰å…¥ Notion ç®¡ç†å™¨ (å¦‚æœéœ€è¦) -->
    <!-- <script src="../assets/js/notion-manager.js?v=2025072501"></script> -->
</body>
</html>
