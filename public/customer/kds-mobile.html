<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ“± æ‰‹æ©Ÿå»šæˆ¿ç³»çµ± - Tanawat Restaurant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .order-card {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .order-card:active {
            transform: scale(0.98);
        }
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
        .status-new {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-left: 4px solid #f59e0b;
        }
        .status-preparing {
            background: linear-gradient(135deg, #dbeafe 0%, #3b82f6 100%);
            border-left: 4px solid #2563eb;
            color: white;
        }
        .status-ready {
            background: linear-gradient(135deg, #dcfce7 0%, #16a34a 100%);
            border-left: 4px solid #15803d;
        }
        .status-delivered {
            background: linear-gradient(135deg, #f3f4f6 0%, #6b7280 100%);
            border-left: 4px solid #4b5563;
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        .time-badge {
            font-family: monospace;
            font-weight: bold;
        }
        .urgent {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .priority-high {
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .swipe-action {
            position: relative;
            overflow: hidden;
        }
        .action-buttons {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .order-card.swiped .action-buttons {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- æ‰‹æ©Ÿå°ˆç”¨é ­éƒ¨ -->
    <header class="mobile-header bg-white shadow-sm border-b">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-gray-900">ğŸ‘¨â€ğŸ³ å»šæˆ¿ç³»çµ±</h1>
                    <p class="text-xs text-gray-500" id="statusInfo">è¼‰å…¥ä¸­...</p>
                </div>
                <div class="flex space-x-2">
                    <button id="refreshBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
                        ğŸ”„
                    </button>
                    <button id="settingsBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">
                        âš™ï¸
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ¨™ç±¤åˆ‡æ› -->
        <div class="flex bg-gray-100 text-sm">
            <button id="tabNew" class="tab-button flex-1 py-2 font-medium active">
                ğŸ”” æ–°è¨‚å–® (<span id="newCount">0</span>)
            </button>
            <button id="tabPreparing" class="tab-button flex-1 py-2 font-medium">
                ğŸ”¥ æº–å‚™ä¸­ (<span id="preparingCount">0</span>)
            </button>
            <button id="tabReady" class="tab-button flex-1 py-2 font-medium">
                âœ… å®Œæˆ (<span id="readyCount">0</span>)
            </button>
        </div>
    </header>

    <!-- çµ±è¨ˆé¢æ¿ï¼ˆå¯æ”¶ç¸®ï¼‰ -->
    <div id="statsPanel" class="bg-white border-b">
        <button id="statsToggle" class="w-full px-4 py-2 text-left text-sm flex items-center justify-between">
            <span>ğŸ“Š ä»Šæ—¥çµ±è¨ˆ</span>
            <span id="statsIcon">â–¼</span>
        </button>
        <div id="statsContent" class="px-4 pb-2 hidden">
            <div class="grid grid-cols-3 gap-3 text-center text-xs">
                <div class="bg-yellow-50 p-2 rounded">
                    <div class="font-semibold text-yellow-700" id="todayNew">0</div>
                    <div class="text-yellow-600">æ–°è¨‚å–®</div>
                </div>
                <div class="bg-blue-50 p-2 rounded">
                    <div class="font-semibold text-blue-700" id="todayCompleted">0</div>
                    <div class="text-blue-600">å·²å®Œæˆ</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                    <div class="font-semibold text-green-700" id="avgTime">-</div>
                    <div class="text-green-600">å¹³å‡æ™‚é–“</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°è¨‚å–®åˆ—è¡¨ -->
    <div id="newOrdersSection" class="p-4">
        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="newOrdersLoading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-2"></div>
            <p class="text-sm text-gray-500">è¼‰å…¥æ–°è¨‚å–®...</p>
        </div>

        <!-- è¨‚å–®åˆ—è¡¨ -->
        <div id="newOrdersList" class="space-y-3 hidden"></div>

        <!-- ç„¡è¨‚å–® -->
        <div id="noNewOrders" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">å¤ªæ£’äº†ï¼</h3>
            <p class="text-sm text-gray-500">ç›®å‰æ²’æœ‰æ–°è¨‚å–®</p>
        </div>

        <!-- éŒ¯èª¤ -->
        <div id="newOrdersError" class="text-center py-8 hidden">
            <div class="text-4xl mb-2 text-red-400">âš ï¸</div>
            <p class="text-sm text-red-500 mb-3">è¼‰å…¥å¤±æ•—</p>
            <button onclick="loadOrders()" class="bg-red-500 text-white px-4 py-2 rounded text-sm">
                é‡è©¦
            </button>
        </div>
    </div>

    <!-- æº–å‚™ä¸­è¨‚å–®åˆ—è¡¨ -->
    <div id="preparingOrdersSection" class="p-4 hidden">
        <div id="preparingOrdersList" class="space-y-3"></div>
        <div id="noPreparingOrders" class="text-center py-12 hidden">
            <div class="text-4xl mb-4">â³</div>
            <p class="text-sm text-gray-500">æ²’æœ‰æº–å‚™ä¸­çš„è¨‚å–®</p>
        </div>
    </div>

    <!-- å®Œæˆè¨‚å–®åˆ—è¡¨ -->
    <div id="readyOrdersSection" class="p-4 hidden">
        <div id="readyOrdersList" class="space-y-3"></div>
        <div id="noReadyOrders" class="text-center py-12 hidden">
            <div class="text-4xl mb-4">ğŸ“¦</div>
            <p class="text-sm text-gray-500">æ²’æœ‰ç­‰å¾…é€é”çš„è¨‚å–®</p>
        </div>
    </div>

    <!-- æ“ä½œç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="actionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-3" id="modalTitle">ç¢ºèªæ“ä½œ</h3>
            <p class="text-gray-600 mb-4" id="modalMessage">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex space-x-2">
                <button id="confirmAction" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm font-semibold">
                    ç¢ºèª
                </button>
                <button id="cancelAction" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div id="settingsPanel" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4">âš™ï¸ ç³»çµ±è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">è‡ªå‹•åˆ·æ–°é–“éš”</label>
                    <select id="refreshInterval" class="w-full border rounded px-3 py-2 text-sm">
                        <option value="5000">5 ç§’</option>
                        <option value="10000" selected>10 ç§’</option>
                        <option value="30000">30 ç§’</option>
                        <option value="0">é—œé–‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">éŸ³æ•ˆé€šçŸ¥</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="soundEnabled" checked class="mr-2">
                        <span class="text-sm">æ–°è¨‚å–®éŸ³æ•ˆæé†’</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ç·Šæ€¥è¨‚å–®é–¾å€¼ï¼ˆåˆ†é˜ï¼‰</label>
                    <input type="number" id="urgentThreshold" value="15" min="5" max="60" 
                           class="w-full border rounded px-3 py-2 text-sm">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button id="saveSettings" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm font-semibold">
                    å„²å­˜
                </button>
                <button id="closeSettings" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½® ===
        const VERSION = 'mobile-kds-v1.0-' + Date.now();
        console.log('ğŸ“± æ‰‹æ©Ÿå»šæˆ¿ç³»çµ±ç‰ˆæœ¬:', VERSION);

        const CONFIG = {
            apiBase: `${window.location.origin}/.netlify/functions/notion-api`,
            databases: {
                orders: '23afd5adc30b80c39e71d1a640ccfb5d'
            }
        };

        // === å…¨åŸŸè®Šæ•¸ ===
        let allOrders = [];
        let currentTab = 'new';
        let refreshTimer = null;
        let settings = {
            refreshInterval: 10000,
            soundEnabled: true,
            urgentThreshold: 15
        };
        let lastOrderCount = 0;

        // === API å‡½æ•¸ ===
        async function callNotionAPI(path, method = 'GET', body = null) {
            try {
                const response = await fetch(CONFIG.apiBase, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, method, body })
                });

                if (!response.ok) {
                    throw new Error(`API éŒ¯èª¤: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('âŒ API å‘¼å«å¤±æ•—:', error);
                throw error;
            }
        }

        // === è³‡æ–™è¼‰å…¥ ===
        async function loadOrders() {
            updateStatus('è¼‰å…¥è¨‚å–®ä¸­...');
            try {
                const data = await callNotionAPI(`/databases/${CONFIG.databases.orders}/query`, 'POST', {
                    page_size: 100,
                    filter: {
                        and: [
                            {
                                property: 'ç‹€æ…‹',
                                select: { does_not_equal: 'å·²å–æ¶ˆ' }
                            },
                            {
                                property: 'ä»˜æ¬¾ç‹€æ…‹',
                                select: { does_not_equal: 'å·²ä»˜æ¬¾' }
                            }
                        ]
                    },
                    sorts: [{ property: 'å»ºç«‹æ™‚é–“', direction: 'descending' }]
                });
                
                allOrders = data.results || [];
                
                // æª¢æŸ¥æ–°è¨‚å–®é€šçŸ¥
                checkNewOrders();
                
                updateStatus(`å·²è¼‰å…¥ ${allOrders.length} å€‹æ´»èºè¨‚å–®`);
                return allOrders;
            } catch (error) {
                updateStatus(`è¼‰å…¥å¤±æ•—: ${error.message}`);
                throw error;
            }
        }

        function checkNewOrders() {
            const newOrders = getOrdersByStatus('é»é¤ä¸­');
            if (newOrders.length > lastOrderCount && lastOrderCount > 0) {
                if (settings.soundEnabled) {
                    playNotificationSound();
                }
                // é¡¯ç¤ºé€šçŸ¥ï¼ˆå¦‚æœæ”¯æ´ï¼‰
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('æ–°è¨‚å–®ï¼', {
                        body: `æ”¶åˆ° ${newOrders.length - lastOrderCount} å€‹æ–°è¨‚å–®`,
                        icon: 'ğŸ””'
                    });
                }
            }
            lastOrderCount = newOrders.length;
        }

        function playNotificationSound() {
            // ä½¿ç”¨ Web Audio API ç”¢ç”Ÿç°¡å–®éŸ³æ•ˆ
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
            }
        }

        // === è³‡æ–™è§£æ ===
        function getProperty(obj, propName, type = 'text') {
            try {
                const prop = obj.properties?.[propName];
                if (!prop) return null;

                switch (type) {
                    case 'title': return prop.title?.[0]?.text?.content || null;
                    case 'text': return prop.rich_text?.[0]?.text?.content || null;
                    case 'number': return prop.number || 0;
                    case 'select': return prop.select?.name || null;
                    default: return null;
                }
            } catch (error) {
                return null;
            }
        }

        function parseOrder(order) {
            const itemsText = getProperty(order, 'è¨‚å–®é …ç›®', 'text');
            let items = [];
            if (itemsText) {
                try { items = JSON.parse(itemsText); } catch (e) {}
            }

            const createTimeText = getProperty(order, 'å»ºç«‹æ™‚é–“', 'text');
            let createTime = null;
            if (createTimeText) {
                createTime = new Date(createTimeText);
            }

            return {
                id: order.id,
                number: getProperty(order, 'è¨‚å–®ç·¨è™Ÿ', 'title'),
                tableNumber: getProperty(order, 'æ¡Œè™Ÿ', 'text'),
                items: items,
                total: getProperty(order, 'ç¸½é‡‘é¡', 'number'),
                status: getProperty(order, 'ç‹€æ…‹', 'select'),
                paymentStatus: getProperty(order, 'ä»˜æ¬¾ç‹€æ…‹', 'select'),
                createTime: createTime
            };
        }

        // === è¨‚å–®ç¯©é¸ ===
        function getOrdersByStatus(status) {
            return allOrders.map(parseOrder).filter(order => order.status === status);
        }

        function getElapsedTime(createTime) {
            if (!createTime) return 0;
            return Math.floor((Date.now() - createTime.getTime()) / 1000 / 60); // åˆ†é˜
        }

        function isUrgent(order) {
            const elapsed = getElapsedTime(order.createTime);
            return elapsed >= settings.urgentThreshold;
        }

        // === UI æ›´æ–° ===
        function updateStatus(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('statusInfo').textContent = `${message} (${timestamp})`;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ¨™ç±¤æ¨£å¼
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            // é¡¯ç¤ºå°æ‡‰å…§å®¹
            document.getElementById('newOrdersSection').classList.toggle('hidden', tab !== 'new');
            document.getElementById('preparingOrdersSection').classList.toggle('hidden', tab !== 'preparing');
            document.getElementById('readyOrdersSection').classList.toggle('hidden', tab !== 'ready');
            
            renderOrders();
        }

        function updateOrderCounts() {
            const newOrders = getOrdersByStatus('é»é¤ä¸­');
            const preparingOrders = getOrdersByStatus('æº–å‚™ä¸­');
            const readyOrders = getOrdersByStatus('å·²é€é”');

            document.getElementById('newCount').textContent = newOrders.length;
            document.getElementById('preparingCount').textContent = preparingOrders.length;
            document.getElementById('readyCount').textContent = readyOrders.length;
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayOrders = allOrders
                .map(parseOrder)
                .filter(order => order.createTime && order.createTime.toDateString() === today);

            const newToday = todayOrders.filter(o => o.status === 'é»é¤ä¸­').length;
            const completedToday = todayOrders.filter(o => o.status === 'å·²é€é”').length;
            
            // è¨ˆç®—å¹³å‡è™•ç†æ™‚é–“
            const completedWithTime = todayOrders.filter(o => 
                o.status === 'å·²é€é”' && o.createTime
            );
            
            let avgTime = '-';
            if (completedWithTime.length > 0) {
                const totalMinutes = completedWithTime.reduce((sum, order) => {
                    return sum + getElapsedTime(order.createTime);
                }, 0);
                avgTime = Math.round(totalMinutes / completedWithTime.length) + 'åˆ†';
            }

            document.getElementById('todayNew').textContent = newToday;
            document.getElementById('todayCompleted').textContent = completedToday;
            document.getElementById('avgTime').textContent = avgTime;
        }

        function renderOrders() {
            let orders, container, emptyContainer;

            switch (currentTab) {
                case 'new':
                    orders = getOrdersByStatus('é»é¤ä¸­');
                    container = document.getElementById('newOrdersList');
                    emptyContainer = document.getElementById('noNewOrders');
                    break;
                case 'preparing':
                    orders = getOrdersByStatus('æº–å‚™ä¸­');
                    container = document.getElementById('preparingOrdersList');
                    emptyContainer = document.getElementById('noPreparingOrders');
                    break;
                case 'ready':
                    orders = getOrdersByStatus('å·²é€é”');
                    container = document.getElementById('readyOrdersList');
                    emptyContainer = document.getElementById('noReadyOrders');
                    break;
                default:
                    return;
            }

            if (orders.length === 0) {
                container.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }

            emptyContainer.classList.add('hidden');
            container.classList.remove('hidden');

            // æŒ‰æ™‚é–“æ’åºï¼Œç·Šæ€¥è¨‚å–®å„ªå…ˆ
            orders.sort((a, b) => {
                const aUrgent = isUrgent(a);
                const bUrgent = isUrgent(b);
                if (aUrgent && !bUrgent) return -1;
                if (!aUrgent && bUrgent) return 1;
                return (a.createTime || 0) - (b.createTime || 0);
            });

            container.innerHTML = orders.map(order => {
                const elapsed = getElapsedTime(order.createTime);
                const urgent = isUrgent(order);
                
                return `
                    <div class="order-card ${getStatusClass(order.status)} ${urgent ? 'urgent priority-high' : ''} 
                                p-4 rounded-lg shadow-sm border">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg">ğŸ“‹ ${order.number}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-sm font-medium">ğŸª‘ æ¡Œ ${order.tableNumber}</span>
                                    <span class="time-badge text-xs px-2 py-1 rounded-full ${urgent ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-700'}">
                                        ${elapsed}åˆ†é˜å‰
                                    </span>
                                    ${urgent ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded-full">ğŸš¨ ç·Šæ€¥</span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600">NT$ ${order.total}</div>
                                ${renderActionButtons(order)}
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${order.items.map(item => `
                                <div class="flex justify-between text-sm bg-white bg-opacity-50 p-2 rounded">
                                    <span class="font-medium">${item.name} Ã— ${item.quantity}</span>
                                    <span>NT$ ${item.price * item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'é»é¤ä¸­': return 'status-new';
                case 'æº–å‚™ä¸­': return 'status-preparing';
                case 'å·²é€é”': return 'status-ready';
                default: return 'status-delivered';
            }
        }

        function renderActionButtons(order) {
            switch (order.status) {
                case 'é»é¤ä¸­':
                    return `
                        <button onclick="updateOrderStatus('${order.id}', 'æº–å‚™ä¸­')" 
                                class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs font-semibold">
                            ğŸ”¥ é–‹å§‹æº–å‚™
                        </button>
                    `;
                case 'æº–å‚™ä¸­':
                    return `
                        <button onclick="updateOrderStatus('${order.id}', 'å·²é€é”')" 
                                class="mt-2 bg-green-500 text-white px-3 py-1 rounded text-xs font-semibold">
                            âœ… å®Œæˆ
                        </button>
                    `;
                case 'å·²é€é”':
                    return `
                        <button onclick="markAsDelivered('${order.id}')" 
                                class="mt-2 bg-gray-500 text-white px-3 py-1 rounded text-xs font-semibold">
                            ğŸ“¦ å·²é€é”
                        </button>
                    `;
                default:
                    return '';
            }
        }

        // === è¨‚å–®æ“ä½œ ===
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await callNotionAPI(`/pages/${orderId}`, 'PATCH', {
                    properties: {
                        'ç‹€æ…‹': { select: { name: newStatus } }
                    }
                });

                updateStatus(`è¨‚å–®ç‹€æ…‹å·²æ›´æ–°ç‚º: ${newStatus}`);
                await refreshData();
                
            } catch (error) {
                updateStatus(`æ›´æ–°å¤±æ•—: ${error.message}`);
                alert(`âŒ æ›´æ–°å¤±æ•—ï¼š${error.message}`);
            }
        }

        async function markAsDelivered(orderId) {
            try {
                await callNotionAPI(`/pages/${orderId}`, 'PATCH', {
                    properties: {
                        'ç‹€æ…‹': { select: { name: 'å·²é€é”' } }
                    }
                });

                updateStatus('è¨‚å–®å·²æ¨™è¨˜ç‚ºå·²é€é”');
                await refreshData();
                
            } catch (error) {
                updateStatus(`æ¨™è¨˜å¤±æ•—: ${error.message}`);
                alert(`âŒ æ¨™è¨˜å¤±æ•—ï¼š${error.message}`);
            }
        }

        // === è¨­å®šç®¡ç† ===
        function showSettings() {
            document.getElementById('refreshInterval').value = settings.refreshInterval;
            document.getElementById('soundEnabled').checked = settings.soundEnabled;
            document.getElementById('urgentThreshold').value = settings.urgentThreshold;
            
            document.getElementById('settingsPanel').classList.remove('hidden');
            document.getElementById('settingsPanel').classList.add('flex');
        }

        function hideSettings() {
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('settingsPanel').classList.remove('flex');
        }

        function saveSettings() {
            settings.refreshInterval = parseInt(document.getElementById('refreshInterval').value);
            settings.soundEnabled = document.getElementById('soundEnabled').checked;
            settings.urgentThreshold = parseInt(document.getElementById('urgentThreshold').value);
            
            // é‡è¨­è‡ªå‹•åˆ·æ–°
            setupAutoRefresh();
            
            // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('kds-settings', JSON.stringify(settings));
            
            hideSettings();
            updateStatus('è¨­å®šå·²å„²å­˜');
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('kds-settings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.log('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // === è‡ªå‹•åˆ·æ–° ===
        function setupAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }

            if (settings.refreshInterval > 0) {
                refreshTimer = setInterval(refreshData, settings.refreshInterval);
            }
        }

        // === è³‡æ–™åˆ·æ–° ===
        async function refreshData() {
            try {
                await loadOrders();
                updateOrderCounts();
                updateStats();
                renderOrders();
                
                // éš±è—è¼‰å…¥ç‹€æ…‹
                document.getElementById('newOrdersLoading').classList.add('hidden');
                document.getElementById('newOrdersError').classList.add('hidden');
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±æ•—:', error);
                if (currentTab === 'new') {
                    document.getElementById('newOrdersLoading').classList.add('hidden');
                    document.getElementById('newOrdersError').classList.remove('hidden');
                }
            }
        }

        // === äº‹ä»¶ç›£è½ ===
        function setupEventListeners() {
            // æ¨™ç±¤åˆ‡æ›
            document.getElementById('tabNew').addEventListener('click', () => switchTab('new'));
            document.getElementById('tabPreparing').addEventListener('click', () => switchTab('preparing'));
            document.getElementById('tabReady').addEventListener('click', () => switchTab('ready'));

            // çµ±è¨ˆé¢æ¿åˆ‡æ›
            document.getElementById('statsToggle').addEventListener('click', () => {
                const content = document.getElementById('statsContent');
                const icon = document.getElementById('statsIcon');
                content.classList.toggle('hidden');
                icon.textContent = content.classList.contains('hidden') ? 'â–¼' : 'â–²';
            });

            // æŒ‰éˆ•äº‹ä»¶
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('settingsBtn').addEventListener('click', showSettings);
            
            // è¨­å®šé¢æ¿
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('closeSettings').addEventListener('click', hideSettings);
            
            // èƒŒæ™¯é»æ“Šé—œé–‰
            document.getElementById('settingsPanel').addEventListener('click', (e) => {
                if (e.target.id === 'settingsPanel') hideSettings();
            });

            // è«‹æ±‚é€šçŸ¥æ¬Šé™
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // === åˆå§‹åŒ– ===
        async function initSystem() {
            updateStatus('ç³»çµ±åˆå§‹åŒ–ä¸­...');
            try {
                loadSettings();
                setupEventListeners();
                setupAutoRefresh();
                await refreshData();
                updateStatus('ç³»çµ±å·²å°±ç·’');
            } catch (error) {
                updateStatus(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                document.getElementById('newOrdersError').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initSystem);

        // === é é¢å¯è¦‹æ€§è™•ç† ===
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é é¢éš±è—æ™‚æš«åœè‡ªå‹•åˆ·æ–°
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                }
            } else {
                // é é¢é¡¯ç¤ºæ™‚æ¢å¾©è‡ªå‹•åˆ·æ–°ä¸¦ç«‹å³åˆ·æ–°ä¸€æ¬¡
                setupAutoRefresh();
                refreshData();
            }
        });
    </script>
</body>
</html>
