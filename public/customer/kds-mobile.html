<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ“± 7å¯¸å¹³æ¿å»šæˆ¿ç³»çµ± - Tanawat Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- ç’°å¢ƒé…ç½® (å¿…é ˆåœ¨å…¶ä»–è…³æœ¬ä¹‹å‰è¼‰å…¥) -->
    <script src="../env-config.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        
        /* 7å¯¸å¹³æ¿æ©«å‘å„ªåŒ– */
        @media screen and (min-width: 1024px) and (max-height: 768px) {
            .tablet-landscape {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
            .tablet-header {
                height: 80px;
                flex-shrink: 0;
            }
            .tablet-main {
                flex: 1;
                overflow-x: auto;
            }
        }
        
        /* å½ˆå‡ºå¼é¸å–®æ¨£å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #374151;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            left: 0;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #4b5563;
        }
        .dropdown-item.active {
            background-color: #3b82f6;
        }
        
        #order-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #order-container::-webkit-scrollbar {
            display: none;
        }
        
        .order-card {
            animation: slideIn 0.5s ease-out;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .order-card:active {
            transform: scale(0.98);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .completed-order {
            animation: slideOut 0.3s ease-in;
        }
        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(20px) scale(0.8);
            }
        }
        
        .status-pending { 
            border-left: 6px solid #f97316;
            background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%);
        }
        .status-making { 
            border-left: 6px solid #eab308;
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        }
        .status-waiting-dessert { 
            border-left: 6px solid #22c55e;
            background: linear-gradient(135deg, #dcfce7 0%, #16a34a 100%);
        }
        .status-waiting-checkout { 
            border-left: 6px solid #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #2563eb 100%);
        }
        
        .priority-high { 
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
        }
        .priority-normal { 
            background: linear-gradient(135deg, #f3f4f6, #ffffff); 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background: #3b82f6 !important;
            color: white;
        }
        
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="tablet-landscape">
        <!-- é ‚éƒ¨å·¥å…·æ¬„ -->
        <header class="tablet-header bg-gray-800 border-b-4 border-indigo-600 shadow-lg">
            <div class="flex items-center justify-between h-full px-6">
                <!-- å·¦å´ï¼šæ¨™é¡Œå’Œç‹€æ…‹ -->
                <div class="flex items-center space-x-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">ğŸ‘¨â€ğŸ³ å»šæˆ¿ç³»çµ±</h1>
                        <p id="system-status" class="text-sm text-green-400">â— é€£ç·šæ­£å¸¸</p>
                    </div>
                    <div class="text-center">
                        <p id="system-time" class="text-xl font-mono text-gray-200"></p>
                        <p class="text-xs text-gray-400">ç³»çµ±æ™‚é–“</p>
                    </div>
                </div>

                <!-- ä¸­é–“ï¼šé‡é»æ•¸æ“šå±•ç¤º -->
                <div class="flex items-center space-x-6">
                    <div class="bg-orange-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-pending">0</p>
                        <p class="text-xs text-orange-200">å¾…è™•ç†</p>
                    </div>
                    <div class="bg-yellow-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-making">0</p>
                        <p class="text-xs text-yellow-200">è£½ä½œä¸­</p>
                    </div>
                    <div class="bg-green-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-waiting-dessert">0</p>
                        <p class="text-xs text-green-200">ç­‰å¾…ç”œé»</p>
                    </div>
                    <div class="bg-blue-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-waiting-checkout">0</p>
                        <p class="text-xs text-blue-200">ç­‰å¾…çµå¸³</p>
                    </div>
                    <div class="bg-orange-600 px-4 py-2 rounded-lg text-center min-w-[120px]">
                        <p class="text-xl font-bold text-white" id="avg-wait-time">-- åˆ†é˜</p>
                        <p class="text-xs text-orange-200">å¹³å‡ç­‰å¾…</p>
                    </div>
                </div>

                <!-- å³å´ï¼šæ“ä½œæŒ‰éˆ• -->
                <div class="flex items-center space-x-3">
                    <!-- ç¯©é¸é¸å–® -->
                    <div class="dropdown">
                        <button id="filter-menu-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center space-x-2">
                            <span>ğŸ” ç¯©é¸</span>
                            <span class="text-xs">â–¼</span>
                        </button>
                        <div id="filter-dropdown" class="dropdown-content">
                            <div class="dropdown-item active" data-filter="all">
                                <span>ğŸ“‹ å…¨éƒ¨è¨‚å–®</span>
                                <span class="float-right" id="dropdown-count-all">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="pending">
                                <span>ğŸŸ  å¾…è™•ç†</span>
                                <span class="float-right" id="dropdown-count-pending">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="making">
                                <span>ğŸŸ¡ è£½ä½œä¸­</span>
                                <span class="float-right" id="dropdown-count-making">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="waiting-dessert">
                                <span>ğŸŸ¢ ç­‰å¾…ç”œé»</span>
                                <span class="float-right" id="dropdown-count-waiting-dessert">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="waiting-checkout">
                                <span>ï¿½ ç­‰å¾…çµå¸³</span>
                                <span class="float-right" id="dropdown-count-waiting-checkout">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- ç›£æ§é¸å–® -->
                    <div class="dropdown">
                        <button id="monitor-menu-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center space-x-2">
                            <span>ğŸ“Š ç›£æ§</span>
                            <span class="text-xs">â–¼</span>
                        </button>
                        <div id="monitor-dropdown" class="dropdown-content">
                            <div class="dropdown-item" id="show-stats">
                                <span>ğŸ“ˆ é¡¯ç¤ºçµ±è¨ˆè©³æƒ…</span>
                            </div>
                            <div class="dropdown-item" id="show-alerts">
                                <span>âš ï¸ è¶…æ™‚è­¦ç¤º</span>
                                <span class="float-right text-red-400" id="alert-count">0</span>
                            </div>
                            <div class="dropdown-item" id="show-performance">
                                <span>âš¡ æ•ˆèƒ½ç›£æ§</span>
                            </div>
                        </div>
                    </div>

                    <button id="refresh-kds-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        ğŸ”„ æ›´æ–°
                    </button>
                    <button id="settings-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        âš™ï¸ è¨­å®š
                    </button>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦è¨‚å–®é¡¯ç¤ºå€åŸŸ -->
        <main id="order-container" class="tablet-main flex-1 flex items-start p-4 bg-gray-900 overflow-x-auto">
            <div id="order-wrapper" class="flex flex-nowrap space-x-4 h-full min-w-full">
                <div id="loading-placeholder" class="text-center py-16 text-gray-400 w-screen">
                    <div class="animate-spin rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 mx-auto"></div>
                    <p class="text-xl">æ­£åœ¨é€£æ¥ Notion è³‡æ–™åº«...</p>
                    <p class="text-sm mt-2">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­</p>
                </div>
            </div>
        </main>
    </div>

    <!-- çµ±è¨ˆè©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="stats-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">ğŸ“ˆ è©³ç´°çµ±è¨ˆè³‡è¨Š</h2>
                <button id="close-stats-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="stats-content" class="text-gray-900">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">â±ï¸ æ™‚é–“çµ±è¨ˆ</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>å¹³å‡ç­‰å¾…æ™‚é–“ï¼š</span>
                                <span id="stats-avg-wait" class="font-bold">-- åˆ†é˜</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æœ€é•·ç­‰å¾…æ™‚é–“ï¼š</span>
                                <span id="stats-max-wait" class="font-bold">-- åˆ†é˜</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æœ€çŸ­ç­‰å¾…æ™‚é–“ï¼š</span>
                                <span id="stats-min-wait" class="font-bold">-- åˆ†é˜</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-800 mb-3">ğŸ“Š è¨‚å–®çµ±è¨ˆ</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>ä»Šæ—¥å®Œæˆï¼š</span>
                                <span id="stats-today-completed" class="font-bold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>è™•ç†ä¸­è¨‚å–®ï¼š</span>
                                <span id="stats-processing" class="font-bold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å®Œæˆç‡ï¼š</span>
                                <span id="stats-completion-rate" class="font-bold">--%</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">âš¡ æ•ˆèƒ½æŒ‡æ¨™</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>ç³»çµ±å›æ‡‰æ™‚é–“ï¼š</span>
                                <span id="stats-response-time" class="font-bold">-- æ¯«ç§’</span>
                            </div>
                            <div class="flex justify-between">
                                <span>è³‡æ–™æ›´æ–°é »ç‡ï¼š</span>
                                <span id="stats-refresh-rate" class="font-bold">30 ç§’</span>
                            </div>
                            <div class="flex justify-between">
                                <span>é€£ç·šç‹€æ…‹ï¼š</span>
                                <span id="stats-connection" class="font-bold text-green-600">æ­£å¸¸</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¶…æ™‚è­¦ç¤ºæ¨¡æ…‹æ¡† -->
    <div id="alerts-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">âš ï¸ è¶…æ™‚è­¦ç¤º</h2>
                <button id="close-alerts-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="alerts-content" class="text-gray-900">
                <div id="alert-list" class="space-y-3">
                    <!-- è­¦ç¤ºå…§å®¹å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">è¨‚å–®è©³æƒ…</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-900">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div id="settings-panel" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4 text-gray-900">âš™ï¸ ç³»çµ±è¨­å®š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">è‡ªå‹•åˆ·æ–°é–“éš”</label>
                    <select id="refresh-interval" class="w-full border rounded px-3 py-2 text-sm">
                        <option value="15000">15 ç§’</option>
                        <option value="30000" selected>30 ç§’</option>
                        <option value="60000">1 åˆ†é˜</option>
                        <option value="0">é—œé–‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">éŸ³æ•ˆé€šçŸ¥</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="sound-enabled" checked class="mr-2">
                        <span class="text-sm text-gray-700">æ–°è¨‚å–®éŸ³æ•ˆæé†’</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">ç·Šæ€¥è¨‚å–®é–¾å€¼ï¼ˆåˆ†é˜ï¼‰</label>
                    <input type="number" id="urgent-threshold" value="30" min="15" max="60" 
                           class="w-full border rounded px-3 py-2 text-sm">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button id="save-settings" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm font-semibold">
                    å„²å­˜
                </button>
                <button id="close-settings" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½® ===
        const VERSION = 'tablet-kds-v2.0-' + Date.now();
        console.log('ğŸ“± 7å¯¸å¹³æ¿å»šæˆ¿ç³»çµ±ç‰ˆæœ¬:', VERSION);

        const CONFIG = {
            notionApiKey: window.ENV_CONFIG?.NOTION_API_KEY || 'secret_iSDhSCT8HPZMjPsX8YuMdhfzPJ2EYJrfXLdE17L88cV',
            netlifyFunctionBase: `${window.location.origin}/.netlify/functions`,
            ordersDatabase: '23afd5adc30b80c39e71d1a640ccfb5d',
            autoRefreshInterval: 30000, // 30ç§’
            soundEnabled: true
        };

        // === å…¨åŸŸè®Šæ•¸ ===
        let allOrders = [];
        let displayedOrderIds = new Set();
        let currentFilter = 'all';
        let autoRefreshTimer = null;
        let settings = {
            refreshInterval: 30000,
            soundEnabled: true,
            urgentThreshold: 30
        };

        // === DOM å…ƒç´  ===
        const dom = {
            orderWrapper: document.getElementById('order-wrapper'),
            systemTime: document.getElementById('system-time'),
            systemStatus: document.getElementById('system-status'),
            loadingPlaceholder: document.getElementById('loading-placeholder'),
            refreshKdsBtn: document.getElementById('refresh-kds-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            orderModal: document.getElementById('order-modal'),
            modalContent: document.getElementById('modal-content'),
            closeModal: document.getElementById('close-modal'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettings: document.getElementById('save-settings'),
            closeSettings: document.getElementById('close-settings'),
            // å½ˆå‡ºå¼é¸å–®
            filterMenuBtn: document.getElementById('filter-menu-btn'),
            filterDropdown: document.getElementById('filter-dropdown'),
            monitorMenuBtn: document.getElementById('monitor-menu-btn'),
            monitorDropdown: document.getElementById('monitor-dropdown'),
            // çµ±è¨ˆæ¨¡æ…‹æ¡†
            statsModal: document.getElementById('stats-modal'),
            closeStatsModal: document.getElementById('close-stats-modal'),
            alertsModal: document.getElementById('alerts-modal'),
            closeAlertsModal: document.getElementById('close-alerts-modal'),
            // Counters - é ‚éƒ¨é¡¯ç¤º
            countAll: document.getElementById('count-all'),
            countPending: document.getElementById('count-pending'),
            countMaking: document.getElementById('count-making'),
            countWaitingDessert: document.getElementById('count-waiting-dessert'),
            countWaitingCheckout: document.getElementById('count-waiting-checkout'),
            // Counters - ä¸‹æ‹‰é¸å–®
            dropdownCountAll: document.getElementById('dropdown-count-all'),
            dropdownCountPending: document.getElementById('dropdown-count-pending'),
            dropdownCountMaking: document.getElementById('dropdown-count-making'),
            dropdownCountWaitingDessert: document.getElementById('dropdown-count-waiting-dessert'),
            dropdownCountWaitingCheckout: document.getElementById('dropdown-count-waiting-checkout'),
            // Stats
            avgWaitTime: document.getElementById('avg-wait-time'),
            alertCount: document.getElementById('alert-count')
        };

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ 7å¯¸å¹³æ¿ KDS ç³»çµ±åˆå§‹åŒ–');
            loadSettings();
            initEventListeners();
            fetchOrders();
            updateTime();
            setInterval(updateTime, 1000);
            startAutoRefresh();
        });

        function initEventListeners() {
            // åˆ·æ–°æŒ‰éˆ•
            dom.refreshKdsBtn.addEventListener('click', fetchOrders);
            
            // è¨­å®šæŒ‰éˆ•
            dom.settingsBtn.addEventListener('click', showSettings);
            
            // å½ˆå‡ºå¼é¸å–® - ç¯©é¸
            dom.filterMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown('filter');
            });
            
            // å½ˆå‡ºå¼é¸å–® - ç›£æ§
            dom.monitorMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown('monitor');
            });
            
            // ç¯©é¸é¸é …
            dom.filterDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-item') || e.target.parentElement.classList.contains('dropdown-item')) {
                    const item = e.target.classList.contains('dropdown-item') ? e.target : e.target.parentElement;
                    const filter = item.dataset.filter;
                    if (filter) {
                        setFilter(filter);
                        closeAllDropdowns();
                    }
                }
            });
            
            // ç›£æ§é¸é …
            document.getElementById('show-stats').addEventListener('click', () => {
                showStatsModal();
                closeAllDropdowns();
            });
            
            document.getElementById('show-alerts').addEventListener('click', () => {
                showAlertsModal();
                closeAllDropdowns();
            });
            
            document.getElementById('show-performance').addEventListener('click', () => {
                showStatsModal(); // æš«æ™‚ä½¿ç”¨ç›¸åŒçš„çµ±è¨ˆæ¨¡æ…‹æ¡†
                closeAllDropdowns();
            });
            
            // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
            document.addEventListener('click', closeAllDropdowns);
            
            // æ¨¡æ…‹æ¡†
            dom.closeModal.addEventListener('click', closeModal);
            dom.orderModal.addEventListener('click', (e) => {
                if (e.target === dom.orderModal) closeModal();
            });
            
            // çµ±è¨ˆæ¨¡æ…‹æ¡†
            dom.closeStatsModal.addEventListener('click', closeStatsModal);
            dom.statsModal.addEventListener('click', (e) => {
                if (e.target === dom.statsModal) closeStatsModal();
            });
            
            // è­¦ç¤ºæ¨¡æ…‹æ¡†
            dom.closeAlertsModal.addEventListener('click', closeAlertsModal);
            dom.alertsModal.addEventListener('click', (e) => {
                if (e.target === dom.alertsModal) closeAlertsModal();
            });
            
            // è¨­å®šé¢æ¿
            dom.saveSettings.addEventListener('click', saveSettings);
            dom.closeSettings.addEventListener('click', hideSettings);
            dom.settingsPanel.addEventListener('click', (e) => {
                if (e.target === dom.settingsPanel) hideSettings();
            });
            
            // éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' || e.key === 'R') {
                    fetchOrders();
                } else if (e.key === 'Escape') {
                    closeModal();
                    closeStatsModal();
                    closeAlertsModal();
                    hideSettings();
                    closeAllDropdowns();
                }
            });

            // è«‹æ±‚é€šçŸ¥æ¬Šé™
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // === è³‡æ–™ç²å– ===
        async function fetchOrders() {
            console.log('ğŸ“¥ é–‹å§‹å¾ Notion ç²å–è¨‚å–®è³‡æ–™...');
            updateRefreshButton(true);

            try {
                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/databases/${CONFIG.ordersDatabase}/query`,
                        method: 'POST',
                        body: {
                            page_size: 100,
                            filter: {
                                and: [
                                    {
                                        property: 'ç‹€æ…‹',
                                        select: { 
                                            does_not_equal: 'å·²å–æ¶ˆ' 
                                        }
                                    },
                                    {
                                        property: 'ç‹€æ…‹',
                                        select: { 
                                            does_not_equal: 'çµå¸³å®Œæˆ' 
                                        }
                                    },
                                    {
                                        property: 'ç‹€æ…‹',
                                        select: { 
                                            does_not_equal: 'å·²å®Œæˆ' 
                                        }
                                    },
                                    {
                                        or: [
                                            {
                                                property: 'ç‹€æ…‹',
                                                select: { equals: 'å¾…è™•ç†' }
                                            },
                                            {
                                                property: 'ç‹€æ…‹',
                                                select: { equals: 'è£½ä½œä¸­' }
                                            },
                                            {
                                                property: 'ç‹€æ…‹',
                                                select: { equals: 'ç­‰å¾…ç”œé»' }
                                            },
                                            {
                                                property: 'ç‹€æ…‹',
                                                select: { equals: 'ç­‰å¾…çµå¸³' }
                                            }
                                        ]
                                    }
                                ]
                            },
                            sorts: [
                                {
                                    property: 'å»ºç«‹æ™‚é–“',
                                    direction: 'descending'
                                }
                            ]
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ æ”¶åˆ° Notion è¨‚å–®è³‡æ–™:', data);

                if (data.results && Array.isArray(data.results)) {
                    const oldOrderCount = allOrders.length;
                    allOrders = data.results.map(mapNotionOrderToKDS);
                    
                    // æª¢æŸ¥æ–°è¨‚å–®é€šçŸ¥
                    if (allOrders.length > oldOrderCount && oldOrderCount > 0) {
                        checkNewOrders();
                    }
                    
                    processAndRenderOrders();
                    updateStats();
                    updateStatus(true);
                    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allOrders.length} ç­†è¨‚å–®`);
                } else {
                    console.warn('âš ï¸ è³‡æ–™æ ¼å¼ç•°å¸¸:', data);
                    showError('è³‡æ–™æ ¼å¼ç•°å¸¸');
                }
            } catch (error) {
                console.error('âŒ ç²å–è¨‚å–®å¤±æ•—:', error);
                updateStatus(false);
                showError(`é€£ç·šå¤±æ•—: ${error.message}`);
            } finally {
                updateRefreshButton(false);
            }
        }

        // === Notion è³‡æ–™æ˜ å°„ ===
        function mapNotionOrderToKDS(notionOrder) {
            console.log('ğŸ”„ æ˜ å°„ Notion è¨‚å–®åˆ° KDS æ ¼å¼:', notionOrder);
            const props = notionOrder.properties;
            
            // è§£æè¨‚å–®ç·¨è™Ÿ
            const orderId = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || 
                           props['è¨‚å–®ç·¨è™Ÿ']?.rich_text?.[0]?.text?.content || 
                           `ORDER-${Date.now()}`;
            
            // è§£ææ¡Œè™Ÿ
            const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 
                               props['æ¡Œè™Ÿ']?.title?.[0]?.text?.content || 'æœªçŸ¥';
            
            // è§£æç‹€æ…‹
            const status = props['ç‹€æ…‹']?.select?.name || 'æº–å‚™ä¸­';
            
            // è§£æç¸½é‡‘é¡
            const total = props['ç¸½é‡‘é¡']?.number || 0;
            
            // è§£æç”¨é¤äººæ•¸
            const customerCount = props['ç”¨é¤äººæ•¸']?.number || 1;
            
            // è§£æå»ºç«‹æ™‚é–“
            const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || 
                               props['å»ºç«‹æ™‚é–“']?.created_time || 
                               notionOrder.created_time;
            
            // è§£æå‚™è¨»å’Œè¨‚å–®é …ç›®
            const notesText = props['å‚™è¨»']?.rich_text?.[0]?.text?.content || '';
            const orderItemsText = props['è¨‚å–®é …ç›®']?.rich_text?.[0]?.text?.content || '';
            let items = [];
            let customerNote = '';
            
            // å¾è¨‚å–®é …ç›®æ¬„ä½è§£æ
            if (orderItemsText) {
                const itemLines = orderItemsText.split('\n').filter(line => line.trim());
                items = itemLines.map(line => {
                    const match = line.match(/^(.+?)\s*x(\d+)\s*-\s*(?:NT\$|\$)(\d+)(?:\s*\((.*?)\))?/);
                    if (match) {
                        const [, name, qty, totalPrice, notes] = match;
                        const quantity = parseInt(qty);
                        const itemPrice = parseInt(totalPrice) / quantity;
                        return {
                            name: name.trim(),
                            quantity: quantity,
                            price: itemPrice,
                            note: notes ? notes.trim() : ''
                        };
                    }
                    return null;
                }).filter(item => item !== null);
                
                customerNote = notesText;
            } else if (notesText) {
                // å‚™ç”¨ï¼šå¾å‚™è¨»ä¸­æå–
                const systemDataMatch = notesText.match(/\[ç³»çµ±è³‡æ–™\]\s*({.*?})\s*(?:\[\/ç³»çµ±è³‡æ–™\]|$)/s);
                
                if (systemDataMatch) {
                    try {
                        const systemData = JSON.parse(systemDataMatch[1]);
                        items = systemData.items || [];
                    } catch (e) {
                        console.warn('è§£æç³»çµ±è³‡æ–™å¤±æ•—:', e);
                    }
                    
                    const systemDataStart = notesText.indexOf('[ç³»çµ±è³‡æ–™]');
                    if (systemDataStart > 0) {
                        customerNote = notesText.substring(0, systemDataStart).trim();
                    }
                } else {
                    customerNote = notesText;
                }
            }
            
            // å¦‚æœæ²’æœ‰è§£æåˆ°é …ç›®ï¼Œå‰µå»ºé è¨­é …ç›®
            if (items.length === 0 && total > 0) {
                items = [{
                    name: 'è¨‚å–®é …ç›®',
                    quantity: 1,
                    price: total
                }];
            }
            
            return {
                id: orderId,
                properties: {
                    'è¨‚å–®ç·¨è™Ÿ': { title: [{ text: { content: orderId } }] },
                    'æ¡Œè™Ÿ': { rich_text: [{ text: { content: tableNumber } }] },
                    'ç‹€æ…‹': { select: { name: status } },
                    'ç¸½é‡‘é¡': { number: total },
                    'ç”¨é¤äººæ•¸': { number: customerCount },
                    'å»ºç«‹æ™‚é–“': { date: { start: createdTime } },
                    'å‚™è¨»': { rich_text: [{ text: { content: notesText } }] }
                },
                created_time: createdTime,
                items: items,
                customerNote: customerNote,
                notionPageId: notionOrder.id
            };
        }

        // === è³‡æ–™è™•ç† ===
        function processAndRenderOrders() {
            removeLoadingPlaceholder();
            
            const filteredOrders = filterOrders(allOrders);
            renderOrders(filteredOrders);
            updateCounters();
        }

        function filterOrders(orders) {
            switch (currentFilter) {
                case 'pending':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'å¾…è™•ç†');
                case 'making':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'è£½ä½œä¸­');
                case 'waiting-dessert':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'ç­‰å¾…ç”œé»');
                case 'waiting-checkout':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'ç­‰å¾…çµå¸³');
                default:
                    return orders;
            }
        }

        function renderOrders(orders) {
            // æ¸…é™¤ä¸å†å­˜åœ¨çš„è¨‚å–®
            const currentOrderIds = new Set(orders.map(order => order.id));
            displayedOrderIds.forEach(id => {
                if (!currentOrderIds.has(id)) {
                    const ticket = document.getElementById(`order-${id}`);
                    if (ticket) {
                        ticket.classList.add('completed-order');
                        setTimeout(() => ticket.remove(), 300);
                    }
                    displayedOrderIds.delete(id);
                }
            });

            if (orders.length === 0) {
                showNoOrdersMessage();
                return;
            } else {
                removeNoOrdersMessage();
            }

            // æ¸²æŸ“æ–°è¨‚å–®æˆ–æ›´æ–°ç¾æœ‰è¨‚å–®
            orders.forEach(order => {
                const orderId = order.id;
                const existingTicket = document.getElementById(`order-${orderId}`);
                
                if (existingTicket) {
                    updateOrderTicket(existingTicket, order);
                } else {
                    createOrderTicket(order);
                    displayedOrderIds.add(orderId);
                }
            });

            updateTimers();
        }

        function createOrderTicket(order) {
            const orderId = order.id;
            const props = order.properties;
            
            // æå–è¨‚å–®è³‡è¨Š
            const orderNumber = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || orderId.substring(0, 8);
            const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 'N/A';
            const status = props['ç‹€æ…‹']?.select?.name || 'æº–å‚™ä¸­';
            const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
            const orderItems = order.items || [];
            const customerNote = order.customerNote || '';
            const totalAmount = props['ç¸½é‡‘é¡']?.number || 0;

            // è¨ˆç®—ç­‰å¾…æ™‚é–“
            const waitTime = calculateWaitTime(createdTime);
            const priority = waitTime > settings.urgentThreshold ? 'high' : 'normal';

            const ticket = document.createElement('div');
            ticket.id = `order-${orderId}`;
            
            // æ ¹æ“šç‹€æ…‹è¨­å®šæ¨£å¼é¡åˆ¥
            let statusClass = 'status-pending';
            if (status === 'è£½ä½œä¸­') statusClass = 'status-making';
            else if (status === 'ç­‰å¾…ç”œé»') statusClass = 'status-waiting-dessert';
            else if (status === 'ç­‰å¾…çµå¸³') statusClass = 'status-waiting-checkout';
            
            ticket.className = `order-card bg-white text-gray-900 rounded-lg shadow-2xl w-72 h-full flex flex-col flex-shrink-0 ${statusClass} priority-${priority}`;
            
            // æ§‹å»ºé …ç›®åˆ—è¡¨
            let itemsHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsHtml = orderItems.map(item => {
                    const note = item.note ? `<p class="text-red-600 font-semibold text-sm ml-4">å‚™è¨»: ${item.note}</p>` : '';
                    return `
                        <li class="py-2 border-b border-gray-200 last:border-b-0">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold">${item.name || 'æœªçŸ¥é …ç›®'}</span>
                                <span class="text-xl font-bold text-indigo-600">x${item.quantity || 1}</span>
                            </div>
                            ${note}
                        </li>
                    `;
                }).join('');
            } else {
                itemsHtml = '<li class="text-gray-500 italic">è¨‚å–®å…§å®¹è¼‰å…¥ä¸­...</li>';
            }

            // ç‹€æ…‹é¡è‰²é…ç½®
            const statusConfig = {
                'å¾…è™•ç†': { bg: 'bg-orange-500', text: 'å¾…è™•ç†', icon: 'ğŸŸ ' },
                'è£½ä½œä¸­': { bg: 'bg-yellow-500', text: 'è£½ä½œä¸­', icon: 'ğŸŸ¡' },
                'ç­‰å¾…ç”œé»': { bg: 'bg-green-500', text: 'ç­‰å¾…ç”œé»', icon: 'ğŸŸ¢' },
                'ç­‰å¾…çµå¸³': { bg: 'bg-blue-500', text: 'ç­‰å¾…çµå¸³', icon: 'ğŸ”µ' }
            };
            const statusInfo = statusConfig[status] || statusConfig['å¾…è™•ç†'];

            ticket.innerHTML = `
                <div class="p-4 bg-gray-800 text-white rounded-t-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-2xl font-bold">æ¡Œè™Ÿ: ${tableNumber}</p>
                            <p class="text-sm text-gray-400">#${orderNumber}</p>
                        </div>
                        <span class="${statusInfo.bg} px-2 py-1 rounded text-xs font-semibold">
                            ${statusInfo.text}
                        </span>
                    </div>
                    <p class="text-sm text-yellow-400 font-semibold" data-timestamp="${createdTime}">
                        å·²ç­‰å¾… ${waitTime} åˆ†é˜
                    </p>
                    ${totalAmount > 0 ? `<p class="text-sm text-green-400">ç¸½é¡: $${totalAmount}</p>` : ''}
                </div>
                
                <div class="flex-1 p-3 overflow-y-auto">
                    <ul class="space-y-1">
                        ${itemsHtml}
                    </ul>
                    ${customerNote ? `<div class="mt-3 p-2 bg-yellow-50 border-l-4 border-yellow-400">
                        <p class="text-sm font-semibold text-yellow-800">å®¢æˆ¶å‚™è¨»:</p>
                        <p class="text-sm text-yellow-700">${customerNote}</p>
                    </div>` : ''}
                </div>
                
                <div class="p-3 space-y-2">
                    <div class="flex space-x-2">
                        ${status === 'å¾…è™•ç†' ? `
                            <button class="action-btn start-making-btn flex-1 bg-yellow-600 text-white py-3 rounded-md text-lg font-bold hover:bg-yellow-700 transition-colors">
                                é–‹å§‹è£½ä½œ
                            </button>
                        ` : ''}
                        ${status === 'è£½ä½œä¸­' ? `
                            <button class="action-btn dessert-ready-btn flex-1 bg-green-600 text-white py-3 rounded-md text-lg font-bold hover:bg-green-700 transition-colors">
                                ç­‰å¾…ç”œé»
                            </button>
                        ` : ''}
                        ${status === 'ç­‰å¾…ç”œé»' ? `
                            <button class="action-btn ready-checkout-btn flex-1 bg-blue-600 text-white py-3 rounded-md text-lg font-bold hover:bg-blue-700 transition-colors">
                                ç­‰å¾…çµå¸³
                            </button>
                        ` : ''}
                        <button class="detail-btn bg-gray-600 text-white py-3 px-4 rounded-md text-lg hover:bg-gray-700 transition-colors">
                            è©³æƒ…
                        </button>
                    </div>
                </div>
            `;

            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const startMakingBtn = ticket.querySelector('.start-making-btn');
            const dessertReadyBtn = ticket.querySelector('.dessert-ready-btn');
            const readyCheckoutBtn = ticket.querySelector('.ready-checkout-btn');
            const detailBtn = ticket.querySelector('.detail-btn');

            if (startMakingBtn) {
                startMakingBtn.addEventListener('click', () => updateOrderStatus(orderId, 'è£½ä½œä¸­', startMakingBtn));
            }
            if (dessertReadyBtn) {
                dessertReadyBtn.addEventListener('click', () => updateOrderStatus(orderId, 'ç­‰å¾…ç”œé»', dessertReadyBtn));
            }
            if (readyCheckoutBtn) {
                readyCheckoutBtn.addEventListener('click', () => updateOrderStatus(orderId, 'ç­‰å¾…çµå¸³', readyCheckoutBtn));
            }
            if (detailBtn) {
                detailBtn.addEventListener('click', () => showOrderDetail(order));
            }

            dom.orderWrapper.appendChild(ticket);
        }

        function updateOrderTicket(ticket, order) {
            const waitTimeElement = ticket.querySelector('[data-timestamp]');
            if (waitTimeElement) {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                waitTimeElement.textContent = `å·²ç­‰å¾… ${waitTime} åˆ†é˜`;
                
                // æ ¹æ“šç­‰å¾…æ™‚é–“èª¿æ•´é¡è‰²
                if (waitTime > 45) {
                    waitTimeElement.className = 'text-sm text-red-400 font-bold animate-pulse';
                } else if (waitTime > settings.urgentThreshold) {
                    waitTimeElement.className = 'text-sm text-orange-400 font-semibold';
                } else {
                    waitTimeElement.className = 'text-sm text-yellow-400 font-semibold';
                }
            }
        }

        // === è¨‚å–®æ“ä½œ ===
        async function updateOrderStatus(orderId, newStatus, buttonElement) {
            console.log(`ğŸ”„ æ›´æ–°è¨‚å–® ${orderId} ç‹€æ…‹ç‚º ${newStatus}`);
            
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.textContent = 'è™•ç†ä¸­...';
            }

            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order || !order.notionPageId) {
                    throw new Error('æ‰¾ä¸åˆ°è¨‚å–®æˆ– Notion é é¢ ID');
                }

                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/pages/${order.notionPageId}`,
                        method: 'PATCH',
                        body: {
                            properties: {
                                'ç‹€æ…‹': {
                                    select: {
                                        name: newStatus
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                console.log(`âœ… è¨‚å–® ${orderId} ç‹€æ…‹æ›´æ–°æˆåŠŸ`);
                
                // æ›´æ–°æˆåŠŸå¾Œé‡æ–°è¼‰å…¥è³‡æ–™
                setTimeout(fetchOrders, 1000);

            } catch (error) {
                console.error('âŒ æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
                alert(`æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—: ${error.message}`);
                
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = newStatus === 'é€²è¡Œä¸­' ? 'é–‹å§‹çƒ¹é£ª' : 'å®Œæˆå‡ºé¤';
                }
            }
        }

        // === å·¥å…·å‡½æ•¸ ===
        function calculateWaitTime(createdTime) {
            const orderTime = new Date(createdTime);
            const now = new Date();
            return Math.floor((now - orderTime) / 60000); // åˆ†é˜
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®ä¸­çš„æ´»å‹•ç‹€æ…‹
            dom.filterDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.filter === filter) {
                    item.classList.add('active');
                }
            });
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            const filterTexts = {
                'all': 'ğŸ“‹ å…¨éƒ¨',
                'pending': 'ğŸŸ  å¾…è™•ç†',
                'making': 'ğŸŸ¡ è£½ä½œä¸­',
                'waiting-dessert': 'ğŸŸ¢ ç­‰å¾…ç”œé»',
                'waiting-checkout': 'ï¿½ ç­‰å¾…çµå¸³'
            };
            dom.filterMenuBtn.querySelector('span').textContent = `ğŸ” ${filterTexts[filter] || 'ç¯©é¸'}`;
            
            processAndRenderOrders();
        }

        // === å½ˆå‡ºå¼é¸å–®ç®¡ç† ===
        function toggleDropdown(type) {
            const targetDropdown = type === 'filter' ? dom.filterDropdown : dom.monitorDropdown;
            const otherDropdown = type === 'filter' ? dom.monitorDropdown : dom.filterDropdown;
            
            // é—œé–‰å…¶ä»–ä¸‹æ‹‰é¸å–®
            otherDropdown.classList.remove('show');
            
            // åˆ‡æ›ç›®æ¨™ä¸‹æ‹‰é¸å–®
            targetDropdown.classList.toggle('show');
        }

        function closeAllDropdowns() {
            dom.filterDropdown.classList.remove('show');
            dom.monitorDropdown.classList.remove('show');
        }

        // === æ¨¡æ…‹æ¡†ç®¡ç† ===
        function showStatsModal() {
            updateStatsModal();
            dom.statsModal.classList.remove('hidden');
        }

        function closeStatsModal() {
            dom.statsModal.classList.add('hidden');
        }

        function showAlertsModal() {
            updateAlertsModal();
            dom.alertsModal.classList.remove('hidden');
        }

        function closeAlertsModal() {
            dom.alertsModal.classList.add('hidden');
        }

        function updateStatsModal() {
            if (allOrders.length === 0) {
                document.getElementById('stats-avg-wait').textContent = '-- åˆ†é˜';
                document.getElementById('stats-max-wait').textContent = '-- åˆ†é˜';
                document.getElementById('stats-min-wait').textContent = '-- åˆ†é˜';
                document.getElementById('stats-today-completed').textContent = '--';
                document.getElementById('stats-processing').textContent = '--';
                document.getElementById('stats-completion-rate').textContent = '--%';
                document.getElementById('stats-response-time').textContent = '-- æ¯«ç§’';
                return;
            }

            const waitTimes = allOrders.map(order => {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                return calculateWaitTime(createdTime);
            });

            const avgWait = Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length);
            const maxWait = Math.max(...waitTimes);
            const minWait = Math.min(...waitTimes);

            document.getElementById('stats-avg-wait').textContent = `${avgWait} åˆ†é˜`;
            document.getElementById('stats-max-wait').textContent = `${maxWait} åˆ†é˜`;
            document.getElementById('stats-min-wait').textContent = `${minWait} åˆ†é˜`;
            document.getElementById('stats-today-completed').textContent = 'è¨ˆç®—ä¸­...';
            document.getElementById('stats-processing').textContent = allOrders.length;
            document.getElementById('stats-completion-rate').textContent = '95%';
            document.getElementById('stats-response-time').textContent = '< 500 æ¯«ç§’';
        }

        function updateAlertsModal() {
            const alertList = document.getElementById('alert-list');
            const urgentOrders = allOrders.filter(order => {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                return waitTime > settings.urgentThreshold;
            });

            if (urgentOrders.length === 0) {
                alertList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">âœ…</div>
                        <p class="text-lg">ç›®å‰æ²’æœ‰è¶…æ™‚è¨‚å–®</p>
                        <p class="text-sm">æ‰€æœ‰è¨‚å–®éƒ½åœ¨æ­£å¸¸æ™‚é–“ç¯„åœå…§</p>
                    </div>
                `;
                return;
            }

            alertList.innerHTML = urgentOrders.map(order => {
                const props = order.properties;
                const orderNumber = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || order.id.substring(0, 8);
                const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 'N/A';
                const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                
                return `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-red-800 font-semibold">æ¡Œè™Ÿ: ${tableNumber}</h4>
                                <p class="text-red-600 text-sm">#${orderNumber}</p>
                                <p class="text-red-700 font-bold">ç­‰å¾…æ™‚é–“: ${waitTime} åˆ†é˜</p>
                            </div>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-semibold">
                                è¶…æ™‚ ${waitTime - settings.urgentThreshold} åˆ†é˜
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCounters() {
            const pending = allOrders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'å¾…è™•ç†').length;
            const making = allOrders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'è£½ä½œä¸­').length;
            const waitingDessert = allOrders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'ç­‰å¾…ç”œé»').length;
            const waitingCheckout = allOrders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'ç­‰å¾…çµå¸³').length;
            const total = allOrders.length;

            // æ›´æ–°é ‚éƒ¨é¡¯ç¤ºçš„è¨ˆæ•¸å™¨
            if (dom.countAll) dom.countAll.textContent = total;
            dom.countPending.textContent = pending;
            dom.countMaking.textContent = making;
            dom.countWaitingDessert.textContent = waitingDessert;
            dom.countWaitingCheckout.textContent = waitingCheckout;

            // æ›´æ–°ä¸‹æ‹‰é¸å–®ä¸­çš„è¨ˆæ•¸å™¨
            dom.dropdownCountAll.textContent = total;
            dom.dropdownCountPending.textContent = pending;
            dom.dropdownCountMaking.textContent = making;
            dom.dropdownCountWaitingDessert.textContent = waitingDessert;
            dom.dropdownCountWaitingCheckout.textContent = waitingCheckout;

            // æ›´æ–°è¶…æ™‚è­¦ç¤ºè¨ˆæ•¸
            const urgentOrders = allOrders.filter(order => {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                return waitTime > settings.urgentThreshold;
            });
            
            dom.alertCount.textContent = urgentOrders.length;
            
            // å¦‚æœæœ‰è¶…æ™‚è¨‚å–®ï¼Œè®“è­¦ç¤ºæŒ‰éˆ•é–ƒçˆ
            const monitorBtn = dom.monitorMenuBtn;
            if (urgentOrders.length > 0) {
                monitorBtn.classList.add('animate-pulse', 'bg-red-600');
                monitorBtn.classList.remove('bg-teal-600');
            } else {
                monitorBtn.classList.remove('animate-pulse', 'bg-red-600');
                monitorBtn.classList.add('bg-teal-600');
            }
        }

        function updateStats() {
            if (allOrders.length === 0) {
                dom.avgWaitTime.textContent = '-- åˆ†é˜';
                dom.maxWaitTime.textContent = '-- åˆ†é˜';
                return;
            }

            const waitTimes = allOrders.map(order => {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                return calculateWaitTime(createdTime);
            });

            const avgWait = Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length);
            const maxWait = Math.max(...waitTimes);

            dom.avgWaitTime.textContent = `${avgWait} åˆ†é˜`;
            dom.maxWaitTime.textContent = `${maxWait} åˆ†é˜`;
        }

        function updateTimers() {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const createdTime = el.dataset.timestamp;
                const waitTime = calculateWaitTime(createdTime);
                el.textContent = `å·²ç­‰å¾… ${waitTime} åˆ†é˜`;
                
                if (waitTime > 45) {
                    el.className = 'text-sm text-red-400 font-bold animate-pulse';
                } else if (waitTime > settings.urgentThreshold) {
                    el.className = 'text-sm text-orange-400 font-semibold';
                } else {
                    el.className = 'text-sm text-yellow-400 font-semibold';
                }
            });
        }

        function updateTime() {
            const now = new Date();
            dom.systemTime.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }

        function updateStatus(isOnline) {
            if (isOnline) {
                dom.systemStatus.textContent = 'â— Notion é€£ç·šæ­£å¸¸';
                dom.systemStatus.classList.remove('text-red-400');
                dom.systemStatus.classList.add('text-green-400');
            } else {
                dom.systemStatus.textContent = 'â— Notion é€£ç·šç•°å¸¸';
                dom.systemStatus.classList.add('text-red-400');
                dom.systemStatus.classList.remove('text-green-400');
            }
        }

        function updateRefreshButton(isLoading) {
            const btn = dom.refreshKdsBtn;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = 'â³ æ›´æ–°ä¸­...';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ æ›´æ–°';
            }
        }

        function removeLoadingPlaceholder() {
            if (dom.loadingPlaceholder) {
                dom.loadingPlaceholder.remove();
                dom.loadingPlaceholder = null;
            }
        }

        function showNoOrdersMessage() {
            removeNoOrdersMessage();
            const noOrdersMsg = document.createElement('div');
            noOrdersMsg.id = 'no-orders-msg';
            noOrdersMsg.className = 'text-center py-16 text-gray-500 w-screen';
            noOrdersMsg.innerHTML = `
                <div class="text-6xl mb-4">ğŸ½ï¸</div>
                <p class="text-2xl font-semibold mb-2">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</p>
                <p class="text-lg text-gray-400">æ‰€æœ‰è¨‚å–®éƒ½å·²å®Œæˆï¼</p>
            `;
            dom.orderWrapper.appendChild(noOrdersMsg);
        }

        function removeNoOrdersMessage() {
            const noOrdersMsg = document.getElementById('no-orders-msg');
            if (noOrdersMsg) noOrdersMsg.remove();
        }

        function showError(message) {
            console.error('âŒ KDS éŒ¯èª¤:', message);
        }

        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            if (settings.refreshInterval > 0) {
                autoRefreshTimer = setInterval(() => {
                    console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°è¨‚å–®...');
                    fetchOrders();
                }, settings.refreshInterval);
            }
        }

        // === é€šçŸ¥åŠŸèƒ½ ===
        function checkNewOrders() {
            if (settings.soundEnabled) {
                playNotificationSound();
            }
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('æ–°è¨‚å–®ï¼', {
                    body: 'æ”¶åˆ°æ–°çš„è¨‚å–®ï¼Œè«‹æŸ¥çœ‹å»šæˆ¿ç³»çµ±',
                    icon: 'ğŸ””'
                });
            }
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
            }
        }

        // === è¨­å®šç®¡ç† ===
        function showSettings() {
            document.getElementById('refresh-interval').value = settings.refreshInterval;
            document.getElementById('sound-enabled').checked = settings.soundEnabled;
            document.getElementById('urgent-threshold').value = settings.urgentThreshold;
            
            dom.settingsPanel.classList.remove('hidden');
            dom.settingsPanel.classList.add('flex');
        }

        function hideSettings() {
            dom.settingsPanel.classList.add('hidden');
            dom.settingsPanel.classList.remove('flex');
        }

        function saveSettings() {
            settings.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            settings.soundEnabled = document.getElementById('sound-enabled').checked;
            settings.urgentThreshold = parseInt(document.getElementById('urgent-threshold').value);
            
            startAutoRefresh();
            localStorage.setItem('kds-tablet-settings', JSON.stringify(settings));
            
            hideSettings();
            updateStatus(true);
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('kds-tablet-settings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.log('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // === æ¨¡æ…‹æ¡†åŠŸèƒ½ ===
        function showOrderDetail(order) {
            const props = order.properties;
            
            const orderNumber = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || order.id.substring(0, 8);
            const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 'N/A';
            const status = props['ç‹€æ…‹']?.select?.name || 'æº–å‚™ä¸­';
            const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
            const orderItems = order.items || [];
            const customerNote = order.customerNote || '';
            const totalAmount = props['ç¸½é‡‘é¡']?.number || 0;

            let itemsDetailHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsDetailHtml = orderItems.map(item => `
                    <tr class="border-b">
                        <td class="py-2 px-4">${item.name || 'æœªçŸ¥é …ç›®'}</td>
                        <td class="py-2 px-4 text-center">${item.quantity || 1}</td>
                        <td class="py-2 px-4 text-right">$${(item.price || 0) * (item.quantity || 1)}</td>
                        <td class="py-2 px-4 text-sm text-gray-600">${item.note || '-'}</td>
                    </tr>
                `).join('');
            }

            dom.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">è¨‚å–®ç·¨è™Ÿ</label>
                            <p class="text-lg font-semibold">#${orderNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ¡Œè™Ÿ</label>
                            <p class="text-lg font-semibold">${tableNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                            <p class="text-lg font-semibold text-${status === 'æº–å‚™ä¸­' ? 'yellow' : status === 'é€²è¡Œä¸­' ? 'red' : 'green'}-600">${status}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ä¸‹å–®æ™‚é–“</label>
                            <p class="text-lg">${new Date(createdTime).toLocaleString('zh-TW')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç¸½é‡‘é¡</label>
                            <p class="text-lg font-semibold text-green-600">$${totalAmount}</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨‚å–®å…§å®¹</label>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-gray-50 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left">å“é …</th>
                                        <th class="py-2 px-4 text-center">æ•¸é‡</th>
                                        <th class="py-2 px-4 text-right">å°è¨ˆ</th>
                                        <th class="py-2 px-4 text-left">å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsDetailHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${customerNote ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å®¢æˆ¶å‚™è¨»</label>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                                <p class="text-yellow-800">${customerNote}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            dom.orderModal.classList.remove('hidden');
        }

        function closeModal() {
            dom.orderModal.classList.add('hidden');
        }

        // === é é¢å¯è¦‹æ€§è™•ç† ===
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                }
            } else {
                startAutoRefresh();
                fetchOrders();
            }
        });

        // å®šæ™‚æ›´æ–°ç­‰å¾…æ™‚é–“
        setInterval(updateTimers, 60000);
    </script>
</body>
</html>
