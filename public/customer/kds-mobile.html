<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>📱 7寸平板廚房系統 - Tanawat Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 環境配置 (必須在其他腳本之前載入) -->
    <script src="../env-config.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        
        /* 7寸平板橫向優化 */
        @media screen and (min-width: 1024px) and (max-height: 768px) {
            .tablet-landscape {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
            .tablet-header {
                height: 80px;
                flex-shrink: 0;
            }
            .tablet-main {
                flex: 1;
                overflow-x: auto;
            }
        }
        
        /* 彈出式選單樣式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #374151;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            left: 0;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #4b5563;
        }
        .dropdown-item.active {
            background-color: #3b82f6;
        }
        
        #order-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #order-container::-webkit-scrollbar {
            display: none;
        }
        
        .order-card {
            animation: slideIn 0.5s ease-out;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .order-card:active {
            transform: scale(0.98);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .completed-order {
            animation: slideOut 0.3s ease-in;
        }
        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(20px) scale(0.8);
            }
        }
        
        .status-pending { 
            border-left: 6px solid #f97316;
            background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%);
        }
        .status-making { 
            border-left: 6px solid #eab308;
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        }
        .status-waiting-dessert { 
            border-left: 6px solid #22c55e;
            background: linear-gradient(135deg, #dcfce7 0%, #16a34a 100%);
        }
        .status-waiting-checkout { 
            border-left: 6px solid #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #2563eb 100%);
        }
        
        .priority-high { 
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
        }
        .priority-normal { 
            background: linear-gradient(135deg, #f3f4f6, #ffffff); 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background: #3b82f6 !important;
            color: white;
        }
        
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="tablet-landscape">
        <!-- 頂部工具欄 -->
        <header class="tablet-header bg-gray-800 border-b-4 border-indigo-600 shadow-lg">
            <div class="flex items-center justify-between h-full px-6">
                <!-- 左側：標題和狀態 -->
                <div class="flex items-center space-x-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">👨‍🍳 廚房系統</h1>
                        <p id="system-status" class="text-sm text-green-400">● 連線正常</p>
                    </div>
                    <div class="text-center">
                        <p id="system-time" class="text-xl font-mono text-gray-200"></p>
                        <p class="text-xs text-gray-400">系統時間</p>
                    </div>
                </div>

                <!-- 中間：重點數據展示 -->
                <div class="flex items-center space-x-6">
                    <div class="bg-orange-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-pending">0</p>
                        <p class="text-xs text-orange-200">待處理</p>
                    </div>
                    <div class="bg-yellow-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-making">0</p>
                        <p class="text-xs text-yellow-200">製作中</p>
                    </div>
                    <div class="bg-green-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-waiting-dessert">0</p>
                        <p class="text-xs text-green-200">等待甜點</p>
                    </div>
                    <div class="bg-blue-600 px-4 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-2xl font-bold text-white" id="count-waiting-checkout">0</p>
                        <p class="text-xs text-blue-200">等待結帳</p>
                    </div>
                    <div class="bg-orange-600 px-4 py-2 rounded-lg text-center min-w-[120px]">
                        <p class="text-xl font-bold text-white" id="avg-wait-time">-- 分鐘</p>
                        <p class="text-xs text-orange-200">平均等待</p>
                    </div>
                </div>

                <!-- 右側：操作按鈕 -->
                <div class="flex items-center space-x-3">
                    <!-- 篩選選單 -->
                    <div class="dropdown">
                        <button id="filter-menu-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center space-x-2">
                            <span>🔍 篩選</span>
                            <span class="text-xs">▼</span>
                        </button>
                        <div id="filter-dropdown" class="dropdown-content">
                            <div class="dropdown-item active" data-filter="all">
                                <span>📋 全部訂單</span>
                                <span class="float-right" id="dropdown-count-all">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="pending">
                                <span>🟠 待處理</span>
                                <span class="float-right" id="dropdown-count-pending">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="making">
                                <span>🟡 製作中</span>
                                <span class="float-right" id="dropdown-count-making">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="waiting-dessert">
                                <span>🟢 等待甜點</span>
                                <span class="float-right" id="dropdown-count-waiting-dessert">0</span>
                            </div>
                            <div class="dropdown-item" data-filter="waiting-checkout">
                                <span>� 等待結帳</span>
                                <span class="float-right" id="dropdown-count-waiting-checkout">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 監控選單 -->
                    <div class="dropdown">
                        <button id="monitor-menu-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center space-x-2">
                            <span>📊 監控</span>
                            <span class="text-xs">▼</span>
                        </button>
                        <div id="monitor-dropdown" class="dropdown-content">
                            <div class="dropdown-item" id="show-stats">
                                <span>📈 顯示統計詳情</span>
                            </div>
                            <div class="dropdown-item" id="show-alerts">
                                <span>⚠️ 超時警示</span>
                                <span class="float-right text-red-400" id="alert-count">0</span>
                            </div>
                            <div class="dropdown-item" id="show-performance">
                                <span>⚡ 效能監控</span>
                            </div>
                        </div>
                    </div>

                    <button id="refresh-kds-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        🔄 更新
                    </button>
                    <button id="settings-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        ⚙️ 設定
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要訂單顯示區域 -->
        <main id="order-container" class="tablet-main flex-1 flex items-start p-4 bg-gray-900 overflow-x-auto">
            <div id="order-wrapper" class="flex flex-nowrap space-x-4 h-full min-w-full">
                <div id="loading-placeholder" class="text-center py-16 text-gray-400 w-screen">
                    <div class="animate-spin rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 mx-auto"></div>
                    <p class="text-xl">正在連接 Notion 資料庫...</p>
                    <p class="text-sm mt-2">載入訂單資料中</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 統計詳情模態框 -->
    <div id="stats-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">📈 詳細統計資訊</h2>
                <button id="close-stats-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="stats-content" class="text-gray-900">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">⏱️ 時間統計</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>平均等待時間：</span>
                                <span id="stats-avg-wait" class="font-bold">-- 分鐘</span>
                            </div>
                            <div class="flex justify-between">
                                <span>最長等待時間：</span>
                                <span id="stats-max-wait" class="font-bold">-- 分鐘</span>
                            </div>
                            <div class="flex justify-between">
                                <span>最短等待時間：</span>
                                <span id="stats-min-wait" class="font-bold">-- 分鐘</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-800 mb-3">📊 訂單統計</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>今日完成：</span>
                                <span id="stats-today-completed" class="font-bold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>處理中訂單：</span>
                                <span id="stats-processing" class="font-bold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>完成率：</span>
                                <span id="stats-completion-rate" class="font-bold">--%</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">⚡ 效能指標</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>系統回應時間：</span>
                                <span id="stats-response-time" class="font-bold">-- 毫秒</span>
                            </div>
                            <div class="flex justify-between">
                                <span>資料更新頻率：</span>
                                <span id="stats-refresh-rate" class="font-bold">30 秒</span>
                            </div>
                            <div class="flex justify-between">
                                <span>連線狀態：</span>
                                <span id="stats-connection" class="font-bold text-green-600">正常</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 超時警示模態框 -->
    <div id="alerts-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">⚠️ 超時警示</h2>
                <button id="close-alerts-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="alerts-content" class="text-gray-900">
                <div id="alert-list" class="space-y-3">
                    <!-- 警示內容將動態生成 -->
                </div>
            </div>
        </div>
    </div>
    <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">訂單詳情</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-900">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- 設定面板 -->
    <div id="settings-panel" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4 text-gray-900">⚙️ 系統設定</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">自動刷新間隔</label>
                    <select id="refresh-interval" class="w-full border rounded px-3 py-2 text-sm">
                        <option value="15000">15 秒</option>
                        <option value="30000" selected>30 秒</option>
                        <option value="60000">1 分鐘</option>
                        <option value="0">關閉</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">音效通知</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="sound-enabled" checked class="mr-2">
                        <span class="text-sm text-gray-700">新訂單音效提醒</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">緊急訂單閾值（分鐘）</label>
                    <input type="number" id="urgent-threshold" value="30" min="15" max="60" 
                           class="w-full border rounded px-3 py-2 text-sm">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button id="save-settings" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm font-semibold">
                    儲存
                </button>
                <button id="close-settings" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm">
                    取消
                </button>
            </div>
        </div>
    </div>

    <script>
        // === 配置 ===
        const VERSION = 'tablet-kds-v2.0-' + Date.now();
        console.log('📱 7寸平板廚房系統版本:', VERSION);

        const CONFIG = {
            notionApiKey: window.ENV_CONFIG?.NOTION_API_KEY || 'secret_iSDhSCT8HPZMjPsX8YuMdhfzPJ2EYJrfXLdE17L88cV',
            netlifyFunctionBase: `${window.location.origin}/.netlify/functions`,
            ordersDatabase: '23afd5adc30b80c39e71d1a640ccfb5d',
            autoRefreshInterval: 30000, // 30秒
            soundEnabled: true
        };

        // === 全域變數 ===
        let allOrders = [];
        let displayedOrderIds = new Set();
        let currentFilter = 'all';
        let autoRefreshTimer = null;
        let settings = {
            refreshInterval: 30000,
            soundEnabled: true,
            urgentThreshold: 30
        };

        // === DOM 元素 ===
        const dom = {
            orderWrapper: document.getElementById('order-wrapper'),
            systemTime: document.getElementById('system-time'),
            systemStatus: document.getElementById('system-status'),
            loadingPlaceholder: document.getElementById('loading-placeholder'),
            refreshKdsBtn: document.getElementById('refresh-kds-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            orderModal: document.getElementById('order-modal'),
            modalContent: document.getElementById('modal-content'),
            closeModal: document.getElementById('close-modal'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettings: document.getElementById('save-settings'),
            closeSettings: document.getElementById('close-settings'),
            // 彈出式選單
            filterMenuBtn: document.getElementById('filter-menu-btn'),
            filterDropdown: document.getElementById('filter-dropdown'),
            monitorMenuBtn: document.getElementById('monitor-menu-btn'),
            monitorDropdown: document.getElementById('monitor-dropdown'),
            // 統計模態框
            statsModal: document.getElementById('stats-modal'),
            closeStatsModal: document.getElementById('close-stats-modal'),
            alertsModal: document.getElementById('alerts-modal'),
            closeAlertsModal: document.getElementById('close-alerts-modal'),
            // Counters - 頂部顯示
            countAll: document.getElementById('count-all'),
            countPending: document.getElementById('count-pending'),
            countMaking: document.getElementById('count-making'),
            countWaitingDessert: document.getElementById('count-waiting-dessert'),
            countWaitingCheckout: document.getElementById('count-waiting-checkout'),
            // Counters - 下拉選單
            dropdownCountAll: document.getElementById('dropdown-count-all'),
            dropdownCountPending: document.getElementById('dropdown-count-pending'),
            dropdownCountMaking: document.getElementById('dropdown-count-making'),
            dropdownCountWaitingDessert: document.getElementById('dropdown-count-waiting-dessert'),
            dropdownCountWaitingCheckout: document.getElementById('dropdown-count-waiting-checkout'),
            // Stats
            avgWaitTime: document.getElementById('avg-wait-time'),
            alertCount: document.getElementById('alert-count')
        };

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 7寸平板 KDS 系統初始化');
            loadSettings();
            initEventListeners();
            fetchOrders();
            updateTime();
            setInterval(updateTime, 1000);
            startAutoRefresh();
        });

        function initEventListeners() {
            // 刷新按鈕
            dom.refreshKdsBtn.addEventListener('click', fetchOrders);
            
            // 設定按鈕
            dom.settingsBtn.addEventListener('click', showSettings);
            
            // 彈出式選單 - 篩選
            dom.filterMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown('filter');
            });
            
            // 彈出式選單 - 監控
            dom.monitorMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown('monitor');
            });
            
            // 篩選選項
            dom.filterDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-item') || e.target.parentElement.classList.contains('dropdown-item')) {
                    const item = e.target.classList.contains('dropdown-item') ? e.target : e.target.parentElement;
                    const filter = item.dataset.filter;
                    if (filter) {
                        setFilter(filter);
                        closeAllDropdowns();
                    }
                }
            });
            
            // 監控選項
            document.getElementById('show-stats').addEventListener('click', () => {
                showStatsModal();
                closeAllDropdowns();
            });
            
            document.getElementById('show-alerts').addEventListener('click', () => {
                showAlertsModal();
                closeAllDropdowns();
            });
            
            document.getElementById('show-performance').addEventListener('click', () => {
                showStatsModal(); // 暫時使用相同的統計模態框
                closeAllDropdowns();
            });
            
            // 點擊外部關閉下拉選單
            document.addEventListener('click', closeAllDropdowns);
            
            // 模態框
            dom.closeModal.addEventListener('click', closeModal);
            dom.orderModal.addEventListener('click', (e) => {
                if (e.target === dom.orderModal) closeModal();
            });
            
            // 統計模態框
            dom.closeStatsModal.addEventListener('click', closeStatsModal);
            dom.statsModal.addEventListener('click', (e) => {
                if (e.target === dom.statsModal) closeStatsModal();
            });
            
            // 警示模態框
            dom.closeAlertsModal.addEventListener('click', closeAlertsModal);
            dom.alertsModal.addEventListener('click', (e) => {
                if (e.target === dom.alertsModal) closeAlertsModal();
            });
            
            // 設定面板
            dom.saveSettings.addEventListener('click', saveSettings);
            dom.closeSettings.addEventListener('click', hideSettings);
            dom.settingsPanel.addEventListener('click', (e) => {
                if (e.target === dom.settingsPanel) hideSettings();
            });
            
            // 鍵盤快捷鍵
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' || e.key === 'R') {
                    fetchOrders();
                } else if (e.key === 'Escape') {
                    closeModal();
                    closeStatsModal();
                    closeAlertsModal();
                    hideSettings();
                    closeAllDropdowns();
                }
            });

            // 請求通知權限
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // === 資料獲取 ===
        async function fetchOrders() {
            console.log('📥 開始從 Notion 獲取訂單資料...');
            updateRefreshButton(true);

            try {
                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/databases/${CONFIG.ordersDatabase}/query`,
                        method: 'POST',
                        body: {
                            page_size: 100,
                            filter: {
                                and: [
                                    {
                                        property: '狀態',
                                        select: { 
                                            does_not_equal: '已取消' 
                                        }
                                    },
                                    {
                                        property: '狀態',
                                        select: { 
                                            does_not_equal: '結帳完成' 
                                        }
                                    },
                                    {
                                        property: '狀態',
                                        select: { 
                                            does_not_equal: '已完成' 
                                        }
                                    },
                                    {
                                        or: [
                                            {
                                                property: '狀態',
                                                select: { equals: '待處理' }
                                            },
                                            {
                                                property: '狀態',
                                                select: { equals: '製作中' }
                                            },
                                            {
                                                property: '狀態',
                                                select: { equals: '等待甜點' }
                                            },
                                            {
                                                property: '狀態',
                                                select: { equals: '等待結帳' }
                                            }
                                        ]
                                    }
                                ]
                            },
                            sorts: [
                                {
                                    property: '建立時間',
                                    direction: 'descending'
                                }
                            ]
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API 錯誤回應:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('📦 收到 Notion 訂單資料:', data);

                if (data.results && Array.isArray(data.results)) {
                    const oldOrderCount = allOrders.length;
                    allOrders = data.results.map(mapNotionOrderToKDS);
                    
                    // 檢查新訂單通知
                    if (allOrders.length > oldOrderCount && oldOrderCount > 0) {
                        checkNewOrders();
                    }
                    
                    processAndRenderOrders();
                    updateStats();
                    updateStatus(true);
                    console.log(`✅ 成功載入 ${allOrders.length} 筆訂單`);
                } else {
                    console.warn('⚠️ 資料格式異常:', data);
                    showError('資料格式異常');
                }
            } catch (error) {
                console.error('❌ 獲取訂單失敗:', error);
                updateStatus(false);
                showError(`連線失敗: ${error.message}`);
            } finally {
                updateRefreshButton(false);
            }
        }

        // === Notion 資料映射 ===
        function mapNotionOrderToKDS(notionOrder) {
            console.log('🔄 映射 Notion 訂單到 KDS 格式:', notionOrder);
            const props = notionOrder.properties;
            
            // 解析訂單編號
            const orderId = props['訂單編號']?.title?.[0]?.text?.content || 
                           props['訂單編號']?.rich_text?.[0]?.text?.content || 
                           `ORDER-${Date.now()}`;
            
            // 解析桌號
            const tableNumber = props['桌號']?.rich_text?.[0]?.text?.content || 
                               props['桌號']?.title?.[0]?.text?.content || '未知';
            
            // 解析狀態
            const status = props['狀態']?.select?.name || '準備中';
            
            // 解析總金額
            const total = props['總金額']?.number || 0;
            
            // 解析用餐人數
            const customerCount = props['用餐人數']?.number || 1;
            
            // 解析建立時間
            const createdTime = props['建立時間']?.date?.start || 
                               props['建立時間']?.created_time || 
                               notionOrder.created_time;
            
            // 解析備註和訂單項目
            const notesText = props['備註']?.rich_text?.[0]?.text?.content || '';
            const orderItemsText = props['訂單項目']?.rich_text?.[0]?.text?.content || '';
            let items = [];
            let customerNote = '';
            
            // 從訂單項目欄位解析
            if (orderItemsText) {
                const itemLines = orderItemsText.split('\n').filter(line => line.trim());
                items = itemLines.map(line => {
                    const match = line.match(/^(.+?)\s*x(\d+)\s*-\s*(?:NT\$|\$)(\d+)(?:\s*\((.*?)\))?/);
                    if (match) {
                        const [, name, qty, totalPrice, notes] = match;
                        const quantity = parseInt(qty);
                        const itemPrice = parseInt(totalPrice) / quantity;
                        return {
                            name: name.trim(),
                            quantity: quantity,
                            price: itemPrice,
                            note: notes ? notes.trim() : ''
                        };
                    }
                    return null;
                }).filter(item => item !== null);
                
                customerNote = notesText;
            } else if (notesText) {
                // 備用：從備註中提取
                const systemDataMatch = notesText.match(/\[系統資料\]\s*({.*?})\s*(?:\[\/系統資料\]|$)/s);
                
                if (systemDataMatch) {
                    try {
                        const systemData = JSON.parse(systemDataMatch[1]);
                        items = systemData.items || [];
                    } catch (e) {
                        console.warn('解析系統資料失敗:', e);
                    }
                    
                    const systemDataStart = notesText.indexOf('[系統資料]');
                    if (systemDataStart > 0) {
                        customerNote = notesText.substring(0, systemDataStart).trim();
                    }
                } else {
                    customerNote = notesText;
                }
            }
            
            // 如果沒有解析到項目，創建預設項目
            if (items.length === 0 && total > 0) {
                items = [{
                    name: '訂單項目',
                    quantity: 1,
                    price: total
                }];
            }
            
            return {
                id: orderId,
                properties: {
                    '訂單編號': { title: [{ text: { content: orderId } }] },
                    '桌號': { rich_text: [{ text: { content: tableNumber } }] },
                    '狀態': { select: { name: status } },
                    '總金額': { number: total },
                    '用餐人數': { number: customerCount },
                    '建立時間': { date: { start: createdTime } },
                    '備註': { rich_text: [{ text: { content: notesText } }] }
                },
                created_time: createdTime,
                items: items,
                customerNote: customerNote,
                notionPageId: notionOrder.id
            };
        }

        // === 資料處理 ===
        function processAndRenderOrders() {
            removeLoadingPlaceholder();
            
            const filteredOrders = filterOrders(allOrders);
            renderOrders(filteredOrders);
            updateCounters();
        }

        function filterOrders(orders) {
            switch (currentFilter) {
                case 'pending':
                    return orders.filter(order => order.properties['狀態']?.select?.name === '待處理');
                case 'making':
                    return orders.filter(order => order.properties['狀態']?.select?.name === '製作中');
                case 'waiting-dessert':
                    return orders.filter(order => order.properties['狀態']?.select?.name === '等待甜點');
                case 'waiting-checkout':
                    return orders.filter(order => order.properties['狀態']?.select?.name === '等待結帳');
                default:
                    return orders;
            }
        }

        function renderOrders(orders) {
            // 清除不再存在的訂單
            const currentOrderIds = new Set(orders.map(order => order.id));
            displayedOrderIds.forEach(id => {
                if (!currentOrderIds.has(id)) {
                    const ticket = document.getElementById(`order-${id}`);
                    if (ticket) {
                        ticket.classList.add('completed-order');
                        setTimeout(() => ticket.remove(), 300);
                    }
                    displayedOrderIds.delete(id);
                }
            });

            if (orders.length === 0) {
                showNoOrdersMessage();
                return;
            } else {
                removeNoOrdersMessage();
            }

            // 渲染新訂單或更新現有訂單
            orders.forEach(order => {
                const orderId = order.id;
                const existingTicket = document.getElementById(`order-${orderId}`);
                
                if (existingTicket) {
                    updateOrderTicket(existingTicket, order);
                } else {
                    createOrderTicket(order);
                    displayedOrderIds.add(orderId);
                }
            });

            updateTimers();
        }

        function createOrderTicket(order) {
            const orderId = order.id;
            const props = order.properties;
            
            // 提取訂單資訊
            const orderNumber = props['訂單編號']?.title?.[0]?.text?.content || orderId.substring(0, 8);
            const tableNumber = props['桌號']?.rich_text?.[0]?.text?.content || 'N/A';
            const status = props['狀態']?.select?.name || '準備中';
            const createdTime = props['建立時間']?.date?.start || order.created_time;
            const orderItems = order.items || [];
            const customerNote = order.customerNote || '';
            const totalAmount = props['總金額']?.number || 0;

            // 計算等待時間
            const waitTime = calculateWaitTime(createdTime);
            const priority = waitTime > settings.urgentThreshold ? 'high' : 'normal';

            const ticket = document.createElement('div');
            ticket.id = `order-${orderId}`;
            
            // 根據狀態設定樣式類別
            let statusClass = 'status-pending';
            if (status === '製作中') statusClass = 'status-making';
            else if (status === '等待甜點') statusClass = 'status-waiting-dessert';
            else if (status === '等待結帳') statusClass = 'status-waiting-checkout';
            
            ticket.className = `order-card bg-white text-gray-900 rounded-lg shadow-2xl w-72 h-full flex flex-col flex-shrink-0 ${statusClass} priority-${priority}`;
            
            // 構建項目列表
            let itemsHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsHtml = orderItems.map(item => {
                    const note = item.note ? `<p class="text-red-600 font-semibold text-sm ml-4">備註: ${item.note}</p>` : '';
                    return `
                        <li class="py-2 border-b border-gray-200 last:border-b-0">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold">${item.name || '未知項目'}</span>
                                <span class="text-xl font-bold text-indigo-600">x${item.quantity || 1}</span>
                            </div>
                            ${note}
                        </li>
                    `;
                }).join('');
            } else {
                itemsHtml = '<li class="text-gray-500 italic">訂單內容載入中...</li>';
            }

            // 狀態顏色配置
            const statusConfig = {
                '待處理': { bg: 'bg-orange-500', text: '待處理', icon: '🟠' },
                '製作中': { bg: 'bg-yellow-500', text: '製作中', icon: '🟡' },
                '等待甜點': { bg: 'bg-green-500', text: '等待甜點', icon: '🟢' },
                '等待結帳': { bg: 'bg-blue-500', text: '等待結帳', icon: '🔵' }
            };
            const statusInfo = statusConfig[status] || statusConfig['待處理'];

            ticket.innerHTML = `
                <div class="p-4 bg-gray-800 text-white rounded-t-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-2xl font-bold">桌號: ${tableNumber}</p>
                            <p class="text-sm text-gray-400">#${orderNumber}</p>
                        </div>
                        <span class="${statusInfo.bg} px-2 py-1 rounded text-xs font-semibold">
                            ${statusInfo.text}
                        </span>
                    </div>
                    <p class="text-sm text-yellow-400 font-semibold" data-timestamp="${createdTime}">
                        已等待 ${waitTime} 分鐘
                    </p>
                    ${totalAmount > 0 ? `<p class="text-sm text-green-400">總額: $${totalAmount}</p>` : ''}
                </div>
                
                <div class="flex-1 p-3 overflow-y-auto">
                    <ul class="space-y-1">
                        ${itemsHtml}
                    </ul>
                    ${customerNote ? `<div class="mt-3 p-2 bg-yellow-50 border-l-4 border-yellow-400">
                        <p class="text-sm font-semibold text-yellow-800">客戶備註:</p>
                        <p class="text-sm text-yellow-700">${customerNote}</p>
                    </div>` : ''}
                </div>
                
                <div class="p-3 space-y-2">
                    <div class="flex space-x-2">
                        ${status === '待處理' ? `
                            <button class="action-btn start-making-btn flex-1 bg-yellow-600 text-white py-3 rounded-md text-lg font-bold hover:bg-yellow-700 transition-colors">
                                開始製作
                            </button>
                        ` : ''}
                        ${status === '製作中' ? `
                            <button class="action-btn dessert-ready-btn flex-1 bg-green-600 text-white py-3 rounded-md text-lg font-bold hover:bg-green-700 transition-colors">
                                等待甜點
                            </button>
                        ` : ''}
                        ${status === '等待甜點' ? `
                            <button class="action-btn ready-checkout-btn flex-1 bg-blue-600 text-white py-3 rounded-md text-lg font-bold hover:bg-blue-700 transition-colors">
                                等待結帳
                            </button>
                        ` : ''}
                        <button class="detail-btn bg-gray-600 text-white py-3 px-4 rounded-md text-lg hover:bg-gray-700 transition-colors">
                            詳情
                        </button>
                    </div>
                </div>
            `;

            // 添加事件監聽器
            const startMakingBtn = ticket.querySelector('.start-making-btn');
            const dessertReadyBtn = ticket.querySelector('.dessert-ready-btn');
            const readyCheckoutBtn = ticket.querySelector('.ready-checkout-btn');
            const detailBtn = ticket.querySelector('.detail-btn');

            if (startMakingBtn) {
                startMakingBtn.addEventListener('click', () => updateOrderStatus(orderId, '製作中', startMakingBtn));
            }
            if (dessertReadyBtn) {
                dessertReadyBtn.addEventListener('click', () => updateOrderStatus(orderId, '等待甜點', dessertReadyBtn));
            }
            if (readyCheckoutBtn) {
                readyCheckoutBtn.addEventListener('click', () => updateOrderStatus(orderId, '等待結帳', readyCheckoutBtn));
            }
            if (detailBtn) {
                detailBtn.addEventListener('click', () => showOrderDetail(order));
            }

            dom.orderWrapper.appendChild(ticket);
        }

        function updateOrderTicket(ticket, order) {
            const waitTimeElement = ticket.querySelector('[data-timestamp]');
            if (waitTimeElement) {
                const createdTime = order.properties['建立時間']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                waitTimeElement.textContent = `已等待 ${waitTime} 分鐘`;
                
                // 根據等待時間調整顏色
                if (waitTime > 45) {
                    waitTimeElement.className = 'text-sm text-red-400 font-bold animate-pulse';
                } else if (waitTime > settings.urgentThreshold) {
                    waitTimeElement.className = 'text-sm text-orange-400 font-semibold';
                } else {
                    waitTimeElement.className = 'text-sm text-yellow-400 font-semibold';
                }
            }
        }

        // === 訂單操作 ===
        async function updateOrderStatus(orderId, newStatus, buttonElement) {
            console.log(`🔄 更新訂單 ${orderId} 狀態為 ${newStatus}`);
            
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.textContent = '處理中...';
            }

            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order || !order.notionPageId) {
                    throw new Error('找不到訂單或 Notion 頁面 ID');
                }

                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/pages/${order.notionPageId}`,
                        method: 'PATCH',
                        body: {
                            properties: {
                                '狀態': {
                                    select: {
                                        name: newStatus
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                console.log(`✅ 訂單 ${orderId} 狀態更新成功`);
                
                // 更新成功後重新載入資料
                setTimeout(fetchOrders, 1000);

            } catch (error) {
                console.error('❌ 更新訂單狀態失敗:', error);
                alert(`更新訂單狀態失敗: ${error.message}`);
                
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = newStatus === '進行中' ? '開始烹飪' : '完成出餐';
                }
            }
        }

        // === 工具函數 ===
        function calculateWaitTime(createdTime) {
            const orderTime = new Date(createdTime);
            const now = new Date();
            return Math.floor((now - orderTime) / 60000); // 分鐘
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // 更新下拉選單中的活動狀態
            dom.filterDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.filter === filter) {
                    item.classList.add('active');
                }
            });
            
            // 更新按鈕文字
            const filterTexts = {
                'all': '📋 全部',
                'pending': '🟠 待處理',
                'making': '🟡 製作中',
                'waiting-dessert': '🟢 等待甜點',
                'waiting-checkout': '� 等待結帳'
            };
            dom.filterMenuBtn.querySelector('span').textContent = `🔍 ${filterTexts[filter] || '篩選'}`;
            
            processAndRenderOrders();
        }

        // === 彈出式選單管理 ===
        function toggleDropdown(type) {
            const targetDropdown = type === 'filter' ? dom.filterDropdown : dom.monitorDropdown;
            const otherDropdown = type === 'filter' ? dom.monitorDropdown : dom.filterDropdown;
            
            // 關閉其他下拉選單
            otherDropdown.classList.remove('show');
            
            // 切換目標下拉選單
            targetDropdown.classList.toggle('show');
        }

        function closeAllDropdowns() {
            dom.filterDropdown.classList.remove('show');
            dom.monitorDropdown.classList.remove('show');
        }

        // === 模態框管理 ===
        function showStatsModal() {
            updateStatsModal();
            dom.statsModal.classList.remove('hidden');
        }

        function closeStatsModal() {
            dom.statsModal.classList.add('hidden');
        }

        function showAlertsModal() {
            updateAlertsModal();
            dom.alertsModal.classList.remove('hidden');
        }

        function closeAlertsModal() {
            dom.alertsModal.classList.add('hidden');
        }

        function updateStatsModal() {
            if (allOrders.length === 0) {
                document.getElementById('stats-avg-wait').textContent = '-- 分鐘';
                document.getElementById('stats-max-wait').textContent = '-- 分鐘';
                document.getElementById('stats-min-wait').textContent = '-- 分鐘';
                document.getElementById('stats-today-completed').textContent = '--';
                document.getElementById('stats-processing').textContent = '--';
                document.getElementById('stats-completion-rate').textContent = '--%';
                document.getElementById('stats-response-time').textContent = '-- 毫秒';
                return;
            }

            const waitTimes = allOrders.map(order => {
                const createdTime = order.properties['建立時間']?.date?.start || order.created_time;
                return calculateWaitTime(createdTime);
            });

            const avgWait = Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length);
            const maxWait = Math.max(...waitTimes);
            const minWait = Math.min(...waitTimes);

            document.getElementById('stats-avg-wait').textContent = `${avgWait} 分鐘`;
            document.getElementById('stats-max-wait').textContent = `${maxWait} 分鐘`;
            document.getElementById('stats-min-wait').textContent = `${minWait} 分鐘`;
            document.getElementById('stats-today-completed').textContent = '計算中...';
            document.getElementById('stats-processing').textContent = allOrders.length;
            document.getElementById('stats-completion-rate').textContent = '95%';
            document.getElementById('stats-response-time').textContent = '< 500 毫秒';
        }

        function updateAlertsModal() {
            const alertList = document.getElementById('alert-list');
            const urgentOrders = allOrders.filter(order => {
                const createdTime = order.properties['建立時間']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                return waitTime > settings.urgentThreshold;
            });

            if (urgentOrders.length === 0) {
                alertList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">✅</div>
                        <p class="text-lg">目前沒有超時訂單</p>
                        <p class="text-sm">所有訂單都在正常時間範圍內</p>
                    </div>
                `;
                return;
            }

            alertList.innerHTML = urgentOrders.map(order => {
                const props = order.properties;
                const orderNumber = props['訂單編號']?.title?.[0]?.text?.content || order.id.substring(0, 8);
                const tableNumber = props['桌號']?.rich_text?.[0]?.text?.content || 'N/A';
                const createdTime = props['建立時間']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                
                return `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-red-800 font-semibold">桌號: ${tableNumber}</h4>
                                <p class="text-red-600 text-sm">#${orderNumber}</p>
                                <p class="text-red-700 font-bold">等待時間: ${waitTime} 分鐘</p>
                            </div>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-semibold">
                                超時 ${waitTime - settings.urgentThreshold} 分鐘
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCounters() {
            const pending = allOrders.filter(order => order.properties['狀態']?.select?.name === '待處理').length;
            const making = allOrders.filter(order => order.properties['狀態']?.select?.name === '製作中').length;
            const waitingDessert = allOrders.filter(order => order.properties['狀態']?.select?.name === '等待甜點').length;
            const waitingCheckout = allOrders.filter(order => order.properties['狀態']?.select?.name === '等待結帳').length;
            const total = allOrders.length;

            // 更新頂部顯示的計數器
            if (dom.countAll) dom.countAll.textContent = total;
            dom.countPending.textContent = pending;
            dom.countMaking.textContent = making;
            dom.countWaitingDessert.textContent = waitingDessert;
            dom.countWaitingCheckout.textContent = waitingCheckout;

            // 更新下拉選單中的計數器
            dom.dropdownCountAll.textContent = total;
            dom.dropdownCountPending.textContent = pending;
            dom.dropdownCountMaking.textContent = making;
            dom.dropdownCountWaitingDessert.textContent = waitingDessert;
            dom.dropdownCountWaitingCheckout.textContent = waitingCheckout;

            // 更新超時警示計數
            const urgentOrders = allOrders.filter(order => {
                const createdTime = order.properties['建立時間']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                return waitTime > settings.urgentThreshold;
            });
            
            dom.alertCount.textContent = urgentOrders.length;
            
            // 如果有超時訂單，讓警示按鈕閃爍
            const monitorBtn = dom.monitorMenuBtn;
            if (urgentOrders.length > 0) {
                monitorBtn.classList.add('animate-pulse', 'bg-red-600');
                monitorBtn.classList.remove('bg-teal-600');
            } else {
                monitorBtn.classList.remove('animate-pulse', 'bg-red-600');
                monitorBtn.classList.add('bg-teal-600');
            }
        }

        function updateStats() {
            if (allOrders.length === 0) {
                dom.avgWaitTime.textContent = '-- 分鐘';
                dom.maxWaitTime.textContent = '-- 分鐘';
                return;
            }

            const waitTimes = allOrders.map(order => {
                const createdTime = order.properties['建立時間']?.date?.start || order.created_time;
                return calculateWaitTime(createdTime);
            });

            const avgWait = Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length);
            const maxWait = Math.max(...waitTimes);

            dom.avgWaitTime.textContent = `${avgWait} 分鐘`;
            dom.maxWaitTime.textContent = `${maxWait} 分鐘`;
        }

        function updateTimers() {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const createdTime = el.dataset.timestamp;
                const waitTime = calculateWaitTime(createdTime);
                el.textContent = `已等待 ${waitTime} 分鐘`;
                
                if (waitTime > 45) {
                    el.className = 'text-sm text-red-400 font-bold animate-pulse';
                } else if (waitTime > settings.urgentThreshold) {
                    el.className = 'text-sm text-orange-400 font-semibold';
                } else {
                    el.className = 'text-sm text-yellow-400 font-semibold';
                }
            });
        }

        function updateTime() {
            const now = new Date();
            dom.systemTime.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }

        function updateStatus(isOnline) {
            if (isOnline) {
                dom.systemStatus.textContent = '● Notion 連線正常';
                dom.systemStatus.classList.remove('text-red-400');
                dom.systemStatus.classList.add('text-green-400');
            } else {
                dom.systemStatus.textContent = '❗ Notion 連線異常';
                dom.systemStatus.classList.add('text-red-400');
                dom.systemStatus.classList.remove('text-green-400');
            }
        }

        function updateRefreshButton(isLoading) {
            const btn = dom.refreshKdsBtn;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '⏳ 更新中...';
            } else {
                btn.disabled = false;
                btn.innerHTML = '🔄 更新';
            }
        }

        function removeLoadingPlaceholder() {
            if (dom.loadingPlaceholder) {
                dom.loadingPlaceholder.remove();
                dom.loadingPlaceholder = null;
            }
        }

        function showNoOrdersMessage() {
            removeNoOrdersMessage();
            const noOrdersMsg = document.createElement('div');
            noOrdersMsg.id = 'no-orders-msg';
            noOrdersMsg.className = 'text-center py-16 text-gray-500 w-screen';
            noOrdersMsg.innerHTML = `
                <div class="text-6xl mb-4">🍽️</div>
                <p class="text-2xl font-semibold mb-2">目前沒有待處理訂單</p>
                <p class="text-lg text-gray-400">所有訂單都已完成！</p>
            `;
            dom.orderWrapper.appendChild(noOrdersMsg);
        }

        function removeNoOrdersMessage() {
            const noOrdersMsg = document.getElementById('no-orders-msg');
            if (noOrdersMsg) noOrdersMsg.remove();
        }

        function showError(message) {
            console.error('❌ KDS 錯誤:', message);
        }

        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            if (settings.refreshInterval > 0) {
                autoRefreshTimer = setInterval(() => {
                    console.log('🔄 自動刷新訂單...');
                    fetchOrders();
                }, settings.refreshInterval);
            }
        }

        // === 通知功能 ===
        function checkNewOrders() {
            if (settings.soundEnabled) {
                playNotificationSound();
            }
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('新訂單！', {
                    body: '收到新的訂單，請查看廚房系統',
                    icon: '🔔'
                });
            }
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('音效播放失敗:', error);
            }
        }

        // === 設定管理 ===
        function showSettings() {
            document.getElementById('refresh-interval').value = settings.refreshInterval;
            document.getElementById('sound-enabled').checked = settings.soundEnabled;
            document.getElementById('urgent-threshold').value = settings.urgentThreshold;
            
            dom.settingsPanel.classList.remove('hidden');
            dom.settingsPanel.classList.add('flex');
        }

        function hideSettings() {
            dom.settingsPanel.classList.add('hidden');
            dom.settingsPanel.classList.remove('flex');
        }

        function saveSettings() {
            settings.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            settings.soundEnabled = document.getElementById('sound-enabled').checked;
            settings.urgentThreshold = parseInt(document.getElementById('urgent-threshold').value);
            
            startAutoRefresh();
            localStorage.setItem('kds-tablet-settings', JSON.stringify(settings));
            
            hideSettings();
            updateStatus(true);
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('kds-tablet-settings');
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.log('載入設定失敗:', error);
            }
        }

        // === 模態框功能 ===
        function showOrderDetail(order) {
            const props = order.properties;
            
            const orderNumber = props['訂單編號']?.title?.[0]?.text?.content || order.id.substring(0, 8);
            const tableNumber = props['桌號']?.rich_text?.[0]?.text?.content || 'N/A';
            const status = props['狀態']?.select?.name || '準備中';
            const createdTime = props['建立時間']?.date?.start || order.created_time;
            const orderItems = order.items || [];
            const customerNote = order.customerNote || '';
            const totalAmount = props['總金額']?.number || 0;

            let itemsDetailHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsDetailHtml = orderItems.map(item => `
                    <tr class="border-b">
                        <td class="py-2 px-4">${item.name || '未知項目'}</td>
                        <td class="py-2 px-4 text-center">${item.quantity || 1}</td>
                        <td class="py-2 px-4 text-right">$${(item.price || 0) * (item.quantity || 1)}</td>
                        <td class="py-2 px-4 text-sm text-gray-600">${item.note || '-'}</td>
                    </tr>
                `).join('');
            }

            dom.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">訂單編號</label>
                            <p class="text-lg font-semibold">#${orderNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">桌號</label>
                            <p class="text-lg font-semibold">${tableNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">狀態</label>
                            <p class="text-lg font-semibold text-${status === '準備中' ? 'yellow' : status === '進行中' ? 'red' : 'green'}-600">${status}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">下單時間</label>
                            <p class="text-lg">${new Date(createdTime).toLocaleString('zh-TW')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">總金額</label>
                            <p class="text-lg font-semibold text-green-600">$${totalAmount}</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">訂單內容</label>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-gray-50 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left">品項</th>
                                        <th class="py-2 px-4 text-center">數量</th>
                                        <th class="py-2 px-4 text-right">小計</th>
                                        <th class="py-2 px-4 text-left">備註</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsDetailHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${customerNote ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客戶備註</label>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                                <p class="text-yellow-800">${customerNote}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            dom.orderModal.classList.remove('hidden');
        }

        function closeModal() {
            dom.orderModal.classList.add('hidden');
        }

        // === 頁面可見性處理 ===
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                }
            } else {
                startAutoRefresh();
                fetchOrders();
            }
        });

        // 定時更新等待時間
        setInterval(updateTimers, 60000);
    </script>
</body>
</html>
