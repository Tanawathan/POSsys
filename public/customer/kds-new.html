<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»šæˆ¿å‡ºé¤ç³»çµ± (KDS) - Notionç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- ç’°å¢ƒé…ç½® (å¿…é ˆåœ¨å…¶ä»–è…³æœ¬ä¹‹å‰è¼‰å…¥) -->
    <script src="../env-config.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        #order-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #order-container::-webkit-scrollbar {
            display: none;
        }
        .order-card {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .completed-order {
            animation: slideOut 0.3s ease-in;
        }
        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(20px) scale(0.8);
            }
        }
        .status-preparing { border-left: 6px solid #f59e0b; }
        .status-cooking { border-left: 6px solid #ef4444; }
        .status-ready { border-left: 6px solid #10b981; }
        .priority-high { background: linear-gradient(135deg, #fee2e2, #fef2f2); }
        .priority-normal { background: linear-gradient(135deg, #f3f4f6, #ffffff); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800 border-b-4 border-indigo-600 shadow-lg">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-4">
                            <a href="../index.html" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm">â† ä¸»ç³»çµ±</a>
                            <a href="../main-dashboard.html" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm">ğŸ“Š å„€è¡¨æ¿</a>
                        </div>
                        <h1 class="text-3xl font-bold text-white">å»šæˆ¿å‡ºé¤ç³»çµ± (KDS)</h1>
                        <div class="flex space-x-2">
                            <button id="filter-all" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm filter-btn active">
                                å…¨éƒ¨ (<span id="count-all">0</span>)
                            </button>
                            <button id="filter-preparing" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm filter-btn">
                                æº–å‚™ä¸­ (<span id="count-preparing">0</span>)
                            </button>
                            <button id="filter-cooking" class="px-3 py-1 bg-red-600 text-white rounded text-sm filter-btn">
                                çƒ¹é£ªä¸­ (<span id="count-cooking">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button id="refresh-kds-btn" class="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-400 disabled:cursor-wait">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0M6.817 9.348L3.636 6.165a8.25 8.25 0 0111.664 0l3.181 3.183" />
                            </svg>
                            æ›´æ–°è¨‚å–®
                        </button>
                        
                        <div class="text-right">
                            <p id="system-time" class="text-2xl text-gray-200"></p>
                            <p id="system-status" class="text-sm text-green-400 mt-1">â— é€£ç·šæ­£å¸¸</p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Bar -->
                <div class="mt-3 flex space-x-4 text-sm">
                    <div class="bg-yellow-600 px-3 py-1 rounded text-white">
                        <span>å¹³å‡ç­‰å¾…: </span><span id="avg-wait-time">-- åˆ†é˜</span>
                    </div>
                    <div class="bg-red-600 px-3 py-1 rounded text-white">
                        <span>æœ€é•·ç­‰å¾…: </span><span id="max-wait-time">-- åˆ†é˜</span>
                    </div>
                    <div class="bg-green-600 px-3 py-1 rounded text-white">
                        <span>ä»Šæ—¥å®Œæˆ: </span><span id="today-completed">--</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Order Container -->
        <main id="order-container" class="flex-1 flex items-start p-4 bg-gray-900 overflow-x-auto">
            <div id="order-wrapper" class="flex flex-nowrap space-x-4 h-full min-w-full">
                <div id="loading-placeholder" class="text-center py-16 text-gray-400 w-screen">
                    <div class="animate-spin rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 mx-auto"></div>
                    <p class="text-xl">æ­£åœ¨é€£æ¥ Notion è³‡æ–™åº«...</p>
                    <p class="text-sm mt-2">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">è¨‚å–®è©³æƒ…</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-900">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            notionApiKey: window.ENV_CONFIG?.NOTION_API_KEY || 'secret_iSDhSCT8HPZMjPsX8YuMdhfzPJ2EYJrfXLdE17L88cV',
            netlifyFunctionBase: `${window.location.origin}/.netlify/functions`,
            ordersDatabase: window.ENV_CONFIG?.ORDERS_DATABASE_ID || '23afd5adc30b80c39e71d1a640ccfb5d',
            autoRefreshInterval: 30000, // 30ç§’
            soundEnabled: true
        };

        // --- STATE ---
        let allOrders = [];
        let displayedOrderIds = new Set();
        let currentFilter = 'all';
        let autoRefreshTimer = null;

        // --- DOM ELEMENTS ---
        const dom = {
            orderWrapper: document.getElementById('order-wrapper'),
            systemTime: document.getElementById('system-time'),
            systemStatus: document.getElementById('system-status'),
            loadingPlaceholder: document.getElementById('loading-placeholder'),
            refreshKdsBtn: document.getElementById('refresh-kds-btn'),
            orderModal: document.getElementById('order-modal'),
            modalContent: document.getElementById('modal-content'),
            closeModal: document.getElementById('close-modal'),
            // Filter buttons
            filterAll: document.getElementById('filter-all'),
            filterPreparing: document.getElementById('filter-preparing'),
            filterCooking: document.getElementById('filter-cooking'),
            // Counters
            countAll: document.getElementById('count-all'),
            countPreparing: document.getElementById('count-preparing'),
            countCooking: document.getElementById('count-cooking'),
            // Stats
            avgWaitTime: document.getElementById('avg-wait-time'),
            maxWaitTime: document.getElementById('max-wait-time'),
            todayCompleted: document.getElementById('today-completed')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ KDS ç³»çµ±åˆå§‹åŒ–');
            initEventListeners();
            fetchOrders();
            updateTime();
            setInterval(updateTime, 1000);
            startAutoRefresh();
        });

        function initEventListeners() {
            // Refresh button
            dom.refreshKdsBtn.addEventListener('click', fetchOrders);
            
            // Filter buttons
            dom.filterAll.addEventListener('click', () => setFilter('all'));
            dom.filterPreparing.addEventListener('click', () => setFilter('preparing'));
            dom.filterCooking.addEventListener('click', () => setFilter('cooking'));
            
            // Modal
            dom.closeModal.addEventListener('click', closeModal);
            dom.orderModal.addEventListener('click', (e) => {
                if (e.target === dom.orderModal) closeModal();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' || e.key === 'R') {
                    fetchOrders();
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // --- DATA FETCHING ---
        async function fetchOrders() {
            console.log('ğŸ“¥ é–‹å§‹å¾ Notion ç²å–è¨‚å–®è³‡æ–™...');
            updateRefreshButton(true);

            try {
                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/databases/${CONFIG.ordersDatabase}/query`,
                        method: 'POST',
                        body: {
                            sorts: [
                                {
                                    property: 'å»ºç«‹æ™‚é–“',
                                    direction: 'descending'
                                }
                            ],
                            filter: {
                                or: [
                                    {
                                        property: 'ç‹€æ…‹',
                                        select: {
                                            equals: 'æº–å‚™ä¸­'
                                        }
                                    },
                                    {
                                        property: 'ç‹€æ…‹',
                                        select: {
                                            equals: 'é€²è¡Œä¸­'
                                        }
                                    }
                                ]
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ æ”¶åˆ° Notion è¨‚å–®è³‡æ–™:', data);

                if (data.results && Array.isArray(data.results)) {
                    // å°‡ Notion è³‡æ–™æ˜ å°„ç‚º KDS å¯ç”¨æ ¼å¼
                    allOrders = data.results.map(mapNotionOrderToKDS);
                    processAndRenderOrders();
                    updateStats();
                    updateStatus(true);
                    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allOrders.length} ç­†è¨‚å–®`);
                } else {
                    console.warn('âš ï¸ è³‡æ–™æ ¼å¼ç•°å¸¸:', data);
                    showError('è³‡æ–™æ ¼å¼ç•°å¸¸');
                }
            } catch (error) {
                console.error('âŒ ç²å–è¨‚å–®å¤±æ•—:', error);
                updateStatus(false);
                showError(`é€£ç·šå¤±æ•—: ${error.message}`);
            } finally {
                updateRefreshButton(false);
            }
        }

        // --- NOTION DATA MAPPING ---
        function mapNotionOrderToKDS(notionOrder) {
            const props = notionOrder.properties;
            
            // è§£æè¨‚å–®ç·¨è™Ÿ
            const orderId = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || 
                           props['è¨‚å–®ç·¨è™Ÿ']?.rich_text?.[0]?.text?.content || 
                           `ORDER-${Date.now()}`;
            
            // è§£ææ¡Œè™Ÿ
            const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 
                               props['æ¡Œè™Ÿ']?.title?.[0]?.text?.content || 'æœªçŸ¥';
            
            // è§£æç‹€æ…‹
            const status = props['ç‹€æ…‹']?.select?.name || 'æº–å‚™ä¸­';
            
            // è§£æç¸½é‡‘é¡
            const total = props['ç¸½é‡‘é¡']?.number || 0;
            
            // è§£æç”¨é¤äººæ•¸
            const customerCount = props['ç”¨é¤äººæ•¸']?.number || 1;
            
            // è§£æå»ºç«‹æ™‚é–“
            const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || 
                               props['å»ºç«‹æ™‚é–“']?.created_time || 
                               notionOrder.created_time;
            
            // è§£æå‚™è¨»å’Œè¨‚å–®é …ç›®
            const notesText = props['å‚™è¨»']?.rich_text?.[0]?.text?.content || '';
            let items = [];
            let customerNote = '';
            
            // å¾å‚™è¨»ä¸­æå–ç³»çµ±è³‡æ–™å’Œç”¨æˆ¶å‚™è¨»
            if (notesText) {
                const systemDataMatch = notesText.match(/\[ç³»çµ±è³‡æ–™\]\s*({.*?})\s*(?:\[\/ç³»çµ±è³‡æ–™\]|$)/s);
                
                if (systemDataMatch) {
                    try {
                        const systemData = JSON.parse(systemDataMatch[1]);
                        items = systemData.items || [];
                    } catch (e) {
                        console.warn('è§£æç³»çµ±è³‡æ–™å¤±æ•—:', e);
                    }
                    
                    // æå–ç”¨æˆ¶å‚™è¨»ï¼ˆç³»çµ±è³‡æ–™ä¹‹å‰çš„éƒ¨åˆ†ï¼‰
                    const systemDataStart = notesText.indexOf('[ç³»çµ±è³‡æ–™]');
                    if (systemDataStart > 0) {
                        customerNote = notesText.substring(0, systemDataStart).trim();
                    }
                } else {
                    // å¦‚æœæ²’æœ‰ç³»çµ±è³‡æ–™ï¼Œå˜—è©¦å¾è¨‚å–®é …ç›®æ¬„ä½è§£æ
                    const orderItemsText = props['è¨‚å–®é …ç›®']?.rich_text?.[0]?.text?.content || '';
                    if (orderItemsText) {
                        // å˜—è©¦è§£ææ ¼å¼å¦‚ "é …ç›®åç¨± x æ•¸é‡ - $ç¸½åƒ¹"
                        const itemMatches = orderItemsText.match(/([^x]+)\s*x\s*(\d+)\s*-\s*\$(\d+)/g);
                        if (itemMatches) {
                            items = itemMatches.map(match => {
                                const [, name, qty, totalPrice] = match.match(/([^x]+)\s*x\s*(\d+)\s*-\s*\$(\d+)/);
                                const quantity = parseInt(qty);
                                const itemPrice = parseInt(totalPrice) / quantity;
                                return {
                                    name: name.trim(),
                                    quantity: quantity,
                                    price: itemPrice
                                };
                            });
                        }
                    }
                    
                    // ç”¨æˆ¶å‚™è¨»å°±æ˜¯æ•´å€‹å‚™è¨»å…§å®¹
                    customerNote = notesText;
                }
            }
            
            // å¦‚æœæ²’æœ‰è§£æåˆ°é …ç›®ï¼Œå‰µå»ºé è¨­é …ç›®
            if (items.length === 0 && total > 0) {
                items = [{
                    name: 'è¨‚å–®é …ç›®',
                    quantity: 1,
                    price: total
                }];
            }
            
            return {
                id: orderId,
                properties: {
                    'è¨‚å–®ç·¨è™Ÿ': { title: [{ text: { content: orderId } }] },
                    'æ¡Œè™Ÿ': { rich_text: [{ text: { content: tableNumber } }] },
                    'ç‹€æ…‹': { select: { name: status } },
                    'ç¸½é‡‘é¡': { number: total },
                    'ç”¨é¤äººæ•¸': { number: customerCount },
                    'å»ºç«‹æ™‚é–“': { date: { start: createdTime } },
                    'å‚™è¨»': { rich_text: [{ text: { content: notesText } }] }
                },
                created_time: createdTime,
                // KDS ç‰¹å®šå±¬æ€§
                items: items,
                customerNote: customerNote,
                notionPageId: notionOrder.id
            };
        }

        // --- DATA PROCESSING ---
        function processAndRenderOrders() {
            removeLoadingPlaceholder();
            
            // éæ¿¾ä¸¦é¡¯ç¤ºè¨‚å–®
            const filteredOrders = filterOrders(allOrders);
            renderOrders(filteredOrders);
            updateCounters();
        }

        function filterOrders(orders) {
            switch (currentFilter) {
                case 'preparing':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'æº–å‚™ä¸­');
                case 'cooking':
                    return orders.filter(order => order.properties['ç‹€æ…‹']?.select?.name === 'é€²è¡Œä¸­');
                default:
                    return orders;
            }
        }

        function renderOrders(orders) {
            // æ¸…é™¤ä¸å†å­˜åœ¨çš„è¨‚å–®
            const currentOrderIds = new Set(orders.map(order => order.id));
            displayedOrderIds.forEach(id => {
                if (!currentOrderIds.has(id)) {
                    const ticket = document.getElementById(`order-${id}`);
                    if (ticket) {
                        ticket.classList.add('completed-order');
                        setTimeout(() => ticket.remove(), 300);
                    }
                    displayedOrderIds.delete(id);
                }
            });

            if (orders.length === 0) {
                showNoOrdersMessage();
                return;
            } else {
                removeNoOrdersMessage();
            }

            // æ¸²æŸ“æ–°è¨‚å–®æˆ–æ›´æ–°ç¾æœ‰è¨‚å–®
            orders.forEach(order => {
                const orderId = order.id;
                const existingTicket = document.getElementById(`order-${orderId}`);
                
                if (existingTicket) {
                    // æ›´æ–°ç¾æœ‰è¨‚å–®
                    updateOrderTicket(existingTicket, order);
                } else {
                    // å‰µå»ºæ–°è¨‚å–®ç¥¨æ“š
                    createOrderTicket(order);
                    displayedOrderIds.add(orderId);
                }
            });

            updateTimers();
        }

        function createOrderTicket(order) {
            const orderId = order.id;
            const props = order.properties;
            
            // æå–è¨‚å–®è³‡è¨Š
            const orderNumber = props['è¨‚å–®ç·¨è™Ÿ']?.title?.[0]?.text?.content || orderId.substring(0, 8);
            const tableNumber = props['æ¡Œè™Ÿ']?.rich_text?.[0]?.text?.content || 'N/A';
            const status = props['ç‹€æ…‹']?.select?.name || 'æº–å‚™ä¸­';
            const createdTime = props['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
            const orderItems = order.items || [];
            const customerNote = order.customerNote || '';
            const totalAmount = props['ç¸½é‡‘é¡']?.number || 0;

            // è¨ˆç®—ç­‰å¾…æ™‚é–“
            const waitTime = calculateWaitTime(createdTime);
            const priority = waitTime > 30 ? 'high' : 'normal';

            const ticket = document.createElement('div');
            ticket.id = `order-${orderId}`;
            ticket.className = `order-card bg-white text-gray-900 rounded-lg shadow-2xl w-80 h-full flex flex-col flex-shrink-0 status-${status.toLowerCase()} priority-${priority}`;
            
            // æ§‹å»ºé …ç›®åˆ—è¡¨
            let itemsHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsHtml = orderItems.map(item => {
                    const note = item.note ? `<p class="text-red-600 font-semibold text-sm ml-4">å‚™è¨»: ${item.note}</p>` : '';
                    return `
                        <li class="py-2 border-b border-gray-200 last:border-b-0">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold">${item.name || 'æœªçŸ¥é …ç›®'}</span>
                                <span class="text-xl font-bold text-indigo-600">x${item.quantity || 1}</span>
                            </div>
                            ${note}
                        </li>
                    `;
                }).join('');
            } else {
                itemsHtml = '<li class="text-gray-500 italic">è¨‚å–®å…§å®¹è¼‰å…¥ä¸­...</li>';
            }

            // ç‹€æ…‹é¡è‰²é…ç½®
            const statusConfig = {
                'æº–å‚™ä¸­': { bg: 'bg-yellow-500', text: 'æº–å‚™ä¸­' },
                'é€²è¡Œä¸­': { bg: 'bg-red-500', text: 'é€²è¡Œä¸­' },
                'å·²å®Œæˆ': { bg: 'bg-green-500', text: 'å·²å®Œæˆ' }
            };
            const statusInfo = statusConfig[status] || statusConfig['æº–å‚™ä¸­'];

            ticket.innerHTML = `
                <div class="p-4 bg-gray-800 text-white rounded-t-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-2xl font-bold">æ¡Œè™Ÿ: ${tableNumber}</p>
                            <p class="text-sm text-gray-400">#${orderNumber}</p>
                        </div>
                        <span class="${statusInfo.bg} px-2 py-1 rounded text-xs font-semibold">
                            ${statusInfo.text}
                        </span>
                    </div>
                    <p class="text-sm text-yellow-400 font-semibold" data-timestamp="${createdTime}">
                        å·²ç­‰å¾… ${waitTime} åˆ†é˜
                    </p>
                    ${totalAmount > 0 ? `<p class="text-sm text-green-400">ç¸½é¡: $${totalAmount}</p>` : ''}
                </div>
                
                <div class="flex-1 p-3 overflow-y-auto">
                    <ul class="space-y-1">
                        ${itemsHtml}
                    </ul>
                    ${customerNote ? `<div class="mt-3 p-2 bg-yellow-50 border-l-4 border-yellow-400">
                        <p class="text-sm font-semibold text-yellow-800">å®¢æˆ¶å‚™è¨»:</p>
                        <p class="text-sm text-yellow-700">${customerNote}</p>
                    </div>` : ''}
                </div>
                
                <div class="p-3 space-y-2">
                    <div class="flex space-x-2">
                        ${status === 'æº–å‚™ä¸­' ? `
                            <button class="action-btn cooking-btn flex-1 bg-orange-600 text-white py-3 rounded-md text-lg font-bold hover:bg-orange-700 transition-colors">
                                é–‹å§‹çƒ¹é£ª
                            </button>
                        ` : ''}
                        ${status === 'é€²è¡Œä¸­' ? `
                            <button class="action-btn complete-btn flex-1 bg-green-600 text-white py-3 rounded-md text-lg font-bold hover:bg-green-700 transition-colors">
                                å®Œæˆå‡ºé¤
                            </button>
                        ` : ''}
                        <button class="detail-btn bg-gray-600 text-white py-3 px-4 rounded-md text-lg hover:bg-gray-700 transition-colors">
                            è©³æƒ…
                        </button>
                    </div>
                </div>
            `;

            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const cookingBtn = ticket.querySelector('.cooking-btn');
            const completeBtn = ticket.querySelector('.complete-btn');
            const detailBtn = ticket.querySelector('.detail-btn');

            if (cookingBtn) {
                cookingBtn.addEventListener('click', () => updateOrderStatus(orderId, 'é€²è¡Œä¸­', cookingBtn));
            }
            if (completeBtn) {
                completeBtn.addEventListener('click', () => updateOrderStatus(orderId, 'å·²å®Œæˆ', completeBtn));
            }
            if (detailBtn) {
                detailBtn.addEventListener('click', () => showOrderDetail(order));
            }

            dom.orderWrapper.appendChild(ticket);
        }

        function updateOrderTicket(ticket, order) {
            const waitTimeElement = ticket.querySelector('[data-timestamp]');
            if (waitTimeElement) {
                const createdTime = order.properties['å»ºç«‹æ™‚é–“']?.date?.start || order.created_time;
                const waitTime = calculateWaitTime(createdTime);
                waitTimeElement.textContent = `å·²ç­‰å¾… ${waitTime} åˆ†é˜`;
            }
        }

        // --- ORDER ACTIONS ---
        async function updateOrderStatus(orderId, newStatus, buttonElement) {
            console.log(`ğŸ”„ æ›´æ–°è¨‚å–® ${orderId} ç‹€æ…‹ç‚º ${newStatus}`);
            
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.textContent = 'è™•ç†ä¸­...';
            }

            try {
                // æ‰¾åˆ°å°æ‡‰çš„è¨‚å–®
                const order = allOrders.find(o => o.id === orderId);
                if (!order || !order.notionPageId) {
                    throw new Error('æ‰¾ä¸åˆ°è¨‚å–®æˆ– Notion é é¢ ID');
                }

                // ä½¿ç”¨ Netlify Functions èª¿ç”¨ Notion API
                const response = await fetch(`${CONFIG.netlifyFunctionBase}/notion-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/pages/${order.notionPageId}`,
                        method: 'PATCH',
                        body: {
                            properties: {
                                'ç‹€æ…‹': {
                                    select: {
                                        name: newStatus
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                console.log(`âœ… è¨‚å–® ${orderId} ç‹€æ…‹æ›´æ–°æˆåŠŸ`);
                
                // å¦‚æœæ˜¯å®Œæˆç‹€æ…‹ï¼Œç§»é™¤è¨‚å–®å¡ç‰‡
                if (newStatus === 'å·²å®Œæˆ') {
                    const ticket = document.getElementById(`order-${orderId}`);
                    if (ticket) {
                        ticket.classList.add('completed-order');
                        setTimeout(() => {
                            ticket.remove();
                            displayedOrderIds.delete(orderId);
                            // å¾ allOrders ä¸­ç§»é™¤
                            allOrders = allOrders.filter(order => order.id !== orderId);
                            updateCounters();
                            updateStats();
                        }, 300);
                    }
                } else {
                    // é‡æ–°ç²å–è¨‚å–®è³‡æ–™ä»¥æ›´æ–°é¡¯ç¤º
                    setTimeout(fetchOrders, 1000);
                }

            } catch (error) {
                console.error('âŒ æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
                alert(`æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—: ${error.message}`);
                
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = newStatus === 'çƒ¹é£ªä¸­' ? 'é–‹å§‹çƒ¹é£ª' : 'å®Œæˆå‡ºé¤';
                }
            }
        }

        // --- MODAL FUNCTIONS ---
        function showOrderDetail(order) {
            const props = order.properties;
            
            const orderNumber = extractTitle(order, 'è¨‚å–®ç·¨è™Ÿ') || extractRichText(order, 'è¨‚å–®ID') || order.id.substring(0, 8);
            const tableNumber = extractNumber(order, 'æ¡Œè™Ÿ') || extractRichText(order, 'æ¡Œè™Ÿ') || 'N/A';
            const status = extractSelect(order, 'ç‹€æ…‹') || 'æº–å‚™ä¸­';
            const createdTime = extractDate(order, 'å»ºç«‹æ™‚é–“') || order.created_time;
            const orderItems = parseOrderItems(extractRichText(order, 'è¨‚å–®å…§å®¹(JSON)'));
            const customerNote = extractRichText(order, 'å®¢æˆ¶å‚™è¨»') || '';
            const totalAmount = extractNumber(order, 'ç¸½é‡‘é¡') || 0;
            const paymentMethod = extractSelect(order, 'ä»˜æ¬¾æ–¹å¼') || 'æœªæŒ‡å®š';

            let itemsDetailHtml = '';
            if (orderItems && Array.isArray(orderItems)) {
                itemsDetailHtml = orderItems.map(item => `
                    <tr class="border-b">
                        <td class="py-2 px-4">${item.name || 'æœªçŸ¥é …ç›®'}</td>
                        <td class="py-2 px-4 text-center">${item.quantity || 1}</td>
                        <td class="py-2 px-4 text-right">$${(item.price || 0) * (item.quantity || 1)}</td>
                        <td class="py-2 px-4 text-sm text-gray-600">${item.note || '-'}</td>
                    </tr>
                `).join('');
            }

            dom.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">è¨‚å–®ç·¨è™Ÿ</label>
                            <p class="text-lg font-semibold">#${orderNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ¡Œè™Ÿ</label>
                            <p class="text-lg font-semibold">${tableNumber}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                            <p class="text-lg font-semibold text-${status === 'æº–å‚™ä¸­' ? 'yellow' : status === 'çƒ¹é£ªä¸­' ? 'red' : 'green'}-600">${status}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ä¸‹å–®æ™‚é–“</label>
                            <p class="text-lg">${new Date(createdTime).toLocaleString('zh-TW')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç¸½é‡‘é¡</label>
                            <p class="text-lg font-semibold text-green-600">$${totalAmount}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ä»˜æ¬¾æ–¹å¼</label>
                            <p class="text-lg">${paymentMethod}</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨‚å–®å…§å®¹</label>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-gray-50 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left">å“é …</th>
                                        <th class="py-2 px-4 text-center">æ•¸é‡</th>
                                        <th class="py-2 px-4 text-right">å°è¨ˆ</th>
                                        <th class="py-2 px-4 text-left">å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsDetailHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${customerNote ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å®¢æˆ¶å‚™è¨»</label>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                                <p class="text-yellow-800">${customerNote}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            dom.orderModal.classList.remove('hidden');
        }

        function closeModal() {
            dom.orderModal.classList.add('hidden');
        }

        // --- UTILITY FUNCTIONS ---
        function extractTitle(order, propertyName) {
            const prop = order.properties[propertyName];
            return prop?.title?.[0]?.plain_text || '';
        }

        function extractRichText(order, propertyName) {
            const prop = order.properties[propertyName];
            return prop?.rich_text?.[0]?.plain_text || '';
        }

        function extractSelect(order, propertyName) {
            const prop = order.properties[propertyName];
            return prop?.select?.name || '';
        }

        function extractNumber(order, propertyName) {
            const prop = order.properties[propertyName];
            return prop?.number || null;
        }

        function extractDate(order, propertyName) {
            const prop = order.properties[propertyName];
            return prop?.date?.start || prop?.created_time || null;
        }

        function parseOrderItems(jsonString) {
            if (!jsonString) return [];
            
            try {
                const parsed = JSON.parse(jsonString);
                return Array.isArray(parsed) ? parsed : [parsed];
            } catch (e) {
                console.warn('ç„¡æ³•è§£æè¨‚å–®å…§å®¹:', jsonString);
                return [];
            }
        }

        function calculateWaitTime(createdTime) {
            const orderTime = new Date(createdTime);
            const now = new Date();
            return Math.floor((now - orderTime) / 60000); // åˆ†é˜
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600');
                btn.classList.add('bg-gray-600');
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            activeBtn.classList.add('active', 'bg-indigo-600');
            activeBtn.classList.remove('bg-gray-600');
            
            // é‡æ–°æ¸²æŸ“è¨‚å–®
            processAndRenderOrders();
        }

        function updateCounters() {
            const preparing = allOrders.filter(order => extractSelect(order, 'ç‹€æ…‹') === 'æº–å‚™ä¸­').length;
            const cooking = allOrders.filter(order => extractSelect(order, 'ç‹€æ…‹') === 'çƒ¹é£ªä¸­').length;
            const total = allOrders.length;

            dom.countAll.textContent = total;
            dom.countPreparing.textContent = preparing;
            dom.countCooking.textContent = cooking;
        }

        function updateStats() {
            if (allOrders.length === 0) {
                dom.avgWaitTime.textContent = '-- åˆ†é˜';
                dom.maxWaitTime.textContent = '-- åˆ†é˜';
                return;
            }

            const waitTimes = allOrders.map(order => {
                const createdTime = extractDate(order, 'å»ºç«‹æ™‚é–“') || order.created_time;
                return calculateWaitTime(createdTime);
            });

            const avgWait = Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length);
            const maxWait = Math.max(...waitTimes);

            dom.avgWaitTime.textContent = `${avgWait} åˆ†é˜`;
            dom.maxWaitTime.textContent = `${maxWait} åˆ†é˜`;
        }

        function updateTimers() {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const createdTime = el.dataset.timestamp;
                const waitTime = calculateWaitTime(createdTime);
                el.textContent = `å·²ç­‰å¾… ${waitTime} åˆ†é˜`;
                
                // æ ¹æ“šç­‰å¾…æ™‚é–“èª¿æ•´é¡è‰²
                if (waitTime > 45) {
                    el.className = 'text-sm text-red-400 font-bold animate-pulse';
                } else if (waitTime > 30) {
                    el.className = 'text-sm text-orange-400 font-semibold';
                } else {
                    el.className = 'text-sm text-yellow-400 font-semibold';
                }
            });
        }

        function updateTime() {
            const now = new Date();
            dom.systemTime.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }

        function updateStatus(isOnline) {
            if (isOnline) {
                dom.systemStatus.textContent = 'â— Notion é€£ç·šæ­£å¸¸';
                dom.systemStatus.classList.remove('text-red-400');
                dom.systemStatus.classList.add('text-green-400');
            } else {
                dom.systemStatus.textContent = 'â— Notion é€£ç·šç•°å¸¸';
                dom.systemStatus.classList.add('text-red-400');
                dom.systemStatus.classList.remove('text-green-400');
            }
        }

        function updateRefreshButton(isLoading) {
            const btn = dom.refreshKdsBtn;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    æ›´æ–°ä¸­...
                `;
            } else {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0M6.817 9.348L3.636 6.165a8.25 8.25 0 0111.664 0l3.181 3.183" />
                    </svg>
                    æ›´æ–°è¨‚å–®
                `;
            }
        }

        function removeLoadingPlaceholder() {
            if (dom.loadingPlaceholder) {
                dom.loadingPlaceholder.remove();
                dom.loadingPlaceholder = null;
            }
        }

        function showNoOrdersMessage() {
            removeNoOrdersMessage();
            const noOrdersMsg = document.createElement('div');
            noOrdersMsg.id = 'no-orders-msg';
            noOrdersMsg.className = 'text-center py-16 text-gray-500 w-screen';
            noOrdersMsg.innerHTML = `
                <div class="text-6xl mb-4">ğŸ½ï¸</div>
                <p class="text-2xl font-semibold mb-2">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</p>
                <p class="text-lg text-gray-400">æ‰€æœ‰è¨‚å–®éƒ½å·²å®Œæˆï¼</p>
            `;
            dom.orderWrapper.appendChild(noOrdersMsg);
        }

        function removeNoOrdersMessage() {
            const noOrdersMsg = document.getElementById('no-orders-msg');
            if (noOrdersMsg) noOrdersMsg.remove();
        }

        function showError(message) {
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ éŒ¯èª¤æç¤ºçš„ UI
            console.error('âŒ KDS éŒ¯èª¤:', message);
        }

        function startAutoRefresh() {
            autoRefreshTimer = setInterval(() => {
                console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°è¨‚å–®...');
                fetchOrders();
            }, CONFIG.autoRefreshInterval);
        }

        // å®šæ™‚æ›´æ–°ç­‰å¾…æ™‚é–“
        setInterval(updateTimers, 60000);
    </script>
</body>
</html>
