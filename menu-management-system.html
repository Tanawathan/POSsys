<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœå–®ç®¡ç†ç³»çµ± - Tanawaté¤å»³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-sufficient { color: #22c55e; }
        .status-low { color: #f59e0b; }
        .status-shortage { color: #ef4444; }
        .menu-card { transition: all 0.3s ease; }
        .menu-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-utensils mr-2"></i>
                èœå–®ç®¡ç†ç³»çµ±
            </h1>
            <div class="flex space-x-4">
                <button onclick="loadAllMenuData()" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>é‡æ–°è¼‰å…¥
                </button>
                <button onclick="showSupplyAnalysis()" class="bg-green-500 hover:bg-green-700 px-4 py-2 rounded">
                    <i class="fas fa-chart-line mr-2"></i>ä¾›æ‡‰åˆ†æ
                </button>
            </div>
        </div>
    </nav>

    <!-- çµ±è¨ˆé¢æ¿ -->
    <div class="container mx-auto mt-6 px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-list-alt text-blue-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">ç¸½èœè‰²æ•¸</p>
                        <p class="text-2xl font-bold" id="totalMenuItems">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">å¯ä¾›æ‡‰</p>
                        <p class="text-2xl font-bold status-sufficient" id="availableItems">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">åº«å­˜åä½</p>
                        <p class="text-2xl font-bold status-low" id="lowStockItems">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <i class="fas fa-times-circle text-red-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">ç„¡æ³•ä¾›æ‡‰</p>
                        <p class="text-2xl font-bold status-shortage" id="shortageItems">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¯©é¸æ§åˆ¶ -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex flex-wrap gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¤é»é¡å‹</label>
                    <select id="typeFilter" class="border rounded px-3 py-2" onchange="filterMenuItems()">
                        <option value="">å…¨éƒ¨é¡å‹</option>
                        <option value="ä¸»é¤">ä¸»é¤</option>
                        <option value="å°é»">å°é»</option>
                        <option value="ç”œé»">ç”œé»</option>
                        <option value="é£²å“">é£²å“</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä¾›æ‡‰ç‹€æ…‹</label>
                    <select id="statusFilter" class="border rounded px-3 py-2" onchange="filterMenuItems()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="sufficient">å¯ä¾›æ‡‰</option>
                        <option value="low">åº«å­˜åä½</option>
                        <option value="shortage">ç„¡æ³•ä¾›æ‡‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è£½ä½œåœ°é»</label>
                    <select id="locationFilter" class="border rounded px-3 py-2" onchange="filterMenuItems()">
                        <option value="">å…¨éƒ¨åœ°é»</option>
                        <option value="å»šæˆ¿">å»šæˆ¿</option>
                        <option value="å§å°">å§å°</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœå°‹èœè‰²</label>
                    <input type="text" id="searchInput" placeholder="è¼¸å…¥èœè‰²åç¨±..." 
                           class="w-full border rounded px-3 py-2" onkeyup="filterMenuItems()">
                </div>
            </div>
        </div>

        <!-- èœå–®åˆ—è¡¨ -->
        <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- èœå–®å¡ç‰‡å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loadingIndicator" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
            <p class="mt-2 text-gray-600">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- èœè‰²è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="menuDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" id="modalMenuName">èœè‰²è©³æƒ…</h2>
                        <button onclick="closeMenuDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent">
                        <!-- è©³æƒ…å…§å®¹å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // èœå–®ç®¡ç†ç³»çµ±æ ¸å¿ƒé¡åˆ¥
        class MenuManagementSystem {
            constructor() {
                this.menuItems = [];
                this.menuComponents = [];
                this.recipes = [];
                this.ingredients = [];
                this.inventory = [];
                this.filteredItems = [];
                
                // Notion API è¨­å®š
                this.apiKey = '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';
                this.apiVersion = '2022-06-28';
                this.baseUrl = 'https://api.notion.com/v1';
                
                // è³‡æ–™åº« IDs
                this.databaseIds = {
                    finalMenuItems: '237fd5adc30b80bbb9bbe79d9e330d49',  // æœ€çµ‚èœè‰²
                    menuComponents: '237fd5adc30b80cfa054ec0cdadd8a37',   // æœ€çµ‚èœè‰²çµ„æˆé …ç›®
                    recipes: '237fd5adc30b80c09b59c03cd67c6432',         // åŠæˆå“
                    ingredients: '237fd5adc30b80f7aedfe94804d80218',     // åŠæˆå“çµ„æˆé …ç›®
                    inventory: '237fd5adc30b808cbba3c03f8f2065fd'        // é£Ÿæåº«
                };
            }

            // å–å¾— Notion API æ¨™é ­
            getHeaders() {
                return {
                    'Authorization': `Bearer ${this.apiKey}`,
                    'Content-Type': 'application/json',
                    'Notion-Version': this.apiVersion
                };
            }

            // è¼‰å…¥æ‰€æœ‰è³‡æ–™
            async loadAllData() {
                try {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    console.log('ğŸ”„ é–‹å§‹è¼‰å…¥èœå–®ç®¡ç†è³‡æ–™...');
                    
                    // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™åº«
                    const [menuItems, components, recipes, ingredients, inventory] = await Promise.all([
                        this.loadDatabase(this.databaseIds.finalMenuItems, 'æœ€çµ‚èœè‰²'),
                        this.loadDatabase(this.databaseIds.menuComponents, 'æœ€çµ‚èœè‰²çµ„æˆé …ç›®'),
                        this.loadDatabase(this.databaseIds.recipes, 'åŠæˆå“'),
                        this.loadDatabase(this.databaseIds.ingredients, 'åŠæˆå“çµ„æˆé …ç›®'),
                        this.loadDatabase(this.databaseIds.inventory, 'é£Ÿæåº«')
                    ]);
                    
                    this.menuItems = menuItems;
                    this.menuComponents = components;
                    this.recipes = recipes;
                    this.ingredients = ingredients;
                    this.inventory = inventory;
                    
                    console.log('ğŸ“Š è³‡æ–™è¼‰å…¥å®Œæˆ:');
                    console.log(`  - æœ€çµ‚èœè‰²: ${this.menuItems.length} é …`);
                    console.log(`  - çµ„æˆé …ç›®: ${this.menuComponents.length} é …`);
                    console.log(`  - åŠæˆå“: ${this.recipes.length} é …`);
                    console.log(`  - åŠæˆå“çµ„æˆ: ${this.ingredients.length} é …`);
                    console.log(`  - é£Ÿæåº«å­˜: ${this.inventory.length} é …`);
                    
                    // è¨ˆç®—ä¾›æ‡‰ç‹€æ…‹
                    this.calculateSupplyStatus();
                    
                    // é¡¯ç¤ºèœå–®
                    this.displayMenuItems();
                    this.updateStatistics();
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            // è¼‰å…¥å–®ä¸€è³‡æ–™åº«
            async loadDatabase(databaseId, name) {
                const allResults = [];
                let cursor = undefined;
                
                try {
                    do {
                        const requestBody = {
                            page_size: 100
                        };
                        
                        if (cursor) {
                            requestBody.start_cursor = cursor;
                        }
                        
                        // ä½¿ç”¨æœ¬åœ°ä»£ç†ä¼ºæœå™¨ä¾†é¿å… CORS å•é¡Œ
                        const response = await fetch(`/api/notion/databases/${databaseId}/query`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`è¼‰å…¥ ${name} å¤±æ•—: ${response.status} - ${errorText}`);
                        }
                        
                        const data = await response.json();
                        allResults.push(...data.results);
                        cursor = data.next_cursor;
                        
                    } while (cursor);
                    
                    console.log(`âœ… ${name} è¼‰å…¥å®Œæˆ: ${allResults.length} ç­†`);
                    return allResults;
                    
                } catch (error) {
                    console.error(`âŒ è¼‰å…¥ ${name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                    throw error;
                }
            }

            // è¨ˆç®—ä¾›æ‡‰ç‹€æ…‹
            calculateSupplyStatus() {
                this.menuItems.forEach(item => {
                    const components = this.getMenuComponents(item.id);
                    let canSupply = true;
                    let isLowStock = false;
                    let minServings = Infinity;
                    
                    components.forEach(component => {
                        // å…ˆå˜—è©¦å¾ Notion å–å¾—å¯è£½ä½œä»½æ•¸
                        let availableServings = this.getPropertyFormula(component, 'å¯è£½ä½œä»½æ•¸');
                        
                        // å¦‚æœ Notion ä¸­æ²’æœ‰æ•¸æ“šï¼Œå‰‡è‡ªè¡Œè¨ˆç®—
                        if (availableServings === null || availableServings === 0) {
                            availableServings = this.calculateComponentAvailableServings(component);
                        }
                        
                        // å°‡è¨ˆç®—çµæœå­˜å›çµ„ä»¶ç‰©ä»¶ä¾›å¾ŒçºŒä½¿ç”¨
                        component.calculatedServings = availableServings;
                        
                        if (availableServings !== null) {
                            minServings = Math.min(minServings, availableServings);
                        }
                        
                        // æª¢æŸ¥åº«å­˜ç‹€æ…‹
                        if (availableServings <= 0) {
                            canSupply = false;
                        } else if (availableServings <= 5) {  // å‡è¨­5ä»½ä»¥ä¸‹ç‚ºåº«å­˜åä½
                            isLowStock = true;
                        }
                    });
                    
                    // è¨­å®šä¾›æ‡‰ç‹€æ…‹
                    if (!canSupply) {
                        item.supplyStatus = 'shortage';
                    } else if (isLowStock) {
                        item.supplyStatus = 'low';
                    } else {
                        item.supplyStatus = 'sufficient';
                    }
                    
                    item.availableServings = minServings === Infinity ? 0 : Math.floor(minServings);
                });
            }

            // è¨ˆç®—çµ„ä»¶çš„å¯è£½ä½œä»½æ•¸
            calculateComponentAvailableServings(component) {
                const compName = this.getPropertyTitle(component, 'åç¨±');
                const foodAmount = this.getPropertyNumber(component, 'é£Ÿæç”¨é‡');
                const recipeAmount = this.getPropertyNumber(component, 'é£Ÿè­œç”¨é‡');
                
                // å¦‚æœæ˜¯é£Ÿæçµ„ä»¶ï¼ˆæœ‰é£Ÿæç”¨é‡ï¼‰
                if (foodAmount && foodAmount > 0) {
                    return this.calculateIngredientAvailableServings(compName, foodAmount);
                }
                
                // å¦‚æœæ˜¯åŠæˆå“çµ„ä»¶ï¼ˆæœ‰é£Ÿè­œç”¨é‡ï¼‰
                if (recipeAmount && recipeAmount > 0) {
                    return this.calculateRecipeAvailableServings(compName, recipeAmount);
                }
                
                return 0;
            }

            // è¨ˆç®—é£Ÿæçš„å¯è£½ä½œä»½æ•¸
            calculateIngredientAvailableServings(ingredientName, requiredAmount) {
                // åœ¨é£Ÿæåº«ä¸­å°‹æ‰¾å°æ‡‰çš„é£Ÿæ
                const inventoryItem = this.inventory.find(item => {
                    const itemName = this.getPropertyTitle(item, 'å“é …åç¨±') || this.getPropertyTitle(item, 'åç¨±');
                    return itemName === ingredientName || itemName.includes(ingredientName.replace(/.*-/, ''));
                });
                
                if (!inventoryItem) {
                    console.warn(`âš ï¸ æ‰¾ä¸åˆ°é£Ÿæåº«å­˜: ${ingredientName}`);
                    return 0;
                }
                
                const currentStock = this.getPropertyNumber(inventoryItem, 'åº«å­˜é‡') || 
                                   this.getPropertyNumber(inventoryItem, 'å‹•æ…‹åº«å­˜é‡') || 0;
                
                return Math.floor(currentStock / requiredAmount);
            }

            // è¨ˆç®—åŠæˆå“çš„å¯è£½ä½œä»½æ•¸
            calculateRecipeAvailableServings(recipeName, requiredAmount) {
                // åœ¨åŠæˆå“ä¸­å°‹æ‰¾å°æ‡‰çš„åŠæˆå“
                const recipe = this.recipes.find(item => {
                    const itemName = this.getPropertyTitle(item, 'å“é …åç¨±') || this.getPropertyTitle(item, 'åç¨±');
                    return itemName === recipeName || itemName.includes(recipeName.replace(/.*-/, ''));
                });
                
                if (!recipe) {
                    console.warn(`âš ï¸ æ‰¾ä¸åˆ°åŠæˆå“: ${recipeName}`);
                    return 0;
                }
                
                // é€™è£¡å¯ä»¥é€²ä¸€æ­¥è¨ˆç®—åŠæˆå“çš„å¯è£½ä½œä»½æ•¸
                // ç›®å‰å…ˆä½¿ç”¨åº«å­˜é‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const currentStock = this.getPropertyNumber(recipe, 'åº«å­˜é‡') || 
                                   this.getPropertyNumber(recipe, 'å‹•æ…‹åº«å­˜é‡') || 0;
                
                return Math.floor(currentStock / requiredAmount);
            }

            // å–å¾—èœè‰²çµ„æˆé …ç›®
            getMenuComponents(menuItemId) {
                return this.menuComponents.filter(component => {
                    const relations = this.getPropertyRelation(component, 'ä½¿ç”¨èœå–®');
                    return relations.some(rel => rel.id === menuItemId);
                });
            }

            // é¡¯ç¤ºèœå–®é …ç›®
            displayMenuItems() {
                this.filteredItems = [...this.menuItems];
                this.renderMenuGrid();
            }

            // æ¸²æŸ“èœå–®ç¶²æ ¼
            renderMenuGrid() {
                const grid = document.getElementById('menuGrid');
                
                if (this.filteredItems.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èœè‰²</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = this.filteredItems.map(item => this.createMenuCard(item)).join('');
            }

            // å‰µå»ºèœå–®å¡ç‰‡
            createMenuCard(item) {
                const name = this.getPropertyTitle(item, 'é¤é»åç¨±');
                const price = this.getPropertyNumber(item, 'åƒ¹æ ¼');
                const type = this.getPropertySelect(item, 'é¤é»é¡å‹');
                const location = this.getPropertySelect(item, 'è£½ä½œåœ°é»');
                const description = this.getPropertyRichText(item, 'é¤é»ä»‹ç´¹');
                const cost = this.getPropertyRollup(item, 'æˆæœ¬');
                const isRecommended = this.getPropertyCheckbox(item, 'æ¨è–¦');
                const spiceLevel = this.getPropertySelect(item, 'è¾£åº¦');
                
                const statusConfig = this.getStatusConfig(item.supplyStatus);
                
                return `
                    <div class="menu-card bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800">${name || 'æœªå‘½åèœè‰²'}</h3>
                                ${isRecommended ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">æ¨è–¦</span>' : ''}
                            </div>
                            
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-2xl font-bold text-blue-600">$${price || 0}</span>
                                <span class="text-sm text-gray-500">æˆæœ¬: $${cost || 'N/A'}</span>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">${type || 'æœªåˆ†é¡'}</span>
                                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">${location || 'æœªæŒ‡å®š'}</span>
                                ${spiceLevel ? `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded">${spiceLevel}</span>` : ''}
                            </div>
                            
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${description || 'æš«ç„¡ä»‹ç´¹'}</p>
                            
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fas ${statusConfig.icon} ${statusConfig.color} mr-2"></i>
                                    <span class="text-sm ${statusConfig.color}">${statusConfig.text}</span>
                                    <span class="text-xs text-gray-500 ml-2">(${item.availableServings}ä»½)</span>
                                </div>
                                
                                <button onclick="showMenuDetail('${item.id}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                                    <i class="fas fa-eye mr-1"></i>æŸ¥çœ‹è©³æƒ…
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // å–å¾—ç‹€æ…‹é…ç½®
            getStatusConfig(status) {
                const configs = {
                    sufficient: { 
                        icon: 'fa-check-circle', 
                        color: 'status-sufficient', 
                        text: 'å¯ä¾›æ‡‰' 
                    },
                    low: { 
                        icon: 'fa-exclamation-triangle', 
                        color: 'status-low', 
                        text: 'åº«å­˜åä½' 
                    },
                    shortage: { 
                        icon: 'fa-times-circle', 
                        color: 'status-shortage', 
                        text: 'ç„¡æ³•ä¾›æ‡‰' 
                    }
                };
                return configs[status] || configs.sufficient;
            }

            // å–å¾—çµ„ä»¶åº«å­˜ç‹€æ…‹
            getComponentStockStatus(component, availableServings) {
                if (availableServings <= 0) {
                    return { color: 'status-shortage', text: 'ç¼ºæ–™' };
                } else if (availableServings <= 5) {
                    return { color: 'status-low', text: 'åº«å­˜åä½' };
                } else {
                    return { color: 'status-sufficient', text: 'åº«å­˜å……è¶³' };
                }
            }

            // é¡¯ç¤ºèœè‰²è©³æƒ…
            showMenuDetail(menuId) {
                const item = this.menuItems.find(m => m.id === menuId);
                if (!item) return;
                
                const name = this.getPropertyTitle(item, 'é¤é»åç¨±');
                const components = this.getMenuComponents(menuId);
                
                document.getElementById('modalMenuName').textContent = name || 'æœªå‘½åèœè‰²';
                document.getElementById('modalContent').innerHTML = this.createMenuDetailContent(item, components);
                document.getElementById('menuDetailModal').classList.remove('hidden');
            }

            // å‰µå»ºèœè‰²è©³æƒ…å…§å®¹
            createMenuDetailContent(item, components) {
                const price = this.getPropertyNumber(item, 'åƒ¹æ ¼');
                const type = this.getPropertySelect(item, 'é¤é»é¡å‹');
                const location = this.getPropertySelect(item, 'è£½ä½œåœ°é»');
                const description = this.getPropertyRichText(item, 'é¤é»ä»‹ç´¹');
                const cost = this.getPropertyRollup(item, 'æˆæœ¬');
                const statusConfig = this.getStatusConfig(item.supplyStatus);
                
                let componentsList = '';
                if (components.length > 0) {
                    componentsList = components.map(comp => {
                        const compName = this.getPropertyTitle(comp, 'åç¨±');
                        const foodAmount = this.getPropertyNumber(comp, 'é£Ÿæç”¨é‡');
                        const recipeAmount = this.getPropertyNumber(comp, 'é£Ÿè­œç”¨é‡');
                        const totalPrice = this.getPropertyFormula(comp, 'ç¸½åƒ¹');
                        
                        // ä½¿ç”¨æˆ‘å€‘è¨ˆç®—çš„å¯è£½ä½œä»½æ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ Notion çš„æ•¸æ“š
                        let availableServings = comp.calculatedServings;
                        if (availableServings === undefined) {
                            availableServings = this.getPropertyFormula(comp, 'å¯è£½ä½œä»½æ•¸') || 
                                              this.getPropertyNumber(comp, 'å¯è£½ä½œä»½æ•¸') || 0;
                        }
                        
                        // å–å¾—åº«å­˜ç‹€æ…‹
                        const stockStatus = this.getComponentStockStatus(comp, availableServings);
                        
                        return `
                            <tr class="border-b">
                                <td class="py-2 px-4">${compName || 'æœªå‘½å'}</td>
                                <td class="py-2 px-4">${foodAmount ? foodAmount + 'g' : (recipeAmount ? recipeAmount + 'g' : 'N/A')}</td>
                                <td class="py-2 px-4">$${totalPrice || 'N/A'}</td>
                                <td class="py-2 px-4">
                                    <span class="${stockStatus.color}">${availableServings || 0} ä»½</span>
                                    <small class="text-gray-500 block">${stockStatus.text}</small>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    componentsList = '<tr><td colspan="4" class="py-4 text-center text-gray-500">æš«ç„¡çµ„æˆé …ç›®è³‡æ–™</td></tr>';
                }
                
                return `
                    <div class="space-y-6">
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">åŸºæœ¬è³‡è¨Š</h3>
                                <div class="space-y-2">
                                    <p><span class="font-medium">åƒ¹æ ¼:</span> $${price || 0}</p>
                                    <p><span class="font-medium">æˆæœ¬:</span> $${cost || 'N/A'}</p>
                                    <p><span class="font-medium">é¡å‹:</span> ${type || 'æœªåˆ†é¡'}</p>
                                    <p><span class="font-medium">è£½ä½œåœ°é»:</span> ${location || 'æœªæŒ‡å®š'}</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">ä¾›æ‡‰ç‹€æ…‹</h3>
                                <div class="flex items-center mb-2">
                                    <i class="fas ${statusConfig.icon} ${statusConfig.color} mr-2"></i>
                                    <span class="${statusConfig.color} font-medium">${statusConfig.text}</span>
                                </div>
                                <p class="text-sm text-gray-600">å¯è£½ä½œä»½æ•¸: ${item.availableServings} ä»½</p>
                            </div>
                        </div>
                        
                        <!-- ä»‹ç´¹ -->
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">é¤é»ä»‹ç´¹</h3>
                            <p class="text-gray-600">${description || 'æš«ç„¡ä»‹ç´¹'}</p>
                        </div>
                        
                        <!-- çµ„æˆé …ç›® -->
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">çµ„æˆé …ç›®</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-200 py-2 px-4 text-left">é …ç›®åç¨±</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">ç”¨é‡</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">æˆæœ¬</th>
                                            <th class="border border-gray-200 py-2 px-4 text-left">å¯è£½ä½œä»½æ•¸</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${componentsList}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ç¯©é¸èœå–®é …ç›®
            filterMenuItems() {
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const locationFilter = document.getElementById('locationFilter').value;
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                this.filteredItems = this.menuItems.filter(item => {
                    const name = this.getPropertyTitle(item, 'é¤é»åç¨±').toLowerCase();
                    const type = this.getPropertySelect(item, 'é¤é»é¡å‹');
                    const location = this.getPropertySelect(item, 'è£½ä½œåœ°é»');
                    
                    return (!typeFilter || type === typeFilter) &&
                           (!statusFilter || item.supplyStatus === statusFilter) &&
                           (!locationFilter || location === locationFilter) &&
                           (!searchTerm || name.includes(searchTerm));
                });
                
                this.renderMenuGrid();
                this.updateStatistics();
            }

            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            updateStatistics() {
                const total = this.filteredItems.length;
                const available = this.filteredItems.filter(item => item.supplyStatus === 'sufficient').length;
                const lowStock = this.filteredItems.filter(item => item.supplyStatus === 'low').length;
                const shortage = this.filteredItems.filter(item => item.supplyStatus === 'shortage').length;
                
                document.getElementById('totalMenuItems').textContent = total;
                document.getElementById('availableItems').textContent = available;
                document.getElementById('lowStockItems').textContent = lowStock;
                document.getElementById('shortageItems').textContent = shortage;
            }

            // é¡¯ç¤ºä¾›æ‡‰åˆ†æ
            showSupplyAnalysis() {
                const shortageItems = this.menuItems.filter(item => item.supplyStatus === 'shortage');
                const lowStockItems = this.menuItems.filter(item => item.supplyStatus === 'low');
                
                let analysisContent = `
                    <h3 class="text-lg font-bold mb-4">ä¾›æ‡‰ç‹€æ³åˆ†æå ±å‘Š</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-red-600 mb-2">ç„¡æ³•ä¾›æ‡‰èœè‰² (${shortageItems.length} é …)</h4>
                        ${shortageItems.length > 0 ? `
                            <ul class="list-disc list-inside space-y-1">
                                ${shortageItems.map(item => `
                                    <li>${this.getPropertyTitle(item, 'é¤é»åç¨±')} - å¯è£½ä½œ: ${item.availableServings} ä»½</li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-gray-600">ç›®å‰æ²’æœ‰ç„¡æ³•ä¾›æ‡‰çš„èœè‰²</p>'}
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-yellow-600 mb-2">åº«å­˜åä½èœè‰² (${lowStockItems.length} é …)</h4>
                        ${lowStockItems.length > 0 ? `
                            <ul class="list-disc list-inside space-y-1">
                                ${lowStockItems.map(item => `
                                    <li>${this.getPropertyTitle(item, 'é¤é»åç¨±')} - å¯è£½ä½œ: ${item.availableServings} ä»½</li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-gray-600">ç›®å‰æ²’æœ‰åº«å­˜åä½çš„èœè‰²</p>'}
                    </div>
                `;
                
                document.getElementById('modalMenuName').textContent = 'ä¾›æ‡‰åˆ†æå ±å‘Š';
                document.getElementById('modalContent').innerHTML = analysisContent;
                document.getElementById('menuDetailModal').classList.remove('hidden');
            }

            // Notion å±¬æ€§å–å¾—æ–¹æ³•
            getPropertyTitle(item, propertyName) {
                return item.properties[propertyName]?.title?.[0]?.plain_text || '';
            }

            getPropertyRichText(item, propertyName) {
                return item.properties[propertyName]?.rich_text?.[0]?.plain_text || '';
            }

            getPropertyNumber(item, propertyName) {
                return item.properties[propertyName]?.number || null;
            }

            getPropertySelect(item, propertyName) {
                return item.properties[propertyName]?.select?.name || '';
            }

            getPropertyCheckbox(item, propertyName) {
                return item.properties[propertyName]?.checkbox || false;
            }

            getPropertyRelation(item, propertyName) {
                return item.properties[propertyName]?.relation || [];
            }

            getPropertyRollup(item, propertyName) {
                const rollup = item.properties[propertyName]?.rollup;
                return rollup?.number || rollup?.array?.[0]?.number || null;
            }

            getPropertyFormula(item, propertyName) {
                const formula = item.properties[propertyName]?.formula;
                return formula?.number || formula?.string || null;
            }
        }

        // å…¨åŸŸå¯¦ä¾‹
        let menuSystem;

        // åˆå§‹åŒ–ç³»çµ±
        document.addEventListener('DOMContentLoaded', function() {
            menuSystem = new MenuManagementSystem();
            loadAllMenuData();
        });

        // å…¨åŸŸå‡½æ•¸
        function loadAllMenuData() {
            menuSystem.loadAllData();
        }

        function filterMenuItems() {
            menuSystem.filterMenuItems();
        }

        function showMenuDetail(menuId) {
            menuSystem.showMenuDetail(menuId);
        }

        function showSupplyAnalysis() {
            menuSystem.showSupplyAnalysis();
        }

        function closeMenuDetailModal() {
            document.getElementById('menuDetailModal').classList.add('hidden');
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰æ¨¡æ…‹æ¡†
        document.getElementById('menuDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMenuDetailModal();
            }
        });
    </script>
</body>
</html>
