<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…æ–¹ç®¡ç†æ¸¬è©¦ - TANAWAT POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .test-error {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            <i class="fas fa-flask text-blue-600 mr-3"></i>
            é…æ–¹ç®¡ç† Notion API æ¸¬è©¦
        </h1>
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">API é€£æ¥æ¸¬è©¦</h2>
                <button id="start-test" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-play mr-2"></i>é–‹å§‹æ¸¬è©¦
                </button>
            </div>
            
            <div id="test-results" class="space-y-3">
                <!-- æ¸¬è©¦çµæœæœƒåœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">è³‡æ–™é è¦½</h2>
            <div id="data-preview" class="space-y-4">
                <!-- è³‡æ–™é è¦½æœƒåœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <script src="assets/js/recipe-notion-manager.js"></script>
    <script>
        let testManager;
        
        // ç¢ºä¿ RecipeNotionManager è¼‰å…¥
        function waitForManager() {
            return new Promise((resolve, reject) => {
                if (typeof RecipeNotionManager !== 'undefined') {
                    resolve();
                    return;
                }
                
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (typeof RecipeNotionManager !== 'undefined') {
                        clearInterval(interval);
                        resolve();
                    } else if (attempts > 50) { // 5ç§’å¾Œè¶…æ™‚
                        clearInterval(interval);
                        reject(new Error('RecipeNotionManager è¼‰å…¥è¶…æ™‚'));
                    }
                }, 100);
            });
        }
        
        document.getElementById('start-test').addEventListener('click', async () => {
            const resultsContainer = document.getElementById('test-results');
            const previewContainer = document.getElementById('data-preview');
            
            resultsContainer.innerHTML = '';
            previewContainer.innerHTML = '';
            
            try {
                // ç­‰å¾… RecipeNotionManager è¼‰å…¥
                addTestResult('â³ ç­‰å¾…ç®¡ç†å™¨è¼‰å…¥...', 'loading');
                await waitForManager();
                addTestResult('âœ… ç®¡ç†å™¨è¼‰å…¥å®Œæˆ', 'success');
                
                // æ¸¬è©¦ 1: åˆå§‹åŒ–ç®¡ç†å™¨
                addTestResult('ğŸ”§ åˆå§‹åŒ–é…æ–¹ç®¡ç†å™¨...', 'loading');
                testManager = new RecipeNotionManager();
                addTestResult('âœ… é…æ–¹ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æ¸¬è©¦ 2: è¼‰å…¥åŠæˆå“é…æ–¹
                addTestResult('ğŸ“Š è¼‰å…¥åŠæˆå“é…æ–¹è³‡æ–™åº«...', 'loading');
                const recipes = await testManager.loadRecipes();
                addTestResult(`âœ… æˆåŠŸè¼‰å…¥ ${recipes.length} é …åŠæˆå“é…æ–¹`, 'success');
                
                // æ¸¬è©¦ 3: è¼‰å…¥çµ„æˆé …ç›®
                addTestResult('ğŸ§© è¼‰å…¥åŠæˆå“çµ„æˆé …ç›®è³‡æ–™åº«...', 'loading');
                const ingredients = await testManager.loadIngredients();
                addTestResult(`âœ… æˆåŠŸè¼‰å…¥ ${ingredients.length} é …çµ„æˆé …ç›®`, 'success');
                
                // æ¸¬è©¦ 4: å»ºç«‹é—œè¯
                addTestResult('ğŸ”— å»ºç«‹é…æ–¹èˆ‡çµ„æˆé …ç›®é—œè¯...', 'loading');
                testManager.linkRecipesWithIngredients();
                addTestResult('âœ… é—œè¯å»ºç«‹å®Œæˆ', 'success');
                
                // æ¸¬è©¦ 5: åˆ†æçµ±è¨ˆ
                addTestResult('ğŸ“ˆ åˆ†æé…æ–¹çµ±è¨ˆè³‡æ–™...', 'loading');
                const producible = testManager.getProducibleRecipes();
                const shortage = testManager.getShortageRecipes();
                const avgCost = testManager.calculateAverageCost();
                addTestResult(`âœ… çµ±è¨ˆå®Œæˆ: å¯ç”Ÿç”¢ ${producible.length} é …, ç¼ºæ–™ ${shortage.length} é …, å¹³å‡æˆæœ¬ $${avgCost}`, 'success');
                
                // æ¸¬è©¦ 6: ç”Ÿæˆæ¡è³¼å»ºè­°
                addTestResult('ğŸ›’ ç”Ÿæˆæ¡è³¼å»ºè­°...', 'loading');
                const suggestions = testManager.generatePurchaseSuggestions();
                addTestResult(`âœ… ç”Ÿæˆ ${suggestions.length} é …æ¡è³¼å»ºè­°`, 'success');
                
                // é¡¯ç¤ºè³‡æ–™é è¦½
                showDataPreview(recipes, ingredients);
                
                addTestResult('ğŸ‰ æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼ç³»çµ±é‹è¡Œæ­£å¸¸', 'success');
                
            } catch (error) {
                console.error('æ¸¬è©¦å¤±æ•—:', error);
                addTestResult(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        function addTestResult(message, type) {
            const resultsContainer = document.getElementById('test-results');
            const div = document.createElement('div');
            
            div.className = `test-result ${type === 'error' ? 'test-error' : ''}`;
            
            if (type === 'loading') {
                div.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-spinner loading mr-3"></i>
                        <span>${message}</span>
                    </div>
                `;
            } else {
                div.innerHTML = `<span>${message}</span>`;
            }
            
            resultsContainer.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDataPreview(recipes, ingredients) {
            const previewContainer = document.getElementById('data-preview');
            
            // é¡¯ç¤ºå‰5é …é…æ–¹
            const recipePreview = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">é…æ–¹é è¦½ (å‰5é …)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${recipes.slice(0, 5).map(recipe => `
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-blue-600">${recipe.name}</h4>
                                <div class="text-sm text-gray-600 mt-2">
                                    <p>åˆ†é¡: ${recipe.category}</p>
                                    <p>é‡é‡: ${recipe.weight}g</p>
                                    <p>æˆæœ¬: $${recipe.unitCost.toFixed(2)}/100g</p>
                                    <p>ç‹€æ…‹: ${recipe.status}</p>
                                    <p>å¯è£½ä½œ: ${recipe.maxProduction} ä»½</p>
                                    <p>çµ„æˆé …ç›®: ${recipe.ingredients?.length || 0} é …</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // é¡¯ç¤ºå‰10é …çµ„æˆé …ç›®
            const ingredientPreview = `
                <div>
                    <h3 class="text-lg font-semibold mb-3">çµ„æˆé …ç›®é è¦½ (å‰10é …)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${ingredients.slice(0, 10).map(ingredient => `
                            <div class="border rounded-lg p-3">
                                <h4 class="font-medium text-green-600">${ingredient.name}</h4>
                                <div class="text-sm text-gray-600 mt-1">
                                    <p>ç”¨é‡: ${ingredient.usageAmount}g</p>
                                    <p>æˆæœ¬: $${ingredient.itemCost.toFixed(2)}</p>
                                    <p>åº«å­˜: ${ingredient.ingredientStock}g</p>
                                    <p>å¯è£½ä½œ: ${ingredient.maxProduciblePieces} ä»½</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = recipePreview + ingredientPreview;
        }
    </script>
</body>
</html>
